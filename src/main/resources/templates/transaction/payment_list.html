<html layout:decorate="~{layout_page}">
<th:block layout:fragment="content">
    <div class="layout-contents">
        <div class="page-title-wrap">
            <div class="left">
                <h2>ì§€ê¸‰ í˜„í™©</h2>
                <a title="ë¶ë§ˆí¬" class="bookmark toggle">
                    ë‚´ ë©”ë‰´
                </a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
                <li>ì¶œê¸ˆ ê´€ë¦¬</li>
                <li>ì§€ê¸‰ í˜„í™©</li>
            </ul>
        </div>

        <section class="section">
            <div class="section-top">
                <div class="search-wrap">
                    <dl>
                        <dt>
                            ê±°ë˜ì²˜<span class="eq">*</span>
                        </dt>
                        <dd>
                            <ul class="date-box">
                                <li>
                                    <input type="text" id="btnCompanySearch" name="keyword" />
                                    <input type="hidden" id="cboCompanyHidden" name="keyword" />
                                </li>
                            </ul>
                        </dd>
                    </dl>

                    <dl>
                        <dt>
                            <label for="accountNum">
                                ê³„ì¢Œëª…<span class="eq"></span>
                            </label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <input type="text" id="accountNum">
                            </div>
                        </dd>
                    </dl>

                    <dl>
                        <dt>
                            <label for="depositType">
                                ì…ê¸ˆí˜•íƒœ
                            </label>
                        </dt>
                        <dd>
                            <select id="depositType" name="depositType">

                            </select>
                        </dd>
                    </dl>
                    <dl>
                        <dt>
                            <label for="remark">
                                ì  ìš”
                            </label>
                        </dt>
                        <dd>
                            <input type="text" id="remark">
                        </dd>
                    </dl>
                    <dl>
                        <dt>
                            <label for="eumNum">
                                ì–´ìŒë²ˆí˜¸
                            </label>
                        </dt>
                        <dd>
                            <input type="text" id="eumNum">
                        </dd>
                    </dl>
                </div>
            </div>
            <div style="display: flex;">
                <dl>
                    <dt>
                        <label for="">
                            ì¡°íšŒê¸°ê°„
                        </label>
                    </dt>
                    <dd>
                        <ul class="date-box">
                            <li>
                                <input type="date" id="date_from" name="date_from">
                                <label for="date_from" class="hide">ì‹œì‘ì¼</label>
                            </li>
                            ~
                            <li>
                                <input type="date" id="date_to" name="date_to">
                                <label for="date_to" class="hide">ì¢…ë£Œì¼</label>
                            </li>
                        </ul>
                    </dd>
                </dl>

                <dl>
                    <dd>
                        <li>
                            <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnMainSearch">
                                <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                                <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                ê²€ìƒ‰
                            </a>
                        </li>
                    </dd>
                </dl>
            </div>
            <div class="container-fluid">
                <div id="theGrid" style="height: 600px;"></div>
            </div>

        </section>
    </div>

    <script type="text/x-tmpl" id="production_order">
        <div class="content_wrap popup">
            <div class="table-wrap">
                <form id="productionOrderForm" class="form-group">
                    <table class="write-table">
                        <caption>ì‘ì—… ì§€ì‹œ í…Œì´ë¸”</caption>
                        <input type="hidden" id="id" name="id" value="{%=o.id%}">
                        <tbody>
                            {% if (o.id != '') { %}
                            <tr>
                                <th style="text-align: center">
                                    <label for="workorder_number">ì‘ì§€ë²ˆí˜¸</label>
                                </th>
                                <td>
                                    <input class="form-control2 tac readonly" id="workorder_number" name="workorder_number" type="text" readonly="readonly" value="{%=o.workorder_number%}" />
                                </td>
                                <th style="text-align: center">
                                    <label for="cboState">ìƒíƒœ</label>
                                </th>
                                <td>
                                    <input class="form-control2 tac readonly" id="cboState" name="cboState" type="text" readonly="readonly" value="{%=o.state_name%}" />
                                </td>
                            </tr>
                            {% } %}
                            <tr>
                                <th style="text-align: center">
                                    <label for="cboMaterialGrp">í’ˆëª©ê·¸ë£¹</label>
                                </th>
                                <td>
                                    <input class="form-control2" id="cboMaterialGrp" name="cboMaterialGrp" readonly type="hidden">
                                    <input class="form-control2" id="cboMaterialGrpName" name="cboMaterialGrpName" readonly>
                                </td>
                                <th style="text-align: center">
                                    <label for="mat_code">í’ˆëª©ì½”ë“œ</label>
                                </th>
                                <td>
                                    <input type="text" class="form-control2" id="mat_code" name="mat_code" readonly value="{%=o.mat_code%}" />
                                </td>
                            </tr>
                            <tr>
                                <th style="text-align: center">
                                    <label for="cboMaterial">ì œí’ˆ*</label>
                                </th>
                                <td colspan="3">
                                    <input id="cboMaterial" type="hidden" name="cboMaterial" readonly >
                                    <input id="cboMaterialName" name="cboMaterialName" readonly placeholder="ê²€ìƒ‰ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì œí’ˆì„ ê²€ìƒ‰í•˜ì„¸ìš”">
                                    <a class="btn btn-delete" id="btnMaterialSearch" title="í’ˆëª©ê²€ìƒ‰">
                                        <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                        í’ˆëª© ê²€ìƒ‰
                                    </a>
                                </td>
                            </tr>
                            <tr>
                                <th style="text-align: center">
                                    <label for="txtOrderQty">ì§€ì‹œëŸ‰*</label>
                                </th>
                                <td>
                                    <input class="form-control2 tar" type="number" id="txtOrderQty" name="txtOrderQty" value="{%=o.order_qty%}" min="1" />
                                </td>
                                <th style="text-align: center">
                                    <label for="txtUnit">ë‹¨ìœ„</label>
                                </th>
                                <td>
                                    <input class="form-control2 tac readonly" type="text" id="txtUnit" name="txtUnit" value="{%=o.unit_name%}" readonly="readonly" />
                                </td>
                            </tr>
                            <tr>
                                <th style="text-align: center">
                                    <label for="production_date">ìƒì‚°ì¼</label>
                                </th>
                                <td>
                                    <input class="form-control2 tac" type="date" id="production_date" name="production_date" value="{%=o.production_date%}" />
                                </td>
                                <th style="text-align: center">
                                    <label for="cboShiftCode">ê·¼ë¬´ì¡°*</label>
                                </th>
                                <td>
                                    <select class="form-control2" id="cboShiftCode" name="cboShiftCode" value="{%=o.shift_name%}"></select>
                                </td>
                            </tr>
                            <tr>
                                <th style="text-align: center">
                                    <label for="cboWorcenter">ì›Œí¬ì„¼í„°*</label>
                                </th>
                                <td>
                                    <select class="form-control2" id="cboWorcenter" name="cboWorcenter"></select>
                                </td>
                                <th style="text-align: center">
                                    <label for="cboEquipment">ì„¤ë¹„</label>
                                </th>
                                <td>
                                    <select class="form-control2" id="cboEquipment" name="cboEquipment"></select>
                                </td>
                            </tr>
                            <tr>
                                <th style="text-align: center">
                                    <label for="txtDescription">ë¹„ê³ </label>
                                </th>
                                <td colspan="3">
                                    <textarea class="form-control2" id="txtDescription" name="txtDescription">{%=o.description%}</textarea>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </form>
            </div>

            <div class="popup-button">
                <button type="button" class="btn-popup" id="btn_save" ><span data-labelCd="ì €ì¥">ì €ì¥</span></button>
                <button type="button" class="btn-popup" id="modal-close-button"><span data-labelCd="ë‹«ê¸°">ë‹«ê¸°</span></button>
            </div>
        </div>
    </script>

    <th:block layout:fragment="scripts">
        <th:block th:replace="/common/multiform_material :: multiform_material"></th:block>
        <th:block th:replace="/common/popup_company :: popup_company"></th:block>
        <th:block th:replace="/common/popup_account :: popup_account" />
        <script type="text/javascript">

            class production_require {
                constructor() {
                    this.grid = null;
                    this.init();
                }

                init() {
                    let _this = this;
                    this.grid = new wijmo.grid.FlexGrid('#theGrid', {
                        autoGenerateColumns: false,
                        selectionMode: wijmo.grid.SelectionMode.Row,
                        headersVisibility: wijmo.grid.HeadersVisibility.Column,
                        isReadOnly: false,
                        showMarquee: true,
                        formatItem: (sender, e) => {
                            if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                                e.cell.style.textAlign = 'center';
                            }
                        },
                        columns: [
                            {binding: 'trdate', header: 'ì¼ì', width: 130, align: 'center'},
                            {binding: 'id', header: 'ì½”ë“œ', width: 120, align: 'center'},
                            {binding: 'Name', header: 'ê±°ë˜ì²˜ëª…', width: 220, align: 'center'},
                            {binding: 'accout', header: 'ê¸ˆì•¡', width: 100, align: 'right'},
                            {binding: 'iotype', header: 'ì§€ê¸‰í˜•íƒœ', width: 130, align: 'left'},
                            {binding: 'accname', header: 'ì€í–‰', width: 110, align: 'center'},
                            {binding: 'accnum', header: 'ê³„ì¢Œ', width: 200, align: 'center'},
                            {binding: 'trid', header: 'ê±°ë˜êµ¬ë¶„', width: 120, align: 'center'},
                            {binding: 'memo', header: 'ë©”ëª¨', width: 450, align: 'left'},
                            {binding: 'remark', header: 'ì ìš”', width: 350, align: 'left'}
                        ]
                    });

                    new FlexGridContextMenu(this.grid);
                    this.grid.downloadFileName = 'ì‘ì—… ì§€ì‹œ ë“±ë¡ ë‚´ì—­';

                    this.grid.hostElement.addEventListener('dblclick', function (e) {
                        let items = _this.grid.selectedItems;
                        if (items.length === 0) {
                            return false;
                        }
                        $('#btnPlanSave').trigger('click');
                    });
                    // âœ… Footer íŒ¨ë„ ì‚¬ìš© ì„¤ì •
                    this.grid.columnFooters.rows.push(new wijmo.grid.Row());
                    this.grid.bottomLeftCells.setCellData(0, 0, 'ì›” ê³„');
                    this.grid.columnFooters.rows.push(new wijmo.grid.Row());
                    this.grid.bottomLeftCells.setCellData(0, 0, 'í•© ê³„');

                    // âœ… Footer í•©ê³„ ê°’ ì„¤ì • (ìˆ˜ë™)
                    this.grid.loadedRows.addHandler(() => {
                        const rows = this.grid.rows;
                        const footerMonth = this.grid.columnFooters.rows[0];
                        const footerTotal = this.grid.columnFooters.rows[1];

                        const getSum = (field) => rows.map(r => +r.dataItem[field] || 0).reduce((a, b) => a + b, 0);

                        footerMonth.dataItem = {
                            mat_grp_name: 'ì›” ê³„'
                            // year_qty_sum: getSum('year_qty_sum'),
                            // year_money_sum: getSum('year_money_sum'),
                        };
                        footerTotal.dataItem = {
                            mat_grp_name: 'í•© ê³„'
                            // year_qty_sum: getSum('year_qty_sum'),
                            // year_money_sum: getSum('year_money_sum'),
                        };
                    });
                }

                searchMainData() {
                    let _this = this;
                    let date_from = $('#date_from').val();
                    let date_to = $('#date_to').val();
                    let company = $('#cboCompanyHidden').val();
                    let accountNum = $('#accountNum').val();
                    let depositType = $('#depositType').val();
                    let remark = $('#remark').val();
                    let eumNum = $('#eumNum').val();
                    let url = '/api/transaction/payment_list'
                    let data = {
                        'date_from': date_from,
                        'date_to': date_to,
                        'companyCode': company,
                        'accountNum': accountNum,
                        'depositType': depositType,
                        'remark': remark,
                        'eumNum': eumNum
                    };
                    let result = AjaxUtil.getSyncData(url + "/read", data);
                    if (result.data != null) {
                        console.log("data : ", result.data)
                        _this.grid.itemsSource = new wijmo.collections.CollectionView(result.data);
                    }
                }



                showPopUp(data, action) {
                    let _this = this;
                    let content = tmpl('production_order', data);
                    let $content = $(content);
                    let $form = $content.find('#productionOrderForm');
                    let today = CommonUtil.getYYYYMMDD();

                    let modalContainer = null;
                    if (action === 'update') {
                        modalContainer = new PopupDraggable('ì‘ì—… ì§€ì‹œ ìˆ˜ì •');
                        modalContainer.open({width: 1000, height: 550, $content});
                    } else if (action === 'new') {
                        modalContainer = new PopupDraggable('ì‘ì—… ì§€ì‹œ ë“±ë¡');
                        modalContainer.open({width: 1000, height: 480, $content});
                    }

                    let $btnMaterialSearch = $content.find('#btnMaterialSearch');

                    // $('#srchDt').ax5DatePicker({direction: 'top'});
                    $('production_date').val(today);

                    AjaxUtil.fillSelectOptions($content.find('#cboShiftCode'), 'shift', 'choose', false);
                    AjaxUtil.fillSelectOptions($content.find('#cboMaterialGrp'), 'material_group', 'choose', false, 'product,semi');
                    AjaxUtil.fillSelectOptions($content.find('#cboWorcenter'), 'workcenter', 'choose', false);

                    $content.find('#cboWorcenter').off('change').on('change', function () {
                        const workcenterId = $content.find('#cboWorcenter').val();
                        if (!workcenterId) return;
                        AjaxUtil.fillSelectOptions($content.find('#cboEquipment'), 'equipment_code', 'choose', '', $content.find('#cboWorcenter').val());
                    });
                    AjaxUtil.fillSelectOptions($content.find('#cboMaterial'), 'material', 'choose', false);

                    if (action === 'update') {
                        AjaxUtil.fillSelectOptions($content.find('#cboMaterial'), 'material', 'choose', false, data.mat_grp_id);
                        $content.find('#cboShiftCode').val(data.shift_code);
                        $content.find('#cboMaterialGrp').val(data.mat_grp_id);
                        $content.find('#cboMaterial').val(data.mat_id);
                        $content.find('#cboMaterialGrpName').val(data.mat_grp_name);
                        $content.find('#cboMaterialName').val(data.mat_name);
                        $content.find('#cboWorcenter').val(data.workcenter_id);
                        $content.find('#cboEquipment').val(data.equip_id);
                    } else {
                        $btnMaterialSearch.removeAttr('disabled');
                        $btnMaterialSearch.click(function (e) {

                            let pop = new PopMatComponent();
                            pop.material_type = 'product,semi';
                            pop.show(function (item) {
                                $content.find('#cboMaterial').val(item.id);
                                $content.find('#cboMaterialGrp').val(item.MaterialGroup_id);
                                $content.find('#cboMaterialName').val(item.Name);
                                $content.find('#cboMaterialGrpName').val(item.group_name);
                                $content.find('#mat_code').val(item.Code);
                                $content.find('#cboWorcenter').val(item.WorkCenter_id);
                                $content.find('#cboEquipment').val(item.Equipment_id);

                                const $cboEquipment = $content.find('#cboEquipment');
                                const $cboWorcenter = $content.find('#cboWorcenter');

                                if (item.WorkCenter_id) {
                                    // ì›Œí¬ì„¼í„° ì„ íƒ â†’ ê·¸ì— ë§ëŠ” ì„¤ë¹„ ì˜µì…˜ ì±„ìš°ê¸°
                                    AjaxUtil.fillSelectOptions($cboEquipment, 'equipment_code', 'choose', item.Equipment_id, item.WorkCenter_id, function () {
                                        // ì„¤ë¹„ ì˜µì…˜ì´ ë¡œë“œëœ ë’¤, ì¼ì¹˜í•˜ëŠ” Equipment_idê°€ ìˆìœ¼ë©´ ì„ íƒ
                                        if (item.Equipment_id) {
                                            $cboEquipment.val(item.Equipment_id);
                                        }
                                    });
                                } else {
                                    $cboEquipment.empty(); // ì›Œí¬ì„¼í„° ì—†ìœ¼ë©´ ì„¤ë¹„ ì´ˆê¸°í™”
                                }

                                // ì›Œí¬ì„¼í„° ë³€ê²½ ì‹œ ì„¤ë¹„ ì˜µì…˜ ë‹¤ì‹œ ì±„ìš°ê¸°
                                $cboWorcenter.off('change').on('change', function () {
                                    const workcenterId = $(this).val();
                                    if (!workcenterId) return;

                                    AjaxUtil.fillSelectOptions($cboEquipment, 'equipment_code', 'choose', '', workcenterId);
                                });
                            });
                            pop.searchDataBind();

                        });

                    }



                    $('#cboMaterialGrp').change(function (e) {
                        AjaxUtil.fillSelectOptions($content.find('#cboMaterial'), 'material', 'choose', false, $content.find('#cboMaterialGrp').val());
                    });


                    $('#cboMaterial').change(function (e) {
                        let url = '/api/production/prod_order_a/mat_info';
                        let id = $content.find('#cboMaterial').val();
                        let data = {'id': id};
                        let result = AjaxUtil.getSyncData(url, data);
                        if (result.data != null) {
                            $content.find('#cboWorcenter').val(result.data.workcenter_pk);
                            $content.find('#txtUnit').val(result.data.unit_name);
                        } else {
                            $content.find('#cboWorcenter').val(null);
                            $content.find('#txtUnit').val(null);
                        }
                        //$content.find('#cboWorcenter').val(result.workcenter_pk);
                        //$content.find('#cboEquipment').val(result.equip_pk);

                    })

                    $content.find('#btn_save').on('click', function (e) {

                        // í•„ìˆ˜ì…ë ¥ check routine

                        if (!$('#cboShiftCode').val()) {
                            Alert.alert('', 'ê·¼ë¬´ì¡°ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                            return false;
                        }

                        if (!$('#cboWorcenter').val()) {
                            Alert.alert('', 'ì›Œí¬ì„¼í„°ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                            return false;
                        }

                        if (!$('#cboMaterialGrp').val()) {
                            Alert.alert('', 'ì œí’ˆ ê·¸ë£¹ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                            return false;
                        }

                        if (!$('#cboMaterial').val()) {
                            Alert.alert('', 'ì œí’ˆì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                            return false;
                        }

                        if (!$('#txtOrderQty').val()) {
                            Alert.alert('', 'ì§€ì‹œëŸ‰ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
                            return false;
                        } else if ($('#txtOrderQty').val() < 1) {
                            Alert.alert('', 'ì§€ì‹œëŸ‰ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.');
                            return false;
                        }

                        Alert.confirm('', "ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                            function () {
                                _this.saveOrder($form, modalContainer);
                            }
                        );

                    });
                }

                //ë²„íŠ¼ í™œì„±í™”
                setButtonState() {
                    let pk = this.grid.selectedItems;
                    $('#btnNew').prop('disabled', false);
                    $('#btnSave').prop('disabled', false);
                    if (pk) {
                        $('#btnDel').prop('disabled', false);
                    } else {
                        $('#btnDel').prop('disabled', true);
                    }
                }

            }

            let page = null;

            $(document).ready(function (e) {
                page = new production_require();

                let date_from = CommonUtil.getYYYYMMDD(-7);
                let today = CommonUtil.getYYYYMMDD();

                $('#date_from').val(date_from);
                $('#date_to').val(today);

                // ê²€ìƒ‰
                $('#btnMainSearch').click(function (e) {
                    page.searchMainData();
                });

                if (userinfo.group_code == 'admin') {
                    $('#btnGridSetting').css('visibility', 'visible');
                }

                // ê±°ë˜ì²˜ focusì‹œ ê±°ë˜ì²˜ ê²€ìƒ‰ ëª¨ë‹¬
                $('#btnCompanySearch').focus(function () {
                    let poppage = new PopCompComponent();
                    let $poppage = $(poppage);
                    let searchcallback = function (items) {
                        console.log('items : ',items);
                        document.getElementById('btnCompanySearch').value = items.compname;
                        document.getElementById('cboCompanyHidden').value = items.id;
                    };

                    poppage.show(searchcallback);
                });

                //ê³„ì¢Œ íŒì—…
                $('#accountNum').focus(function () {
                    let poppage = new PopAccountComponent();
                    let searchcallback = function (items) {
                        console.log('btnAccountName items : ', items);
                        // document.getElementById('btnAccountName').value = items.compname;
                    };
                    poppage.show(searchcallback);
                });

                // text '' ì¼ê²½ìš° hidden ê°’ ì´ˆê¸°í™”
                $('#btnCompanySearch').on('input', function () {
                    const val = $(this).val();
                    if (val === '') {
                        $('#cboCompanyHidden').val('');
                    }
                });
                $('#btnAccountName').on('input', function () {
                    const val = $(this).val();
                    if (val === '') {
                        $('#cboBankId').val('');
                    }
                });
                // .btn-clear í´ë¦­ í›„ input ì´ë²¤íŠ¸ ê°•ì œ ë°œìƒ
                $(document).on('click', '.btn-clear', function () {
                    const $input = $(this).siblings('input[type="text"]');
                    $input.val('');
                    $input.trigger('input'); // ğŸ”¥ input ì´ë²¤íŠ¸ ê°•ì œ ë°œìƒ
                });

                AjaxUtil.fillSelectOptions($('#depositType'), 'system_code', 'all', false, 'deposit_type');
                page.searchMainData();

            })
        </script>
    </th:block>
</th:block>
</html>
