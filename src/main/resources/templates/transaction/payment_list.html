<html layout:decorate="~{layout_page}">
<th:block layout:fragment="content">

    <div class="layout-contents">
        <div class="page-title-wrap">
            <div class="left">
                <h2>ÏßÄÍ∏â ÌòÑÌô©</h2>
                <a title="Î∂ÅÎßàÌÅ¨" class="bookmark toggle">
                    ÎÇ¥ Î©îÎâ¥
                </a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="ÌôàÏïÑÏù¥ÏΩò"></li>
                <li>Ï∂úÍ∏àÍ¥ÄÎ¶¨</li>
                <li>ÏßÄÍ∏â ÌòÑÌô©</li>
            </ul>
        </div>
        <section class="section">
            <div class="section-top">
                <div class="search-wrap">
                    <dl id="searchComArea">
                        <dt>
                            Í±∞ÎûòÏ≤ò
                        </dt>
                        <dd>
                            <input type="text" id="btnCompanySearch" name="btnCompanySearch" placeholder="Ìï¥Îãπ Ïπ∏ÏùÑ ÌÅ¥Î¶≠Ìï¥ÏÑú Í≤ÄÏÉâÌïòÏÑ∏Ïöî." style="width:225px">
                            <input type="hidden" id="cboCompanyHidden">
                            <input type="hidden" id="spjangcdHidden">
                        </dd>
                    </dl>
                    <dl>
                        <dt>
                            <label for="btnAccountName">
                                Í≥ÑÏ¢åÎ™Ö
                            </label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <input type="text" id="btnAccountName" name="btnAccountName" placeholder="Ìï¥Îãπ Ïπ∏ÏùÑ ÌÅ¥Î¶≠Ìï¥ÏÑú Í≤ÄÏÉâÌïòÏÑ∏Ïöî."  style="width:225px">
                                <input type="hidden" id="cboBankId">
                            </div>
                        </dd>
                    </dl>
                    <dl>
                        <dt>
                            <label for="cboDepositType">
                                ÏûÖÍ∏â ÌòïÌÉú<span class="eq"></span>
                            </label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <select id="cboDepositType" name="cboDepositType">
                                </select>
                            </div>
                        </dd>
                    </dl>
                    <dl>
                        <dt>
                            <label for="txtDescription">
                                Ï†ÅÏöî
                            </label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <input class="form-control2" type="text" id="txtDescription" name="txtDescription" placeholder="Ï†ÅÏöî" style="width:150px"/>
                            </div>
                        </dd>
                    </dl>
                    <dl>
                        <dt>
                            <label for="txtEumnum">
                                Ïñ¥ÏùåÎ≤àÌò∏
                            </label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <input class="form-control2" type="text" id="txtEumnum" name="txtEumnum" placeholder="Ïñ¥ÏùåÎ≤àÌò∏" style="width:200px"/>
                            </div>
                        </dd>
                    </dl>

                    <dl>
                        <dt>
                            Ï°∞ÌöåÍ∏∞Í∞Ñ<span class="eq">*</span>
                        </dt>
                        <dd>
                            <ul class="date-box">
                                <li>
                                    <input type="date" id="srchStartDt" name="srchStartDt">
                                    <label for="srchStartDt" class="hide">ÏãúÏûëÏùº</label>
                                </li>
                                ~
                                <li>
                                    <input type="date" id="srchEndDt" name="srchEndDt">
                                    <label for="srchEndDt" class="hide">Ï¢ÖÎ£åÏùº</label>
                                </li>
                            </ul>
                        </dd>
                    </dl>
                    <dl>
                        <dt>&nbsp;</dt>
                        <dd>
                            <li>
                                <a class="btn btn-delete" title="Í≤ÄÏÉâ" id="btnSearch">
                                    <!--                                        class Ïì∞Ïù¥Îäî Í≥≥ Ï∞æÍ≥† ÏóÜÏúºÎ©¥ ÌÅ¥ÎûòÏä§Î™Ö ÏàòÏ†ïÌïòÍ∏∞-->
                                    <img src="/images/icon/btn-srch.svg" alt="Í≤ÄÏÉâ ÏïÑÏù¥ÏΩò">
                                    Í≤ÄÏÉâ
                                </a>
                            </li>
                        </dd>
                    </dl>
                </div>
            </div>
            <div class="container-fluid">
                <div id="theGrid" style="height: 730px;" ></div>
            </div>
        </section>
    </div>
</th:block>

<th:block layout:fragment="scripts">
    <!--<th:block th:replace="/common/columns_setting :: columns_setting"></th:block>-->
    <th:block th:replace="/common/multiform_material :: multiform_material"></th:block>
    <th:block th:replace="/common/popup_company :: popup_company"></th:block>
    <th:block th:replace="/common/popup_account :: popup_account" />

    <script type="text/javascript">
        class PaymentList {
            constructor() {
                this.grid = null;
                this.$btnEdit = $('#btnEdit');
                this.$btnAddNew = $('#btnAddNew');
                this.spjangcd = $('#spjangcdHidden');
                this.viewData = new wijmo.collections.CollectionView();
                this.init();
            }

            init() {
                let _this = this;
                this.grid = new wijmo.grid.FlexGrid('#theGrid', {
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.Column,
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    formatItem: (sender, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                        if (e.panel.cellType === wijmo.grid.CellType.Cell) {
                            const row = sender.rows[e.row];
                            if (row instanceof wijmo.grid.GroupRow) {
                                const group = row.dataItem;
                                const sumAccOut = wijmo.getAggregate(wijmo.Aggregate.Sum, group.items, 'accout');
                                e.cell.innerHTML = `<b>${group.name}</b> (Ïõî Í≥Ñ: ${sumAccOut.toLocaleString()}Ïõê)`;
                                e.cell.colSpan = sender.columns.length;
                            }
                        }
                    },
                    columns: [
                        {binding: 'trdate', header: 'ÏùºÏûê', width: 120, align: 'left'},
                        {binding: 'ioid', header: 'ÏΩîÎìú', width: 100, align: 'right',visible: false },
                        {binding: 'CompanyName', header: 'Í±∞ÎûòÏ≤òÎ™Ö', width: 160, align: 'center'},
                        {binding: 'accout', header: 'Í∏àÏï°', width: 130, align: 'right'},
                        {binding: 'deposit_type', header: 'ÏûÖÍ∏âÌòïÌÉú', width: 80, align: 'center'},
                        {binding: 'banknm', header: 'ÏùÄÌñâ', width: 100, align: 'center'},
                        {binding: 'accnum', header: 'Í≥ÑÏ¢å', width: 180, align: 'center'},
                        {binding: 'eumnum', header: 'Ïñ¥ÏùåÎ≤àÌò∏', width: 180, align: 'center'},
                        {binding: 'eumtodt', header: 'ÎßåÍ∏∞ÏùºÏûê', width: 120, align: 'center'},
                        {binding: 'tradenm', header: 'Í±∞ÎûòÍµ¨Î∂Ñ', width: 100, align: 'center'},
                        {binding: 'remark1', header: 'Ï†ÅÏöî', width: 170},
                        {binding: 'memo', header: 'Î©îÎ™®', width: 190}
                    ],
                    itemsSource: this.viewData, // Îç∞Ïù¥ÌÑ∞Î•º ÏÑ§Ï†ïÌï† Î∞∞Ïó¥
                });

                new FlexGridContextMenu(this.grid);
                this.grid.downloadFileName = 'ÏßÄÍ∏â ÌòÑÌô©';

                //Footer Ìå®ÎÑê ÏÇ¨Ïö© ÏÑ§Ï†ï
                this.grid.columnFooters.rows.push(new wijmo.grid.Row());
                this.grid.bottomLeftCells.setCellData(0, 0, 'Ìï©Í≥Ñ');

                // Footer Ìï©Í≥Ñ Í∞í ÏÑ§Ï†ï (ÏàòÎèô)
                this.grid.loadedRows.addHandler(() => {
                    const rows = this.grid.rows;
                    const footer = this.grid.columnFooters.rows[0];

                    const getSum = (field) => rows.map(r => +r.dataItem[field] || 0).reduce((a, b) => a + b, 0);

                    footer.dataItem = {
                        CompanyName: "Ìï©Í≥Ñ",
                        accout: getSum('accout'),
                    };
                });


                // ÏóîÌÑ∞ÌÇ§ Í≤ÄÏÉâ
                $('#txtDescription, #txtEumnum').on('keypress', function (e) {
                    if (e.keyCode === 13) {
                        _this.searchMainData();
                    }
                });
            }

            searchMainData() {
                let _this = this;
                let url = '/api/transaction/payment_list/read'

                let data = {
                    'srchStartDt' : $("#srchStartDt").val(),
                    'srchEndDt' : $("#srchEndDt").val(),
                    'AccountName' : $("#cboBankId").val(), //Í≥ÑÏ¢åÎ™Ö(accidÎ°ú Í≤ÄÏÉâ)
                    'cboDepositType' : $('#cboDepositType').val(),  //ÏûÖÍ∏àÌòïÌÉú
                    'cboCompany': $("#cboCompanyHidden").val(),
                    'txtDescription' : $("#txtDescription").val(),
                    'txtEumnum' :$('#txtEumnum').val(),
                    spjangcd: this.spjangcd.val()  //ÏÇ¨ÏóÖÏû• ÏΩîÎìú
                }
                let fnsuccess = function(result) {
                    if (result != null) {
                        _this.viewData = new wijmo.collections.CollectionView(result.data);

                        _this.viewData.groupDescriptions.push(
                            new wijmo.collections.PropertyGroupDescription('trdate', (item, prop) => {
                                if (!item[prop]) return '';
                                const date = new Date(item[prop]);
                                const year = date.getFullYear();
                                const month = ('0' + (date.getMonth() + 1)).slice(-2);
                                return `${year}ÎÖÑ${month}Ïõî`; // Ïó¨Í∏∞!
                            })
                        );

                        _this.grid.itemsSource = _this.viewData;
                    }
                };

                AjaxUtil.getAsyncData(url, data, fnsuccess);
            }
        }
        let page = null;

        $(document).ready(function (e) {

            const spjangcd = sessionStorage.getItem('spjangcd');
            if (spjangcd) {
                $('#spjangcdHidden').val(spjangcd);
            }

            page = new PaymentList();

            AjaxUtil.fillSelectOptions($('#cboYear'), 'data_year', '', false);
            AjaxUtil.fillSelectOptions($('#cboDepositType'), 'system_code', 'all', false, 'deposit_type', '');

            let today = new Date();
            let monthStart = new Date(today.getFullYear(), today.getMonth(), 1);

            $('#srchStartDt').val(CommonUtil.formatYYYYMMDD(monthStart));
            $('#srchEndDt').val(CommonUtil.formatYYYYMMDD(today));

            page.searchMainData();

            // Í≤ÄÏÉâ
            $('#btnSearch').click(function (e) {
                if ($('#cboCompany').val() !== '' && $('#cboCompanyHidden').val() === '') {
                    // ÏóÖÏ≤¥Î™Ö ÌÖçÏä§Ìä∏Îäî ÏçºÏßÄÎßå, ÏóÖÏ≤¥ Í≤ÄÏÉâ Î≤ÑÌäº Ïïà ÎàåÎ†ÄÏùÑ Îïå
                    page.searchMainData();
                } else {
                    page.searchMainData();
                }
            });


            $('#btnGridSetting').click(function (e) {
                let _this = this;
                let fix_cols = page.grid_config.frozenColumnIndex;
                page.popColSetting.show(gui.gui_code, gui.template_key, 'grid', page.grid_config.columns, page.grid, { 'order_fix':false,  'fix_cols' : fix_cols });
            });

            $('#btnCompanySearch').click(function () {
                let poppage = new PopCompComponent();
                let $poppage = $(poppage);
                let searchcallback = function (items) {
                    //console.log('items : ',items);
                    document.getElementById('btnCompanySearch').value = items.compname;
                    document.getElementById('cboCompanyHidden').value = items.id;
                };

                poppage.show(searchcallback);
            });

            $('#btnCompanySearch').on('input', function () {
                const val = $(this).val();
                if (val === '') {
                    $('#cboCompanyHidden').val('');
                }
            });

            //Í≥ÑÏ¢å ÌåùÏóÖ
            $('#btnAccountName').click(function () {
                let poppage = new PopAccountComponent();
                let searchcallback = function (items) {
                    //console.log('btnAccountName items : ', items);
                    document.getElementById('btnAccountName').value = items.accountName;
                    document.getElementById('cboBankId').value = items.accid;
                };
                poppage.show(searchcallback);
            });

            $('#btnAccountName').on('input', function () {
                const val = $(this).val();
                if (val === '') {
                    $('#cboBankId').val('');
                }
            });

            // .btn-clear ÌÅ¥Î¶≠ ÌõÑ input Ïù¥Î≤§Ìä∏ Í∞ïÏ†ú Î∞úÏÉù
            $(document).on('click', '.btn-clear', function () {
                const $input = $(this).siblings('input[type="text"]');
                $input.val('');
                $input.trigger('input'); // üî• input Ïù¥Î≤§Ìä∏ Í∞ïÏ†ú Î∞úÏÉù
            });
            // Ï¥àÍ∏∞Ìôî Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
            $('#btnClear').click(function () {

                document.getElementById('cboCompany').value = '';
                document.getElementById('cboCompanyHidden').value = '';
            });

        })
    </script>

</th:block>

<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
</html>