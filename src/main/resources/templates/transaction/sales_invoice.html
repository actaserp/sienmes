<html layout:decorate="~{layout_page}">
<head>
    <style>
        .wj-cell .v-center {
            position: relative;
            top: 50%;
            transform: translateY(-50%);
            white-space: pre-wrap;
        }
    </style>
</head>

<th:block layout:fragment="content">

    <div class="layout-contents">
        <div class="page-title-wrap">
            <div class="left">
                <h2>ë§¤ì¶œ ê³„ì‚°ì„œ ê´€ë¦¬</h2>
                <a title="ë¶ë§ˆí¬" class="bookmark toggle">
                    ë‚´ ë©”ë‰´
                </a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
                <li>ì…ê¸ˆ ê´€ë¦¬</li>
                <li>ë§¤ì¶œ ê³„ì‚°ì„œ ê´€ë¦¬</li>
            </ul>
        </div>

        <section class="section">
            <div class="section-top">
                <div class="search-wrap">
                    <dl>
                        <dt>
                            <label for="cboInvoice">
                                ê²€ìƒ‰ êµ¬ë¶„<span class="eq"></span>
                            </label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <select id="cboInvoice" name="cboInvoice">
                                    <option value="" selected>ì „ì²´</option>
                                    <option value="ê³¼ì„¸">ì„¸ê¸ˆê³„ì‚°ì„œ</option>
                                    <option value="ì˜ì„¸">ì˜ì„¸ìœ¨ ì„¸ê¸ˆê³„ì‚°ì„œ</option>
                                    <option value="ë©´ì„¸">ê³„ì‚°ì„œ</option>
                                </select>
                            </div>
                        </dd>
                    </dl>
                    <dl>
                        <dt>
                            <label for="btnCompanySearch">
                                ê±°ë˜ì²˜
                            </label>
                        </dt>
                        <dd>
                            <input type="text" id="btnCompanySearch" name="btnCompanySearch" placeholder="í•´ë‹¹ ì¹¸ì„ í´ë¦­í•´ì„œ ê²€ìƒ‰í•˜ì„¸ìš”.">
                            <input type="hidden" id="cboCompanyHidden">
                        </dd>
                    </dl>
                    <!--                    <dl>-->
                    <!--                        <dt>-->
                    <!--                            <label for="cboAlign">-->
                    <!--                                ì •ë ¬<span class="eq"></span>-->
                    <!--                            </label>-->
                    <!--                        </dt>-->
                    <!--                        <dd>-->
                    <!--                            <div class="srch-box">-->
                    <!--                                <select id="cboAlign" name="cboAlign">-->
                    <!--                                    <option value="createDate">ì‘ì„±ì¼ì</option>-->
                    <!--                                    <option value="issueDate">ë°œí–‰ì¼ì</option>-->
                    <!--                                </select>-->
                    <!--                            </div>-->
                    <!--                        </dd>-->
                    <!--                    </dl>-->
                    <dl>
                        <dt>
                            ì¡°íšŒê¸°ê°„<span class="eq">*</span>
                        </dt>
                        <dd>
                            <ul class="date-box">
                                <li>
                                    <input type="date" id="srchStartDt" name="srchStartDt">
                                    <label for="srchStartDt" class="hide">ì‹œì‘ì¼</label>
                                </li>
                                <li>
                                    <input type="date" id="srchEndDt" name="srchEndDt">
                                    <label for="srchEndDt" class="hide">ì¢…ë£Œì¼</label>
                                </li>
                            </ul>
                        </dd>
                    </dl>

                    <dl>
                        <dt>&nbsp;</dt>
                        <dd>
                            <li>
                                <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnSearch">
                                    <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                                    <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                    ê²€ìƒ‰
                                </a>
                            </li>
                        </dd>
                    </dl>
                </div>
                <div class="button-wrap">
                    <ul>
                        <li>
                            <a class="btn" title="ê±°ë˜ëª…ì„¸ì„œ ì¶œë ¥" id="btnPrint">
                                ê±°ë˜ëª…ì„¸ì„œ ì¶œë ¥
                            </a>
                        </li>
                        <li>
                            <a class="btn" title="ì¶œê³  ë¦¬ìŠ¤íŠ¸" id="btnShipList">
                                ì¶œê³  ë¦¬ìŠ¤íŠ¸
                            </a>
                        </li>
                        <li>
                            <a class="btn" title="ê³„ì‚°ì„œ ì¼ê´„ ë“±ë¡" id="btnAddBatch">
                                ê³„ì‚°ì„œ ì¼ê´„ ë“±ë¡
                            </a>
                        </li>
                        <li>
                            <a class="btn" title="ê³„ì‚°ì„œ ë“±ë¡" id="btnAddNew">
                                ê³„ì‚°ì„œ ë“±ë¡
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="section-top">
                <div class="search-wrap">
                    <dl>
                        <dt>
                            <label for="totalAmount">
                                ì´ í•©ê³„ê¸ˆì•¡
                            </label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <input style="text-align: right;max-width: 200px;" class="form-control2" id="totalAmount" name="totalAmount" readonly>
                            </div>
                        </dd>
                    </dl>
                    <dl>
                        <dt>
                            <label for="totalSupPrice">
                                ì´ ê³µê¸‰ê°€ì•¡
                            </label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <input style="text-align: right;max-width: 200px;" class="form-control2" id="totalSupPrice" name="totalSupPrice" readonly>
                            </div>
                        </dd>
                    </dl>
                    <dl>
                        <dt>
                            <label for="totalTax">
                                ì´ ì„¸ì•¡
                            </label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <input style="text-align: right;max-width: 200px;" class="form-control2" id="totalTax" name="totalTax" readonly>
                            </div>
                        </dd>
                    </dl>
                </div>
                <div class="button-wrap">
                    <ul>
                        <li>
                            <a class="btn btn-delete" title="ì‚­ì œ" id="btnDelete">
                                <img src="/images/icon/ico-delete.svg" alt="ì‚­ì œ ì•„ì´ì½˜">
                                ì‚­ì œ
                            </a>
                        </li>
                        <li>
                            <a class="btn btn-edit" title="ìˆ˜ì •" id="btnEdit">
                                <img src="/images/icon/ico-edit.svg" alt="ìˆ˜ì • ì•„ì´ì½˜">
                                ìˆ˜ì •
                            </a>
                        </li>
                        <li>
                            <a class="btn btn-edit" title="ìˆ˜ì •" id="btnIssue" >
                                ë°œí–‰
                            </a>
                        </li>
                        <li style="display: none;">
                            <a class="btn btn-edit" title="ìˆ˜ì •" id="btnIssueCancel">
                                ë°œí–‰ ì·¨ì†Œ
                            </a>
                        </li>
                        <li>
                            <a class="btn" title="ì—­ë°œí–‰/ì¬ì „ì†¡" id="btnReIssue">
                                ì—­ë°œí–‰/ì¬ì „ì†¡
                            </a>
                        </li>
                        <li style="display: none;">
                            <a class="btn" title="ì—­ë°œí–‰/ì¬ì „ì†¡" id="btnModifyInvoice">
                                ìˆ˜ì • ì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="container-fluid">
                <div id="theGrid" style="height: 660px;"></div>
            </div>
        </section>
    </div>
    <script type="text/x-tmpl" id="addShipListPopup">
        <div class="content_wrap popup">
            <div class="section-top">
                <div class="search-wrap" style="justify-content: flex-start;">
                  <dl>
                    <dt style="display:flex;">
                      ì¡°íšŒê¸°ê°„
                    </dt>
                    <dd>
                      <ul class="date-box">
                        <li>
                          <input type="date" id="srchStartDt" name="srchStartDt">
                          <label for="srchStartDt" class="hide">ì‹œì‘ì¼</label>
                        </li>
                        <li>
                          <input type="date" id="srchEndDt" name="srchEndDt">
                          <label for="srchEndDt" class="hide">ì¢…ë£Œì¼</label>
                        </li>
                      </ul>
                    </dd>
                  </dl>

                  <dl>
                    <dt>&nbsp;</dt>
                    <dd>
                      <li>
                        <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnSearch">
                          <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                          <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                          ê²€ìƒ‰
                        </a>
                      </li>
                    </dd>
                  </dl>
                </div>
            </div>
            <div class="container-fluid">
                <div id="ship-list-grid" style="height: 400px;"></div>
            </div>
            <div class="popup-button">
                <button type="button" class="btn-popup y_write_auth" id="btnShipAction">ê³„ì‚°ì„œ ë“±ë¡</button>
                <button type="button" class="btn-popup" id="modal-close-button">ë‹«ê¸°</button>
            </div>

        </div>
    </script>

</th:block>

<th:block layout:fragment="scripts">
    <!--<th:block th:replace="/common/columns_setting :: columns_setting"></th:block>-->
    <th:block th:replace="/common/multiform_material :: multiform_material"></th:block>
    <th:block th:replace="/common/popup_company :: popup_company"></th:block>
    <th:block th:replace="/common/popup_invoice :: popup_invoice"></th:block>
    <th:block th:replace="/common/popup_totalAmount :: popup_totalAmount"></th:block>

    <script type="text/javascript">
        class SalesInvoicePage {
            constructor() {
                this.url = '/api/tran/tran';
                this.grid = null;
                this.$btnEdit = $('#btnEdit');
                this.$btnAddNew = $('#btnAddNew');
                this.viewData = new wijmo.collections.CollectionView();
                this.init();
                this.invoiceSelector = null;
                this.shipSelector = null

            }

            init() {
                let _this = this;
                this.grid = new wijmo.grid.FlexGrid('#theGrid', {
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.All,
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    formatItem: (sender, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnFooter) {
                            const col = sender.columns[e.col];
                            if (col.binding === 'item_summary') {
                                e.cell.style.textAlign = 'center';
                            }
                        }
                    },
                    columns: [
                        {binding: 'misdate', header: 'ì‘ì„±ì¼ì', width: 110, align: 'center'},
                        {binding: 'misnum', header: 'ì‘ì„±ë²ˆí˜¸', width: 90, visible: false},
                        {binding: 'cltcd', header: 'íšŒì‚¬id', width: 90, visible: false},
                        {binding: 'ivercorpnum', header: 'ì‚¬ì—…ì ë²ˆí˜¸', width: 150, align: 'center'},
                        {binding: 'ivercorpnm', header: 'ìƒí˜¸', width: 130, align: 'left'},
                        {binding: 'item_summary', header: 'í’ˆëª…', width: 100},
                        {binding: 'totalamt', header: 'í•©ê³„ê¸ˆì•¡', width: 110, align: 'right', format: 'n0'},
                        {binding: 'supplycost', header: 'ê³µê¸‰ê°€ì•¡', width: 110, align: 'right', format: 'n0'},
                        {binding: 'taxtotal', header: 'ì„¸ì•¡', width: 110, align: 'right', format: 'n0'},
                        {binding: 'statecode', header: 'ìƒíƒœ', width: 100, align: 'center'},
                        {binding: 'taxtype', header: 'êµ¬ë¶„', width: 100, align: 'center'},
                        {binding: 'misgubun_name', header: 'ë§¤ì¶œêµ¬ë¶„', width: 100, align: 'center'},
                        {binding: 'iverceonm', header: 'ëŒ€í‘œì', width: 100, align: 'center'},
                        {binding: 'iveremail', header: 'ì´ë©”ì¼', width: 130, align: 'center'},
                        {binding: 'iveraddr', header: 'ì£¼ì†Œ', width: 150, align: 'center'},
                    ],
                    itemsSource: this.viewData, // ë°ì´í„°ë¥¼ ì„¤ì •í•  ë°°ì—´
                });

                new FlexGridContextMenu(this.grid);
                this.grid.downloadFileName = 'ë§¤ì¶œ ê³„ì‚°ì„œ ë‚´ì—­';

                // í•˜ë‹¨ í•©ê³„ í–‰ ì¶”ê°€
                this.grid.columnFooters.rows.push(new wijmo.grid.GroupRow());

                // ë°ì´í„° ë³€ê²½ ì‹œ í•©ê³„ ì—…ë°ì´íŠ¸
                this.grid.collectionView.collectionChanged.addHandler(() => {
                    _this.updateFooter();
                });
                this.invoiceSelector = new wijmo.grid.selector.Selector(this.grid, {
                    itemChecked: () => {
                        this.updateSelectedTotals();
                    }
                })

                this.grid.hostElement.addEventListener('dblclick', function (e) {
                    let items = _this.grid.selectedItems;
                    if (items.length === 0) {
                        return false;
                    }
                    _this.$btnEdit.trigger('click');
                });


                //ìˆ˜ì£¼ë“±ë¡ í´ë¦­
                this.$btnAddNew.click(function (e) {
                    let defaultData = {
                        id: '',
                        mode: 'new',
                    };
                    _this.showInvoiceForm(defaultData);
                });

                // ìˆ˜ì£¼ ìˆ˜ì • í´ë¦­
                this.$btnEdit.click(function (e) {
                    let selectedItems = _this.grid.selectedItems;

                    if (selectedItems.length === 1) {

                        let data = {
                            misdate: selectedItems[0].misdate,
                            misnum: selectedItems[0].misnum,
                            action: 'detail'
                        };
                        let fnsuccess = function (result) {
                            console.log('edit', result.data);
                            result.data['mode'] = 'edit';
                            _this.showInvoiceForm(result.data);
                        };
                        AjaxUtil.getAsyncData(_this.url + '/invoice_detail', data, fnsuccess);
                    } else if (selectedItems.length > 1) {
                        Alert.alert('', 'ë°ì´í„°ë¥¼ í•˜ë‚˜ë§Œ ì„ íƒí•˜ì„¸ìš”.');
                    } else {
                        Alert.alert('', 'ì„ íƒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    }

                });

                // ì‚­ì œ ë²„íŠ¼
                $('#btnDelete').click(function (e) {
                    const items = _this.grid.rows
                        .filter(row => row.isSelected)
                        .map(row => row.dataItem);
                    console.log('items', items);

                    if (items.length === 0) {
                        Alert.alert('', 'ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                        return;
                    }

                    Alert.confirm('', 'ì„ íƒí•œ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function () {
                        const deleteList = items.map(item => ({
                            misnum: item.misnum,
                            misdate: item.misdate.replace(/-/g, '')  // '2025-04-30' â†’ '20250430'
                        }));

                        let url = _this.url + '/invoice_delete';
                        AjaxUtil.postJsonData(url, deleteList, function (res) {
                            if (res.success) {
                                Alert.alert('', 'ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', function () {
                                    _this.searchMainData();
                                });
                            } else {
                                Alert.alert('', 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                            }
                        });
                    });

                });
            }

            updateSelectedTotals() {
                const selectedItems = this.grid.rows
                    .filter(row => row.isSelected)
                    .map(row => row.dataItem);
                let _this = this;
                let totalAmt = 0, totalSupply = 0, totalTax = 0;

                selectedItems.forEach(item => {
                    totalAmt += item.totalamt || 0;
                    totalSupply += item.supplycost || 0;
                    totalTax += item.taxtotal || 0;
                });

                const formatNumber = (n) => n.toLocaleString('ko-KR');
                $('#totalAmount').val(formatNumber(totalAmt));
                $('#totalSupPrice').val(formatNumber(totalSupply));
                $('#totalTax').val(formatNumber(totalTax));
            }


            // í•˜ë‹¨ í•©ê³„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            updateFooter() {
                let totalamtSum = 0;
                let supplycostSum = 0;
                let taxtotalSum = 0;

                // grid í•©ê³„ ê³„ì‚°
                if (this.grid && this.grid.collectionView) {
                    this.grid.collectionView.items.forEach(item => {
                        totalamtSum += item.totalamt || 0; // undefinedì¼ ê²½ìš° 0 ì²˜ë¦¬
                        supplycostSum += item.supplycost || 0; // undefinedì¼ ê²½ìš° 0 ì²˜ë¦¬
                        taxtotalSum += item.taxtotal || 0; // undefinedì¼ ê²½ìš° 0 ì²˜ë¦¬
                    });

                    // columnFootersì˜ ì²« ë²ˆì§¸ í–‰ì„ ê°€ì ¸ì™€ í•©ê³„ ì—…ë°ì´íŠ¸
                    let footerRow = this.grid.columnFooters.rows[0];

                    this.grid.columnFooters.setCellData(footerRow.index, 'item_summary', 'í•©ê³„');
                    this.grid.columnFooters.setCellData(footerRow.index, 'totalamt', totalamtSum);
                    this.grid.columnFooters.setCellData(footerRow.index, 'supplycost', supplycostSum);
                    this.grid.columnFooters.setCellData(footerRow.index, 'taxtotal', taxtotalSum);
                }

            }

            // ê³„ì‚°ì„œ ë“±ë¡ íŒì—…
            showInvoiceForm(data) {
                let _this = this;
                let content = tmpl('popup_invoiceTemplate', data);
                let $content = $(content);

                let modalContainer = null;
                let $taxForm = $content.find('#taxForm');
                // ë§¤ì¶œ êµ¬ë¶„
                let $saleType = $content.find('#sale_type');
                AjaxUtil.fillSelectOptions($saleType, 'system_code', 'choose', false, 'sale_type');

                if (data.mode === 'new') {
                    modalContainer = new PopupDraggable('ë“±ë¡');

                    let purposeType = AjaxUtil.getSyncData('/api/definition/code/getvalue', { code: 'PurposeType' });

                    if (purposeType.data.Value === 'ì˜ìˆ˜') {
                        $content.find('#PurposeType1').prop('checked', true);
                    } else if (purposeType.data.Value === 'ì²­êµ¬') {
                        $content.find('#PurposeType2').prop('checked', true);
                    } else if (purposeType.data.Value === 'ì—†ìŒ') {
                        $content.find('#PurposeType3').prop('checked', true);
                    }

                    // ê³µê¸‰ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
                    let data1 = {
                        spjangcd: 'ZZ',
                    };
                    let url = _this.url + '/invoicer_read';
                    let fnSaveSuccess = function (result) {
                        if (result.success) {
                            $content.find('#InvoicerCorpNum').val(result.data.saupnum).trigger('input');
                            // $content.find('#InvoicerTaxRegID').val(result.data);
                            $content.find('#InvoicerCorpName').val(result.data.spjangnm);
                            $content.find('#InvoicerCEOName').val(result.data.prenm);
                            $content.find('#InvoicerAddr').val(result.data.address);
                            $content.find('#InvoicerBizType').val(result.data.biztype);
                            $content.find('#InvoicerBizClass').val(result.data.item);
                            $content.find('#InvoicerContactName').val(result.data.agnertel1);
                            $content.find('#InvoicerTEL').val(result.data.agnertel2).trigger('input');
                            $content.find('#InvoicerEmail').val(result.data.emailadres);

                        }
                    };
                    AjaxUtil.getAsyncData(url, data1, fnSaveSuccess);

                } else {
                    modalContainer = new PopupDraggable('ìˆ˜ì •');
                    setTimeout(() => {
                        FormUtil.BindInvoiceDataForm(data, $content.find('#taxForm'));
                        $content.find('#InvoiceeCorpNum').prop('readonly', true);
                        $content.find('#writeDate')
                            .prop('readonly', true)
                            .css('background-color', '#EDEFF5');
                        $content.find('#btnInvoiceSave span').text('ìˆ˜ì •');
                    }, 0);

                }
                modalContainer.open({width: 1200, height: 680, $content});
                initializeDetailRows();


                let oldBusinessNumber = null;
                // ì„ íƒ ë²„íŠ¼(ê±°ë˜ì²˜ ì¡°íšŒ)
                $content.find('#btnSelectInvoicee').click(function () {
                    let poppage = new PopCompComponent();

                    let searchcallback = function (items) {
                        $content.find('#InvoiceeID').val(items.id).trigger('change');
                        $content.find('#InvoiceeCorpNum').val(items.business_number).trigger('input');
                        $content.find('#InvoiceeTaxRegID').val(items.invoiceetaxregid);
                        $content.find('#InvoiceeCorpName').val(items.compname);
                        $content.find('#InvoiceeCEOName').val(items.invoiceeceoname);
                        $content.find('#InvoiceeAddr').val(items.invoiceeaddr);
                        $content.find('#InvoiceeBizType').val(items.invoiceebiztype);
                        $content.find('#InvoiceeBizClass').val(items.invoiceebizclass);
                        $content.find('#InvoiceeContactName1').val(items.invoiceecontactname1);
                        $content.find('#InvoiceeTEL1').val(items.invoiceetel1).trigger('input');
                        $content.find('#InvoiceeEmail1').val(items.invoiceeemail1);
                        oldBusinessNumber = items.business_number;


                    };

                    poppage.show(searchcallback);
                });

                // ì €ì¥ë²„íŠ¼
                let $saveInvoicer = $content.find('#saveInvoicer');

                $saveInvoicer.click(function (e) {

                    //ìˆ˜ì£¼ì¼, ë‚©ê¸°ì¼ ì²´í¬?
                    let data = FormUtil.extractForm($taxForm);
                    console.log('$taxForm', data);

                    let id = data.InvoiceeID;
                    let newBusinessNumber = data.InvoiceeCorpNum;


                    if (id && oldBusinessNumber && oldBusinessNumber !== newBusinessNumber) {
                        Alert.confirm('', 'ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.\nìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì·¨ì†Œí•˜ë©´ ìƒˆë¡œ ë“±ë¡í•©ë‹ˆë‹¤.',
                            function () {
                                // í™•ì¸(ìˆ˜ì • ì„ íƒ)
                                let url = _this.url + '/invoicee_save';
                                let fnSaveSuccess = function (result) {
                                    if (result.success) {
                                        Alert.alert('', 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                                        _this.searchMainData();
                                    } else {
                                        Alert.alert('', result.message);
                                    }
                                };
                                AjaxUtil.postAsyncData(url, data, fnSaveSuccess);
                            },
                            function () {
                                // ì·¨ì†Œ(ì‹ ê·œ ì„ íƒ)
                                data.InvoiceeID = '';
                                let url = _this.url + '/invoicee_save';
                                let fnSaveSuccess = function (result) {
                                    if (result.success) {
                                        Alert.alert('', 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                                        $content.find('#InvoiceeID').val(result.data.id);
                                    } else {
                                        Alert.alert('', result.message);
                                    }
                                };
                                AjaxUtil.postAsyncData(url, data, fnSaveSuccess);
                            }
                        );
                    } else {
                        // id ì—†ê±°ë‚˜ ì‚¬ì—…ìë²ˆí˜¸ ë³€ê²½ ì•ˆëœ ê²½ìš° ê·¸ëƒ¥ ì €ì¥
                        let url = _this.url + '/invoicee_save';
                        let fnSaveSuccess = function (result) {
                            if (result.success) {
                                Notify.success("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                            } else {
                                Notify.error(result.message || "ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                            }
                        };
                        AjaxUtil.postAsyncData(url, data, fnSaveSuccess);
                    }

                });

                // ì‘ì„±ì¼ì
                let $writeDate = $content.find('#writeDate');
                let today = CommonUtil.getYYYYMMDD();
                $writeDate.val(today);

                // í’ˆëª© ì¶”ê°€ ë²„íŠ¼
                $(document).on('click', 'a[id^="btnViewItem_"]', function (e) {
                    e.preventDefault();


                    const $btn = $(this);
                    const $row = $btn.closest('tr'); // ë²„íŠ¼ì´ ì†í•œ tr

                    const pop = new PopMatComponent();
                    pop.material_type = 'product,sangpum';

                    pop.show(function (item) {

                        $row.find('input[id$=".ItemId"]').val(item.id || '');
                        $row.find('textarea[id$=".ItemName"]').val(item.Name || '');
                        $row.find('textarea[id$=".Spec"]').val(item.Spec || '');

                        // checkAndTryShowPrice($row);

                    });

                    pop.searchDataBind();
                });

                // "í•©ê³„ê¸ˆì•¡" ë¼ë””ì˜¤ ë²„íŠ¼ í´ë¦­
                $content.find('#WriteType4').click(function (event) {
                    event.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë§‰ê¸°
                    openPopup();
                });

                // "ê³„ì‚°" ë²„íŠ¼ í´ë¦­
                $content.find('#totalAmountAct').click(function (event) {
                    event.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë§‰ê¸°
                    openPopup();
                });

                function openPopup() {
                    let poppage = new PopTotalAmountComponent();

                    let searchcallback = function (items) {
                        console.log('totalAmountAct', items);
                        let index = 0;
                        while (true) {
                            let $supplyCost = $content.find('#detailList' + index + '\\.SupplyCost');
                            let $tax = $content.find('#detailList' + index + '\\.Tax');

                            // ì—†ìœ¼ë©´ ë°˜ë³µ ì¢…ë£Œ
                            if ($supplyCost.length === 0 || $tax.length === 0) {
                                break;
                            }

                            // ë¹„ì–´ìˆëŠ” í–‰ ì°¾ê¸°
                            if ($supplyCost.val().trim() === '' && $tax.val().trim() === '') {
                                $supplyCost.val(items.supplyCost.toLocaleString());
                                $tax.val(items.tax.toLocaleString());
                                break; // ì…ë ¥í–ˆìœ¼ë©´ ë©ˆì¶˜ë‹¤
                            }

                            index++;
                        }

                    };

                    poppage.show(searchcallback);
                }

                // ê³„ì‚°ì„œ ì €ì¥ ë²„íŠ¼
                let $btnInvoiceSave = $content.find('#btnInvoiceSave');

                $btnInvoiceSave.click(function (e) {
                    let data = FormUtil.extractForm($taxForm);

                    for (let i = 0; i < 20; i++) {
                        let month = data[`detailList[${i}].PurchaseDT1`];
                        let day = data[`detailList[${i}].PurchaseDT2`];

                        if (month && day) {
                            // ë‘ ê°’ ëª¨ë‘ ìˆì„ ë•Œë§Œ ì²˜ë¦¬
                            const paddedMonth = month.padStart(2, '0');
                            const paddedDay = day.padStart(2, '0');
                            data[`detailList[${i}].PurchaseDT`] = `${paddedMonth}${paddedDay}`;
                        }

                        // ì›ë˜ í•„ë“œëŠ” ì œê±° (ì„œë²„ì— ì•ˆ ë³´ë‚´ë„ ë˜ê²Œ)
                        delete data[`detailList[${i}].PurchaseDT1`];
                        delete data[`detailList[${i}].PurchaseDT2`];
                    }

                    console.log('taxForm', data);

                    Alert.confirm('', 'ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function () {
                        let url = _this.url + '/invoice_save';

                        let fnSaveSuccess = function (result) {
                            Notify.success("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                            modalContainer.close();
                        };

                        AjaxUtil.postJsonAsyncData(url, data, fnSaveSuccess);
                    });

                });

                // let data = FormUtil.extractForm($taxForm);

                // $content.find('#InvoiceeID').change(function () {
                //     $content.find('tr[id^="item_"]').each(function () {
                //         checkAndTryShowPrice($(this));
                //     });
                // });

                // ë‹¨ê°€ ê°€ì ¸ì˜¤ê¸°
                // function checkAndTryShowPrice($row) {
                //     const $Material_id = $row.find('input[id$=".ItemId"]');
                //     const $InvoiceeID = $content.find('#InvoiceeID'); // ê±°ë˜ì²˜ id
                //     const today = new Date().getFullYear().toString();
                //     const month = $row.find('input[id$=".PurchaseDT1"]').val();
                //     const day = $row.find('input[id$=".PurchaseDT2"]').val();
                //
                //     const monthStr = month ? month.padStart(2, '0') : '01';
                //     const dayStr = day ? day.padStart(2, '0') : '01';
                //     const JumunDate = `${today}-${monthStr}-${dayStr}`;
                //
                //     if ($Material_id.val() && $InvoiceeID.val() && JumunDate) {
                //         tryShowPrice($Material_id.val(), $InvoiceeID.val(), $row, JumunDate);
                //     }
                // }

                // $(document).on('change', 'input[id$=".PurchaseDT1"], input[id$=".PurchaseDT2"]', function () {
                //     const $row = $(this).closest('tr');
                //     checkAndTryShowPrice($row);
                // });

                // function tryShowPrice(mat_pk, company_id, row, JumunDate) {
                //     let url = '/api/sales/suju/readPriceSuju';
                //     let data = {
                //         'mat_pk': mat_pk,
                //         'company_id': company_id,
                //         'JumunDate': JumunDate
                //     };
                //
                //     if (mat_pk && company_id && JumunDate) {
                //         let fnsuccess = function (result) {
                //             console.log('ë‹¨ê°€ ê²°ê³¼', result);
                //             if (result && result.data && result.data.length > 0) {
                //                 let unitPrice = parseFloat(result.data[0].UnitPrice);
                //                 row.find('input[id$=".UnitCost"]').val(unitPrice.toLocaleString());
                //             } else {
                //                 row.find('input[id$=".UnitCost"]').val('');
                //             }
                //         };
                //
                //         AjaxUtil.getAsyncData(url, data, fnsuccess);
                //     }
                // }

            }


            deleteSujuData(id, state, ShipmentStateName) {
                let _this = this;
                let url = _this.url + '/delete';
                let data = {'id': id, 'State': state, 'ShipmentStateName': ShipmentStateName}
                let fnsuccess = function (res) {
                    if (res.success) {
                        Notify.success('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        _this.searchMainData();
                    } else {
                        Alert.alert('', res.message);
                    }
                };

                AjaxUtil.postAsyncData(url, data, fnsuccess);
            }

            // ê³„ì‚°ì„œ ê°€ì ¸ì˜¤ê¸°
            searchMainData() {
                let _this = this;
                let invoice_kind = $('#cboInvoice').val();
                let cboCompany = $('#cboCompanyHidden').val();
                let start = $('#srchStartDt').val();
                let end = $('#srchEndDt').val();
                let url = this.url + '/read';

                let data = {
                    'invoice_kind': invoice_kind,
                    'cboCompany': cboCompany,
                    'start': start,
                    'end': end,
                    'action': 'read'
                };


                let fnsuccess = function (result) {
                    if (result != null) {
                        _this.grid.itemsSource = result.data;
                        _this.updateFooter();
                    }
                };
                AjaxUtil.getAsyncData(url, data, fnsuccess);
            }

            showShipListPopup() {
                let _this = this;

                let content = tmpl('addShipListPopup', {});
                let $content = $(content);
                let modalContainer = new PopupDraggable('ì¶œê³  ë¦¬ìŠ¤íŠ¸');
                modalContainer.open({width: 1300, height: 670, $content});

                this.shipListGrid = new wijmo.grid.FlexGrid('#ship-list-grid', {
                    autoGenerateColumns: false,
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.All,
                    allowMerging: 'ColumnHeaders',
                    formatItem: (s, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.Cell) {
                            e.cell.style.color = '';
                            e.cell.style.textAlign = '';
                        }
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';

                            const binding = s.columns[e.col].binding;

                            if (binding === 'StoreHouse_id' || binding === 'inputQty' || binding === 'Description2') {
                                e.cell.style.color = '#5567ff'; // ê¸€ì ìƒ‰ ì ìš©
                            }
                        }
                    },
                    columns: [
                        {
                            binding: 'company_name',
                            header: 'ê±°ë˜ì²˜',
                            width: 100,
                            align: 'left',
                            isReadOnly: true,
                            allowMerging: true
                        },
                        {
                            binding: 'ship_date',
                            header: 'ì¶œí•˜ì¼',
                            width: 120,
                            align: 'center',
                            isReadOnly: true,
                            allowMerging: true
                        },
                        {
                            binding: 'total_qty',
                            header: 'ì´ ì§€ì‹œëŸ‰',
                            width: 120,
                            align: 'center',
                            isReadOnly: true,
                            allowMerging: true
                        },
                        {
                            binding: 'total_price',
                            header: 'ì´ ê³µê¸‰ê°€',
                            width: 150,
                            align: 'right',
                            isReadOnly: true,
                            allowMerging: true
                        },
                        {
                            binding: 'total_vat',
                            header: 'ì´ ì„¸ì•¡',
                            width: 150,
                            align: 'right',
                            isReadOnly: true,
                            allowMerging: true
                        },
                        {
                            binding: 'total_amount',
                            header: 'ì´ì•¡',
                            width: 150,
                            align: 'right',
                            isReadOnly: true,
                            allowMerging: true
                        },
                        {
                            binding: 'state_name',
                            header: 'ìƒíƒœ',
                            width: 60,
                            align: 'center',
                            isReadOnly: true,
                            allowMerging: true
                        },
                        {binding: 'issue_yn', header: 'ë°œí–‰ ì—¬ë¶€', width: 80, align: 'right', isReadOnly: true},
                        {binding: 'issue_date', header: 'ë°œí–‰ ì¼ì', width: 90, align: 'right', isReadOnly: true},
                        {
                            binding: 'description',
                            header: 'ë¹„ê³ ',
                            width: 90,
                            align: 'right',
                            isReadOnly: true,
                            allowMerging: true
                        },
                    ],
                    itemsSource: new wijmo.collections.CollectionView([]),
                });

                new FlexGridContextMenu(this.shipListGrid);
                this.shipListGrid.downloadFileName = 'ì¶œê³  ë¦¬ìŠ¤íŠ¸';

                let extraRow = new wijmo.grid.Row();
                extraRow.allowMerging = true;

                let panel = this.shipListGrid.columnHeaders;
                panel.rows.splice(0, 0, extraRow)

                for (let colIndex = 7; colIndex <= 8; colIndex++) {
                    panel.setCellData(0, colIndex, 'ê±°ë˜ëª…ì„¸ì„œ');
                }

                ['company_name', 'ship_date', 'total_qty', 'total_price', 'total_vat'
                    , 'total_amount', 'state_name', 'description'].forEach((binding) => {
                    let col = this.shipListGrid.getColumn(binding);
                    col.allowMerging = true;
                    panel.setCellData(0, col.index, col.header);
                });

                this.shipListGrid.formatItem.addHandler(function (s, e) {
                    if (e.panel == s.columnHeaders && e.range.rowSpan > 1) {
                        var html = e.cell.innerHTML;
                        e.cell.innerHTML = '<div class="v-center">' + html + '</div>';
                    }
                });

                $content.find('#btnSearch').on('click', function () {
                    fnLoadShipList();
                });

                let start = $content.find('#srchStartDt');
                let end = $content.find('#srchEndDt');

                start.val(CommonUtil.getYYYYMMDD(-7));
                end.val(CommonUtil.getYYYYMMDD());

                let fnLoadShipList = function () {
                    let fnsuccess = function (result) {
                        if (result.data !== null) {
                            _this.shipListGrid.itemsSource = new wijmo.collections.CollectionView(result.data);
                            _this.shipSelector = new wijmo.grid.selector.Selector(_this.shipListGrid);

                        }
                    };
                    let shipParam = {
                        'srchStartDt': start.val(),
                        'srchEndDt': end.val(),
                    };

                    console.log('shipParam', shipParam);
                    AjaxUtil.getAsyncData(_this.url + '/shipment_head_list', shipParam, fnsuccess);

                };

                fnLoadShipList();

                $content.find('#btnShipAction').on('click', function () {

                    let url = _this.url + '/save_balju';
                    let items = _this.shipListGrid.rows
                        .filter(row => row.isSelected)
                        .map(row => row.dataItem);

                    console.log(items);

                    if (!items || items.length === 0) {
                        Alert.alert('', 'ì €ì¥í•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.');
                        return;
                    }

                    let fnSuccess = function (res) {
                        if (!res.success) {
                            Alert.alert('', res.message);
                        } else {
                            Notify.success('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
                            // page.searchDataBind();
                            modalContainer.modal.close();
                        }
                    };

                    AjaxUtil.postJsonAsyncData(url, items, fnSuccess);
                });

            }

        }

        let page = null;

        $(document).ready(function (e) {

            page = new SalesInvoicePage();


            $('#srchStartDt').val(CommonUtil.getYYYYMMDD(-7));
            $('#srchEndDt').val(CommonUtil.getYYYYMMDD());

            page.searchMainData();

            // ê²€ìƒ‰
            $('#btnSearch').click(function (e) {
                page.searchMainData();
            });

            $('#btnShipList').on('click', function () {
                page.showShipListPopup();
            });

            $('#btnCompanySearch').click(function () {
                let poppage = new PopCompComponent();
                let $poppage = $(poppage);
                let searchcallback = function (items) {
                    //console.log('items : ',items);
                    document.getElementById('btnCompanySearch').value = items.compname;
                    document.getElementById('cboCompanyHidden').value = items.id;

                    // ìˆ˜ë™ìœ¼ë¡œ input ì´ë²¤íŠ¸ ë°œìƒ
                    $('#btnCompanySearch').trigger('input');
                };

                poppage.show(searchcallback);
            });

            // input ê°ì§€ â†’ x ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€, íˆë“ ê°’ í´ë¦¬ì–´
            $(document).on('input', '#btnCompanySearch', function () {
                let $clearBtn = $(this).closest('.input-clear').find('.btn-clear');
                let value = $(this).val().trim();

                if (value) {
                    $clearBtn.show();
                } else {
                    console.log('[DEBUG] cleared');
                    $clearBtn.hide();
                    $('#cboCompanyHidden').val('');
                }
            });

            // x ë²„íŠ¼ í´ë¦­ â†’ í…ìŠ¤íŠ¸ ì´ˆê¸°í™” ë° input ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°
            $(document).on('click', '.btn-clear', function () {
                const $input = $(this).siblings('input[type="text"]');
                $input.val('').trigger('input'); // ğŸ”¥ input ì´ë²¤íŠ¸ ê°•ì œ ë°œìƒ
            });


        })
    </script>

</th:block>
<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
</html>