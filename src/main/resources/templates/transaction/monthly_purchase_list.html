<html layout:decorate="~{layout_page}">
<th:block layout:fragment="content">
    <div class="layout-contents">
        <div class="page-title-wrap">
            <div class="left">
                <h2>ÏõîÎ≥Ñ Îß§ÏûÖ ÌòÑÌô©</h2>
                <a title="Î∂ÅÎßàÌÅ¨" class="bookmark toggle">
                    ÎÇ¥ Î©îÎâ¥
                </a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="ÌôàÏïÑÏù¥ÏΩò"></li>
                <li>ÏûÖÍ∏àÍ¥ÄÎ¶¨</li>
                <li>ÏõîÎ≥Ñ Îß§ÏûÖ ÌòÑÌô©</li>
            </ul>
        </div>

        <section class="section">
            <div class="section-top">
                <div class="search-wrap">
                    <dl>
                        <dt>
                            <label>
                                Ïó∞ÎèÑ
                            </label>
                        </dt>
                        <dd>
                            <select class="" id="cboYear" name="cboYear" >
                            </select>
                        </dd>
                    </dl>
                    <dl id="searchComArea">
                        <dt>
                            Í±∞ÎûòÏ≤ò
                        </dt>
                        <dd>
                            <input type="text" id="cboCompany" name="cboCompany" placeholder="ÏóÖÏ≤¥Í≤ÄÏÉâÎ≤ÑÌäºÏúºÎ°ú Í≤ÄÏÉâÌïòÏÑ∏Ïöî.">
                            <input type="hidden" id="cboCompanyHidden">
                            &nbsp;
                            <a class="btn btn-delete" title="Í≤ÄÏÉâ" id="btnCompanySearch">
                                <img src="/images/icon/btn-srch.svg" alt="Í≤ÄÏÉâ ÏïÑÏù¥ÏΩò">
                                ÏóÖÏ≤¥ Í≤ÄÏÉâ
                            </a>
                        </dd>
                    </dl>
                    <dl>
                        <dt>&nbsp;</dt>
                        <dd>
                            <li>
                                <a class="btn btn-delete" title="Í≤ÄÏÉâ" id="btnSearch">
                                    <!--                                        class Ïì∞Ïù¥Îäî Í≥≥ Ï∞æÍ≥† ÏóÜÏúºÎ©¥ ÌÅ¥ÎûòÏä§Î™Ö ÏàòÏ†ïÌïòÍ∏∞-->
                                    <img src="/images/icon/btn-srch.svg" alt="Í≤ÄÏÉâ ÏïÑÏù¥ÏΩò">
                                    Í≤ÄÏÉâ
                                </a>
                            </li>
                        </dd>
                    </dl>
                </div>
            </div>
            <div class="tab-wrap">
                <ul class="tab-links">
                    <li><a href="#tabs_sales" style="border-radius: 6px 0 0 0;">Îß§ÏûÖ</a></li>
                    <li><a href="#tabs_deposit">ÏßÄÍ∏â</a></li>
                    <li><a href="#tabs_accounts_receivable" style="border-radius: 0 6px 0 0;">ÎØ∏ÏßÄÍ∏â</a></li>
                </ul>
                <div>
                    <section class="tab-item" id="tabs_sales" style="border-top-left-radius: 0;">
                        <div class="container-fluid">
                            <div id="theGrid" style="height: 730px;"></div>
                        </div>
                    </section>
                    <section class="tab-item" id="tabs_deposit" style="border-top-left-radius: 0;">
                        <div class="container-fluid">
                            <div id="deposit-grid" style="height: 730px;"></div>
                        </div>
                    </section>
                    <section class="tab-item" id="tabs_accounts_receivable" style="border-top-left-radius: 0;">
                        <div class="container-fluid">
                            <div id="accounts_receivable-grid" style="height: 730px;"></div>
                        </div>
                    </section>

                </div>
            </div>
        </section>
    </div>
</th:block>

<th:block layout:fragment="scripts">
    <!--<th:block th:replace="/common/columns_setting :: columns_setting"></th:block>-->
    <th:block th:replace="/common/multiform_material :: multiform_material"></th:block>
    <th:block th:replace="/common/popup_company :: popup_company"></th:block>
    <script type="text/javascript">
        class MonthlySalesListPage {
            constructor() {
                this.grid = null;
                this.grid3 = null;
                this.grid4= null;
                this.$btnEdit = $('#btnEdit');
                this.$btnAddNew = $('#btnAddNew');
                this.viewData = new wijmo.collections.CollectionView();
                this.init();
            }

            init() {
                let _this = this;
                const monthColumns = Array.from({ length: 12 }, (_, i) => {
                    const month = i + 1;
                    return {
                        binding: `mon_${month}`,
                        header: `${month}Ïõî`,
                        width: 80,
                        align: 'right',
                        allowSorting: false,
                        format: 'n0',
                    };
                });

                this.grid = new wijmo.grid.FlexGrid('#theGrid', {
                    frozenColumns: 4,
                    frozenRows: 0,
                    allowSorting: wijmo.grid.AllowSorting.MultiColumn,
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    allowMerging: wijmo.grid.AllowMerging.Cells,
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    formatItem: (sender, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                    },
                    columns: [
                        { binding: 'Name', header: 'Í±∞ÎûòÏ≤òÎ™Ö', width: 170, align: 'center', allowMerging: true },
                        { binding: 'misgubun', header: 'Íµ¨Î∂Ñ', width: 70, align: 'center', allowMerging: true },
                        { binding: 'icerdeptnm', header: 'Î∂ÄÏÑú', width: 130, align: 'left', allowMerging: true },
                        { binding: 'icerpernm', header: 'Îã¥ÎãπÏûê', width: 100, align: 'center', allowSorting: false },
                        ...monthColumns,  // ‚úÖ Ïó¨Í∏∞ÏóêÏÑú ÏõîÎ≥Ñ Ïª¨ÎüºÏùÑ ÏÇΩÏûÖ
                        { binding: 'total', header: 'Ìï©Í≥Ñ', width: 200, align: 'center', allowSorting: false }
                    ],
                    itemsSource: this.viewData,
                });
                this.grid.rowHeaders.columns.splice(0, 1);
                this.grid.itemFormatter = function (panel, row, col, cell) {
                    if (panel.cellType === wijmo.grid.CellType.Cell) {
                        const colName = panel.columns[col].binding;
                        const item = panel.rows[row].dataItem;

                        //Î™®Îì† ÏÖÄ Í≥µÌÜµ Ï¥àÍ∏∞Ìôî (Í∏∞Ï°¥ Ïä§ÌÉÄÏùº Ï†úÍ±∞)
                        cell.style.backgroundColor = '';
                        cell.style.color = '';
                        cell.style.fontWeight = '';
                        cell.style.textAlign = '';
                        cell.style.verticalAlign = '';
                        cell.style.display = '';
                        cell.style.alignItems = '';
                        cell.style.justifyContent = '';

                        //'Ï†ÑÏ≤¥' ÏóÖÏ≤¥Î™ÖÏù∏ ÏÖÄÎßå Ïä§ÌÉÄÏùº Ï†ÅÏö©
                        if (
                            colName === 'company_name' &&
                            typeof item?.[colName] === 'string' &&
                            item[colName].trim() === 'Ï†ÑÏ≤¥'
                        ) {
                            cell.style.backgroundColor = '#f0f9ff';
                            cell.style.color = '#007acc';
                            cell.style.fontWeight = 'bold';
                        }

                        //Ï§ëÏïô Ï†ïÎ†¨ Ïª¨Îüº
                        if (['mat_grp_name', 'mat_code', 'mat_name', 'unit_name'].includes(colName)) {
                            cell.style.textAlign = 'center';
                            cell.style.verticalAlign = 'middle';
                            cell.style.display = 'flex';
                            cell.style.alignItems = 'center';
                            cell.style.justifyContent = 'center';
                        }
                    }
                };
                new FlexGridContextMenu(this.grid);
                this.grid.downloadFileName = 'Î∞úÏ£º ÎÇ¥Ïó≠';


                this.grid3 = new wijmo.grid.FlexGrid('#deposit-grid', {
                    frozenColumns: 4,
                    frozenRows: 0,
                    allowSorting: wijmo.grid.AllowSorting.MultiColumn,
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    allowMerging: wijmo.grid.AllowMerging.Cells,
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    formatItem: (sender, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                    },
                    columns: [
                        { binding: 'Name', header: 'Í±∞ÎûòÏ≤òÎ™Ö', width: 170, align: 'center', allowMerging: true },
                        { binding: 'mat_code', header: 'Íµ¨Î∂Ñ', width: 70, align: 'center', allowMerging: true },
                        { binding: 'mat_name', header: 'Î∂ÄÏÑú', width: 130, align: 'left', allowMerging: true },
                        { binding: 'unit_name', header: 'Îã¥ÎãπÏûê', width: 100, align: 'center', allowSorting: false },
                        ...monthColumns,
                        { binding: 'total', header: 'Ìï©Í≥Ñ', width: 200, align: 'center', allowSorting: false },
                    ],
                    itemsSource: this.viewData,
                });

                this.grid3.rowHeaders.columns.splice(0, 1);

                this.grid3.itemFormatter = function (panel, row, col, cell) {
                    if (panel.cellType === wijmo.grid.CellType.Cell) {
                        const colName = panel.columns[col].binding;
                        const item = panel.rows[row].dataItem;

                        // Ï¥àÍ∏∞Ìôî
                        cell.style.backgroundColor = '';
                        cell.style.color = '';
                        cell.style.fontWeight = '';
                        cell.style.textAlign = '';
                        cell.style.verticalAlign = '';
                        cell.style.display = '';
                        cell.style.alignItems = '';
                        cell.style.justifyContent = '';

                        if (colName === 'company_name' && item?.[colName]?.trim() === 'Ï†ÑÏ≤¥') {
                            cell.style.backgroundColor = '#f0f9ff';
                            cell.style.color = '#007acc';
                            cell.style.fontWeight = 'bold';
                        }

                        if (['mat_grp_name', 'mat_code', 'mat_name', 'unit_name'].includes(colName)) {
                            cell.style.textAlign = 'center';
                            cell.style.verticalAlign = 'middle';
                            cell.style.display = 'flex';
                            cell.style.alignItems = 'center';
                            cell.style.justifyContent = 'center';
                        }
                    }
                };

                new FlexGridContextMenu(this.grid3);
                this.grid3.downloadFileName = 'ÏûÖÍ∏à ÎÇ¥Ïó≠';


                this.grid4 = new wijmo.grid.FlexGrid('#accounts_receivable-grid', {
                    frozenColumns: 4,
                    frozenRows: 0,
                    allowSorting: wijmo.grid.AllowSorting.MultiColumn,
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    allowMerging: wijmo.grid.AllowMerging.Cells,
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    formatItem: (sender, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                    },
                    columns: [
                        { binding: 'mat_grp_name', header: 'Í±∞ÎûòÏ≤òÎ™Ö', width: 170, align: 'center', allowMerging: true },
                        { binding: 'mat_code', header: 'Íµ¨Î∂Ñ', width: 70, align: 'center', allowMerging: true },
                        { binding: 'mat_name', header: 'Î∂ÄÏÑú', width: 130, align: 'left', allowMerging: true },
                        { binding: 'unit_name', header: 'Îã¥ÎãπÏûê', width: 100, align: 'center', allowSorting: false },
                        ...monthColumns,
                        { binding: 'total', header: 'Ìï©Í≥Ñ', width: 200, align: 'center', allowSorting: false }
                    ],
                    itemsSource: this.viewData,
                });

                this.grid4.rowHeaders.columns.splice(0, 1);

                this.grid4.itemFormatter = function (panel, row, col, cell) {
                    if (panel.cellType === wijmo.grid.CellType.Cell) {
                        const colName = panel.columns[col].binding;
                        const item = panel.rows[row].dataItem;

                        // Ï¥àÍ∏∞Ìôî
                        cell.style.backgroundColor = '';
                        cell.style.color = '';
                        cell.style.fontWeight = '';
                        cell.style.textAlign = '';
                        cell.style.verticalAlign = '';
                        cell.style.display = '';
                        cell.style.alignItems = '';
                        cell.style.justifyContent = '';

                        if (colName === 'company_name' && item?.[colName]?.trim() === 'Ï†ÑÏ≤¥') {
                            cell.style.backgroundColor = '#f0f9ff';
                            cell.style.color = '#007acc';
                            cell.style.fontWeight = 'bold';
                        }

                        if (['mat_grp_name', 'mat_code', 'mat_name', 'unit_name'].includes(colName)) {
                            cell.style.textAlign = 'center';
                            cell.style.verticalAlign = 'middle';
                            cell.style.display = 'flex';
                            cell.style.alignItems = 'center';
                            cell.style.justifyContent = 'center';
                        }
                    }
                };
                new FlexGridContextMenu(this.grid4);
                this.grid4.downloadFileName = 'ÎØ∏ÏàòÍ∏à ÎÇ¥Ïó≠';
            }

            searchMainData() {
                let _this = this;
                let url = '/api/transaction/monthly_purchase_list/read'
                let data = {
                    'cboYear': $("#cboYear").val(),
                    'cboCompany': $("#cboCompanyHidden").val()
                }
                let fnsuccess = function (result) {
                    if (result != null) {
                        _this.viewData.sourceCollection = result.data;
                    }
                };
                AjaxUtil.getAsyncData(url, data, fnsuccess);
            }
        }
        let page = null;

        $(document).ready(function (e) {

            page = new MonthlySalesListPage();

            AjaxUtil.fillSelectOptions($('#cboCompany'), 'company', 'all', '', 'sale');
            AjaxUtil.fillSelectOptions($('#cboYear'), 'data_year', '', false);

            $('#srchStartDt').val(CommonUtil.getYYYYMMDD(-7));
            $('#srchEndDt').val(CommonUtil.getYYYYMMDD());

            page.searchMainData();

            // Í≤ÄÏÉâ
            $('#btnSearch').click(function (e) {
                if ($('#cboCompanyHidden').val() === '' && $('#cboCompany').val() !== '') {
                    Alert.alert('', 'ÏóÖÏ≤¥Î™ÖÏùÄ ÏóÖÏ≤¥Í≤ÄÏÉâ Î≤ÑÌäºÏùÑ ÌÜµÌï¥ÏÑú \n Í≤ÄÏÉâÌï¥Ï£ºÏÑ∏Ïöî');
                    return;
                }
                page.searchMainData();
            });

            $('#btnGridSetting').click(function (e) {
                let _this = this;
                let fix_cols = page.grid_config.frozenColumnIndex;
                page.popColSetting.show(gui.gui_code, gui.template_key, 'grid', page.grid_config.columns, page.grid, { 'order_fix':false,  'fix_cols' : fix_cols });
            });

            $('#btnCompanySearch').click(function () {
                let poppage = new PopCompComponent();
                let $poppage = $(poppage);
                let searchcallback = function (items) {
                    console.log('items : ',items);
                    document.getElementById('cboCompany').value = items.compname;
                    document.getElementById('cboCompanyHidden').value = items.id;
                };

                poppage.show(searchcallback);
            });
            $('#cboCompany').on('input', function () {
                const val = $(this).val();
                if (val === '') {
                    $('#cboCompanyHidden').val('');
                }
            });
            // .btn-clear ÌÅ¥Î¶≠ ÌõÑ input Ïù¥Î≤§Ìä∏ Í∞ïÏ†ú Î∞úÏÉù
            $(document).on('click', '.btn-clear', function () {
                const $input = $(this).siblings('input[type="text"]');
                $input.val('');
                $input.trigger('input'); // üî• input Ïù¥Î≤§Ìä∏ Í∞ïÏ†ú Î∞úÏÉù
            });
            // Ï¥àÍ∏∞Ìôî Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
            $('#btnClear').click(function () {

                document.getElementById('cboCompany').value = '';
                document.getElementById('cboCompanyHidden').value = '';
            });

        })
    </script>

</th:block>

<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
</html>