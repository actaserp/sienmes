<html layout:decorate="~{layout_page}">
<th:block layout:fragment="content">
    <div class="layout-contents">
        <div class="page-title-wrap">
            <div class="left">
                <h2>ì›”ë³„ ë§¤ì… í˜„í™©</h2>
                <a title="ë¶ë§ˆí¬" class="bookmark toggle">
                    ë‚´ ë©”ë‰´
                </a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
                <li>ì…ê¸ˆê´€ë¦¬</li>
                <li>ì›”ë³„ ë§¤ì… í˜„í™©</li>
            </ul>
        </div>

        <section class="section">
            <div class="section-top">
                <div class="search-wrap">
                    <dl>
                        <dt>
                            <label>
                                ì—°ë„
                            </label>
                        </dt>
                        <dd>
                            <select class="" id="cboYear" name="cboYear" >
                            </select>
                        </dd>
                    </dl>
                    <dl id="searchComArea">
                        <dt>
                            ê±°ë˜ì²˜
                        </dt>
                        <dd>
                            <input type="text" id="cboCompany" name="cboCompany" placeholder="ì—…ì²´ê²€ìƒ‰ë²„íŠ¼ìœ¼ë¡œ ê²€ìƒ‰í•˜ì„¸ìš”.">
                            <input type="hidden" id="cboCompanyHidden">
                            <input type="hidden" id="spjangcdHidden">
                            &nbsp;
                            <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnCompanySearch">
                                <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                ì—…ì²´ ê²€ìƒ‰
                            </a>
                        </dd>
                    </dl>
                    <dl>
                        <dt>&nbsp;</dt>
                        <dd>
                            <li>
                                <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnSearch">
                                    <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                                    <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                    ê²€ìƒ‰
                                </a>
                            </li>
                        </dd>
                    </dl>
                </div>
            </div>
            <div class="tab-wrap">
                <ul class="tab-links">
                    <li><a href="#tabs_sales" style="border-radius: 6px 0 0 0;">ë§¤ì…</a></li>
                    <li><a href="#tabs_payment">ì§€ê¸‰</a></li>
                    <li><a href="#tabs_accounts_payable" style="border-radius: 0 6px 0 0;">ë¯¸ì§€ê¸‰</a></li>
                </ul>
                <div>
                    <section class="tab-item" id="tabs_sales" style="border-top-left-radius: 0;">
                        <div class="container-fluid">
                            <div id="theGrid" style="height: 730px;"></div>
                        </div>
                    </section>
                    <section class="tab-item" id="tabs_payment" style="border-top-left-radius: 0;">
                        <div class="container-fluid">
                            <div id="payment-grid" style="height: 730px;"></div>
                        </div>
                    </section>
                    <section class="tab-item" id="tabs_accounts_payable" style="border-top-left-radius: 0;">
                        <div class="container-fluid">
                            <div id="accounts_payable-grid" style="height: 730px;"></div>
                        </div>
                    </section>

                </div>
            </div>
        </section>
    </div>
</th:block>

<th:block layout:fragment="scripts">
    <!--<th:block th:replace="/common/columns_setting :: columns_setting"></th:block>-->
    <th:block th:replace="/common/multiform_material :: multiform_material"></th:block>
    <th:block th:replace="/common/popup_company :: popup_company"></th:block>
    <script type="text/javascript">
        class  MonthlyPurchaseListPage {
            constructor() {
                this.grid = null;
                this.grid3 = null;
                this.grid4= null;
                this.$btnEdit = $('#btnEdit');
                this.$btnAddNew = $('#btnAddNew');
                this.spjangcd = $('#spjangcdHidden');
                this.viewData = new wijmo.collections.CollectionView();
                this.init();
            }

            init() {
                let _this = this;
                const monthColumns = Array.from({ length: 12 }, (_, i) => {
                    const month = i + 1;
                    return {
                        binding: `mon_${month}`,
                        header: `${month}ì›”`,
                        width: 120,
                        align: 'right',
                        allowSorting: false,
                        format: 'n0',
                    };
                });

                this.grid = new wijmo.grid.FlexGrid('#theGrid', {
                    frozenColumns: 4,
                    frozenRows: 0,
                    allowSorting: wijmo.grid.AllowSorting.MultiColumn,
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    allowMerging: wijmo.grid.AllowMerging.Cells,
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    formatItem: (sender, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                    },
                    columns: [
                        { binding: 'comp_name', header: 'ê±°ë˜ì²˜ëª…', width: 250, align: 'center', allowMerging: false },
                        { binding: 'misgubun', header: 'ë§¤ì¶œêµ¬ë¶„', width: 90, align: 'center', allowMerging: false },
                        { binding: 'iverdeptnm', header: 'ë¶€ì„œ', width: 90, align: 'center', allowMerging: false },
                        { binding: 'iverpernm', header: 'ë‹´ë‹¹ì', width: 100, align: 'center', allowSorting: false },
                        ...monthColumns,  //ì—¬ê¸°ì—ì„œ ì›”ë³„ ì»¬ëŸ¼ì„ ì‚½ì…
                        { binding: 'total_sum', header: 'í•©ê³„', width: 120, align: 'right', allowSorting: false },
                    ],
                    itemsSource: this.viewData,
                });
                this.grid.rowHeaders.columns.splice(0, 1);
                new FlexGridContextMenu(this.grid);
                this.grid.downloadFileName = 'ì›”ë³„ ë§¤ì… í˜„í™©(ë§¤ì…)';
//Footer íŒ¨ë„ ì‚¬ìš© ì„¤ì •
                this.grid.columnFooters.rows.push(new wijmo.grid.Row());

                //Footer í•©ê³„ ê°’ ì„¤ì • (ìˆ˜ë™)
                this.grid.loadedRows.addHandler(() => {
                    const rows = this.grid.rows;
                    const footerTotal = this.grid.columnFooters.rows[0];
                    const getSum = (field) => rows.map(r => +r.dataItem[field] || 0).reduce((a, b) => a + b, 0);
                    // footerì— ë“¤ì–´ê°ˆ ë°ì´í„° êµ¬ì„±
                    const footerData = {
                        comp_name: 'í•© ê³„', // ì²« ì»¬ëŸ¼ì— í…ìŠ¤íŠ¸
                    };
                    monthColumns.forEach(col => {
                        footerData[col.binding] = getSum(col.binding);
                    });
                    footerData['total_sum'] = getSum('total_sum');
                    footerTotal.dataItem = footerData;
                });

                this.grid3 = new wijmo.grid.FlexGrid('#payment-grid', {
                    frozenColumns: 1,
                    frozenRows: 0,
                    allowSorting: wijmo.grid.AllowSorting.MultiColumn,
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    allowMerging: wijmo.grid.AllowMerging.Cells,
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    formatItem: (sender, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                    },
                    columns: [
                        { binding: 'comp_name', header: 'ê±°ë˜ì²˜ëª…', width: 250, align: 'center', allowMerging: true },
                        /*{ binding: 'deposit_type', header: 'ì…ê¸ˆí˜•íƒœ', width: 90, align: 'center', allowMerging: true },
                        { binding: 'icerdeptnm', header: 'ë¶€ì„œ', width: 130, align: 'center', allowMerging: true },
                        { binding: 'icerceonm', header: 'ë‹´ë‹¹ì', width: 100, align: 'center', allowSorting: false },*/
                        ...monthColumns,
                        { binding: 'total_sum', header: 'í•©ê³„', width: 120, align: 'right', allowSorting: false },
                    ],
                    itemsSource: this.viewData,
                });


                this.grid3.rowHeaders.columns.splice(0, 1);
                new FlexGridContextMenu(this.grid3);
                this.grid3.downloadFileName = 'ì›”ë³„ ë§¤ì… í˜„í™©(ì§€ê¸‰)';
                //Footer íŒ¨ë„ ì‚¬ìš© ì„¤ì •
                this.grid3.columnFooters.rows.push(new wijmo.grid.Row());
                // âœ… Footer í•©ê³„ ì„¤ì •
                this.grid3.loadedRows.addHandler(() => {
                    const rows = this.grid3.rows;
                    const footerTotal = this.grid3.columnFooters.rows[0];
                    const getSum = (field) => rows.map(r => +r.dataItem[field] || 0).reduce((a, b) => a + b, 0);

                    const footerData = {
                        comp_name: 'í•© ê³„',
                    };
                    monthColumns.forEach(col => {
                        footerData[col.binding] = getSum(col.binding);
                    });
                    footerData['total_sum'] = getSum('total_sum');
                    footerTotal.dataItem = footerData;
                });

                this.grid4 = new wijmo.grid.FlexGrid('#accounts_payable-grid', {
                    frozenColumns: 4,
                    frozenRows: 0,
                    allowSorting: wijmo.grid.AllowSorting.MultiColumn,
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    allowMerging: wijmo.grid.AllowMerging.Cells,
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    formatItem: (sender, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                    },
                    columns: [
                        { binding: 'comp_name', header: 'ê±°ë˜ì²˜ëª…', width: 170, align: 'center', allowMerging: true },
                        { binding: 'amount', header: 'ì „ì”ì•¡', width: 110, align: 'right'},
                        /* { binding: 'misgubun', header: 'ë§¤ì¶œêµ¬ë¶„', width: 100, align: 'center', allowMerging: true },
                         { binding: 'icerdeptnm', header: 'ë¶€ì„œ', width: 130, align: 'center', allowMerging: true },
                         { binding: 'icerceonm', header: 'ë‹´ë‹¹ì', width: 100, align: 'center', allowSorting: false },*/
                        ...monthColumns,
                    ],
                    itemsSource: this.viewData,
                });
                this.grid4.rowHeaders.columns.splice(0, 1);
                new FlexGridContextMenu(this.grid4);
                this.grid4.downloadFileName = 'ì›”ë³„ ë§¤ì… í˜„í™©(ë¯¸ì§€ê¸‰)';
                //Footer íŒ¨ë„ ì‚¬ìš© ì„¤ì •
                this.grid4.columnFooters.rows.push(new wijmo.grid.Row());
                // âœ… Footer í•©ê³„ ì„¤ì •
                this.grid4.loadedRows.addHandler(() => {
                    const rows = this.grid4.rows;
                    const footerTotal = this.grid4.columnFooters.rows[0];
                    const getSum = (field) => rows.map(r => +r.dataItem[field] || 0).reduce((a, b) => a + b, 0);

                    const footerData = {
                        comp_name: 'í•© ê³„',
                    };
                    monthColumns.forEach(col => {
                        footerData[col.binding] = getSum(col.binding);
                    });
                    footerData['total_sum'] = getSum('total_sum');
                    footerTotal.dataItem = footerData;
                });
            }

            searchMainData() {
                let _this = this;
                let url = '/api/transaction/monthly_purchase_list'
                let data = {
                    'cboYear': $("#cboYear").val(),
                    'cboCompany': $("#cboCompanyHidden").val(),
                    spjangcd: this.spjangcd.val()
                }
                //ë§¤ì… ë‚´ì—­
                AjaxUtil.getAsyncData(url+'/PurchaseDetails', data, function (result) {
                    if (result != null) {
                        _this.grid.itemsSource = result.data;
                    }
                });
                // ì§€ê¸‰ ë‚´ì—­
                AjaxUtil.getAsyncData(url+'/ProvisionRead' , data, function (result) {
                    if (result != null) {
                        _this.grid3.itemsSource = result.data;
                    }
                });
                // ë¯¸ì§€ê¸‰ê¸ˆ ë‚´ì—­
                AjaxUtil.getAsyncData(url+'/PaymentRead' , data, function (result) {
                    if (result != null) {
                        _this.grid4.itemsSource = result.data;
                    }
                });
            }
        }
        let page = null;

        $(document).ready(function (e) {
            const spjangcd = sessionStorage.getItem('spjangcd');
            if (spjangcd) {
                $('#spjangcdHidden').val(spjangcd);  // hidden inputì´ ìˆì–´ì•¼ í•¨
            }
            page = new  MonthlyPurchaseListPage();

            AjaxUtil.fillSelectOptions($('#cboCompany'), 'company', 'all', '', 'sale');
            AjaxUtil.fillSelectOptions($('#cboYear'), 'data_year', '', false);

            $('#srchStartDt').val(CommonUtil.getYYYYMMDD(-7));
            $('#srchEndDt').val(CommonUtil.getYYYYMMDD());

            page.searchMainData();

            // ê²€ìƒ‰
            $('#btnSearch').click(function (e) {
                if ($('#cboCompanyHidden').val() === '' && $('#cboCompany').val() !== '') {
                    Alert.alert('', 'ì—…ì²´ëª…ì€ ì—…ì²´ê²€ìƒ‰ ë²„íŠ¼ì„ í†µí•´ì„œ \n ê²€ìƒ‰í•´ì£¼ì„¸ìš”');
                    return;
                }
                page.searchMainData();
            });

            $('#btnGridSetting').click(function (e) {
                let _this = this;
                let fix_cols = page.grid_config.frozenColumnIndex;
                page.popColSetting.show(gui.gui_code, gui.template_key, 'grid', page.grid_config.columns, page.grid, { 'order_fix':false,  'fix_cols' : fix_cols });
            });

            $('#btnCompanySearch').click(function () {
                let poppage = new PopCompComponent();
                let $poppage = $(poppage);
                let searchcallback = function (items) {
                    console.log('items : ',items);
                    document.getElementById('cboCompany').value = items.compname;
                    document.getElementById('cboCompanyHidden').value = items.id;
                };

                poppage.show(searchcallback);
            });
            $('#cboCompany').on('input', function () {
                const val = $(this).val();
                if (val === '') {
                    $('#cboCompanyHidden').val('');
                }
            });
            // .btn-clear í´ë¦­ í›„ input ì´ë²¤íŠ¸ ê°•ì œ ë°œìƒ
            $(document).on('click', '.btn-clear', function () {
                const $input = $(this).siblings('input[type="text"]');
                $input.val('');
                $input.trigger('input'); // ğŸ”¥ input ì´ë²¤íŠ¸ ê°•ì œ ë°œìƒ
            });
            // ì´ˆê¸°í™” ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            $('#btnClear').click(function () {

                document.getElementById('cboCompany').value = '';
                document.getElementById('cboCompanyHidden').value = '';
            });

        })
    </script>

</th:block>

<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
</html>