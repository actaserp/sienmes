<html layout:decorate="~{layout_page}">
<th:block layout:fragment="content">
    <div class="layout-contents">
        <div class="page-title-wrap">
            <div class="left">
                <h2>ì›”ë³„ ë§¤ì… í˜„í™©</h2>
                <a title="ë¶ë§ˆí¬" class="bookmark toggle">
                    ë‚´ ë©”ë‰´
                </a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
                <li>ì…ê¸ˆê´€ë¦¬</li>
                <li>ì›”ë³„ ë§¤ì… í˜„í™©</li>
            </ul>
        </div>

        <section class="section">
            <div class="section-top">
                <div class="search-wrap">
                    <dl>
                        <dt>
                            <label>
                                ì—°ë„
                            </label>
                        </dt>
                        <dd>
                            <select class="" id="cboYear" name="cboYear" >
                            </select>
                        </dd>
                    </dl>
                    <dl id="searchComArea">
                        <dt>
                            ê±°ë˜ì²˜
                        </dt>
                        <dd>
                            <input type="text" id="cboCompany" name="cboCompany" placeholder="ì—…ì²´ê²€ìƒ‰ë²„íŠ¼ìœ¼ë¡œ ê²€ìƒ‰í•˜ì„¸ìš”.">
                            <input type="hidden" id="cboCompanyHidden">
                            <input type="hidden" id="spjangcdHidden">
                            &nbsp;
                            <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnCompanySearch">
                                <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                ì—…ì²´ ê²€ìƒ‰
                            </a>
                        </dd>
                    </dl>
                    <dl>
                        <dt>&nbsp;</dt>
                        <dd>
                            <li>
                                <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnSearch">
                                    <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                                    <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                    ê²€ìƒ‰
                                </a>
                            </li>
                        </dd>
                    </dl>
                </div>
            </div>
            <div class="tab-wrap">
                <ul class="tab-links">
                    <li><a href="#tabs_sales" style="border-radius: 6px 0 0 0;">ë§¤ì…</a></li>
                    <li><a href="#tabs_deposit">ì§€ê¸‰</a></li>
                    <li><a href="#tabs_accounts_receivable" style="border-radius: 0 6px 0 0;">ë¯¸ì§€ê¸‰</a></li>
                </ul>
                <div>
                    <section class="tab-item" id="tabs_sales" style="border-top-left-radius: 0;">
                        <div class="container-fluid">
                            <div id="theGrid" style="height: 730px;"></div>
                        </div>
                    </section>
                    <section class="tab-item" id="tabs_deposit" style="border-top-left-radius: 0;">
                        <div class="container-fluid">
                            <div id="deposit-grid" style="height: 730px;"></div>
                        </div>
                    </section>
                    <section class="tab-item" id="tabs_accounts_receivable" style="border-top-left-radius: 0;">
                        <div class="container-fluid">
                            <div id="accounts_receivable-grid" style="height: 730px;"></div>
                        </div>
                    </section>

                </div>
            </div>
        </section>
    </div>
</th:block>

<th:block layout:fragment="scripts">
    <!--<th:block th:replace="/common/columns_setting :: columns_setting"></th:block>-->
    <th:block th:replace="/common/multiform_material :: multiform_material"></th:block>
    <th:block th:replace="/common/popup_company :: popup_company"></th:block>
    <script type="text/javascript">
        class MonthlySalesListPage {
            constructor() {
                this.grid = null;
                this.grid3 = null;
                this.grid4= null;
                this.$btnEdit = $('#btnEdit');
                this.$btnAddNew = $('#btnAddNew');
                this.spjangcd = $('#spjangcdHidden');
                this.viewData = new wijmo.collections.CollectionView();
                this.init();
            }

            init() {
                let _this = this;
                const monthColumns = Array.from({ length: 12 }, (_, i) => {
                    const month = i + 1;
                    return {
                        binding: `mon_${month}`,
                        header: `${month}ì›”`,
                        width: 80,
                        align: 'right',
                        allowSorting: false,
                        format: 'n0',
                    };
                });

                this.grid = new wijmo.grid.FlexGrid('#theGrid', {
                    frozenColumns: 4,
                    frozenRows: 0,
                    allowSorting: wijmo.grid.AllowSorting.MultiColumn,
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    allowMerging: wijmo.grid.AllowMerging.Cells,
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    formatItem: (sender, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                    },
                    columns: [
                        { binding: 'Name', header: 'ê±°ë˜ì²˜ëª…', width: 170, align: 'center', allowMerging: true },
                        { binding: 'misgubun', header: 'êµ¬ë¶„', width: 70, align: 'center', allowMerging: true },
                        { binding: 'icerdeptnm', header: 'ë¶€ì„œ', width: 130, align: 'left', allowMerging: true },
                        { binding: 'icerpernm', header: 'ë‹´ë‹¹ì', width: 100, align: 'center', allowSorting: false },
                        ...monthColumns,  // âœ… ì—¬ê¸°ì—ì„œ ì›”ë³„ ì»¬ëŸ¼ì„ ì‚½ì…
                        { binding: 'total', header: 'í•©ê³„', width: 200, align: 'center', allowSorting: false }
                    ],
                    itemsSource: this.viewData,
                });
                this.grid.rowHeaders.columns.splice(0, 1);
                new FlexGridContextMenu(this.grid);
                this.grid.downloadFileName = 'ì›”ë³„ ë§¤ì… í˜„í™©(ë§¤ì…)';


                this.grid3 = new wijmo.grid.FlexGrid('#deposit-grid', {
                    frozenColumns: 4,
                    frozenRows: 0,
                    allowSorting: wijmo.grid.AllowSorting.MultiColumn,
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    allowMerging: wijmo.grid.AllowMerging.Cells,
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    formatItem: (sender, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                    },
                    columns: [
                        { binding: 'Name', header: 'ê±°ë˜ì²˜ëª…', width: 170, align: 'center', allowMerging: true },
                        { binding: 'mat_code', header: 'êµ¬ë¶„', width: 70, align: 'center', allowMerging: true },
                        { binding: 'mat_name', header: 'ë¶€ì„œ', width: 130, align: 'left', allowMerging: true },
                        { binding: 'unit_name', header: 'ë‹´ë‹¹ì', width: 100, align: 'center', allowSorting: false },
                        ...monthColumns,
                        { binding: 'total', header: 'í•©ê³„', width: 200, align: 'center', allowSorting: false },
                    ],
                    itemsSource: this.viewData,
                });

                this.grid3.rowHeaders.columns.splice(0, 1);
                new FlexGridContextMenu(this.grid3);
                this.grid3.downloadFileName = 'ì›”ë³„ ë§¤ì… í˜„í™©(ì§€ê¸‰)';


                this.grid4 = new wijmo.grid.FlexGrid('#accounts_receivable-grid', {
                    frozenColumns: 4,
                    frozenRows: 0,
                    allowSorting: wijmo.grid.AllowSorting.MultiColumn,
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    allowMerging: wijmo.grid.AllowMerging.Cells,
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    formatItem: (sender, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                    },
                    columns: [
                        { binding: 'mat_grp_name', header: 'ê±°ë˜ì²˜ëª…', width: 170, align: 'center', allowMerging: true },
                        { binding: 'mat_code', header: 'êµ¬ë¶„', width: 70, align: 'center', allowMerging: true },
                        { binding: 'mat_name', header: 'ë¶€ì„œ', width: 130, align: 'left', allowMerging: true },
                        { binding: 'unit_name', header: 'ë‹´ë‹¹ì', width: 100, align: 'center', allowSorting: false },
                        ...monthColumns,
                        { binding: 'total', header: 'í•©ê³„', width: 200, align: 'center', allowSorting: false }
                    ],
                    itemsSource: this.viewData,
                });

                this.grid4.rowHeaders.columns.splice(0, 1);
                new FlexGridContextMenu(this.grid4);
                this.grid4.downloadFileName = 'ì›”ë³„ ë§¤ì… í˜„í™©(ë¯¸ì§€ê¸‰)';
            }

            searchMainData() {
                let _this = this;
                let url = '/api/transaction/monthly_purchase_list/read'
                let data = {
                    'cboYear': $("#cboYear").val(),
                    'cboCompany': $("#cboCompanyHidden").val(),
                    spjangcd: this.spjangcd.val()
                }
                let fnsuccess = function (result) {
                    if (result != null) {
                        _this.viewData.sourceCollection = result.data;
                    }
                };
                AjaxUtil.getAsyncData(url, data, fnsuccess);
            }
        }
        let page = null;

        $(document).ready(function (e) {
            const spjangcd = sessionStorage.getItem('spjangcd');
            if (spjangcd) {
                $('#spjangcdHidden').val(spjangcd);  // hidden inputì´ ìˆì–´ì•¼ í•¨
            }
            page = new MonthlySalesListPage();

            AjaxUtil.fillSelectOptions($('#cboCompany'), 'company', 'all', '', 'sale');
            AjaxUtil.fillSelectOptions($('#cboYear'), 'data_year', '', false);

            $('#srchStartDt').val(CommonUtil.getYYYYMMDD(-7));
            $('#srchEndDt').val(CommonUtil.getYYYYMMDD());

            page.searchMainData();

            // ê²€ìƒ‰
            $('#btnSearch').click(function (e) {
                if ($('#cboCompanyHidden').val() === '' && $('#cboCompany').val() !== '') {
                    Alert.alert('', 'ì—…ì²´ëª…ì€ ì—…ì²´ê²€ìƒ‰ ë²„íŠ¼ì„ í†µí•´ì„œ \n ê²€ìƒ‰í•´ì£¼ì„¸ìš”');
                    return;
                }
                page.searchMainData();
            });

            $('#btnGridSetting').click(function (e) {
                let _this = this;
                let fix_cols = page.grid_config.frozenColumnIndex;
                page.popColSetting.show(gui.gui_code, gui.template_key, 'grid', page.grid_config.columns, page.grid, { 'order_fix':false,  'fix_cols' : fix_cols });
            });

            $('#btnCompanySearch').click(function () {
                let poppage = new PopCompComponent();
                let $poppage = $(poppage);
                let searchcallback = function (items) {
                    console.log('items : ',items);
                    document.getElementById('cboCompany').value = items.compname;
                    document.getElementById('cboCompanyHidden').value = items.id;
                };

                poppage.show(searchcallback);
            });
            $('#cboCompany').on('input', function () {
                const val = $(this).val();
                if (val === '') {
                    $('#cboCompanyHidden').val('');
                }
            });
            // .btn-clear í´ë¦­ í›„ input ì´ë²¤íŠ¸ ê°•ì œ ë°œìƒ
            $(document).on('click', '.btn-clear', function () {
                const $input = $(this).siblings('input[type="text"]');
                $input.val('');
                $input.trigger('input'); // ğŸ”¥ input ì´ë²¤íŠ¸ ê°•ì œ ë°œìƒ
            });
            // ì´ˆê¸°í™” ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            $('#btnClear').click(function () {

                document.getElementById('cboCompany').value = '';
                document.getElementById('cboCompanyHidden').value = '';
            });

        })
    </script>

</th:block>

<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
</html>