<html layout:decorate="~{layout_page}">
<th:block layout:fragment="content">
        <div class="layout-contents">
            <div class="page-title-wrap">
                <div class="left">
                    <h2>ìˆ˜ì£¼ëŸ‰ ì§‘ê³„</h2>
                    <a title="ë¶ë§ˆí¬" class="bookmark toggle">
                        ë‚´ ë©”ë‰´
                    </a>
                </div>
                <ul class="page-navi">
                    <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
                    <li>ì˜ì—… ê´€ë¦¬</li>
                    <li>ìˆ˜ì£¼ëŸ‰ì§‘ê³„</li>
                </ul>
            </div>

            <section class="section">
                <div class="section-top">
                    <div class="search-wrap">
                        <dl>
                            <dt>
                                <label for="srchStartDt">
                                    ê¸°ê°„<span class="eq"></span>
                                </label>
                            </dt>
                            <dd>
                                <div class="srch-box">
                                    <input type="date" id="srchStartDt">&nbsp; ~&nbsp;
                                    <input type="date" id="srchEndDt">
                                </div>
                            </dd>
                        </dl>
                        <dl id="searchComArea">
                            <dt>
                                ì—…ì²´
                            </dt>
                            <dd>
                                <input type="text" id="cboCompany" name="cboCompany">
                                <input type="hidden" id="cboCompanyHidden">
                                &nbsp;
                                <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnCompanySearch">
                                    <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                    ì—…ì²´ ê²€ìƒ‰
                                </a>
                            </dd>

                        </dl>
                        <dl>
                            <dt>
                                ì œí’ˆê·¸ë£¹
                            </dt>
                            <dd>
                                <select class="form-control2" id="cboMatGrp" name="cboMatGrp" ></select>
                            </dd>
                        </dl>

                        <dl>
                            <dt>&nbsp;</dt>
                            <dd>
                                <li>
                                    <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnSearch">
                                        <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                                        <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                        ê²€ìƒ‰
                                    </a>
                                </li>
                            </dd>
                        </dl>
                    </div>
                    <!--                <div class="button-wrap">-->
                    <!--                    <ul>-->
                    <!--                        <li>-->
                    <!--                            <a class="btn btn-excell" title="ë“±ë¡" id="btnAddNew">-->
                    <!--                                <img src="/images/icon/ico-plus.svg" alt="ë“±ë¡ ì•„ì´ì½˜">-->
                    <!--                                ë“±ë¡-->
                    <!--                            </a>-->
                    <!--                        </li>-->
                    <!--                        <li>-->
                    <!--                            <a class="btn btn-delete" title="ì‚­ì œ" id="btnDelete">-->
                    <!--                                <img src="/images/icon/ico-delete.svg" alt="ì‚­ì œ ì•„ì´ì½˜">-->
                    <!--                                ì‚­ì œ-->
                    <!--                            </a>-->
                    <!--                        </li>-->
                    <!--                        <li>-->
                    <!--                            <a class="btn btn-edit" title="ìˆ˜ì •" id="btnEdit">-->
                    <!--                                <img src="/images/icon/ico-edit.svg" alt="ìˆ˜ì • ì•„ì´ì½˜">-->
                    <!--                                ìˆ˜ì •-->
                    <!--                            </a>-->
                    <!--                        </li>-->
                    <!--                    </ul>-->
                    <!--                </div>-->
                </div>
                <div class="container-fluid">
                    <div id="theGrid" style="height: 730px;"></div>
                </div>
                <!--        <div class="grid_box">-->

                <!--            <div class="h-640" data-ax5grid="sujuGrid" ></div>-->
                <!--        </div>-->
            </section>
        </div>
</th:block>
<th:block layout:fragment="scripts">
<th:block th:replace="/common/columns_setting :: columns_setting" ></th:block>
    <th:block th:replace="/common/popup_company :: popup_company"></th:block>
<script type="text/javascript">


    class SujuSummaryPage {
        constructor() {
            this.url = '/api/summary/suju_summary';
            this.grid = null;
            this.$btnEdit = $('#btnEdit');
            this.$btnAddNew = $('#btnAddNew');
            this.viewData = new wijmo.collections.CollectionView();
            this.init();
        }

        init() {
            this.grid = new wijmo.grid.FlexGrid('#theGrid', {
                selectionMode: wijmo.grid.SelectionMode.Row,
                headersVisibility: wijmo.grid.HeadersVisibility.Column,
                allowSorting: wijmo.grid.AllowSorting.MultiColumn,
                allowMerging: wijmo.grid.AllowMerging.Cells,  //ì…€ ë³‘í•©
                autoGenerateColumns: false,
                showMarquee: true,
                isReadOnly: true,
                formatItem: (sender, e) => {
                    if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                        e.cell.style.textAlign = 'center';
                    }
                },
                columns: [
                    { binding: 'mat_grp_name', header: 'ì œí’ˆê·¸ë£¹', width: 150 ,allowMerging: true },
                    { binding: 'mat_code', header: 'ì œí’ˆì½”ë“œ', width: 200 ,allowMerging: true },
                    { binding: 'mat_name', header: 'ì œí’ˆëª…', width: 250 ,allowMerging: true },
                    { binding: 'unit_name', header: 'ë‹¨ìœ„', width: 70, allowSorting: false },
                    { binding: 'tot_price_sum', header: 'ì´ìˆ˜ì£¼ì•¡', width: '*', minWidth: 150,align: 'right', format: 'n0' },
                    { binding: 'tot_suju_sum', header: 'ì´ ìˆ˜ì£¼ëŸ‰', width: 100, align: 'right', format: 'n0' },
                    { binding: 'company_name', header: 'ì—…ì²´', width: 250, allowSorting: false },
                    { binding: 'suju_zsum', header: 'ìˆ˜ì£¼ëŸ‰', width: 100, align: 'right', format: 'n0' },
                    { binding: 'price_sum', header: 'ìˆ˜ì£¼ì•¡', width: 200, align: 'right', format: 'n0' },
                ],
                itemsSource: this.viewData,
            });
            this.grid.itemFormatter = function (panel, row, col, cell) {
                if (panel.cellType === wijmo.grid.CellType.Cell) {
                    let colName = panel.columns[col].binding;
                    if (['mat_grp_name', 'mat_code', 'mat_name', 'unit_name'].includes(colName)) {
                        cell.style.textAlign = 'center';          // ìˆ˜í‰ ê°€ìš´ë°
                        cell.style.verticalAlign = 'middle';      // ìˆ˜ì§ ê°€ìš´ë°
                        cell.style.display = 'flex';              // flexë¡œ ì •ë ¬
                        cell.style.alignItems = 'center';         // ìˆ˜ì§ ì •ë ¬
                        cell.style.justifyContent = 'center';     // ìˆ˜í‰ ì •ë ¬
                    }
                }
            };
            // âœ… Footer íŒ¨ë„ ì‚¬ìš© ì„¤ì •
            this.grid.columnFooters.rows.push(new wijmo.grid.Row());
            this.grid.bottomLeftCells.setCellData(0, 0, 'ì´í•©');

            // âœ… Footer í•©ê³„ ê°’ ì„¤ì • (ìˆ˜ë™)
            this.grid.loadedRows.addHandler(() => {
                const rows = this.grid.rows;
                const footer = this.grid.columnFooters.rows[0];

                const getSum = (field) => rows.map(r => +r.dataItem[field] || 0).reduce((a, b) => a + b, 0);

                footer.dataItem = {
                    tot_price_sum: getSum('tot_price_sum'),
                    tot_suju_sum: getSum('tot_suju_sum'),
                    suju_sum: getSum('suju_sum'),
                    price_sum: getSum('price_sum'),
                };
            });

            new FlexGridContextMenu(this.grid);
            this.grid.downloadFileName = 'ìˆ˜ì£¼ëŸ‰ì§‘ê³„';
        }




        searchMainData() {
            const url = this.url + '/read';
            const data = {
                'srchStartDt' : $("#srchStartDt").val(),
                'srchEndDt' : $("#srchEndDt").val(),
                'cboCompany' : $("#cboCompanyHidden").val(),
                'cboMatGrp' : $("#cboMatGrp").val()
            };
            const result = AjaxUtil.getSyncData(url, data);
            console.log("result data : ", result.data);
            if (result) {
                this.grid.itemsSource = result.data;
            }
        }

        exportExcel() {
            const book = wijmo.grid.xlsx.FlexGridXlsxConverter.saveAsync(this.grid, {
                includeColumnHeaders: true,
                includeCellStyles: false,
            }, (blob) => {
                wijmo.saveFile(blob, 'ìˆ˜ì£¼ëŸ‰.xlsx');
            });
        }
    }

    let page = null;

    $(document.body).ready(function (e) {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0'); // ì›”ì€ 0ë¶€í„° ì‹œì‘
        const dd = String(today.getDate()).padStart(2, '0');

        const firstDay = `${yyyy}-${mm}-01`;
        const currentDay = `${yyyy}-${mm}-${dd}`;
        page = new SujuSummaryPage();


        $('#srchStartDt').val(firstDay);
        $('#srchEndDt').val(currentDay);

        AjaxUtil.fillSelectOptions($('#cboMatGrp'), 'material_group', 'all', '', 'product,semi');

        $('#btnSearch').click(() => {
            if ($('#cboCompanyHidden').val() === '' && $('#cboCompany').val() !== '') {
                Alert.alert('', 'ì—…ì²´ëª…ì€ ì—…ì²´ê²€ìƒ‰ ë²„íŠ¼ì„ í†µí•´ì„œ \n ê²€ìƒ‰í•´ì£¼ì„¸ìš”');
                return;
            }

            page.searchMainData();
        });

        $('#btnCompanySearch').click(function () {

            let poppage = new PopCompComponent();
            let $poppage = $(poppage);
            let searchcallback = function (items) {
                // $content.find('#cboCompany').val(items.id);
                // $content.find('#CompanyName').val(items.compname);
                console.log('items : ',items);
                document.getElementById('cboCompany').value = items.compname;
                document.getElementById('cboCompanyHidden').value = items.id;
            };

            poppage.show(searchcallback);
        });

        page.searchMainData();
    });

    $('#cboCompany').on('input', function () {
        const val = $(this).val();
        if (val === '') {
            $('#cboCompanyHidden').val('');
        }
    });
    // .btn-clear í´ë¦­ í›„ input ì´ë²¤íŠ¸ ê°•ì œ ë°œìƒ
    $(document).on('click', '.btn-clear', function () {
        const $input = $(this).siblings('input[type="text"]');
        $input.val('');
        $input.trigger('input'); // ğŸ”¥ input ì´ë²¤íŠ¸ ê°•ì œ ë°œìƒ
    });




</script>
</th:block>