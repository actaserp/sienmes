<html layout:decorate="~{layout_page}">
<th:block layout:fragment="content">
    <div class="layout-contents">
        <div class="page-title-wrap">
            <div class="left">
                <h2>ì—…ì²´ë³„ ì›”ë³„ìˆ˜ì£¼ëŸ‰</h2>
                <a title="ë¶ë§ˆí¬" class="bookmark toggle">
                    ë‚´ ë©”ë‰´
                </a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
                <li>ì˜ì—… ê´€ë¦¬</li>
                <li>ì›”ë³„ìˆ˜ì£¼ëŸ‰</li>
            </ul>
        </div>

        <section class="section">
            <div class="section-top">
                <div class="search-wrap">
                    <dl>
                        <dt>
                            <label for="cboYear">
                                ì—°ë„<span class="eq">*</span>
                            </label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <select id="cboYear">
                                </select>
                            </div>
                        </dd>
                    </dl>
                    <dl>
                        <dt>
                            ì—…ì²´
                        </dt>
                        <dd>
                            <input type="text" id="cboCompany" name="cboCompany">
                            <input type="hidden" id="cboCompanyHidden">
                            &nbsp;
                            <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnCompanySearch">
                                <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                ì—…ì²´ ê²€ìƒ‰
                            </a>
                        </dd>
                    </dl>
                    <dl>
                        <dt>
                            ì œí’ˆê·¸ë£¹
                        </dt>
                        <dd>
                            <select class="form-control2" id="cboMatGrp" name="cboMatGrp" ></select>
                        </dd>
                    </dl>
                    <dl>
                        <dt>
                            ì¡°íšŒë°ì´í„°<span class="eq">*</span>
                        </dt>
                        <dd>
                            <select class="form-control2" id="cboDataDiv" name="cboDataDiv" >
                                <option value="qty">ìˆ˜ëŸ‰</option>
                                <option value="money">ê¸ˆì•¡</option>
                            </select>
                        </dd>
                    </dl>

                    <dl>
                        <dt>&nbsp;</dt>
                        <dd>
                            <li>
                                <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnSearch">
                                    <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                                    <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                    ê²€ìƒ‰
                                </a>
                            </li>
                        </dd>
                    </dl>
                </div>
<!--                <div class="button-wrap">-->
<!--                    <ul>-->
<!--                        <li>-->
<!--                            <a class="btn btn-excell" title="ë“±ë¡" id="btnAddNew">-->
<!--                                <img src="/images/icon/ico-plus.svg" alt="ë“±ë¡ ì•„ì´ì½˜">-->
<!--                                ë“±ë¡-->
<!--                            </a>-->
<!--                        </li>-->
<!--                        <li>-->
<!--                            <a class="btn btn-delete" title="ì‚­ì œ" id="btnDelete">-->
<!--                                <img src="/images/icon/ico-delete.svg" alt="ì‚­ì œ ì•„ì´ì½˜">-->
<!--                                ì‚­ì œ-->
<!--                            </a>-->
<!--                        </li>-->
<!--                        <li>-->
<!--                            <a class="btn btn-edit" title="ìˆ˜ì •" id="btnEdit">-->
<!--                                <img src="/images/icon/ico-edit.svg" alt="ìˆ˜ì • ì•„ì´ì½˜">-->
<!--                                ìˆ˜ì •-->
<!--                            </a>-->
<!--                        </li>-->
<!--                    </ul>-->
<!--                </div>-->
            </div>
            <div class="container-fluid">
                <div id="theGrid" style="height: 730px;"></div>
            </div>
            <!--        <div class="grid_box">-->

            <!--            <div class="h-640" data-ax5grid="sujuGrid" ></div>-->
            <!--        </div>-->
        </section>
    </div>
</th:block>
<th:block layout:fragment="scripts">
<th:block th:replace="/common/columns_setting :: columns_setting"></th:block>
    <th:block th:replace="/common/popup_company :: popup_company"></th:block>
<script type="text/javascript">
    class SujuMonthWijmoPage {
        constructor() {
            this.url = '/api/summary/suju_month_summary';
            this.grid = null;
            this.$btnEdit = $('#btnEdit');
            this.$btnAddNew = $('#btnAddNew');
            this.viewData = new wijmo.collections.CollectionView();
            this.init();
        }

        init() {
            let _this = this;
            this.grid = new wijmo.grid.FlexGrid('#theGrid', {
                selectionMode: wijmo.grid.SelectionMode.Row,
                headersVisibility: wijmo.grid.HeadersVisibility.Column,
                allowSorting: wijmo.grid.AllowSorting.MultiColumn,
                allowMerging: wijmo.grid.AllowMerging.Cells,  //ì…€ ë³‘í•©
                autoGenerateColumns: false,
                showMarquee: true,
                isReadOnly: true,
                frozenColumns: 7,
                formatItem: (sender, e) => {
                    if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                        e.cell.style.textAlign = 'center';
                    }
                },

                columns: [
                    { binding: 'mat_grp_name', header: 'ì œí’ˆê·¸ë£¹', width: 100 ,allowMerging: true },
                    { binding: 'mat_code', header: 'ì œí’ˆì½”ë“œ', width: 150 ,allowMerging: true },
                    { binding: 'mat_name', header: 'ì œí’ˆëª…', width: 150 ,allowMerging: true },
                    { binding: 'unit_name', header: 'ë‹¨ìœ„', width: 70 , allowSorting: false },
                    { binding: 'year_qty_sum', header: 'ì—°ìˆ˜ì£¼ëŸ‰', width: 100, format: 'n0', align: 'right' },
                    { binding: 'year_money_sum', header: 'ì—°ìˆ˜ì£¼ì•¡', width: 100, format: 'n0', align: 'right' },
                    { binding: 'company_name', header: 'ì—…ì²´', width: 200, allowSorting: false  },
                    ...Array.from({ length: 12 }, (_, i) => ({
                        binding: `mon_${i + 1}`,
                        header: `${i + 1}ì›”`,
                        width: 80,
                        format: 'n0',
                        align: 'right',
                        allowSorting: false
                    }))
                ],
                itemsSource: this.viewData, // ë°ì´í„°ë¥¼ ì„¤ì •í•  ë°°ì—´
            });
            this.grid.itemFormatter = function (panel, row, col, cell) {
                if (panel.cellType === wijmo.grid.CellType.Cell) {
                    let colName = panel.columns[col].binding;
                    if (['mat_grp_name', 'mat_code', 'mat_name', 'unit_name'].includes(colName)) {
                        cell.style.textAlign = 'center';          // ìˆ˜í‰ ê°€ìš´ë°
                        cell.style.verticalAlign = 'middle';      // ìˆ˜ì§ ê°€ìš´ë°
                        cell.style.display = 'flex';              // flexë¡œ ì •ë ¬
                        cell.style.alignItems = 'center';         // ìˆ˜ì§ ì •ë ¬
                        cell.style.justifyContent = 'center';     // ìˆ˜í‰ ì •ë ¬
                    }
                    else if (colName.startsWith('mon_') || ['year_qty_sum', 'year_money_sum'].includes(colName)) {
                        // ìˆ«ì ì˜¤ë¥¸ìª½ ì •ë ¬
                        cell.style.textAlign = 'right';
                    } else if (['company_name'].includes(colName)) {
                        // ê·¸ ì™¸ ê¸°ë³¸ê°’ ì •ë ¬ (ì„ íƒ)
                        cell.style.textAlign = 'left';
                    }
                }
            };
            new FlexGridContextMenu(this.grid);
            this.grid.downloadFileName = 'ì›”ë³„ìˆ˜ì£¼ëŸ‰';
        }


        searchMainData() {
            const url = this.url + '/read';
            const data = {
                'cboYear': $('#cboYear').val(),
                'cboCompany': $('#cboCompany').val(),
                'cboMatGrp': $('#cboMatGrp').val(),
                'cboDataDiv': $('#cboDataDiv').val(),
            };
            const result = AjaxUtil.getSyncData(url, data);
            console.log("result data : ", result.data);
            if (result) {
                this.grid.itemsSource = result.data;
            }
        }

        exportExcel() {
            const book = wijmo.grid.xlsx.FlexGridXlsxConverter.saveAsync(this.grid, {
                includeColumnHeaders: true,
                includeCellStyles: false,
            }, (blob) => {
                wijmo.saveFile(blob, 'ì›”ìˆ˜ì£¼ëŸ‰.xlsx');
            });
        }
    }

    let page = null;

    $(document.body).ready(function (e) {
        const currentYear = new Date().getFullYear();
        const yearSelect = $('#cboYear');
        // ì˜µì…˜ ì¶”ê°€
        for (let y = currentYear; y >= 2010; y--) {
            yearSelect.append(new Option(y, y));
        }
        // ê¸°ë³¸ê°’ ì„¤ì •
        yearSelect.val(currentYear);

        page = new SujuMonthWijmoPage();

        AjaxUtil.fillSelectOptions($('#cboMatGrp'), 'material_group', 'all', '', 'product,semi');

        $('#btnSearch').click(() => {
            if ($('#cboCompanyHidden').val() === '' && $('#cboCompany').val() !== '') {
                Alert.alert('', 'ì—…ì²´ëª…ì€ ì—…ì²´ê²€ìƒ‰ ë²„íŠ¼ì„ í†µí•´ì„œ \n ê²€ìƒ‰í•´ì£¼ì„¸ìš”');
                return;
            }

            page.searchMainData();
        });

        $('#btnCompanySearch').click(function () {

            let poppage = new PopCompComponent();
            let $poppage = $(poppage);
            let searchcallback = function (items) {
                // $content.find('#cboCompany').val(items.id);
                // $content.find('#CompanyName').val(items.compname);
                console.log('items : ',items);
                document.getElementById('cboCompany').value = items.compname;
                document.getElementById('cboCompanyHidden').value = items.id;
            };

            poppage.show(searchcallback);
        });

        page.searchMainData();
    });
    $('#cboCompany').on('input', function () {
        const val = $(this).val();
        if (val === '') {
            $('#cboCompanyHidden').val('');
        }
    });
    // .btn-clear í´ë¦­ í›„ input ì´ë²¤íŠ¸ ê°•ì œ ë°œìƒ
    $(document).on('click', '.btn-clear', function () {
        const $input = $(this).siblings('input[type="text"]');
        $input.val('');
        $input.trigger('input'); // ğŸ”¥ input ì´ë²¤íŠ¸ ê°•ì œ ë°œìƒ
    });



</script>
</th:block>