<html layout:decorate="~{layout_page}">

<head>
    <style>
        .button-list {
            display: flex;
            justify-content: flex-end; /* 버튼들을 오른쪽으로 정렬 */
            list-style: none;
            padding: 0;
            margin: 0;
            gap: 10px; /* 버튼 간 간격 조정 */
        }

        .button-list li {
            margin: 0;
            padding: 0;
        }

        .button-wrap {
            margin-left: auto; /* 버튼들을 오른쪽 끝으로 */
        }

        .button-wrap ul {
            display: flex;
            gap: 10px; /* 버튼 간격 */
            padding: 0;
            margin: 0;
            list-style: none;
        }

        .unitcost-save-btn {
            margin-top: 10px;
        }
        .tab-links li a {
            display: inline-flex;
            justify-content: center;
            min-width: 90px;
            padding: 8px 32px 8px 32px;
            background-color: #3069B3;
            color: #fff;
            font-size: 15px;
            font-weight: 500;
            text-align: center;
            transition: all .3s;
        }
        .tab-links li.active a {
            background-color: #fff;
            color: #03428E;
            font-weight: 600;
        }
    </style>
</head>


<th:block layout:fragment="content">
    <script type="text/javascript" src="/js/fileupload.js?v=20220503"></script> <!--?v=1003-->
    <div class="layout-contents">
        <div class="page-title-wrap">
            <div class="left">
                <h2>품목 정보</h2>
                <a title="북마크" class="bookmark toggle">
                    내 메뉴
                </a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
                <li>기준정보</li>
                <li>품목정보</li>
            </ul>
        </div>


        <div style="display: flex; gap: 5px">
            <section class="section" style="width: 50%;">
                <div class="section-top">
                    <div class="search-wrap">
                        <dl>
                            <dt>
                                <label>품목구분</label>
                            </dt>
                            <dd>
                                <select class="form-control2" id="cboMaterialType" name="cboMaterialType"></select>
                            </dd>
                        </dl>
                        <dl>
                            <dt>
                                <label>품목그룹</label>
                            </dt>
                            <dd>
                                <select class="form-control2" id="cboMaterialGroup" name="cboMaterialGroup"></select>
                            </dd>
                        </dl>
                        <dl>
                            <dt>
                                <label>품목명</label>
                            </dt>
                            <dd>
                                <input type="text" class="form-control2" id="keyword" name="keyword">
                            </dd>
                        </dl>
                        <dl>
                            <dt>
                                <label>사용중지여부</label>
                            </dt>
                            <dd>
                                <input class="form-control2" type="checkbox" id="useYn_flag" name="useYn_flag"/>
                            </dd>
                        </dl>

                    </div>
                    <div class="search-wrap" style="margin-top: -20px; margin-left: auto;">
                        <dl>
                            <dt><span class="eq"></span></dt>
                            <dd>
                                <li>
                                    <a class="btn btn-delete" title="검색" id="btnSearch">
                                        <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                        검색
                                    </a>
                                </li>
                            </dd>
                        </dl>
                        <dl>
                            <dt><span class="eq"></span></dt>
                            <dd>
                                <li>
                                    <button type="button" class="btn-delete btn-danger" id="batchDelete"
                                            style="width: 115px; height: 36px;">
                                        <i class="fas fa-trash"></i>일괄삭제
                                    </button>
                                </li>
                            </dd>
                        </dl>
                    </div>
                </div>

                <!--<div class="grid_box">
                     <div class="h-280" data-ax5grid="material-grid" ></div>
                </div>-->
                <div class="container-fluid">
                    <div id="theGrid" style=""></div>
                </div>
            </section>
            <!--border-radius: 6px 0 0 0;-->
            <section style="width: 50%;">
                <!--<div class="section-top">
                    <div class="button-wrap">
                        <ul>
                            <li>
                                <button type="button" class="btn-default" id="btnNew" name="btnNew"
                                        style="width: 115px; height: 36px;">
                                    <i class="fas fa-plus"></i>신규등록
                                </button>
                            </li>

                            <li>
                                <button type="button" class="btn-danger" id="btnDelete"
                                        style="width: 115px; height: 36px;">
                                    <i class="fas fa-trash"></i>삭제
                                </button>
                            </li>

                            <li>
                                <button disabled type="button" class="btn-default" id="btnSave"
                                        style="width: 115px; height: 36px;">
                                    <i class="fas fa-save"></i>저장
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>-->

                <div class="tab-wrap">
                    <ul class="tab-links">
                        <li><a href="#tab_basic" name="tabs_basic" id="tabs_basic">기본정보</a></li>
                        <li><a href="#tab_production" name="tab_production" id="tabs_production" >생산/출하정보</a></li>
                        <li><a href="#tab_inventory" name="tab_inventory" id="tabs_inventory">발주/재고정보</a></li>
                        <li><a href="#tab_bom" name="tab_bom">BOM</a></li>
                        <li><a href="#tab_bom_reverse" name="tab_bom_reverse">BOM(역전개)</a></li>
                        <li><a href="#tab_unitcost" name="tab_unitcost" id="tabs_unitcost">단가정보</a></li>
                        <li><a href="#tab_test_master" name="tab_test_master">검사정보</a></li>
                        <li><a href="#tab_routing" name="tab_routing">라우팅</a></li>

                    </ul>
                    <div>
                        <div class="button-wrap button-list" style="margin: 5px 0 5px 0">
                            <ul>
                                <li>
                                    <button type="button" class="btn-excellt btn-default" id="btnNew" name="btnNew"
                                            style="width: 115px; height: 36px;">
                                        <i class="fas fa-plus"></i>신규등록
                                    </button>
                                </li>

                                <li>
                                    <button type="button" class="btn-delete btn-danger" id="btnDelete"
                                            style="width: 115px; height: 36px;">
                                        <i class="fas fa-trash"></i>삭제
                                    </button>
                                </li>

                                <li>
                                    <button disabled type="button" class="btn-excellt btn-default" id="btnSave"
                                            style="width: 115px; height: 36px;">
                                        <i class="fas fa-save"></i>저장
                                    </button>
                                </li>
                            </ul>
                        </div>
                        <section class="tab-item" id="tab_basic" style="border-top-left-radius: 0;">
                            <div>
                                <form id="matBasicForm">
                                    <table class="write-table">
                                        <caption style="text-align: left; margin-bottom: 8px;">상세테이블</caption>
                                        <colgroup>
                                            <col class="wp17">
                                            <col class="wp33">
                                            <col class="wp17">
                                            <col class="wp33">
                                        </colgroup>
                                        <input type="hidden" id="id" name="id" readonly>
                                        <tbody>
                                        <tr>
                                            <th>
                                                <label for="MaterialGroup_id"><span class="eq">*</span>품목그룹</label>
                                            </th>
                                            <td>
                                                <select id="MaterialGroup_id" name="MaterialGroup_id"
                                                        style="width: 100%;" required></select>
                                            </td>

                                            <th>
                                                <label for="Code"><span class="eq">*</span>품목코드<br>(바코드)</label>
                                            </th>
                                            <td>
                                                <input type="text" id="Code" name="Code"
                                                       style="width: 100%;" required>
                                            </td>
                                        </tr>

                                        <tr>
                                            <th>
                                                <label for="Name"><span class="eq">*</span>품목명</label>
                                            </th>
                                            <td >
                                                <input type="text" style="width: 100%;" id="Name"
                                                       name="Name" required>
                                            </td>
                                            <th>
                                                <label for="Unit_id"><span class="eq">*</span>단위<br>(생상/투입)</label>
                                            </th>
                                            <td>
                                                <select style="width: 100%;" id="Unit_id"
                                                        name="Unit_id" required></select>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>
                                                <label for="Factory_id"><span class="eq">*</span>공장</label>
                                            </th>
                                            <td>
                                                <select type="text" id="Factory_id" name="Factory_id"
                                                        style="width: 100%;"></select>
                                            </td>

                                            <th>
                                                <label for="mtyn">재고관리여부</label>
                                            </th>
                                            <td>
                                                <input type="checkbox" id="mtyn" name="mtyn" value="1" style="display: block; margin: auto; height: 26px; width: 26px;" checked>
                                            </td>

                                        </tr>
                                        <tr>
                                            <th>
                                                <label for="useyn">사용중지여부</label>
                                            </th>
                                            <td>
                                                <input type="checkbox" id="useyn" name="useyn" value="1" style="display: block; margin: auto; height: 26px; width: 26px;">
                                            </td>
                                            <th style="font-size: 14px;">
                                                <label for="LotSize">(생산/발주)<br>로트사이즈</label>
                                            </th>
                                            <td>
                                                <input type="text" id="LotSize" name="LotSize"
                                                       style="width: 100%;">
                                            </td>



                                            <!--                                        <th>-->
                                            <!--                                            <label for="Thickness">두께(mm)</label>-->
                                            <!--                                        </th>-->
                                            <!--                                        <td>-->
                                            <!--                                            <input type="number" style="width: 100%;" id="Thickness"-->
                                            <!--                                                   name="Thickness">-->
                                            <!--                                        </td>-->
                                            <!--                                        <th>-->
                                            <!--                                            <label for="Width">폭(mm)</label>-->
                                            <!--                                        </th>-->
                                            <!--                                        <td>-->
                                            <!--                                            <input type="number" id="Width" name="Width"-->
                                            <!--                                                   style="width: 100%;">-->
                                            <!--                                        </td>-->
                                            <!--                                        <th>-->
                                            <!--                                            <label for="Length">길이(mm)</label>-->
                                            <!--                                        </th>-->
                                            <!--                                        <td>-->
                                            <!--                                            <input type="number" id="Length" name="Length"-->
                                            <!--                                                   style="width: 100%;">-->
                                            <!--                                        </td>-->
                                        </tr>
                                        <tr>
                                            <th>
                                                <label for="CustomerBarcode">고객바코드</label>
                                            </th>
                                            <td>
                                                <input type="text" style="width: 100%;" id="CustomerBarcode"
                                                       name="CustomerBarcode">
                                            </td>
                                            <th>
                                                <label for="Standard1">규격</label>
                                            </th>
                                            <td>
                                                <input type="text" id="Standard1" name="Standard1"
                                                       style="width: 100%;">
                                            </td>

                                        </tr>

                                        <tr>

                                            <th>
                                                <label for="Standard2">단위중량</label>
                                            </th>
                                            <td>
                                                <input type="text" style="width: 100%;" id="Standard2"
                                                       name="Standard2">
                                            </td>
                                            <th>
                                                <label for="Class1">분류1</label>
                                            </th>
                                            <td>
                                                <input type="text" id="Class1" name="Class1"
                                                       style="width: 100%;">
                                            </td>


                                        </tr>
                                        <tr>
                                            <th>
                                                <label for="Class2">분류2</label>
                                            </th>
                                            <td>
                                                <input type="text" style="width: 100%;" id="Class2"
                                                       name="Class2">
                                            </td>
                                            <th>
                                                <label for="Class3">분류3</label>
                                            </th>
                                            <td>
                                                <input type="text" style="width: 100%;" id="Class3"
                                                       name="Class3">
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>
                                                <label for="Usage">용도</label>
                                            </th>
                                            <td>
                                                <input type="text" id="Usage" name="Usage"
                                                       style="width: 100%;">
                                            </td>

                                            <th>
                                                <label for="Description">비고</label>
                                            </th>
                                            <td>
                                                <!--<textarea id="Description" name="Description"></textarea>-->
                                                <input type="text" id="Description" name="Description"
                                                       style="width: 100%;">
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </form>
                            </div>
                        </section>


                        <!--section 2-->
                        <section class="tab-item" id="tab_production" style="border-top-left-radius: 0;">
                            <div>
                                <form id="matProductionForm">
                                    <table class="write-table">
                                        <colgroup>
                                            <col class="wp20">
                                            <col class="wp80">
                                        </colgroup>
                                        <caption style="text-align: left; margin-bottom: 8px;">생산/출하정보</caption>
                                        <!--<input type="hidden" id="id" name="id"/>-->
                                        <tbody>
                                        <tr>
                                            <th>
                                                <label for="WorkCenter_id">기본 워크센터</label>
                                            </th>
                                            <td>
                                                <select id="WorkCenter_id" name="WorkCenter_id"
                                                        style="width: 100%;" ></select>
                                            </td>


                                        </tr>
                                        <tr>
                                            <th>
                                                <label for="Equipment_id">생산 설비</label>
                                            </th>
                                            <td>
                                                <select id="Equipment_id" name="Equipment_id"
                                                        style="width: 100%;"></select>
                                            </td>


                                        </tr>
                                        <tr>
                                            <th>
                                                <label for="StandardTime">표준 생산 시간</label>
                                            </th>
                                            <td>
                                                <input type="number" style="width: 100%;" id="StandardTime"
                                                       name="StandardTime">
                                            </td>


                                        </tr>
                                        <tr>
                                            <th>
                                                <label for="StandardTimeUnit">생산 시간 단위</label>
                                            </th>
                                            <td>
                                                <select id="StandardTimeUnit" name="StandardTimeUnit"
                                                        style="width: 100%;">
                                                    <option value="min">분</option>
                                                    <option value="sec">초</option>
                                                </select>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>
                                                <label for="InputManCount">기본 작업자 수</label>
                                            </th>
                                            <td>
                                                <input type="number" id="InputManCount" name="InputManCount"
                                                       style="width: 100%;">
                                            </td>


                                        </tr>
                                        <tr>
                                            <th>
                                                <label for="InputManHour">기본 ManHour</label>
                                            </th>
                                            <td>
                                                <input type="number" id="InputManHour" name="InputManHour"
                                                       style="width: 100%;">
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>
                                                <label for="VatExemptionYN">부가세 면제</label>
                                            </th>
                                            <td>
                                                <select id="VatExemptionYN" name="VatExemptionYN"
                                                        style="width: 100%;">
                                                    <option value="N">면제아님</option>
                                                    <option value="Y">면제</option>
                                                </select>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </form>
                            </div>
                        </section>

                        <!--section3-->
                        <section class="tab-item" id="tab_inventory" style="border-top-left-radius: 0;">
                            <div>
                                <form id="matStockForm">
                                    <table class="write-table">
                                        <colgroup>
                                            <col class="wp20">
                                            <col class="wp30">
                                            <col class="wp20">
                                            <col class="wp30">
                                        </colgroup>
                                        <caption style="text-align: left; margin-bottom: 8px;">발주/재고정보</caption>
                                        <!--<input type="hidden" id="id" name="id" readonly>-->
                                        <tbody>
                                        <tr>
                                            <th>
                                                <label for="PurchaseOrderStandard">발주 기준</label>
                                            </th>
                                            <td>
                                                <select id="PurchaseOrderStandard" name="PurchaseOrderStandard"
                                                        style="width: 100%;">
                                                    <option value="mrp">ROP</option>
                                                    <option value="rop">MRP</option>
                                                </select>
                                            </td>

                                            <th>
                                                <label for="LeadTime">리드타임(일)</label>
                                            </th>
                                            <td>
                                                <input type="text" id="LeadTime" name="LeadTime"
                                                       style="width: 100%;">
                                            </td>


                                        </tr>
                                        <tr>
                                            <th>
                                                <label for="MinOrder">최소 발주량</label>
                                            </th>
                                            <td>
                                                <input type="text" style="width: 100%;" id="MinOrder"
                                                       name="MinOrder" value="1" required>
                                            </td>

                                            <th>
                                                <label for="MaxOrder">최대 발주량</label>
                                            </th>
                                            <td>
                                                <input type="text" style="width: 100%;" id="MaxOrder"
                                                       name="MaxOrder" value="10" required>
                                            </td>
                                        </tr>

                                        <tr>
                                            <th>
                                                <label for="StoreHouse_id"><span class="eq">*</span>기본 재고 창고</label>
                                            </th>
                                            <td>
                                                <select type="text" id="StoreHouse_id" name="StoreHouse_id"
                                                        style="width: 100%;" required></select>
                                            </td>
                                            <th>
                                                <label for="StoreHouseLoc">창고 내 위치</label>
                                            </th>
                                            <td>
                                                <input type="text" id="StoreHouseLoc" name="StoreHouseLoc"
                                                       style="width: 100%;">
                                            </td>


                                        </tr>
                                        <tr>
                                            <th>
                                                <label for="ManagementLevel">자재 관리 등급</label>
                                            </th>
                                            <td>
                                                <select style="width: 100%;" id="ManagementLevel"
                                                        name="ManagementLevel"></select>
                                            </td>

                                            <th>
                                                <label for="PackingUnitQty">포장단위수량</label>
                                            </th>
                                            <td>
                                                <input type="text" style="width: 100%;" id="PackingUnitQty"
                                                       name="PackingUnitQty">
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>
                                                <label for="PackingUnitName">포장단위</label>
                                            </th>
                                            <td>
                                                <input type="text" id="PackingUnitName" name="PackingUnitName"
                                                       style="width: 100%;">
                                            </td>
                                            <td colspan="2" style="font-size: 14px">
                                                보관/입출고 시 생산/투입 단위가 몇 개 포장되어 존재하는지.<br>20/bag 이라면 포장단위수량 20, 포당단위명 bag 입력.
                                            </td>



                                        </tr>
                                        <tr>
                                            <th><label for="avrqty">적정재고수량</label></th>
                                            <td>
                                                <input type="text" id="avrqty" name="avrqty" style="width: 100%;">
                                            </td>

                                            <th>
                                                <label for="lot_use_yn">LOT 관리 유무</label>
                                            </th>

                                            <td style="text-align: center; vertical-align: middle;">
                                                <div style="display: flex; justify-content: center; align-items: center; height: 100%;">
                                                    <input type="checkbox" id="lot_use_yn" name="lot_use_yn" value="Y" >
                                                </div>
                                            </td>
                                        </tr>

                                        <tr>
                                            <th>
                                                <label for="SafetyStock">안전재고</label>
                                            </th>
                                            <td>
                                                <input type="text" id="SafetyStock" name="SafetyStock"
                                                       style="width: 100%;">
                                            </td>
                                            <th>
                                                <label for="MaxStock">최대재고</label>
                                            </th>
                                            <td>
                                                <input type="text" id="MaxStock" name="MaxStock"
                                                       style="width: 100%;">
                                            </td>


                                        </tr>
                                        <tr>
                                            <th>
                                                <label for="ProcessSafetyStock">공정 안전재고</label>
                                            </th>
                                            <td>
                                                <input type="text" style="width: 100%;" id="ProcessSafetyStock"
                                                       name="ProcessSafetyStock">
                                            </td>

                                            <th>
                                                <label for="ValidDays">사용기한(일)</label>
                                            </th>
                                            <td>
                                                <input type="number" style="width: 100%;" id="ValidDays"
                                                       name="ValidDays" value="1" required>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>
                                                <label for="CurrentStock">재고량</label>
                                            </th>
                                            <td>
                                                <input type="number" id="CurrentStock" name="CurrentStock"
                                                       style="width: 100%;">
                                            </td>
                                            <th>
                                                <label for="AvailableStock">가용재고량</label>
                                            </th>
                                            <td>
                                                <input type="number" id="AvailableStock" name="AvailableStock"
                                                       style="width: 100%;">
                                            </td>


                                        </tr>
                                        <tr>
                                            <th>
                                                <label for="ReservationStock">예약재고량</label>
                                            </th>
                                            <td>
                                                <input type="number" style="width: 100%;" id="ReservationStock"
                                                       name="ReservationStock">
                                            </td>

                                            <th>
                                                <label for="ExpectedOutput">출고예정량<br>(수주/계획 기준)</label>
                                            </th>
                                            <td>
                                                <input type="number" style="width: 100%;" id="ExpectedOutput"
                                                       name="ExpectedOutput">
                                            </td>
                                        </tr>

                                        </tbody>
                                    </table>
                                </form>
                            </div>

                        </section>

                        <!--section4-->
                        <section class="tab-item" id="tab_bom" style="border-top-left-radius: 0;">
                            <div class="container-fluid">
                                <div id="bom-grid" style=""></div>
                            </div>
                        </section>

                        <!--section5-->
                        <section class="tab-item" id="tab_bom_reverse" style="border-top-left-radius: 0;">
                            <div class="container-fluid">
                                <div id="bom-reverse-grid" style=""></div>
                            </div>
                        </section>


                        <!--section6-->
                        <section class="tab-item" id="tab_unitcost" style="border-top-left-radius: 0;">
                            <div class="section-top">
                                <div class="button-wrap">
                                    <!--<small2>단가정보는 왼쪽 버튼을 통해 별도로 저장됩니다. 기존 이력을 남기려면 단가등록/변경 버튼을 누르시고 이력을 남기지 않으시려면 단가 수정 버튼을
                                        누르십시오.
                                    </small2>-->
                                    <ul class="button-list">
                                        <li>
                                            <button type="button" class="btn-excellt btn-default" id="btnPriceHistory"
                                                    style="width: 115px; height: 36px;"><span
                                                    data-labelCd="히스토리조회">히스토리조회</span></button>
                                        </li>

                                        <li>
                                            <button type="button" class="btn-excellt btn-default" id="btnPriceNew"
                                                    style="width: 115px; height: 36px;"><span
                                                    data-labelCd="신규">신규</span></button>
                                        </li>

                                        <li>
                                            <button type="button" class="btn-excellt btn-default" id="btnPriceSave"
                                                    style="width: 115px; height: 36px;"><span
                                                    data-labelCd="단가등록/변경">단가등록/변경</span></button>
                                        </li>

                                        <li>
                                            <button type="button" class="btn-delete btn-danger" id="btnPriceDelete"
                                                    style="width: 115px; height: 36px;"><span
                                                    data-labelCd="단가삭제">단가삭제</span>
                                            </button>
                                        </li>
                                        <li>
                                            <button type="button" class="btn-edit btn-default" id="btnPriceUpdate"
                                                    style="width: 115px; height: 36px;"><span
                                                    data-labelCd="단가수정">단가수정</span>
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                                <div class="search-wrap">
                                    <form id="priceForm" style="margin-left: auto;">
                                        <dl>
                                            <dt>
                                                <label>평균단가</label>
                                            </dt>
                                            <dd>
                                                <input type="number" id="UnitPrice" name="UnitPrice">
                                            </dd>
                                        </dl>
                                    </form>
                                    <div id="unitcostSaveButtonContainer" style="display: none; margin-top: 10px;">
                                    </div>
                                </div>
                            </div>

                            <div class="">
                                <div class="section">
                                    <form id="companyPriceForm">
                                        <table class="write-table">
                                            <caption style="text-align: left; margin-bottom: 8px;">상세테이블</caption>
                                            <input type="text" id="price_id" name="price_id" hidden/>
                                            <tbody>
                                            <tr>
                                                <th>
                                                    <label for="name">구분</label>
                                                </th>
                                                <td>
                                                    <select id="type" name="type" class="wp100">
                                                        <option value="01">매입</option>
                                                        <option value="02">매출</option>
                                                        <option value="03">단가정보</option>
                                                        <option value="04">가공비</option>
                                                    </select>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>
                                                    <label for="Company_id">업체</label>
                                                </th>
                                                <td>
                                                    <select id="Company_id" name="Company_id"
                                                            style="width: 100%;"></select>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>
                                                    <label for="UnitPrices">변경 단가</label>
                                                </th>
                                                <td>
                                                    <input type="text" id="UnitPrices" name="UnitPrice"
                                                           style="width: 100%;">
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>
                                                    <label for="ApplyStartDate">적용시작일</label>
                                                </th>
                                                <td>
                                                    <input type="date" style="width: 100%;" id="ApplyStartDate"
                                                           name="ApplyStartDate">
                                                </td>
                                            </tr>

                                            </tbody>
                                        </table>
                                    </form>
                                </div>
                            </div>
                            <div class="container-fluid" style="margin-top: 5px">
                                <p id="selectedItem"></p>
                                <div id="price_grid" style=""></div>
                            </div>
                        </section>


                        <!--section7-->
                        <section class="tab-item" id="tab_test_master" style="border-top-left-radius: 0;">

                            <div class="section-top">
                                <form id="matTestForm">
                                    <div class="search-wrap">
                                        <dl>
                                            <dt>
                                                <label>수입 검사 필수</label>
                                            </dt>
                                            <dd>
                                                <input type="checkbox" id="InTestYN" name="InTestYN" value="Y"/>
                                            </dd>
                                        </dl>
                                        <dl>
                                            <dt>
                                                <label>출하 검사 필수</label>
                                            </dt>
                                            <dd>
                                                <input type="checkbox" id="OutTestYN" name="OutTestYN" value="Y"/>
                                            </dd>
                                        </dl>
                                        <dl>
                                            <dt></dt>
                                            <dd>
                                                <select class="s-150" id="cboTestMasterGroup"
                                                        name="cboTestMasterGroup"></select>
                                            </dd>
                                        </dl>
                                        <dl>
                                            <dt></dt>
                                            <dd>
                                                <select class="s-150" id="cboTestMaster" name="cboTestMaster"></select>
                                            </dd>
                                        </dl>
                                    </div>
                                </form>
                                <div class="button-wrap">
                                    <ul>
                                        <li>
                                            <button type="button" class="btn-excellt btn-default" id="btnAddTestMaster"
                                                    style="width: 115px; height: 36px;"><i
                                                    class="fas fa-plus"></i>추가
                                            </button>
                                        </li>
                                        <li>
                                            <button type="button" class="btn-delete btn-danger y_write_auth" id="btnDelTestMaster"
                                                    style="float:none; width: 115px; height: 36px;"><i
                                                    class="fas fa-trash"></i>삭제
                                            </button>
                                        </li>
                                        <li>
                                            <button type="button" class="btn-excellt btn-default y_write_auth"
                                                    id="btnSaveTest" style="width: 115px; height: 36px;"><span
                                                    data-labelCd="저장">저장</span></button>
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <div class="container-fluid">
                                <div id="test-master-grid" style=""></div>
                            </div>
                        </section>

                        <!--section8-->
                        <section class="tab-item" id="tab_routing" style="border-top-left-radius: 0;">
                            <div class="container-fluid">
                                <div id="routing-grid" style=""></div>
                            </div>
                        </section>
                    </div>
                </div>
            </section>
        </div>
    </div>


    <script type="text/x-tmpl" id="MaterialTemplate">
        <div class="content_wrap popup">
            <!--<header>
                <h4 id="popTitle">
                {% if (o.id!='') { %}
                  BOM 수정({%=o.Name%})
                  {% } else { %}
                  BOM 등록
                  {% } %}
                </h4>
                <div class="popup_close_box"><button class="btn_popup_close" id="modal-close-x"><i class="fas fa-times"></i></button></div>
            </header>-->

            <div class="grid_box" style="margin-top: 10px;">
                <div id="price-history-grid" style="height: 400px; max-height: 400px;"></div>
           </div>

        <div class="popup-button">
          <button type="button" class="btn-popup" id="modal-close-button"><span data-labelCd="닫기">닫기</span></button>
        </div>
    </div>
    </script>

</th:block>

<th:block layout:fragment="scripts">
    <th:block th:replace="/common/columns_setting :: columns_setting"></th:block>

    <script type="text/javascript">
        class MaterialPage {
            constructor() {
                this.url = '/api/definition/material';
                this.grid = null;
                this.delMoldClassIds = [];
                this.viewData = new wijmo.collections.CollectionView();
                this.viewData2 = new wijmo.collections.CollectionView();
                this.viewData3 = new wijmo.collections.CollectionView();
                this.viewData4 = new wijmo.collections.CollectionView();
                this.viewData5 = new wijmo.collections.CollectionView();
                this.viewData6 = new wijmo.collections.CollectionView();
                this.viewData8 = new wijmo.collections.CollectionView();
                this.selectedIds = [];

                this.init();
            }

            init() {
                let _this = this;

                this.grid = new wijmo.grid.FlexGrid('#theGrid', {
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.Column,
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    frozenColumns: 4, // 앞에 5개의 컬럼 고정
                    formatItem: (sender, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                    },
                    columns: [
                        {
                            binding: 'selected', // 데이터의 임시 컬럼
                            header: '',
                            width: 40,
                            align: 'center',
                            allowSorting: false,
                            isReadOnly: false, // 체크박스는 편집가능해야함
                            dataType: 'Boolean'
                        },
                        {binding: 'mat_type_name', header: '품목구분', width: 80, align: 'center'},
                        {binding: 'mat_grp_name', header: '품목그룹', width: 100, align: 'left'},

                        {binding: 'mat_name', header: '품목명', width: 220, align: 'left'},
                        {binding: 'mat_code', header: '품목코드', width: 100, align: 'left'},
                        {binding: 'unit_name', header: '단위', width: 100, align: 'center'},
                        {binding: 'starndard1', header: '규격1', width: 150, align: 'right'},
                        {binding: 'standard2', header: '단위중량', width: 150, align: 'right'},
                        {binding: 'class1', header: '분류1', width: 100, align: 'left'},
                        {binding: 'class2', header: '분류2', width: 100, align: 'left'},
                        {binding: 'class3', header: '분류3', width: 100, align: 'left'},
                        {binding: 'usage', header: '용도', width: 150, align: 'left'},
                        {binding: 'customer_barcode', header: '고객바코드', width: 100, align: 'left'},

                        {binding: 'factory_name', header: '공장', width: 100, align: 'center'},
                        {binding: 'mtyn', header: '재고관리유무', width: 100, align: 'center'},
                        {binding: 'useyn', header: '사용중지여부', width: 100, align: 'center'},
                        {binding: 'lotUseYn', header: 'LOT관리 유무', width: 100, align: 'center'},
                        {binding: 'lot_size', header: '로트사이즈', width: 100, align: 'right',},
                        {binding: 'description', header: '비고', width: 250, align: 'left'},

                    ],
                    itemsSource: this.viewData, // 데이터를 설정할 배열
                });

                new FlexGridContextMenu(this.grid);
                this.grid.downloadFileName = '품목 정보';

                // 데이터 로드 후 초기 선택 상태 해제
                this.grid.loadedRows.addHandler(() => {
                    setTimeout(() => {
                        this.grid.select(-1, -1); // 선택 상태 초기화
                    }, 0); // 비동기로 처리하여 초기 선택 해제
                });
                let isInitialLoad = true; // 초기 상태 플래그



                this.grid.hostElement.addEventListener('dblclick', (e) => {
                    let hitTest = this.grid.hitTest(e);
                    if (hitTest.cellType === wijmo.grid.CellType.Cell) {
                        let row = hitTest.row;
                        let selectedItem = this.grid.rows[row].dataItem;
                        let mat_pk = selectedItem.id;

                        // 상세정보 및 모든 탭별 호출
                        _this.showDetail(mat_pk);
                        _this.showPriceList(mat_pk);
                        _this.showBomList(mat_pk);
                        _this.showBomReverseList(mat_pk);
                        _this.showTestList(mat_pk);
                        _this.showRoutingProcessList(mat_pk);
                        // 필요시 추가
                        // 현재 활성화된 탭에 따라 추가 기능 실행
                        if (_this.current_tab == 'tab_unitcost') {
                            _this.showPriceList(mat_pk);
                        } else if (_this.current_tab == 'tab_bom') {
                            if (mat_pk) page.showBomList(mat_pk);
                        } else if (_this.current_tab == 'tab_bom_reverse') {
                            if (mat_pk) page.showBomReverseList(mat_pk);
                        } else if (_this.current_tab == 'tab_routing') {
                            let routing_pk = $('#Routing_id').val();
                            if (routing_pk) page.showRoutingProcessList(routing_pk);
                        } else if (_this.current_tab == 'tab_test_master') {
                            if (mat_pk) page.showTestList(mat_pk);
                        }
                    }
                });

                this.grid.formatItem.addHandler((s, e) => {
                    let col = s.columns[e.col];
                    let item = s.rows[e.row]?.dataItem; // 행에선 row가 없을 수도 있음

                    // 1. 헤더 체크박스 (전체선택)
                    if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader && col.binding === 'selected') {
                        e.cell.innerHTML = `<input type="checkbox" id="allCheck"/>`;
                        let allCheck = e.cell.querySelector('#allCheck');
                        if (allCheck) {
                            // 현재 전체 체크 상태로 표시
                            allCheck.checked = this.grid.itemsSource.items.length > 0 &&
                                this.grid.itemsSource.items.every(row => row.selected);
                            // 이벤트 핸들러 반드시 여기에서 직접 할당!
                            allCheck.onclick = (ev) => {
                                let checked = ev.target.checked;
                                this.grid.itemsSource.items.forEach(row => row.selected = checked);
                                this.grid.refresh(); // 상태 반영!
                                this.updateSelectedIds();
                            }
                        }
                    }
                    // 2. 각 행의 체크박스
                    if (e.panel.cellType === wijmo.grid.CellType.Cell && col.binding === 'selected') {
                        e.cell.innerHTML = `<input type="checkbox" ${item.selected ? 'checked' : ''}/>`;
                        e.cell.firstChild.onclick = (ev) => {
                            item.selected = ev.target.checked;
                            this.updateSelectedIds();
                            this.grid.refresh(); // 전체선택 동기화 위해 refresh
                        }
                    }
                    if (e.panel.cellType === wijmo.grid.CellType.Cell) {
                        let col = s.columns[e.col];
                        let item = s.rows[e.row].dataItem;

                        // 재고관리여부 (1 → 'Y', 0 또는 null → 'N')
                        if (col.binding === "mtyn") {
                            e.cell.textContent = (item.mtyn === 1 || item.mtyn === '1') ? 'Y' : 'N';
                        }

                        // 사용중지여부
                        if (col.binding === "useyn") {
                            e.cell.textContent = (item.useyn === 1 || item.useyn === '1') ? 'Y' : 'N';
                        }

                        // useBOM === 1이면, 특정 컬럼/셀 스타일 적용
                        if (col.binding === "mat_name") {
                            if (item.useBOM === 1 || item.useBOM === '1') {
                                e.cell.style.backgroundColor = "#d4edda";
                            } else {
                                e.cell.style.backgroundColor = "";
                            }
                        }
                    }
                });
                // 일괄삭제 버튼 클릭이벤트
                $('#batchDelete').on('click', () => this.batchDelete());

                this.price_grid = new wijmo.grid.FlexGrid('#price_grid', {
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.Column,
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    formatItem: (sender, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                    },
                    columns: [
                        {binding: 'CompanyName', header: '업체명', width: '*', align: 'left',},
                        {binding: 'type', header: '구분', width: 120, align: 'center',},
                        {binding: 'UnitPrice', header: '단가', width: 120, align: 'right',},
                        {binding: 'FormerUnitPrice', header: '이전단가', width: 120, align: 'right',},
                        {binding: 'ApplyStartDate', header: '적용시작일', width: 120, align: 'center',},
                        {binding: 'ApplyEndDate', header: '적용종료일', width: 120, align: 'center',},
                        {binding: 'ChangerName', header: '변경자', width: 120, align: 'left',},
                        {binding: 'ChangeDate', header: '변경일', width: 120, align: 'center',},
                    ],
                    itemsSource: this.viewData2, // 데이터를 설정할 배열

                });

                this.price_grid.hostElement.addEventListener('dblclick', (e) => {
                    let hitTest = this.price_grid.hitTest(e);
                    if (hitTest.cellType === wijmo.grid.CellType.Cell) {
                        let row = hitTest.row;
                        let selectedItem = this.price_grid.rows[row].dataItem;
                        _this.showPriceDetail(selectedItem.id);
                    }
                });

                this.price_grid.formatItem.addHandler((s, e) => {
                    if (e.panel.cellType === wijmo.grid.CellType.Cell) {
                        let col = s.columns[e.col];
                        let item = s.rows[e.row].dataItem;

                        if (col.binding === "type") {
                            const typeMap = {
                                '01': '매입',
                                '02': '매출',
                                '03': '단가정보',
                                '04': '가공비'
                            };
                            e.cell.textContent = typeMap[item.type] || item.type;
                        }
                    }
                });

                new FlexGridContextMenu(this.price_grid);
                this.grid.downloadFileName = '단가 정보';



                this.bom_grid = new wijmo.grid.FlexGrid('#bom-grid', {
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.Column,
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    formatItem: (sender, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                        if (e.panel.cellType === wijmo.grid.CellType.Cell) {
                            let item = sender.rows[e.row].dataItem; // 현재 행의 데이터 아이템
                            if (item && item.children && item.children.length > 0) {
                                // 부모(그룹) 행 배경색
                                e.cell.style.backgroundColor = '#f0fcf7';
                            } else {
                                // 자식(일반) 행 배경색
                                e.cell.style.backgroundColor = '#ffffff';
                            }
                        }
                    },
                    columns: [
                        {binding: '_level', header: '레벨', width: 100, align: 'left'},
                        {binding: 'my_key', header: 'my_key', width: 100, align: 'left'},
                        {binding: 'mat_type', header: '구분', width: 100, align: 'center'},
                        {binding: 'mat_name', header: '품목', width: 250, align: 'left'},
                        {binding: 'unit', header: '단위', width: 100, align: 'center'},
                        {binding: 'mat_code', header: '품목코드', width: 100, align: 'center'},
                        {binding: 'bom_ratio', header: '소요량', width: 120, align: 'right'},
                        {binding: '', header: '', width: '*', align: 'right'},
                    ],
                    childItemsPath: 'children', // 계층 구조를 위한 속성 설정
                    itemsSource: this.viewData3, // 데이터를 설정할 배열
                });

                new FlexGridContextMenu(this.bom_grid);
                this.grid.downloadFileName = 'BOM 정보';





                this.bom_reverse_grid = new wijmo.grid.FlexGrid('#bom-reverse-grid', {
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.Column,
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    formatItem: (sender, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                        if (e.panel.cellType === wijmo.grid.CellType.Cell) {
                            let item = sender.rows[e.row].dataItem; // 현재 행의 데이터 아이템
                            if (item && item.children && item.children.length > 0) {
                                // 부모(그룹) 행 배경색
                                e.cell.style.backgroundColor = '#f0fcf7';
                            } else {
                                // 자식(일반) 행 배경색
                                e.cell.style.backgroundColor = '#ffffff';
                            }
                        }
                    },
                    columns: [
                        {binding: '_level', header: '레벨', width: 100, align: 'left'},
                        {binding: 'mat_type', header: '구분', width: 100, align: 'center'},
                        {binding: 'mat_name', header: '모품목', width: 200, align: 'left'},
                        {binding: 'unit', header: '단위', width: 100, align: 'center'},
                        {binding: 'mat_code', header: '모품목코드', width: 100, align: 'center'},
                        {binding: 'bom_ratio', header: '투입량', width: 120, align: 'right'},
                        {binding: '', header: '', width: "*", align: 'right'},
                    ],
                    childItemsPath: 'children', // 계층 구조를 위한 속성 설정
                    itemsSource: this.viewData4, // 데이터를 설정할 배열
                });

                new FlexGridContextMenu(this.bom_reverse_grid);
                this.grid.downloadFileName = 'BOM역전개 정보';



                this.routing_grid = new wijmo.grid.FlexGrid('#routing-grid', {
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.Column,
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    formatItem: (sender, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                    },
                    columns: [
                        {binding: 'proc_order', header: '공정순서', width: 100, align: 'left'},
                        {binding: 'proc_code', header: '공정코드', width: 100, align: 'left'},
                        {binding: 'proc_name', header: '공정명', width: 200, align: 'left'},
                        {binding: 'proc_type', header: '공정유형', width: 120, align: 'left'},
                        {binding: '', header: '', width: "*", align: 'left'},
                    ],
                    itemsSource: this.viewData5, // 데이터를 설정할 배열

                });

                new FlexGridContextMenu(this.routing_grid);
                this.grid.downloadFileName = '라우팅 정보';



                this.test_master_grid = new wijmo.grid.FlexGrid('#test-master-grid', {
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.Column,
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true, // 체크박스 클릭 가능하도록 설정
                    formatItem: (sender, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                    },
                    columns: [
                        {binding: 'id', header: '번호', width: 100, align: 'center'},

                        {binding: 'test_master_id', header: '검사마스터번호', visible: false, width: 200, align: 'left'},
                        {binding: 'test_class_name', header: '검사종류', width: 120, align: 'left'},
                        {binding: 'test_master_group_name', header: '검사마스터그룹', width: 120, align: 'left'},
                        {binding: 'test_master_name', header: '검사마스터', width: 150, align: 'left'},
                        {binding: '', header: '', width: "*", align: 'left'},
                    ],
                    itemsSource: this.viewData6, // 데이터를 설정할 배열
                });

                new FlexGridContextMenu(this.test_master_grid);
                this.grid.downloadFileName = '검사정보 정보';




                // filter dropdown load
                AjaxUtil.fillSelectOptions($('#cboMaterialType'), 'system_code', 'all', false, 'mat_type');
                AjaxUtil.fillSelectOptions($('#cboMaterialGroup'), 'material_group', 'all', false);

                $('#cboMaterialType').on('change', function (e) {
                    let mat_type = $('#cboMaterialType').val();
                    AjaxUtil.fillSelectOptions($('#cboMaterialGroup'), 'material_group', 'all', false, mat_type);
                });

                $('#keyword').on('keypress', function (e) {
                    if (event.keyCode == 13) {
                        _this.searchDataBind();
                        resetForms();
                    }
                });

                this.initForm();

                this.setUploader();
            }

            // 품목 그리드 삭제선택 배열 관리
            updateSelectedIds() {
                this.selectedIds = this.grid.itemsSource.items.filter(r => r.selected).map(r => r.id);
            }

            // 일괄삭제(버튼 이벤트 등)
            batchDelete() {
                let ids = this.selectedIds;
                if (!ids.length) {
                    Alert.alert('', '삭제할 품목을 선택하여주세요');
                    return;
                }
                Alert.confirm('', '선택된 품목을 삭제하시겠습니까?', () => {
                    AjaxUtil.postJsonData(this.url + '/batchDelete', { ids }, res => {
                        if (res.success) {
                            Alert.alert('', '삭제되었습니다');
                            this.selectedIds = []; // ✅ 선택 항목 초기화!
                            this.searchDataBind();
                            resetForms();
                        } else {
                            Alert.alert('', res.message);
                        }
                    });
                });
            }

            // 탭 내부 dropdown load
            initForm() {
                AjaxUtil.fillSelectOptions($('#MaterialGroup_id'), 'material_group', '', false); // 품목그룹
                AjaxUtil.fillSelectOptions($('#Unit_id'), 'unit', '', false); // 단위
                AjaxUtil.fillSelectOptions($('#StoreHouse_id'), 'store_house', '', false); // 창고
                AjaxUtil.fillSelectOptions($('#WorkCenter_id'), 'workcenter', '', false); // 워크센터


                $('#WorkCenter_id').change(function (e) {
                    let group_pk = $('#WorkCenter_id').val();
                    AjaxUtil.fillSelectOptions($('#Equipment_id'), 'equipment_code', 'choose', '', group_pk);
                });

                AjaxUtil.fillSelectOptions($('#Factory_id'), 'factory', "", false); // 공장
                AjaxUtil.fillSelectOptions($('#ManagementLevel'), 'user_code', 'choose', false, 'mat_manage_level');
                AjaxUtil.fillSelectOptions($('#EquipmentGroup_id'), 'equipment_group', 'choose', false); // 설비그룹
                AjaxUtil.fillSelectOptions($('#Routing_id'), 'routing', 'choose', false); // 라우팅
                AjaxUtil.fillSelectOptions($('#Company_id'), 'company', 'choose', false); // 업체

                /*AjaxUtil.fillSelectOptions($('#Equipment_id'), 'equipment', 'choose', false); // 생산설비*/
                AjaxUtil.fillSelectOptions($('#MaterialStoreHouse_id'), 'store_house', 'choose', false); // 생산자재창고

                AjaxUtil.fillSelectOptions($('#cboTestMasterGroup'), 'test_master_group', 'choose', false); // 검사마스터
                AjaxUtil.fillSelectOptions($('#cboTestMaster'), 'test_master', 'choose', false); // 검사마스터
            }


            setButtonState() {
                let pk = $('#matBasicForm').find('#id').val();
                $('#btnNew').prop('disabled', false);
                $('#btnSave').prop('disabled', false);
                if (pk) {
                    $('#btnDelete').prop('disabled', false);
                    $('#btnProductionSave').prop('disabled', false);
                    $('#btnInventorySave').prop('disabled', false);
                    $('#btnRoutingSave').prop('disabled', false);
                } else {
                    $('#btnDelete').prop('disabled', true);
                    $('#btnProductionSave').prop('disabled', true);
                    $('#btnInventorySave').prop('disabled', true);
                    $('#btnRoutingSave').prop('disabled', true);
                }
            }

            setPriceButtonState() {
                let pk = $('#matBasicForm').find('#id').val();
                let price_pk = $('#companyPriceForm').find('#price_id').val();
                $('#btnPriceNew').prop('disabled', false);
                $('#btnPriceSave').prop('disabled', false);
                if (pk && price_pk) {
                    $('#btnPriceUpdate').prop('disabled', false);
                    $('#btnPriceDelete').prop('disabled', false);
                } else {
                    $('#btnPriceUpdate').prop('disabled', true);
                    $('#btnPriceDelete').prop('disabled', true);
                }

            }

            // 품목 리스트 조회
            searchDataBind() {
                let _this = this;
                let data = {
                    'mat_type': $('#cboMaterialType').val(),
                    'mat_group': $('#cboMaterialGroup').val(),
                    'keyword': $('#keyword').val(),
                    'action': 'read',
                    'useYn_flag': $('#useYn_flag').is(':checked') ? '1' : '0',
                    spjangcd: sessionStorage.getItem('spjangcd'),
                };

                let result = AjaxUtil.getSyncData(this.url + '/read', data);
                if (result.success) {
                    _this.viewData.sourceCollection = result.data;


                }

                //this.setButtonDisable(false, true, true);
                this.setButtonState();
                //this.setPriceButtonDisabled(true, true, true);
                this.setPriceButtonState();

                this.uploader.mode = 'disabled';
            }

            // 품목 상세 조회
            showDetail(mat_pk) {
                let param = {
                    'id': mat_pk,
                    spjangcd: sessionStorage.getItem('spjangcd')
                };
                let result = AjaxUtil.getSyncData(this.url + '/detail', param);
                if (result.success != null) {
                    let detailData = result.data;
                    FormUtil.BindDataForm(detailData, $('#matBasicForm'));
                    FormUtil.BindDataForm(detailData, $('#matProductionForm'));
                    let group_pk = $('#WorkCenter_id').val();
                    if (group_pk) {
                        AjaxUtil.fillSelectOptions($('#Equipment_id'), 'equipment_code', 'choose', detailData.Equipment_id, group_pk);
                    }
                    FormUtil.BindDataForm(detailData, $('#matStockForm'));
                    FormUtil.BindDataForm(detailData, $('#matTestForm'));
                    FormUtil.BindDataForm(detailData, $('#priceForm'));
                    $('#Routing_id').val(detailData.Routing_id);
                    // lot 체크
                    $('#matStockForm').find('#lot_use_yn').removeAttr('disabled');

                    if (detailData.lotUseYn == 'Y') {
                        $('#matStockForm').find('#lot_use_yn').prop('checked', true);
                    } else {
                        $('#matStockForm').find('#lot_use_yn').prop('checked', false);
                    }

                    if (detailData.mtyn === 1 || detailData.mtyn === '1') {
                        $('#mtyn').prop('checked', true);
                    } else {
                        $('#mtyn').prop('checked', false);
                    }

                    if (detailData.useyn === 1 || detailData.useyn === '1') {
                        $('#useyn').prop('checked', true);
                    } else {
                        $('#useyn').prop('checked', false);
                    }


                    //$('#Routing_id').trigger('change');
                    //FormUtil.BindDataForm(result, $('#matRoutingForm'));
                }

                //this.setButtonDisable(false, false, false);
                this.setButtonState();
                this.uploader.mode = 'active';
            }

            //let testData = FormUtil.extractForm($('#matTestForm'));
            //let data = $.extend({}, basicData, productionData, stockData, testData, routingData);
            /*matBasicForm matProductionForm matStockForm*/

            // 품목 기본정보 저장
            saveData() {
                let _this = this;
                let validate = true;
                let $target = null;

                $('.mat_detail').find('input, select').each(function () {
                    if ($(this).is(':required')) {
                        if (!$(this).val()) {
                            validate = false;
                            $target = $(this);
                            return false;
                        }
                    }
                });

                if (!validate) {
                    Alert.alert('', '필수 항목을 입력해주세요.', function () {
                        $target.focus();
                    });
                    return;
                }


                let url = this.url + '/save';
                let basicData = FormUtil.extractForm($('#matBasicForm'));
                let productionData = FormUtil.extractForm($('#matProductionForm'));
                let stockData = FormUtil.extractForm($('#matStockForm'));
                //let testData = FormUtil.extractForm($('#matTestForm'));
                let routingData = FormUtil.extractForm($('#matRoutingForm'));
                let priceData = FormUtil.extractForm($('#priceForm'));
                //let data = $.extend({}, basicData, productionData, stockData, testData, routingData);
                let data = $.extend({}, basicData, productionData, stockData, routingData, priceData);

                data.spjangcd = sessionStorage.getItem('spjangcd');

                let selectedRowIndex = this.grid.selection.row;
                let selectedId = null;
                if (selectedRowIndex >= 0) {
                    let selectedItem = this.grid.rows[selectedRowIndex].dataItem;
                    selectedId = selectedItem.id;
                }

                let fnSuccess = function (res) {
                    if (!res.success) {
                        Alert.alert('', res.message);
                    } else {
                        Alert.alert('', "저장되었습니다.");
                        _this.searchDataBind();
                        setTimeout(() => {
                            let targetIndex = -1;
                            for (let i = 0; i < _this.grid.rows.length; i++) { // ← 반드시 _this!
                                if (_this.grid.rows[i].dataItem.id === selectedId) {
                                    targetIndex = i;
                                    break;
                                }
                            }
                            if (targetIndex >= 0) {
                                _this.grid.select(targetIndex, 0);
                                _this.grid.scrollIntoView(targetIndex, 0);
                            } else if (_this.grid.rows.length > 0) {
                                _this.grid.select(0, 0);
                                _this.grid.scrollIntoView(0, 0);
                            }
                        }, 0);
                    }
                };

                // 데이터 저장 요청
                AjaxUtil.postAsyncData(url, data, fnSuccess);

            }


            // 라우팅정보 저장
            saveRoutingData() {
                let _this = this;
                let validate = true;
                let $target = null;

                let url = this.url + '/saveRouting';
                let mat_id = $('#id').val();
                let routing_pk = $('#Routing_id').val();
                let param = {
                    'mat_id': mat_id,
                    'routing_pk': routing_pk,
                };

                let fnSuccess = function (res) {
                    if (!res.success) {
                        Alert.alert('', res.message);
                    } else {
                        Alert.alert('', "저장되었습니다.");
                        //_this.searchDataBind();
                    }
                };

                AjaxUtil.postAsyncData(url, param, fnSuccess);

            }

            // 품목 정보 삭제
            deleteData() {
                let _this = this;
                let url = this.url + '/delete';
                let id = $('#matBasicForm').find('#id').val()
                let data = {id: id};

                // 삭제 전 현재 선택된 행 정보 저장
                let selectedRowIndex = this.grid.selection.row;
                let selectedId = null;
                if (selectedRowIndex >= 0) {
                    let selectedItem = this.grid.rows[selectedRowIndex].dataItem;
                    selectedId = selectedItem.id;
                }

                let fnSuccess = function (res) {
                    if (res.success) {
                        Alert.alert('', '삭제되었습니다'); // Notification
                        _this.searchDataBind();
                        resetForms();
                        setTimeout(() => {
                            let targetIndex = -1;
                            for (let i = 0; i < _this.grid.rows.length; i++) { // ← 반드시 _this!
                                if (_this.grid.rows[i].dataItem.id === selectedId) {
                                    targetIndex = i;
                                    break;
                                }
                            }
                            if (targetIndex >= 0) {
                                _this.grid.select(targetIndex, 0);
                                _this.grid.scrollIntoView(targetIndex, 0);
                            } else if (_this.grid.rows.length > 0) {
                                _this.grid.select(0, 0);
                                _this.grid.scrollIntoView(0, 0);
                            }
                        }, 0);
                    } else {
                        Alert.alert('', res.message);
                    }
                };

                AjaxUtil.postAsyncData(url, data, fnSuccess);
            }

            // 업체별 단가 리스트 조회
            showPriceList(mat_pk) {
                let _this = this;
                let data = {'mat_pk': mat_pk};

                let result = AjaxUtil.getSyncData(this.url + '/readPrice', data);
                if (result != null) {
                    result.data.forEach(item => {
                        // Date 객체 추가 (문자열 기반 정렬은 정확하지 않아서)
                        item.ApplyEndDateObj = new Date(item.ApplyEndDate);

                        // ApplyEndDate가 2100-12-31이면 sortFlag로 지정
                        item.sortFlag = item.ApplyEndDate === "2100-12-31" ? 0 : 1;
                    });

                    _this.viewData2.sourceCollection = result.data;

                    // 정렬 순서: 1. 업체명(오름차순), 2. sortFlag(오름차순), 3. 날짜(내림차순)
                    _this.viewData2.sortDescriptions.clear();
                    _this.viewData2.sortDescriptions.push(new wijmo.collections.SortDescription('CompanyName', true));      // 업체명 A → Z
                    _this.viewData2.sortDescriptions.push(new wijmo.collections.SortDescription('sortFlag', true));         // 2100-12-31 우선
                    _this.viewData2.sortDescriptions.push(new wijmo.collections.SortDescription('ApplyEndDateObj', false)); // 최신 날짜 우선

                    $('#companyPriceForm')[0].reset();
                    $('#companyPriceForm').find('#price_id').val('');
                    $('#companyPriceForm').find('input, select').each(function () {
                        if (!$(this).is(':disabled')) {
                            $(this).attr('disabled', 'disabled');
                        }
                    });

                    _this.setPriceButtonState();
                }


            }

            // 업체별 단가히스토리 리스트 조회
            showPriceHistoryList(mat_pk) {
                let _this = this;
                let data = {'mat_pk': mat_pk};

                let result = AjaxUtil.getSyncData(this.url + '/readPriceHistory', data);
                if (result != null) {
                    /*console.log(result);*/
                    _this.viewData2.sourceCollection = result.data;

                    $('#companyPriceForm')[0].reset();
                    $('#companyPriceForm').find('#price_id').val('');
                    $('#companyPriceForm').find('input, select').each(function () {
                        if (!$(this).is(':disabled')) {
                            $(this).attr('disabled', 'disabled');
                        }
                    });

                    //_this.setPriceButtonDisabled(false, true, true);
                    _this.setPriceButtonState();
                }
            }

            // 단가 상세 조회
            showPriceDetail(idx) {
                let param = {'price_id': idx};
                let result = AjaxUtil.getSyncData(this.url + '/detailPrice', param);
                if (result != null) {
                    console.log(result.data);
                    FormUtil.BindDataForm(result.data, $('#companyPriceForm'));

                    // ApplyStartDate를 UTC에서 한국시간(KST)으로 변환하여 datetime-local 포맷으로 설정
                    let applyStartDate = result.data.ApplyStartDate;
                    if (applyStartDate) {
                        let date = new Date(applyStartDate);
                        date.setHours(date.getHours() + 9);

                        // YYYY-MM-DD 형식으로 변환
                        let formattedDate = date.toISOString().substring(0, 10);

                        $('#ApplyStartDate').val(formattedDate);
                    }

                }

                this.setPriceButtonState();
            }

            // 단가 정보 등록/변경
            savePriceData() {
                let _this = this;
                let validate = true;
                let $target = null;
                let mat_id = $('#matBasicForm').find('#id').val();
                let url = this.url + '/savePrice';
                let data = FormUtil.extractForm($('#companyPriceForm'));

                // ApplyStartDate 가공해서 다시 설정
                let applyDate = data.ApplyStartDate; // YYYY-MM-DD
                if (applyDate) {
                    let now = new Date();
                    let hh = String(now.getHours()).padStart(2, '0');
                    let mm = String(now.getMinutes()).padStart(2, '0');
                    let ss = String(now.getSeconds()).padStart(2, '0');
                    data.ApplyStartDate = `${applyDate}T${hh}:${mm}:${ss}`;
                }

                data['Material_id'] = mat_id;
                data['ChangerName'] = userinfo.username;

                let fnSuccess = function (res) {
                    console.log("서버 응답:", res);  // 서버 응답을 콘솔에 출력
                    if (!res.success) {
                        console.error("서버 오류 메시지:", res.message);  // 오류 메시지 확인
                        Alert.alert('', '저장실패: ' + res.message);
                    } else {
                        Alert.alert('', '저장되었습니다');
                        _this.showPriceList(mat_id);
                    }
                };

                $('#companyPriceForm').find('input, select').each(function () {
                    if ($(this).is(':required')) {
                        if (!$(this).val()) {
                            validate = false;
                            $target = $(this);
                            return false;
                        }
                    }
                });

                if (validate) {
                    AjaxUtil.postAsyncData(url, data, fnSuccess);
                } else {
                    Alert.alert('', '필수 항목을 입력해주세요.', function () {
                        $target.focus();
                    });
                }
            }

            // 단가 정보 수정
            updatePriceData() {
                let _this = this;
                let validate = true;
                let $target = null;
                let mat_id = $('#matBasicForm').find('#id').val();
                let url = this.url + '/updatePrice';
                let data = FormUtil.extractForm($('#companyPriceForm'));
                let fnSuccess = function (res) {
                    if (!res.success) {
                        Alert.alert('', res.message);
                    } else {
                        Alert.alert('', '저장되었습니다');
                        _this.showPriceList(mat_id);
                    }
                };

                $('#companyPriceForm').find('input, select').each(function () {
                    if ($(this).is(':required')) {
                        if (!$(this).val()) {
                            validate = false;
                            $target = $(this);
                            return false;
                        }
                    }
                });

                //if ($('#ApplyStartDate').val() > $('#ApplyEndDate').val()) {
                //    Alert.alert('', '적용기간을 확인해주세요.', function () {
                //        $('#ApplyStartDate').focus();
                //    });
                //    return false;
                //}

                data['Material_id'] = mat_id;
                data['ChangerName'] = userinfo.username;

                if (validate) {
                    AjaxUtil.postAsyncData(url, data, fnSuccess);
                } else {
                    Alert.alert('', '필수 항목을 입력해주세요.', function () {
                        $target.focus();
                    });
                }
            }

            // 단가 정보 삭제
            deletePriceData() {
                let _this = this;
                let url = this.url + '/deletePrice';
                let id = $('#companyPriceForm').find('#price_id').val()
                let mat_id = $('#matBasicForm').find('#id').val();
                let data = {id: id};
                let fnSuccess = function () {
                    Alert.alert('', '삭제되었습니다'); // Notification
                    _this.showPriceList(mat_id);
                };

                AjaxUtil.postAsyncData(url, data, fnSuccess);
            }


            // BOM 조회
            showBomList(mat_id) {
                let _this = this;

                let data = {
                    'mat_id': mat_id
                };

                let result = AjaxUtil.getSyncData(this.url + '/bom', data);

                if (result.data && Array.isArray(result.data)) {
                    /*console.log(result.data);*/
                    // 데이터를 계층 구조로 변환
                    let treeData = _this.buildTree(result.data);

                    // FlexGrid의 데이터 갱신
                    _this.bom_grid.itemsSource = treeData;
                } else {
                    // 데이터가 없을 경우 빈 배열 설정
                    _this.bom_grid.itemsSource = [];
                }

                // 데이터 바인딩을 다시 렌더링
                _this.bom_grid.collectionView.refresh();
            }

            /**
             * 부모-자식 관계를 반영하여 계층 구조로 변환하는 함수
             */
            buildTree(flatData) {
                let tree = [];
                let map = {};

                // 모든 항목을 매핑 (my_key를 키로)
                flatData.forEach(item => {
                    map[item.my_key] = {...item, children: []};
                });

                // 부모-자식 관계를 설정
                flatData.forEach(item => {
                    if (item.parent_mat_pk !== null) {
                        if (map[item.parent_mat_pk]) {
                            map[item.parent_mat_pk].children.push(map[item.my_key]);
                        }
                    } else {
                        tree.push(map[item.my_key]); // 최상위 레벨
                    }
                });

                return tree;
            }


            // BOM역전개 조회
            showBomReverseList(mat_id) {
                let _this = this;
                let data = {
                    'mat_id': mat_id
                };

                let result = AjaxUtil.getSyncData(this.url + '/bomReverse', data);

                /* console.log("result: ", result);
                 console.log(JSON.stringify(result, null, 2));*/

                if (result.data && Array.isArray(result.data)) {
                    // 데이터를 계층 구조로 변환
                    let treeData = _this.buildTree2(result.data);

                    // FlexGrid의 데이터 갱신
                    _this.bom_reverse_grid.itemsSource = treeData;
                } else {
                    // 데이터가 없을 경우 빈 배열 설정
                    _this.bom_reverse_grid.itemsSource = [];
                }

                // 데이터 바인딩을 다시 렌더링
                _this.bom_reverse_grid.collectionView.refresh();
            }

            /**
             * 부모-자식 관계를 반영하여 계층 구조로 변환하는 함수
             */
            buildTree2(flatData) {
                let tree = [];
                let map = {};

                // 모든 항목을 매핑 (my_key를 키로)
                flatData.forEach(item => {
                    map[item.my_key] = {...item, children: []};
                });

                // 부모-자식 관계를 설정
                flatData.forEach(item => {
                    if (item.parent_key !== null) {
                        if (map[item.parent_key]) {
                            map[item.parent_key].children.push(map[item.my_key]);
                        }
                    } else {
                        tree.push(map[item.my_key]); // 최상위 레벨
                    }
                });

                return tree;
            }


            // ROUTING 공정정보 조회
            showRoutingProcessList(routing_pk) {
                let _this = this;
                let data = {
                    'routing_pk': routing_pk
                };

                let result = AjaxUtil.getSyncData(this.url + '/routingProcess', data);

                /*console.log("result: ", result);
                console.log(JSON.stringify(result, null, 2));*/

                if (result != null) {
                    let count = result.data.length;

                    _this.viewData5.sourceCollection = result.data;
                }
            }

            //파일 업로더
            setUploader() {
                let _this = this;
                $('#addFile').prop('disabled', false);

                let accept_files = 'jpg,jpeg,gif,png,xlsx,xls';
                let accept = '.' + accept_files.split(',').join(',.');

                //if ($('#fileUploadBox').children().length > 0)
                //    return;
                if (_this.uploader)
                    return;

                _this.uploader = $('#fileUploadDiv').yuFileUploader(
                    {
                        fileIdsCtl: '#srchFileId',
                        dropZone: 'fileuploadAx',
                        boxZone: 'fileuploadAx',
                        others: '', // 파일저장 상위경로
                        filepath: 'material', // 파일저장 하위경로
                        addfileext: 'Y', // 저장시 파일확장자 포함 파일이름저장
                        icons: {
                            'download': '<i class="fa fa-download" aria-hidden="true"></i>',
                            'delete': '<i class="fa fa-minus-circle" aria-hidden="true"></i>'
                        },
                        emptymsg: '파일을 Drag&amp;Drop하거나 클릭하여 업로드를 진행하세요' + '(업로드 후 저장버튼을 클릭하세요.)',

                        multiple: true,  // 멑티업로드 허용여부
                        maxcnt: 5, // 업로드 최대갯수
                        accept: accept, // 허용 확장자 image/* .gif,.jpg,.png
                        accepts: accept_files,    // 드래그로 업로드할 때 체크할 용도
                        fileSize: 50,   // Mega
                        tableName: 'material',
                        attachName: 'drawing',
                    }
                );
                _this.uploader.can_write = userinfo.can_write();
                _this.uploader.mode = 'disable';
            }

            //검사항목
            showTestList(mat_pk) {
                let _this = this;
                if (!mat_pk)
                    return;

                let url = this.url + '/testMaster';
                let data = {
                    'mat_id': mat_pk,
                };

                let result = AjaxUtil.getSyncData(url, data);
                if (result.data != null) {
                    _this.viewData6.sourceCollection = result.data;
                }
            }

            showpriceEdit(data) {
                let _this = this;
                let content = tmpl('MaterialTemplate', data);
                let $content = $(content);

                let modalContainer = new PopupDraggable('히스토리 조회');
                modalContainer.open({width: 1025, height: 500, $content});

                let target = $content.find('#price-history-grid');
                _this.viewData8 = data || [];

                setTimeout(() => {
                    _this.grid8 = new wijmo.grid.FlexGrid('#price-history-grid', {
                        selectionMode: wijmo.grid.SelectionMode.Row,
                        headersVisibility: wijmo.grid.HeadersVisibility.Column,
                        autoGenerateColumns: false,
                        showMarquee: true,
                        isReadOnly: false,
                        formatItem: (sender, e) => {
                            if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                                e.cell.style.textAlign = 'center';
                            }
                        },
                        columns: [
                            {binding: 'CompanyName', header: '업체명', width: '*', align: 'left',},
                            {binding: 'type', header: '구분', width: 120, align: 'center',},
                            {binding: 'UnitPrice', header: '단가', width: 120, align: 'right',},
                            {binding: 'FormerUnitPrice', header: '이전단가', width: 120, align: 'right',},
                            {binding: 'ApplyStartDate', header: '적용시작일', width: 120, align: 'center',},
                            {binding: 'ApplyEndDate', header: '적용종료일', width: 120, align: 'center',},
                            {binding: 'ChangerName', header: '변경자', width: 120, align: 'left',},
                            {binding: 'ChangeDate', header: '변경일', width: 120, align: 'center',},
                        ],
                        itemsSource: _this.viewData8
                    });

                    this.grid8.formatItem.addHandler((s, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.Cell) {
                            let col = s.columns[e.col];
                            let item = s.rows[e.row].dataItem;

                            if (col.binding === "type") {
                                e.cell.textContent = (item.type === '01') ? '매입' : '매출';
                            }
                        }
                    });

                    let $btnTest = $content.find('#btnTest');
                    $btnTest.click(function () {
                        _this.grid8.collectionView.refresh();
                    });
                }, 0);
            }


        }

        let page = null;

        $(document).ready(function (e) {
            page = new MaterialPage();
            //page.searchDataBind();

            // 검색버튼
            $('#btnSearch').click(function (e) {
                page.searchDataBind();
                resetForms();
            });

            $('#keyword').on('keypress', function (e) {
                if (event.keyCode == 13) {
                    page.searchDataBind();
                    resetForms();
                }
            });


            $('.tab_links .tab').click(function (e) {
                let target = e.currentTarget.name;
                page.current_tab = target;
                let mat_pk = $('#matBasicForm').find('#id').val();
                //if (mat_pk == '')
                //    return;
                page.test_grid.setData([]);

                if (target == 'tab_unitcost') {
                    $('#tab_unitcost').removeClass("hidden");
                    if (mat_pk)
                        page.showPriceList(mat_pk);
                } else if (target == 'tab_production') {
                    //$('.tabs .tab_production_tab').css('visibility', 'visible');
                    //$('#tab_production_tab').css('visibility', 'visible');
                } else if (target == 'tab_bom') {
                    $('#tab_bom').removeClass("hidden");
                    if (mat_pk)
                        page.showBomList(mat_pk);
                } else if (target == 'tab_bom_reverse') {
                    $('#tab_bom_reverse').removeClass("hidden");
                    if (mat_pk)
                        page.showBomReverseList(mat_pk);
                } else if (target == 'tab_routing') {
                    $('#tab_routing').removeClass("hidden");
                    let routing_pk = $('#Routing_id').val();
                    //if (routing_pk)
                    page.showRoutingProcessList(routing_pk);
                } else if (target == 'tab_test_master') {
                    $('#tab_test_master').removeClass("hidden");
                    //if (mat_pk)
                    page.showTestList(mat_pk);
                }
            });

            // 기본정보 신규버튼
            $('#btnNew').click(function (e) {

                // 기본정보 리셋
                $('#matBasicForm')[0].reset();
                $('#matBasicForm').find('#id').val('');

                $('#matBasicForm').find('input, select, textarea').each(function () {
                    if ($(this).is(':disabled')) {
                        $(this).removeAttr('disabled');
                    }
                });
                $('#matProductionForm').find('input, select, textarea').each(function () {
                    if ($(this).is(':disabled')) {
                        $(this).removeAttr('disabled');
                    }
                });
                $('#matStockForm').find('input, select, textarea').each(function () {
                    if ($(this).is(':disabled')) {
                        $(this).removeAttr('disabled');
                    }
                });
                $('#priceForm').find('input, select, textarea').each(function () {
                    if ($(this).is(':disabled')) {
                        $(this).removeAttr('disabled');
                    }
                });

                // 생산정보 리셋
                $('#matProductionForm')[0].reset();
                // 재고정보 리셋
                $('#matStockForm')[0].reset();
                // 검사정보 리셋
                $('#matTestForm')[0].reset();
                // 라우팅정보 리셋
                //$('#matRoutingForm')[0].reset();

                // 단가정보 리셋
                /*page.price_grid.setData([]);*/
                $('#companyPriceForm')[0].reset();
                $('#companyPriceForm').find('#price_id').val('');

                $('#companyPriceForm').find('input, select').each(function () {
                    if (!$(this).is(':disabled')) {
                        $(this).attr('disabled', 'disabled');
                    }
                });

                /*page.grid.clearSelect();*/

                //page.setButtonDisable(true, false, true);
                page.setButtonState();
                //page.setPriceButtonDisabled(true, true, true);
                page.setPriceButtonState();

                // uploder
                $('#DataPk').val('');

                let today_string = CommonUtil.getYYYYMMDD();
            });

            // 기본정보 저장버튼
            $(document).on('click', '#btnSave', function (e) {
                let basicData = FormUtil.extractForm($('#matBasicForm'));
                let stockData = FormUtil.extractForm($('#matStockForm'));
                let data = $.extend({}, basicData, stockData);
                console.log("버튼눌림");

                if (!data.MaterialGroup_id) {
                    Alert.alert('', '품목 그룹을 선택해 주세요');
                    $('#matBasicForm #MaterialGroup_id').focus();  // 해당 input으로 포커스 이동
                    return;
                }
                if (!data.Code) {
                    Alert.alert('', '품목코드(바코드)를 입력해 주세요');
                    $('#matBasicForm #Code').focus();  // 해당 input으로 포커스 이동
                    return;
                }
                if (!data.Name) {
                    Alert.alert('', '품목명을 입력해 주세요');
                    $('#matBasicForm #Name').focus();  // 해당 input으로 포커스 이동
                    return;
                }
                if (!data.Unit_id) {
                    Alert.alert('', '단위를 선택해 주세요');
                    $('#matBasicForm #Unit_id').focus();  // 해당 input으로 포커스 이동
                    return;
                }
                if (!data.Factory_id) {
                    Alert.alert('', '공장을 선택해 주세요');
                    $('#matBasicForm #Factory_id').focus();  // 해당 input으로 포커스 이동
                    return;
                }
                if (!data.StoreHouse_id) {
                    Alert.alert('', '기본 재고 창고를 선택해 주세요');
                    $('#matStockForm #StoreHouse_id').focus();  // 해당 input으로 포커스 이동
                    // 탭 이동 및 내용 표시
                    $('a[href="#tab_inventory"]').tab('show');  // 탭 전환
                    $('#tab_basic').hide();
                    $('#tab_inventory').show();  // 해당 탭 내용 표시
                    return;
                }

                // if (!data.MinOrder) {
                //     Alert.alert('', '최소 발주량을 입력해 주세요');
                //     $('#matStockForm #MinOrder').focus();  // 해당 input으로 포커스 이동
                //     // 탭 이동 및 내용 표시
                //     $('a[href="#tab_inventory"]').tab('show');  // 탭 전환
                //     $('#tab_basic').hide();
                //     $('#tab_inventory').show();  // 해당 탭 내용 표시
                //     return;
                // }
                //
                // if (!data.MaxOrder) {
                //     Alert.alert('', '최대 발주량을 입력해 주세요');
                //     $('#matStockForm #MaxOrder').focus();  // 해당 input으로 포커스 이동
                //     // 탭 이동 및 내용 표시
                //     $('a[href="#tab_inventory"]').tab('show');  // 탭 전환
                //     $('#tab_basic').hide();
                //     $('#tab_inventory').show();  // 해당 탭 내용 표시
                //     return;
                // }
                //
                // if (!data.ValidDays) {
                //     Alert.alert('', '사용기한(일)를 입력해 주세요');
                //     $('#matStockForm #ValidDays').focus();  // 해당 input으로 포커스 이동
                //     // 탭 이동 및 내용 표시
                //     $('a[href="#tab_inventory"]').tab('show');  // 탭 전환
                //     $('#tab_basic').hide();
                //     $('#tab_inventory').show();  // 해당 탭 내용 표시
                //     return;
                // }

                Alert.confirm('',
                    '저장하시겠습니까?',
                    function () {
                        page.saveData()
                    },
                    function () {
                    }
                );
            });


            // 기본정보 삭제버튼
            $('#btnDelete').click(function (e) {
                Alert.confirm('',
                    '삭제하시겠습니까?',
                    function () {
                        page.deleteData()
                    },
                    function () {
                    }
                );
            });

            // 단가 히스토리버튼
            $('#btnPriceHistory').click(function (e) {
                let price_grid = wijmo.Control.getControl('#price_grid');
                let selectedRow = price_grid.selection.row;

                // 선택한 행의 데이터 가져오기 (단일 객체)
                let selectedItem = price_grid.rows[selectedRow].dataItem;
                /*console.log(selectedItem);*/
                let id = selectedItem.Material_id; // ID 값 가져오기
                let id2 = selectedItem.Company_id;
                let data = {
                    'mat_pk': id,
                    'com_pk': id2
                }

                let url = '/api/definition/material/readPriceHistory';
                let result = AjaxUtil.getSyncData(url, data);
                if (result.success) {
                    page.showpriceEdit(result.data);
                } else {
                    Alert.alert('', "오류가 발생했습니다.");
                }
            });


            $('#cboTestMasterGroup').change(function (e) {
                let group_pk = $('#cboTestMasterGroup').val();
                AjaxUtil.fillSelectOptions($('#cboTestMaster'), 'test_master', 'choose', '', group_pk);
            });


            /* let newRow = {
                    id: 0,
                    delete: false, // 체크박스 기본값
                    test_master_id: test_master_id,
                    test_class_name: '',
                    test_master_group_name: $('#cboTestMasterGroup option:selected').text(),
                    test_master_name: $('#cboTestMaster option:selected').text()
                };*/

            //검사정보 신규버튼
            $('#btnAddTestMaster').click(function (e) {
                let mat_id = $('#matBasicForm').find('#id').val();
                let test_master_id = $('#cboTestMaster').val();

                if (!test_master_id) return;

                // 그리드 객체 가져오기
                let grid = page.test_master_grid;

                // itemsSource를 배열로 변환
                let data = grid.collectionView ? grid.collectionView.sourceCollection : [];

                // 중복 체크
                let already = data.some(row => row.test_master_id == test_master_id);
                if (already) return;

                // 새 행 데이터 생성
                row = {};
                row["id"] = 0;
                row["test_master_id"] = test_master_id;
                row["test_class_name"] = '';
                row["test_master_group_name"] = $('#cboTestMasterGroup option:selected').text();
                row["test_master_name"] = $('#cboTestMaster option:selected').text();

                // 데이터 추가
                data.push(row);

                // 그리드 갱신
                grid.collectionView.refresh();
            });

            //검사정보 저장버튼
            $('#btnSaveTest').click(function (e) {
                let url = page.url + '/save_test_master';
                let mat_id = $('#matBasicForm').find('#id').val();
                let InTestYN = $('#matTestForm').find('#InTestYN').prop('checked') ? 'Y' : '';
                let OutTestYN = $('#matTestForm').find('#OutTestYN').prop('checked') ? 'Y' : '';

                let grid = page.test_master_grid;

                // collectionView.sourceCollection을 사용하여 데이터 가져오기
                let list = grid.collectionView ? grid.collectionView.sourceCollection : [];
                list = JSON.stringify(list);

                let data = {
                    'mat_id': mat_id,
                    'InTestYN': InTestYN,
                    'OutTestYN': OutTestYN,
                    'Q': list,
                };

                let result = AjaxUtil.postSyncData(url, data);
                /*console.log(result);*/
                if (result.data != null) {
                    Alert.alert('', "저장되었습니다.");
                    page.showTestList(mat_id);
                }

            });

            $('#btnDelTestMaster').click(function (e) {
                let url = page.url + '/save_test_master';
                let mat_id = $('#matBasicForm').find('#id').val();
                let InTestYN = $('#matTestForm').find('#InTestYN').prop('checked') ? 'Y' : '';
                let OutTestYN = $('#matTestForm').find('#OutTestYN').prop('checked') ? 'Y' : '';

                let grid = page.test_master_grid;
                let selectedRow = grid.selection.row; // 선택된 행 인덱스
                /*console.log("선택된 행의 인덱스:", selectedRow);*/

                if (selectedRow >= 0) {
                    let viewdata2 = grid.collectionView.items; // 데이터를 올바르게 가져오기
                    /*console.log("전체 데이터 목록:", viewdata2);*/

                    let selectedItem = viewdata2[selectedRow];
                    /*console.log("선택된 행의 데이터:", selectedItem);*/

                    if (!selectedItem || !selectedItem.id) {
                        /*console.log("삭제할 데이터의 ID가 없음:", selectedItem);*/
                        /*Alert.alert('삭제할 데이터의 ID를 찾을 수 없습니다.');*/
                        return;
                    }

                    let deletedId = selectedItem.id;
                    /*console.log("삭제할 ID:", deletedId);*/

                    // 행 제거
                    grid.collectionView.remove(selectedItem);

                    // 최신 데이터 리스트 변환
                    let list = JSON.stringify(grid.collectionView.items);

                    let data = {
                        'mat_id': mat_id,
                        'InTestYN': InTestYN,
                        'OutTestYN': OutTestYN,
                        'Q': list,
                        'deletedId': deletedId
                    };

                    // 서버에 데이터 전송
                    AjaxUtil.postAsyncData(url, data, function (result) {
                        /*console.log(result);*/
                        if (result.data != null) {
                            Alert.alert('', "삭제되었습니다.");
                            page.showTestList(mat_id); // 갱신된 데이터 반영
                        } else {
                            Alert.alert('', '서버 처리에 실패했습니다.');
                        }
                    });
                } else {
                    Alert.alert('삭제할 행을 선택하세요.');
                }
            });

            // 단가정보 신규버튼
            $('#btnPriceNew').click(function (e) {
                // 단가 상세정보 리셋
                $('#companyPriceForm')[0].reset();
                $('#companyPriceForm').find('#price_id').val('');

                $('#companyPriceForm').find('input, select').each(function () {
                    if ($(this).is(':disabled')) {
                        $(this).removeAttr('disabled');
                    }
                });

                page.setPriceButtonState();

                $('#ApplyStartDate').val(CommonUtil.getYYYYMMDD());
            });

            // 단가등록/변경 버튼
            $('#btnPriceSave').click(function (e) {
                Alert.confirm('',
                    '저장하시겠습니까?',
                    function () {
                        page.savePriceData()
                    },
                    function () {
                    }
                );
            });

            // 단가정보 수정버튼
            $('#btnPriceUpdate').click(function (e) {
                Alert.confirm('',
                    '저장하시겠습니까?',
                    function () {
                        page.updatePriceData()
                    },
                    function () {
                    }
                );
            });

            // 단가정보 삭제버튼
            $('#btnPriceDelete').click(function (e) {
                Alert.confirm('',
                    '삭제하시겠습니까?',
                    function () {
                        page.deletePriceData()
                    },
                    function () {
                    }
                );
            });

            // 라우팅 선택
            $('#Routing_id').change(function (e) {
                let route_pk = $('#Routing_id').val();
                page.showRoutingProcessList(route_pk);
            });

            // 라우팅 저장버튼
            $('#btnRoutingSave').click(function (e) {
                Alert.confirm('',
                    '라우팅 정보를 저장하시겠습니까?',
                    function () {
                        page.saveRoutingData()
                    },
                    function () {
                    }
                );
            });


            $('#btnExcel').click(function (e) {
                page.grid.exportExcel('품목정보.xls');
            });


            if (userinfo.group_code == 'admin') {
                //$('#btnGridSetting').show();
                //$('#btnGridSetting').attr('style', 'visibility:visible');
                $('#btnGridSetting').css('visibility', 'visible');
            }

            $(".tab-links a").on("click", function () {
                const id = $(this).attr("id");
                const showButtons = ["tabs_basic", "tabs_production", "tabs_inventory", "tabs_unitcost"];

                if (showButtons.includes(id)) {
                    $(".button-wrap.button-list").show();

                    if (id === "tabs_unitcost") {
                        // 저장 버튼만 이동해서 보여주기
                        $("#btnNew").parent().hide();
                        $("#btnDelete").parent().hide();

                        // 저장 버튼을 따로 복사해서 옮겨 붙이기
                        const $saveBtn = $("#btnSave").closest("li").clone();
                        // 버튼 안의 <button>에 다시 id 부여
                        $saveBtn.find("button").attr("id", "btnSave");

                        $saveBtn.find("#btnSave").addClass("unitcost-save-btn");
                        $("#unitcostSaveButtonContainer").html($saveBtn).show();


                        // 기존 버튼 영역 숨기기
                        $(".button-wrap.button-list").hide();
                    } else {
                        // 버튼들 원래대로 복원
                        $(".button-wrap.button-list li").show();
                        $(".button-wrap.button-list").show();
                        $("#unitcostSaveButtonContainer").hide();
                    }

                } else {
                    $(".button-wrap.button-list").hide();
                    $("#unitcostSaveButtonContainer").hide();
                }
            });


            page.searchDataBind();
            resetForms();
        });

        // 1. 폼 리셋 유틸 함수
        function resetForms() {
            // 기본정보 리셋
            $('#matBasicForm')[0].reset();
            $('#matBasicForm').find('#id').val('');
            // 재고정보 리셋
            $('#matProductionForm')[0].reset();
            // 재고정보 리셋
            $('#matStockForm')[0].reset();
            // 검사정보 리셋
            $('#matTestForm')[0].reset();
            // 라우팅정보 리셋
            //$('#matRoutingForm')[0].reset();
            // 도면 파일 리셋
            //_this.setUploader();

            //$('#mat_detail').find('input, select').each(function () {
            $('.mat_detail').find('input, select').each(function () {
                if (!$(this).is(':disabled')) {
                    $(this).attr('disabled', 'disabled');
                }
            });

            // 단가정보 리셋
            /*$('#priceForm')[0].reset();*/

            /*_this.price_grid.setData([]);*/
            $('#companyPriceForm')[0].reset();
            $('#companyPriceForm').find('#price_id').val('');
            $('#companyPriceForm').find('input, select').each(function () {
                if (!$(this).is(':disabled')) {
                    $(this).attr('disabled', 'disabled');
                }
            });
        }
    </script>

</th:block>
</html>