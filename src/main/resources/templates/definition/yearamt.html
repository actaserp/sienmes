<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">
<head>
    <style>
        .wj-header {
            text-align: center !important;
        }
    </style>
</head>

<th:block layout:fragment="content">
    <div class="layout-contents">
        <!-- Page Title -->
        <div class="page-title-wrap">
            <div class="left">
                <h2>ë§¤ì…ë§¤ì¶œë…„ë§ˆê°</h2>
                <a title="ë¶ë§ˆí¬" class="bookmark toggle">
                    ë‚´ë©”ë‰´
                </a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
                <li>ê¸°ì¤€ì •ë³´</li>
                <li>ë§¤ì…ë§¤ì¶œë…„ë§ˆê°</li>
            </ul>
        </div>

        <section class="section">
            <div class="section-top">
                <div class="search-wrap">
                    <dl>
                        <dt>
                            <label>ì—°ë„</label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <select  id="cboYear" name="cboYear"></select>
                            </div>
                        </dd>
                    </dl>

                    <dl>
                        <dt>
                            <label>êµ¬ë¶„</label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <select  id="ioflag" name="ioflag">
                                    <option value="0">ë§¤ì¶œ</option>
                                    <option value="1">ë§¤ì…</option>
                                </select>
                            </div>
                        </dd>
                    </dl>

                    <dl id="searchComArea">
                        <dt>
                            ê±°ë˜ì²˜
                        </dt>
                        <dd>
                            <input type="text" id="btnCompanySearch" name="btnCompanySearch" placeholder="ì…ë ¥ í›„ ì—”í„°ë¥¼ ëˆŒëŸ¬ ê²€ìƒ‰í•˜ì„¸ìš”."/>
                            <input type="hidden" id="cboCompanyHidden">
                            <input type="hidden"  id="cltflag" name="cltflag"/>
                            <input type="hidden" id="spjangcdHidden">
                        </dd>
                    </dl>

                    <dl>
                        <dt><span class="eq"></span></dt>
                        <dd>
                            <li>
                                <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnSearch">
                                    <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                    ê²€ìƒ‰
                                </a>
                            </li>
                        </dd>
                    </dl>

                    <dl>
                        <dt>
                            <label>ë§ˆê°ìœ ë¬´ ì „ì²´ì„ íƒ</label>
                        </dt>
                        <dd>
                            <input type="checkbox" id="Allcheck">
                        </dd>
                    </dl>


                </div>

                <div class="button-wrap">
                    <ul>
                        <li>
                            <button type="button" class="btn-excellt btn-default" id="btnMagam"
                                    style="width: 115px; height: 36px;">ë§ˆê°</button>
                        </li>

                        <li>
                            <button type="button" class="btn-delete btn-default" id="btnMagamCancel"
                                    style="width: 115px; height: 36px; display: none;">ë§ˆê°ì·¨ì†Œ</button>
                        </li>

                    </ul>
                </div>
            </div> <!--//section-top end -->
            <div class="container-fluid">
                <p id="selectedItem"></p>
                <div id="yearamt-grid" style="height: 720px; max-height: 720px;"></div>
            </div>
        </section>
    </div> <!--//layout-contents end -->


</th:block>
<th:block layout:fragment="scripts">
    <th:block th:replace="/common/popup_company_employee_bank_card.html :: popup_company"></th:block>
    <script type="text/javascript">
        class YearamtPage {
            constructor() {
                this.grid = null;
                this.selectedPk = null;
                this.viewData = new wijmo.collections.CollectionView();
                this.baseUrl = '/api/definition/yearamt';
                this.init();
            }

            init() {
                let _this = this;

                // FlexGrid ì´ˆê¸°í™”
                this.grid = new wijmo.grid.FlexGrid('#yearamt-grid', {
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.All,
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: false,
                    formatItem: (sender, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                    },
                    columns: [
                        {binding: 'id', header: 'ê±°ë˜ì²˜ID', width: 100, align: 'center', isReadOnly: true},
                        {binding: 'cltflag', header: 'ê±°ë˜ì²˜êµ¬ë¶„', width: 100, visible: false },
                        //{binding: 'cltflagnm', header: 'ê±°ë˜ì²˜êµ¬ë¶„', width: 100, align: 'center'},
                        {binding: 'company_name', header: 'ê±°ë˜ì²˜ëª…', width: 270, align: 'center', isReadOnly: true},
                        {binding: 'ioflag', header: 'ë§¤ì¶œ/ë§¤ì…êµ¬ë¶„', width: 120, align: 'center', isReadOnly: true},
                        {binding: 'yyyymm', header: 'ë§ˆê°ë…„ì›”', width: 130, align: 'center', isReadOnly: true},
                        {binding: 'balance', header: 'ë§ˆê°ê¸ˆì•¡', width: 250, align: 'right'},
                        {binding: 'endyn', header: 'ë§ˆê°ìœ ë¬´', width: 130, align: 'center', dataType: 'Boolean'},
                        {binding: '', header: '', width: "*", align: 'left'},
                    ],
                    itemsSource: this.viewData, // ë°ì´í„°ë¥¼ ì„¤ì •í•  ë°°ì—´
                });

                // ë°ì´í„° ë¡œë“œ í›„ ì´ˆê¸° ì„ íƒ ìƒíƒœ í•´ì œ
                this.grid.loadedRows.addHandler(() => {
                    setTimeout(() => {
                        this.grid.select(-1, -1); // ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
                    }, 0); // ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬í•˜ì—¬ ì´ˆê¸° ì„ íƒ í•´ì œ
                });

                let selector = new wijmo.grid.selector.Selector(this.grid, {
                    itemChecked: function () {

                    }
                })

                // selectionChanged ì´ë²¤íŠ¸ ì²˜ë¦¬ (this.gridì—ì„œ í˜¸ì¶œ)
                let isInitialLoad = true; // ì´ˆê¸° ìƒíƒœ í”Œë˜ê·¸
                this.grid.selectionChanged.addHandler((s, e) => {
                    if (isInitialLoad) {
                        isInitialLoad = false; // ì´ˆê¸° ë¡œë“œ ì´í›„ í”Œë˜ê·¸ í•´ì œ
                        return;
                    }

                    let selectedRowIndex = s.selection.row; // ì„ íƒëœ í–‰ì˜ ì¸ë±ìŠ¤
                    if (selectedRowIndex >= 0) { // ìœ íš¨í•œ í–‰ì´ ì„ íƒë˜ì—ˆëŠ”ì§€ í™•ì¸
                        let selectedRowData = s.rows[selectedRowIndex].dataItem; // ì„ íƒëœ í–‰ì˜ ë°ì´í„°
                        console.log(selectedRowData); // ì„ íƒëœ ë°ì´í„° ì¶œë ¥

                        // ë§ˆê° ì—¬ë¶€ì— ë”°ë¼ ë²„íŠ¼ í‘œì‹œ ìƒíƒœ ì¡°ì ˆ
                        if (selectedRowData.endyn === true) {
                            document.getElementById("btnMagam").style.display = "none";
                            document.getElementById("btnMagamCancel").style.display = "";
                        } else {
                            document.getElementById("btnMagam").style.display = "";
                            document.getElementById("btnMagamCancel").style.display = "none";
                        }

                    }
                });

                // ì…€ í¬ë§·íŒ…
                this.grid.formatItem.addHandler((s, e) => {
                    if (e.panel.cellType === wijmo.grid.CellType.Cell) {
                        let col = s.columns[e.col];
                        let item = s.rows[e.row].dataItem;

                        if (col.binding === "ioflag") {
                            e.cell.textContent = (item.ioflag === 0 || item.ioflag === '0') ? 'ë§¤ì¶œ' : 'ë§¤ì…';
                        }

                        // yyyymmì„ yyyy-mmìœ¼ë¡œ í¬ë§·
                        if (col.binding === "yyyymm" && item.yyyymm) {
                            let yyyymm = item.yyyymm.toString();
                            if (yyyymm.length === 6) {
                                e.cell.textContent = yyyymm.substring(0, 4) + '-' + yyyymm.substring(4, 6);
                            }
                        }
                    }
                });

                // ContextMenu ë° ë‹¤ìš´ë¡œë“œ íŒŒì¼ ì„¤ì •
                new FlexGridContextMenu(this.grid);
                this.grid.downloadFileName = 'ê±°ë˜êµ¬ë¶„';

                // 'Allcheck' ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
                document.getElementById('Allcheck').addEventListener('change', function () {
                    let isChecked = this.checked;

                    // viewDataê°€ CollectionViewì¼ ê²½ìš° .items ë°°ì—´ ì‚¬ìš©
                    _this.viewData.items.forEach(item => {
                        item.endyn = isChecked;
                    });

                    // ê·¸ë¦¬ë“œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
                    _this.grid.invalidate();
                });
            }


            //  ì¡°íšŒ
            searchMainData() {
                let _this = this;
                let param = {
                    'cboYear': $('#cboYear').val(),
                    'ioflag': $('#ioflag').val(),
                    'searchId': $('#cboCompanyHidden').val(),
                    'searchname': $('#btnCompanySearch').val(),
                    spjangcd: sessionStorage.getItem('spjangcd'),
                }

                let url = '/api/definition/yearamt';

                let result = AjaxUtil.getSyncData(url + '/read',param);

                if (result.data != null) {
                    result.data.forEach(item => {
                        item.endyn = (item.endyn == 'Y');
                    });
                    /*console.log(result.data);*/
                    _this.viewData.sourceCollection = result.data;
                }

            }


            saveMagam() {
                let _this = this;
                let url = '/api/definition/yearamt/magam';

                // ì„ íƒëœ í–‰ë“¤ ê°€ì ¸ì˜¤ê¸°
                let selectedItems = _this.grid.rows
                    .filter(row => row.isSelected)  // Selectorì—ì„œ ì²´í¬ëœ í–‰
                    .map(row => row.dataItem);

                // ìœ íš¨ì„± ì²´í¬
                if (selectedItems.length === 0) {
                    Alert.alert('', 'ì„ íƒëœ í–‰ì´ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // ì„œë²„ë¡œ ì „ì†¡í•  ë°ì´í„°
                let data = {
                    list: selectedItems
                };

                /*console.log(data);*/

                let fnSuccess = function (res) {
                    Alert.alert('', 'ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤');
                    _this.searchMainData(); // ì €ì¥ í›„ ê°±ì‹ 
                };
                AjaxUtil.postJsonData(url, data, fnSuccess);

            }

            saveMagamCancel() {
                let _this = this;
                let url = '/api/definition/yearamt/magamCancel';

                // ì„ íƒëœ í–‰ë“¤ ê°€ì ¸ì˜¤ê¸°
                let selectedItems = _this.grid.rows
                    .filter(row => row.isSelected)  // Selectorì—ì„œ ì²´í¬ëœ í–‰
                    .map(row => row.dataItem);

                // ìœ íš¨ì„± ì²´í¬
                if (selectedItems.length === 0) {
                    Alert.alert('', 'ì„ íƒëœ í–‰ì´ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // ì„œë²„ë¡œ ì „ì†¡í•  ë°ì´í„°
                let data = {
                    list: selectedItems
                };

                /*console.log(data);*/

                let fnSuccess = function (res) {
                    Alert.alert('', 'ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');
                    _this.searchMainData(); // ì €ì¥ í›„ ê°±ì‹ 
                };
                AjaxUtil.postJsonData(url, data, fnSuccess);
            }


        }

        function companyPopupOpenCustom(intputId, hiddenid, hiddenflag){

            const value = document.getElementById(intputId).value;

            let poppage = new PopCompComponentCustom(value);

            let result = AjaxUtil.getSyncData('/api/popup/search_Comp_Custom', { item2 : value, spjangcd : getSpjangcdFromSession() });

            let searchcallback = function (items) {

                document.getElementById(intputId).focus();

                document.getElementById(intputId).value = items.item2;
                document.getElementById(hiddenid).value = items.id;
                document.getElementById(hiddenflag).value = items.cltflag;
            };
            if(result && result.data.length === 1){
                searchcallback(result.data[0]);   ``
                return;
            }

            poppage.show(searchcallback, result.data);
        }

        let page = null;

        $(document.body).ready(function (e) {
            page = new YearamtPage();

            AjaxUtil.fillSelectOptions($('#cboYear'), 'data_year', '', false, function() {
                // ì½œë°±ì—ì„œ ì²« ë²ˆì§¸ ì˜µì…˜ì„ ìë™ ì„ íƒ
                $('#cboYear').val($('#cboYear option:first').val());
            });

            page.searchMainData();
            //ê²€ìƒ‰
            $('#btnSearch').click(function (e) {
                page.searchMainData();
            });

            $('#btnCompanySearch').on('click keydown', function (e) {
                if (e.type === 'keydown' && (e.key === 'Enter' || e.keyCode === 13)) {
                    e.preventDefault();

                    companyPopupOpenCustom('btnCompanySearch', 'cboCompanyHidden', 'cltflag');
                }
            });
            $('#btnCompanySearch').on('input', function () {
                const val = $(this).val();
                if (val === '') {
                    $('#cboCompanyHidden').val('');
                    $('#cltflag').val('');
                }
            });

            $('#btnSave').click(function (e) {
                Alert.confirm('',
                    'ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                    function () {
                        page.saveData()
                    },
                    function () {
                    }
                );
            });

            $('#btnMagam').click(function (e) {
                Alert.confirm('',
                    'ë§ˆê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                    function () {
                        page.saveMagam()
                    },
                    function () {
                    }
                );
            });

            $('#btnMagamCancel').click(function (e) {
                Alert.confirm('',
                    'ë§ˆê°ì·¨ì†Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                    function () {
                        page.saveMagamCancel()
                    },
                    function () {
                    }
                );
            });




            $('#btnDel').click(function (e) {

                Alert.confirm('',
                    'ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                    function () {
                        page.deleteData()
                    },
                    function () {
                    }
                );

            });

            $('#btnNew').click(function (e) {
                $('#tradeForm')[0].reset();
                $('#tradeForm').find('#id').val('');
            });

            $('#searchtradenm').on('keypress', function (e) {
                if (event.keyCode == 13) {
                    page.searchMainData();
                }
            });

            // .btn-clear í´ë¦­ í›„ input ì´ë²¤íŠ¸ ê°•ì œ ë°œìƒ
            $(document).on('click', '.btn-clear', function () {
                const $input = $(this).siblings('input[type="text"]');
                $input.val('');
                $input.trigger('input'); // ğŸ”¥ input ì´ë²¤íŠ¸ ê°•ì œ ë°œìƒ
            });
            // ì´ˆê¸°í™” ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            $('#btnClear').click(function () {

                document.getElementById('cboCompany').value = '';
                document.getElementById('cboCompanyHidden').value = '';
            });

        });
    </script>
</th:block>

</html>