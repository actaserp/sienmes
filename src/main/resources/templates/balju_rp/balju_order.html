<html layout:decorate="~{layout_page}">

<th:block layout:fragment="content">
  <div class="layout-contents">
    <div class="page-title-wrap">
      <div class="left">
        <h2>ë°œì£¼ ë“±ë¡(ê°œë³„)</h2>
        <a title="ë¶ë§ˆí¬" class="bookmark toggle">
          ë‚´ ë©”ë‰´
        </a>
      </div>
      <ul class="page-navi">
        <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
        <li>ë°œì£¼/ìˆ˜ë¶ˆê´€ë¦¬</li>
        <li>ë°œì£¼ ë“±ë¡</li>
      </ul>
    </div>

    <section class="section">
      <div class="section-top">
        <div class="search-wrap">
          <input type="hidden" id="spjangcdHidden" name="spjangcd"/>
          <dl>
            <dt>
              <label for="cboDateKind">
                ê²€ìƒ‰ êµ¬ë¶„<span class="eq"></span>
              </label>
            </dt>
            <dd>
              <div class="srch-box">
                <select id="cboDateKind" name="cboDateKind">
                  <option value="sales">ë°œì£¼ì¼</option>
                  <option value="delivery">ë‚©ê¸°ì¼</option>
                </select>
              </div>
            </dd>
          </dl>
          <dl>
            <dt>
              ì¡°íšŒê¸°ê°„<span class="eq">*</span>
            </dt>
            <dd>
              <ul class="date-box">
                <li>
                  <input type="date" id="srchStartDt" name="srchStartDt">
                  <label for="srchStartDt" class="hide">ì‹œì‘ì¼</label>
                </li>
                <li>
                  <input type="date" id="srchEndDt" name="srchEndDt">
                  <label for="srchEndDt" class="hide">ì¢…ë£Œì¼</label>
                </li>
              </ul>
            </dd>
          </dl>

          <dl>
            <dt>&nbsp;</dt>
            <dd>
              <li>
                <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnSearch">
                  <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                  <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                  ê²€ìƒ‰
                </a>
              </li>
            </dd>
          </dl>
        </div>
        <div class="button-wrap">
          <ul>
            <li>
              <a class="btn btn-excell" title="ë“±ë¡" id="btnMail">
                <img src="/images/icon/ico-mail.svg" alt="ë©”ì¼ ì•„ì´ì½˜">
                ë©”ì¼ ì „ì†¡
              </a>
            </li>
            <li>
              <a class="btn btn-excell" title="ë“±ë¡" id="btnAddNew">
                <img src="/images/icon/ico-plus.svg" alt="ë“±ë¡ ì•„ì´ì½˜">
                ë“±ë¡
              </a>
            </li>
            <li>
              <a class="btn btn-delete" title="ì‚­ì œ" id="btnDelete">
                <img src="/images/icon/ico-delete.svg" alt="ì‚­ì œ ì•„ì´ì½˜">
                ì‚­ì œ
              </a>
            </li>
            <li>
              <a class="btn btn-edit" title="ìˆ˜ì •" id="btnEdit">
                <img src="/images/icon/ico-edit.svg" alt="ìˆ˜ì • ì•„ì´ì½˜">
                ìˆ˜ì •
              </a>
            </li>
          </ul>
        </div>
      </div>
      <div class="container-fluid">
        <div id="theGrid" style="height: 730px;"></div>
      </div>
    </section>
  </div>
  </div>

  <script type="text/x-tmpl" id="baljuTemplate">
    <style>

  /* ì•„ì´í…œ í…Œì´ë¸” ì „ì²´ ì„¤ì • */
  .item-table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    margin-top: 10px;
  }

  /* í—¤ë” ì…€ ìŠ¤íƒ€ì¼ */
  .item-table th {
    background-color: #EDEFF5;
    text-align: center;
    font-weight: bold;
    padding: 8px;
    border: 1px solid #ccc;
  }

  /* ë°”ë”” ì…€ ìŠ¤íƒ€ì¼ */
  .item-table td {
    padding: 6px;
    text-align: center;
    border: 1px solid #ccc;
  }

  /* ì…ë ¥ í•„ë“œ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
  .item-table input {
    width: 100%;
    box-sizing: border-box;
    padding: 4px;
  }

  /* í’ˆëª© & ë¹„ê³  ì™¼ìª½ ì •ë ¬ */
  .item-table td:first-child,
  .item-table td:nth-child(6) {
    text-align: left;
  }

  /* ê³µí†µ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
  .item-table .btn.in_btn {
    display: inline-flex;
    justify-content: center;
    align-items: center;
    width: 32px;
    height: 32px;
    border-radius: 4px;
    padding: 0;
    border: 1px solid #B3B3B3;
    background-color: #fff;
    cursor: pointer;
    transition: background-color 0.2s;
    line-height: 0;
  }

  /* + ë²„íŠ¼ ì „ìš© ìŠ¤íƒ€ì¼ */
  .item-table .btn.in_btn.plus img {
    width: 10px;
    height: 10px;
    display: block;
  }

  /* ê³µí†µ ì•„ì´ì½˜ ë²„íŠ¼ ì´ë¯¸ì§€ (ì‚­ì œ, ê²€ìƒ‰ í¬í•¨) */
  .item-table .btn.in_btn img {
    width: 12px;
    height: 12px;
    display: block;
    margin-right:5px;
  }
  .input-with-button {
    display: flex;
    gap: 4px; /* ë²„íŠ¼ê³¼ input ì‚¬ì´ ì—¬ë°± */
    align-items: center;
  }

  .input-with-button input {
    flex: 1; /* ë‚˜ë¨¸ì§€ ì˜ì—­ ì°¨ì§€ */
    min-width: 0;
    padding: 4px;
  }

  .input-with-button .btn.in_btn {
    flex-shrink: 0;
  }
    .content_wrap.popup {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .table-wrap {
      flex: 1;
      overflow-y: auto;
      padding-right: 5px;
    }
    .popup-button {
      flex-shrink: 0;
      padding: 10px;
      background: #fff;
      border-top: 1px solid #ddd;
    }
    .input-with-checkbox {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .input-with-checkbox input[type="number"] {
      flex: 1;
      min-width: 0;
      padding: 4px;
    }

    .input-with-checkbox input[type="checkbox"] {
      flex-shrink: 0;
      width: 18px;
      height: 18px;
    }
    </style>

    <div class="content_wrap popup" id="div_excel_upload">
    <div class="table-wrap">
      <form id="baljuForm">
        <table class="write-table">
          <caption>ë°œì£¼ë“±ë¡ í…Œì´ë¸”</caption>
          <input type="hidden" id="id" name="id">
          <input type="hidden" id="spjangcdHidden" name="spjangcd"/>
          <tbody>
          <tr>
            <th style="text-align: center">
              <label for="JumunDate">ë°œì£¼ì¼</label>
            </th>
            <td>
              <input type="date" id="JumunDate" name="JumunDate">
            </td>
            <th style="text-align: center">
              <label for="DueDate">ë‚©ê¸°ì˜ˆì •ì¼</label>
            </th>
            <td>
              <input type="date" id="DueDate" name="DueDate">
            </td>
          </tr>
          <tr>
            <th style="text-align: center">
              <label for="cboCompany">êµ¬ë§¤ì²˜*</label>
            </th>
            <td colspan="3">
              <input id="cboCompany" name="Company_id" type="hidden">
              <input class="form-control2" type="text" id="CompanyName" name="CompanyName"
                     placeholder="ê²€ìƒ‰ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ êµ¬ë§¤ì²˜ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”" readonly/>
              &nbsp;
              <a class="btn btn-delete" title="êµ¬ë§¤ì²˜ê²€ìƒ‰" id="btnCompanySearch">
                <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                êµ¬ë§¤ì²˜ ê²€ìƒ‰
              </a>
            </td>
          </tr>
          <tr>
            <th style="text-align: center">
              <label for="cboBaljuType">ë°œì£¼êµ¬ë¶„</label>
            </th>
            <td>
              <select id="cboBaljuType" name="SujuType"></select>
            </td>
            <th style="text-align: center">
              <label for="StateName">ìƒíƒœ</label>
            </th>
            <td>
              <input type="text" id="StateName" name="StateName" readonly disabled>
            </td>
          </tr>
          <tr>
            <th style="text-align: center">
              <label for="special_note">íŠ¹ì´ì‚¬í•­</label>
            </th>
            <td colspan="3">
              <textarea id="special_note" name="special_note" style="height: 90px"></textarea>
            </td>
          </tr>
          <tr>
              <th style="text-align: center">
                  <label for="BaljuTotalPrice">ì´ ë°œì£¼ì•¡</label>
              </th>
              <td colspan="8">
                  <input id="BaljuTotalPrice" name="BaljuTotalPrice" style="width: 100%;" readonly ></input>
              </td>
          </tr>
        </table>

        <table class="item-table">

            <colgroup>
              <col style="width: 25%">
              <col style="width: 5%">
              <col style="width: 20%">
              <col style="width: 12%">
              <col style="width: 12%">
              <col style="width: 12%">
              <col style="width: 15%">
              <col style="width: 5%">
            </colgroup>
            <thead>
              <tr id="itemHeaderRow">
                <th>í’ˆëª©</th>
                <th>ìˆ˜ëŸ‰</th>
                <th>ë‹¨ê°€ (ì²´í¬ë°•ìŠ¤ ì„ íƒì‹œ ë¶€ê³¼ì„¸ í¬í•¨)</th>
                <th>ê³µê¸‰ê°€ì•¡</th>
                <th>ë¶€ê³¼ì„¸</th>
                <th>í•©ê³„</th>
                <th>ë¹„ê³ </th>
                <th>
                  <a class="btn in_btn plus" id="addRemark" title="ì¶”ê°€">
                    <img src="/images/icon/ico-plus.svg" alt="ë“±ë¡ ì•„ì´ì½˜" />
                  </a>
                </th>
              </tr>
            </thead>
            <tr class="item-template-row" style="display: none;">
              <td>
                <div class="input-with-button">
                  <input type="text" name="txtProductName" placeholder="ì…ë ¥ í›„ ì—”í„°" />
                  <input type="hidden" name="MaterialGroupName" />
                  <input type="hidden" name="Material_id" />
                  <input type="hidden" name="product_code" />
                  <a class="btn in_btn" title="í’ˆëª© ê²€ìƒ‰" id="btnProductSearch" >
                    <img src="/images/icon/btn-srch-black.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜" />
                  </a>
                </div>
              </td>
              <td><input type="text" name="quantity" placeholder="ìˆ˜ëŸ‰" /></td>
              <td>
                <div class="input-with-checkbox">
                  <input type="text" name="BaljuUnitPrice" min="0" placeholder="ë‹¨ê°€" />
                  <input type="checkbox" id="VatIncluded" name="VatIncluded" checked />
                </div>
              </td>
              <td><input type="text" name="BaljuPrice" readonly /></td>
              <td><input type="text" name="BaljuVat" readonly /></td>
                <td><input type="text" name="totalAmount" readonly /></td>
              <td><input type="text" name="description" /></td>
              <td class="al_c item_border">
                <a class="btn in_btn" title="ì‚­ì œ" onclick="removeItemRow(this)">
                  <img src="/images/icon/ico-delete.svg" alt="ì‚­ì œ ì•„ì´ì½˜" />
                </a>
              </td>
            </tr>
          </tbody>
        </table>
      </form>
    </div>
    <div class="popup-button">
      <button type="button" class="btn-popup y_write_auth" id="btnPopBaljuStop">ì¤‘ì§€</button>
      <button type="button" class="btn-popup y_write_auth" id="btnPopBaljuSave">ì €ì¥</button>
      <button type="button" class="btn-popup" id="modal-close-button">ë‹«ê¸°</button>
    </div>
  </script>

</th:block>

<th:block layout:fragment="scripts">
  <!--<th:block th:replace="/common/columns_setting :: columns_setting"></th:block>-->
  <th:block th:replace="/common/multiform_material :: multiform_material"></th:block>
  <th:block th:replace="/common/popup_company :: popup_company"></th:block>
  <script type="text/javascript">
    class SujuUploadPage {
      constructor() {
        this.url = '/api/balju/balju_order';
        this.grid = null;
        this.$btnEdit = $('#btnEdit');
        this.$btnAddNew = $('#btnAddNew');
        this.spjangcd = $('#spjangcdHidden');
        this.viewData = new wijmo.collections.CollectionView();
        this.init();
      }

      init() {
        let _this = this;
        this.grid = new wijmo.grid.FlexGrid('#theGrid', {
          selectionMode: wijmo.grid.SelectionMode.Row,
          headersVisibility: wijmo.grid.HeadersVisibility.Column,
          autoGenerateColumns: false,
          showMarquee: true,
          isReadOnly: true,
          formatItem: (sender, e) => {
            if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
              e.cell.style.textAlign = 'center';
            }
          },
          columns: [
            {binding: 'CompanyName', header: 'êµ¬ë§¤ì²˜', width: 120},
            {binding: 'BaljuTypeName', header: 'êµ¬ë¶„', width: 70, align: 'center'},
            {binding: 'JumunDate', header: 'ë°œì£¼ì¼', width: 120, align: 'center'},
            {binding: 'MaterialGroupName', header: 'ì œí’ˆê·¸ë£¹', width: 100},
            {binding: 'product_code', header: 'ì œí’ˆì½”ë“œ', width: 100},
            {binding: 'product_name', header: 'ì œí’ˆëª…', width: 100},
            {binding: 'unit', header: 'ë‹¨ìœ„', width: 60, align: 'center'},
            {binding: 'SujuQty', header: 'ìˆ˜ëŸ‰', width: 60, align: 'right', format: 'n0'},
            {binding: 'BaljuUnitPrice', header: 'ë‹¨ê°€', width: 100, align: 'right'},
            {binding: 'BaljuPrice', header: 'ê³µê¸‰ê°€', width: 100, align: 'right'},
            {binding: 'BaljuVat', header: 'ë¶€ê³¼ì„¸', width: 100, align: 'right'},
            {binding: 'BaljuTotalPrice', header: 'ë°œì£¼ì•¡', width: 100, align: 'right'},
            {binding: 'StateName', header: 'ìƒíƒœ', width: 80, align: 'center'},
            {binding: 'SujuQty2', header: 'ê¸°ì…ê³ ìˆ˜ëŸ‰', width: 100, align: 'right'},
            {binding: 'SujuQty3', header: 'ë¯¸ì…ê³ ìˆ˜ëŸ‰', width: 100, align: 'right'},
            {binding: 'ShipmentStateName', header: 'ë‚©í’ˆì¥ì†Œ', width: 100, align: 'center'},
            {binding: 'DueDate', header: 'ë‚©ê¸°ì˜ˆì •ì¼', width: 120, align: 'center'},
            {binding: 'Description', header: 'ë¹„ê³ ', width: 200}
          ],
          itemsSource: this.viewData, // ë°ì´í„°ë¥¼ ì„¤ì •í•  ë°°ì—´
        });

        new FlexGridContextMenu(this.grid);
        this.grid.downloadFileName = 'ë°œì£¼ ë“±ë¡';

        this.grid.hostElement.addEventListener('dblclick', function (e) {
          let items = _this.grid.selectedItems;
          if (items.length === 0) {
            return false;
          }
          _this.$btnEdit.trigger('click');
        });

        let nowDate = CommonUtil.getYYYYMMDD();
        let dueDate = CommonUtil.getYYYYMMDD(10);

        //ë°œì£¼ë“±ë¡ í´ë¦­
        this.$btnAddNew.click(function (e) {
          let defaultData = {
            id: '',
            mode: 'new',
            JumunDate: nowDate,
            DueDate: dueDate,
            State: 'draft',
            spjangcd: _this.spjangcd.val()
          };
          _this.showBaljuForm(defaultData);
        });

        // ë°œì£¼ ìˆ˜ì • í´ë¦­
        this.$btnEdit.click(function (e) {
          let selectedItems = _this.grid.selectedItems;

          if (selectedItems.length === 1) {

            let selected = selectedItems[0];

            let data = {
              id: selected.id,
              SujuQty3: selected.SujuQty3,
              action: 'detail'
            };
            let fnsuccess = function (result) {
              result.data['mode'] = 'edit';
              result.data['SujuQty3'] = selected.SujuQty3;
              _this.showBaljuForm(result.data);
            };
            AjaxUtil.getAsyncData(_this.url + '/detail', data, fnsuccess);
          } else if (items.length > 1) {
            Alert.alert('', 'ë°ì´í„°ë¥¼ í•˜ë‚˜ë§Œ ì„ íƒí•˜ì„¸ìš”.');
          } else {
            Alert.alert('', 'ì„ íƒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          }

        });

        // ì‚­ì œ ë²„íŠ¼
        $('#btnDelete').click(function (e) {
          let items = _this.grid.selectedItems;
          if (items.length > 0) {
            Alert.confirm('', 'ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
              function () {
                let id = items[0].id;
                let state = items[0].State;

                _this.deleteSujuData(id, state);
              },
              function () {
              }
            );
          } else {
            Alert.alert('', 'ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', function () {
              $(this).focus();
            });
          }
        });

        // ì—”í„°í‚¤ ê²€ìƒ‰
        $('#keyword').on('keypress', function (e) {
          if (e.keyCode === 13) {
            _this.searchMainData();
          }
        });
      }

      showBaljuForm(data) {
        //baljuTemplate
        let _this = this;
        let content = tmpl('baljuTemplate', data);
        let $content = $(content);

        let modalContainer = null;
        if (data.mode === 'new') {
          modalContainer = new PopupDraggable('ë°œì£¼ ë“±ë¡');
        } else {
          modalContainer = new PopupDraggable('ë°œì£¼ ìˆ˜ì •');
        }

        //ëª¨ë‹¬ í¬ê¸°
        modalContainer.open({width: 1250, height: 630, $content});
        $('#popSrchDt1').ax5DatePicker({direction: 'top'});
        $('#popSrchDt2').ax5DatePicker({direction: 'top'});

        // ì œí’ˆê²€ìƒ‰
        let $btnProductSearch = $content.find('#btnProductSearch');
        let $btnCompanySearch = $content.find('#btnCompanySearch');
        let $MaterialGroupName = $content.find('#MaterialGroupName');
        let $product_code = $content.find('#product_code');
        let $txtProductName = $content.find('#txtProductName');
        let $Material_id = $content.find('#Material_id');

        let $baljuForm = $content.find('#baljuForm');

        let $cboBaljuType = $content.find('#cboBaljuType');
        let $cboMaterial = $content.find('#cboMaterial');
        let $JumunDate = $content.find('#JumunDate');
        let $DueDate = $content.find('#DueDate');

        let $AvailableStock = $('#AvailableStock');
        let $unit = $('#unit');
        let $cboCompany = $('#cboCompany');
        let $CompanyName = $('#CompanyName');
        let $quantity = $('#quantity');
        let $SujuQty = $('#SujuQty');
        let $BaljuUnitPrice = $content.find('#BaljuUnitPrice');
        let $BaljuPrice = $content.find('#BaljuPrice');
        let $BaljuVat = $content.find('#BaljuVat');
        let $isVatExempt = false;
        let $BaljuTotalPrice = $content.find('#BaljuTotalPri');
        let $vatCheck = $content.find('#VatIncluded');

        let $sujuQty3 = $content.find('#sujuQty3');

        $content.find('#spjangcdHidden').val(data.spjangcd || '');

        if (data.mode === 'new') {
          $btnProductSearch.removeAttr('disabled');

        }
        $vatCheck.change(function () {
          updateBaljuPrice();
          calculateFromTotalPrice();
          calculateFromSupplyPrice();
        });

        $btnProductSearch.click(function (e) {
          let pop = new PopMatComponent();
          pop.material_type = 'product,sangpum';
          pop.show(function (item) {
            console.log('$btnProductSearch', item);
            $txtProductName.val(item.Name);
            $Material_id.val(item.id);
            $product_code.val(item.Code);
            $MaterialGroupName.val(item.group_name);
            $isVatExempt = item.VatExemptionYN === 'Y';
            // ë¶€ê°€ì„¸ UI ì²˜ë¦¬
            if (item.VatExemptionYN === 'Y') {
              $BaljuVat.prop('readonly', true).val('ë©´ì„¸').css({'background-color': '', 'color': ''});
              $('#VatExempt').val('Y');
            } else {
              $BaljuVat.prop('readonly', true).val('')
                .css({'background-color': '', 'color': '', 'text-align': ''});
              $('#VatExempt').val('N');
            }

            if ($Material_id.val() && $cboCompany.val()) {
              tryShowBaljuPrice();
            }
          });
          pop.searchDataBind();
        });

        $content.find('#btnCompanySearch').click(function () {
          let poppage = new PopCompComponent();
          let $poppage = $(poppage);
          let searchcallback = function (items) {
            console.log('btnCompanySearch', items);
            $content.find('#cboCompany').val(items.id);
            $content.find('#CompanyName').val(items.compname);
            $isVatExempt = items.VatExemptionYN === 'Y';
            if (items.VatExemptionYN === 'Y') {
              $BaljuVat.prop('readonly', true).val('ë©´ì„¸').css({'background-color': '', 'color': ''});
              $('#VatExempt').val('Y');
            } else {
              $BaljuVat.prop('readonly', true).val('')
                .css({'background-color': '', 'color': '', 'text-align': ''});
              $('#VatExempt').val('N');
            }

            if ($Material_id.val() && $cboCompany.val()) {
              tryShowBaljuPrice();
            }
          };

          poppage.show(searchcallback);
        });

        let originalUnitPrice = null;

        //ë‹¨ê°€ ê²€ìƒ‰
        function tryShowBaljuPrice() {
          console.log("ğŸ” [tryShowBaljuPrice] ë‹¨ê°€ ê²€ìƒ‰ í•¨ìˆ˜ í˜¸ì¶œë¨");

          const mat_pk = $content.find('#Material_id').val();
          const company_id = $content.find('#cboCompany').val();
          const JumunDate = $content.find('#JumunDate').val();
          let url = _this.url + '/price';

          if (!mat_pk || !company_id || !JumunDate) return;

          let data = {
            'mat_pk': mat_pk,
            'company_id': company_id,
            'JumunDate': JumunDate
          };

          AjaxUtil.getAsyncData(url, data, function (result) {
            console.log('ë‹¨ê°€ ê²€ìƒ‰ ì‘ë‹µ ë°ì´í„° : ', result);
            if (result && result.data && result.data.length > 0) {
              const item = result.data[0];
              const unitPrice = item.UnitPrice || 0;
              const vat = item.vat || 0;
              const supplyPrice = unitPrice * 1;

              $content.find('#unitPrice').prop('readonly', true).val(unitPrice);
              originalUnitPrice = unitPrice;

              $BaljuUnitPrice.val(unitPrice);
              formatNumberInput(unitPrice.toString(), '#BaljuUnitPrice'); // ì½¤ë§ˆ í¬ë§· ì ìš©

              $BaljuPrice.val(supplyPrice);
              formatNumberInput(supplyPrice.toString(), '#BaljuPrice');   // ì½¤ë§ˆ í¬ë§· ì ìš©

            } else {
              $content.find('#unitPrice').val('0');
              originalUnitPrice = '0';

              $BaljuUnitPrice.val('');
              $BaljuPrice.val('');
              $BaljuVat.val('').prop('readonly', true);
            }
          });
        }

        // ì €ì¥ë²„íŠ¼
        let $btnPopBaljuSave = $('#btnPopBaljuSave');
        // ì¤‘ì§€ ë²„íŠ¼
        let $btnPopBaljuStop = $content.find('#btnPopBaljuStop');
        // ìƒíƒœ ê°’ ì •ë¦¬
        const isCanceled = (data.State || '').toLowerCase() === 'canceled';
        const isDraft = (data.State || '').toLowerCase() === 'draft';
        const isFullyReceived = Number(data.SujuQty3 || 0) === 0;
        // ë“±ë¡ ëª¨ë“œì¼ ê²½ìš° â†’ ë²„íŠ¼ ìˆ¨ê¹€
        if (data.mode === 'new') {
          $btnProductSearch.removeAttr('disabled');
          $btnPopBaljuStop.hide();
        } else {
          // ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€
          if (isCanceled || !isFullyReceived || isDraft) {
            $btnPopBaljuStop.show();
            $btnPopBaljuStop.text(isCanceled ? 'ì¤‘ì§€ì·¨ì†Œ' : 'ì¤‘ì§€');
          } else {
            $btnPopBaljuStop.hide();
          }
          // ìƒíƒœê°€ draftê°€ ì•„ë‹ˆë©´ ì €ì¥ ë²„íŠ¼ ìˆ¨ê¸°ê³  ë‹¨ê°€ ì½ê¸° ì „ìš©
          if (!isDraft) {
            $btnPopBaljuSave.hide();
            $BaljuUnitPrice.prop('readonly', true);
          }
        }

        //ë°œì£¼êµ¬ë¶„(ì •ê¸°ë¥¼ ë””í´íŠ¸ë¡œ)
        AjaxUtil.fillSelectOptions($cboBaljuType, 'system_code', 'choose', 'Regular', 'Balju_type');

        //íŒì—…íƒ€ì´í‹€ ì„¤ì •
        let $popTitle = $content.find('#popTitle');
        if (data.mode === 'new') {
          $popTitle.text('ë°œì£¼ ë“±ë¡');
        } else {
          // ë°œì£¼ ìˆ˜ì •ì‹œ ì œí’ˆê·¸ë£¹ê³¼ ì œí’ˆì„ ìˆ˜ì •í•˜ê²Œ í•  ê²ƒ ì¸ì§€?
          $popTitle.text('ë°œì£¼ ìˆ˜ì •');

          if (data.Company_id) {
            $CompanyName.attr('readonly', true);
          }
          originalUnitPrice = parseFloat(data.BaljuUnitPrice || '0');
        }
        FormUtil.BindDataForm(data, $baljuForm);


        if (data.SujuQty > 0) {
          $SujuQty.val(data.SujuQty.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
        }

        // íŒì—… ì¤‘ì§€ë²„íŠ¼ í´ë¦­
        $btnPopBaljuStop.click(function (e) {
          // í˜„ì¬ ë²„íŠ¼ í…ìŠ¤íŠ¸ë¡œ ìƒíƒœ íŒë‹¨ (ì¤‘ì§€ / ì¤‘ì§€ì·¨ì†Œ)
          const isCanceled = $btnPopBaljuStop.text() === 'ì¤‘ì§€ì·¨ì†Œ';
          const confirmMsg = isCanceled ? 'ì¤‘ì§€ì·¨ì†Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?' : 'ì¤‘ì§€ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
          const notifyMsg = isCanceled ? 'ë°œì£¼ê°€ ì¤‘ì§€ì·¨ì†Œ ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ë°œì£¼ê°€ ì¤‘ì§€ ë˜ì—ˆìŠµë‹ˆë‹¤.';

          Alert.confirm('', confirmMsg, function () {
            let url = _this.url + '/balju_stop';

            console.log("ğŸ“¤ ì „ì†¡ë  ë°œì£¼ì •ì§€ ë°ì´í„°:", data);

            let fnSaveSuccess = function (result) {
              Notify.success(notifyMsg);
              _this.searchMainData();
              modalContainer.close();
            };
            AjaxUtil.postAsyncData(url, data, fnSaveSuccess);
          });
        });

        // ë°œì£¼ë“±ë¡ íŒì—… ì €ì¥ë²„íŠ¼ í´ë¦­
        $btnPopBaljuSave.click(function (e) {

          //ë°œì£¼ì¼, ë‚©ê¸°ì¼ ì²´í¬?
          let data = FormUtil.extractForm($baljuForm);
          const isVat = $('#VatIncluded').is(':checked');
          data.invatyn = isVat ? 'Y' : 'N';

          if ((data.Material_id == null) || (data.Material_id === '')) {
            Alert.alert('', 'ì œí’ˆì„ ì„ íƒí•˜ì„¸ìš”.');
            return;
          }

          if (($CompanyName.val() == null) || ($CompanyName.val() === '')) {
            Alert.alert('', 'êµ¬ë§¤ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
            return;
          }

          if ($SujuQty.val() === '') {
            Alert.alert('', 'ë°œì£¼ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.');
            return;
          }
          let currentUnitPrice = $content.find('#BaljuUnitPrice').val().replace(/,/g, '');  // ë°œì£¼ ë‹¨ê°€ í•„ë“œ ID í™•ì¸ í•„ìˆ˜
          let unitPriceChanged = originalUnitPrice != null &&
            parseFloat($content.find('#BaljuUnitPrice').val().replace(/,/g, '')) !== originalUnitPrice;
          console.log('ë¶€ê°€ì„¸ ì ìš© ì—¬ë¶€:', isVat);

          Alert.confirm('', 'ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function () {

            // ë°œì£¼ ì €ì¥ í•¨ìˆ˜ ì •ì˜
            let doSave = function () {
              let url = _this.url + '/manual_save';

              // ìˆ«ì í¬ë§· ì œê±°
              data.SujuQty = data.SujuQty.replace(/,/g, '');
              data.BaljuPrice = data.BaljuPrice.replace(/,/g, '');
              data.BaljuUnitPrice = data.BaljuUnitPrice.replace(/,/g, '');
              data.BaljuVat = (data.BaljuVat === 'ë©´ì„¸') ? '0' : data.BaljuVat.replace(/,/g, '');
              // data.BaljuVat = data.BaljuVat.replace(/,/g, '');
              data.BaljuTotalPrice = data.BaljuTotalPrice.replace(/,/g, '');
              data.spjangcd = $('#spjangcdHidden').val();

              console.log("ğŸ“¤ ì „ì†¡ë  ë°œì£¼ ë°ì´í„°:", data);

              AjaxUtil.postAsyncData(url, data, function (result) {
                Notify.success("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                _this.searchMainData();
                modalContainer.close();
              });
            };

            // ë‹¨ê°€ ë³€ê²½ì´ ìˆëŠ” ê²½ìš° â†’ ë‹¨ê°€ ë¨¼ì € ì €ì¥
            if (unitPriceChanged) {
              let now = new Date();
              let hh = String(now.getHours()).padStart(2, '0');
              let mm = String(now.getMinutes()).padStart(2, '0');
              let ss = String(now.getSeconds()).padStart(2, '0');

              let applyStartDate = `${data.JumunDate}T${hh}:${mm}:${ss}`;

              let priceData = {
                Material_id: data.Material_id,
                Company_id: data.Company_id,
                UnitPrice: currentUnitPrice,
                ApplyStartDate: applyStartDate,  // âœ… ìˆ˜ì •ëœ ê°’ ì‚¬ìš©!
                type: '01',
                ChangerName: userinfo.username,
                spjangcd: _this.spjangcd.val()
              };

              AjaxUtil.postAsyncData('/api/definition/material/savePrice', priceData, function (res) {
                if (res.success) {
                  console.log('âœ… ë‹¨ê°€ ì €ì¥ ì„±ê³µ');
                  doSave();
                } else {
                  Alert.alert('ë‹¨ê°€ ì €ì¥ ì‹¤íŒ¨', res.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                }
              });
            } else {
              // ë‹¨ê°€ ë³€ê²½ ì—†ìœ¼ë©´ ë°œì£¼ ì €ì¥ ë°”ë¡œ ì‹¤í–‰
              doSave();
            }
          });
        });

        FormUtil.BindDataForm(data, $baljuForm);

        // íŒì—… ë™ì  ë¶€ë¶„
        let itemIndex = 1;

        const ProductInputHandler = {
          bind: function ({rowSelector}) {
            const $row = $(rowSelector);

            // ìˆ«ì í¬ë§· ì ìš© ëŒ€ìƒ í•„ë“œë“¤
            const formatFields = [
              'input[name^="quantity_"]',
              'input[name^="BaljuUnitPrice_"]',
              'input[name^="BaljuPrice_"]',
              'input[name^="BaljuVat_"]',
              'input[name^="totalAmount_"]'
            ];

            formatFields.forEach(selector => {
              $row.find(selector).off('keyup').on('keyup', function () {
                formatNumberInput($(this).val(), this);
              });

              $row.find(selector).each(function () {
                if ($(this).val()) {
                  formatNumberInput($(this).val(), this);
                }
              });
            });

            // ğŸ” ê³„ì‚° ì´ë²¤íŠ¸ ë°”ì¸ë”©
            $row.find('input[name^="quantity_"], input[name^="BaljuUnitPrice_"]').off('keyup change').on('keyup change', function () {
              calculateAmount({ row: $row });
            });

            $row.find('input[name^="VatIncluded"]').off('change').on('change', function () {
              calculateAmount({ row: $row });
            });

            // ğŸ” ì œí’ˆ ê²€ìƒ‰ ê¸°ëŠ¥ (ê¸°ì¡´ ê·¸ëŒ€ë¡œ ìœ ì§€)
            const $input = $row.find('input[name^="txtProductName_"]');
            const $id = $row.find('input[name^="Material_id_"]');
            const $code = $row.find('input[name^="product_code_"]');
            const $group = $row.find('input[name^="MaterialGroupName_"]');
            const $next = $row.find('input[name^="quantity_"]');

            function set(item) {
              $input.val(item.Name);
              $id.val(item.id);
              $code.val(item.Code);
              $group.val(item.group_name);

              setTimeout(() => {
                $next.focus().select();
              }, 10);
            }

            $input.off('keydown').on('keydown', function (e) {
              if (e.key === 'Enter') {
                e.preventDefault();
                const keyword = $input.val();
                const spjangcd = sessionStorage.getItem('spjangcd');

                if (!keyword) return showPopup();

                $.get('/api/popup/search_material', { keyword, spjangcd }, function (res) {
                  if (res.data?.length === 1) {
                    set(res.data[0]);
                  } else {
                    showPopup();
                  }
                });

                function showPopup() {
                  const pop = new PopMatComponent();
                  pop.material_type = 'product,sangpum';

                  pop.show(set, keyword);

                  setTimeout(() => {
                    if (pop.$keyword) {
                      pop.$keyword.val(keyword);
                      if (pop.$cboMaterialGrp) pop.$cboMaterialGrp.val('');
                      pop.searchDataBind();
                    }
                  }, 100);
                }
              }
            });
          }
        };

        // í–‰ ì¶”ê°€
        $content.find('#addRemark').click(function () {
          const $tbody = $content.find('.item-table tbody');
          const $template = $tbody.find('.item-template-row');

          for (let i = 0; i < 3; i++) {
            const $newRow = $template.clone().removeClass('item-template-row').show();

            $newRow.find('input').each(function () {
              const baseName = $(this).attr('name');
              if (baseName) {
                $(this).attr('name', `${baseName}_${itemIndex}`);
              }
            });

            $newRow.find('a[title="ì‚­ì œ"]').attr('id', `btnDelItem_${itemIndex}`);

            $tbody.append($newRow);
            ProductInputHandler.bind({rowSelector: $newRow});

            itemIndex++;
          }
        });

        // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ íŒì—…
        $content.on('click', 'a[title="í’ˆëª© ê²€ìƒ‰"]', function () {
          const $row = $(this).closest('tr');

          const $productInput = $row.find('input[name^="txtProductName_"]');
          const $productId = $row.find('input[name^="Material_id_"]');
          const $productCode = $row.find('input[name^="product_code_"]');
          const $materialGroup = $row.find('input[name^="MaterialGroupName_"]');

          const pop = new PopMatComponent();
          pop.material_type = 'product,sangpum';

          pop.show(function (item) {
            $productInput.val(item.Name);
            $productId.val(item.id);
            $productCode.val(item.Code);
            $materialGroup.val(item.group_name);
          });
        });
        // í¬ì»¤ìŠ¤ ìë™ ì´ë™
        $content.on('keydown', 'input', function (e) {
          if (e.key !== 'Enter') return;
          e.preventDefault();

          const $input = $(this);
          const $row = $input.closest('tr');
          const nameAttr = $input.attr('name') || '';

          if (nameAttr.startsWith('quantity_')) {
            $row.find('input[name^="BaljuUnitPrice_"]').focus().select();
          } else if (nameAttr.startsWith('BaljuUnitPrice_')) {
            $row.find('input[name^="description_"]').focus().select();
          } else if (
            nameAttr.startsWith('BaljuPrice') ||
            nameAttr.startsWith('BaljuVat') ||
            nameAttr.startsWith('totalAmount')

          ) {
            $row.find('input[name^="description_"]').focus().select();
          } else if (nameAttr.startsWith('description_')) {
            const $nextRow = $row.nextAll('tr:visible').first();
            const $nextInput = $nextRow.find('input[name^="txtProductName_"]');
            if ($nextInput.length) $nextInput.focus().select();
          }
        });

        // ì´ˆê¸° í–‰ 3ê°œ ì¶”ê°€
        setTimeout(() => {
          $content.find('#addRemark').trigger('click');
        }, 10);

      }


      deleteSujuData(id, state) {
        let _this = this;
        let url = _this.url + '/delete';
        let data = {'id': id, 'State': state}
        let fnsuccess = function (res) {
          if (res.success) {
            Notify.success('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            _this.searchMainData();
          } else {
            Alert.alert('', res.message);
          }
        };

        AjaxUtil.postAsyncData(url, data, fnsuccess);
      }

      searchMainData() {
        let _this = this;
        let date_kind = $('#cboDateKind').val();  //ë°œì£¼êµ¬ë¶„
        let start = $('#srchStartDt').val();  //ì‹œì‘ì¼
        let end = $('#srchEndDt').val();      //ì¢…ë£Œì¼
        let url = this.url + '/read';

        let data = {
          'date_kind': date_kind,
          'start': start,
          'end': end,
          'action': 'read',
          spjangcd: this.spjangcd.val()
        };

        let fnsuccess = function (result) {
          if (result != null) {
            _this.viewData.sourceCollection = result.data;
          }
        };
        AjaxUtil.getAsyncData(url, data, fnsuccess);
      }
    }

    //í–‰ ì‚­ì œ í•¨ìˆ˜
    function removeItemRow(el) {
      const $tbody = $(el).closest('tbody');
      const $rows = $tbody.find('tr:not(.item-template-row)');
      const $targetRow = $(el).closest('tr');

      if ($rows.length <= 3) {
        // ì…ë ¥ê°’ì´ ìˆìœ¼ë©´ ì´ˆê¸°í™”ë§Œ í•˜ê³  ë¦¬í„´
        const hasData = $targetRow.find('input[type="text"], input[type="number"]').filter(function () {
          return $(this).val().trim() !== '';
        }).length > 0;

        if (hasData) {
          $targetRow.find('input[type="text"], input[type="number"]').val('');
          // hidden ê°’ë„ ì´ˆê¸°í™”í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì¶”ê°€
          $targetRow.find('input[type="hidden"]').val('');
        }

        return;
      }

      // 4ê°œ ì´ìƒì´ë©´ ì •ìƒ ì‚­ì œ
      $targetRow.remove();
    }


    function formatNumberInput(inputValue, targetSelector) {
      let cleaned = inputValue.replace(/[^0-9]/g, '').replace(/,/g, '');// ìˆ«ìë§Œ ë‚¨ê¸°ê¸°
      let formatted = cleaned.replace(/\B(?=(\d{3})+(?!\d))/g, ',');// ì‰¼í‘œ ë„£ê¸°
      $(targetSelector).val(formatted);// ê°’ ë„£ê¸°
    }

    // ìˆ˜ëŸ‰ ë˜ëŠ” ë‹¨ê°€ê°€ ì…ë ¥ë˜ì—ˆì„ ë•Œ â†’ ê³µê¸‰ê°€/ë¶€ê°€ì„¸/ì´ì•¡ ê³„ì‚°
    function updateBaljuPrice() {
      const qtyStr = $('#SujuQty').val().replace(/,/g, '');
      const unitStr = $('#BaljuUnitPrice').val().replace(/,/g, '');
      const isVatIncluded = $('#VatIncluded').is(':checked');
      const isVatExempt = $('#VatExempt').val() === 'Y';

      const qty = parseFloat(qtyStr || 0);
      const unitPrice = parseFloat(unitStr || 0);
      const supplyPrice = qty * unitPrice;

      let vat = 0;
      let totalPrice = supplyPrice;

      if (isVatExempt) {
        $('#BaljuVat')
          .val('ë©´ì„¸')
          .prop('readonly', true)
          .css({'background-color': '', 'color': ''});
        totalPrice = supplyPrice;
      } else {
        if (isVatIncluded) {
          vat = Math.round(supplyPrice * 10 / 110);
          totalPrice = supplyPrice;
        } else {
          vat = Math.round(supplyPrice * 0.1);
          totalPrice = supplyPrice + vat;
        }

        $('#BaljuVat')
          .val(vat.toLocaleString())
          .prop('readonly', true)
          .css({'background-color': '', 'color': '', 'text-align': ''});
      }

      $('#BaljuPrice').val(supplyPrice.toLocaleString());
      $('#BaljuTotalPrice').val(totalPrice.toLocaleString());
    }

    // ì´ì•¡ì´ ì…ë ¥ëœ ê²½ìš° â†’ ê³µê¸‰ê°€/ë¶€ê°€ì„¸ë¥¼ ì—­ì‚°
    function calculateFromTotalPrice() {
      const totalStr = $('#BaljuTotalPrice').val().replace(/,/g, '');
      const total = parseFloat(totalStr || 0);

      const isVatIncluded = $('#VatIncluded').is(':checked');
      const isVatExempt = $('#VatExempt').val() === 'Y';

      let supply = total;
      let vat = 0;

      if (isVatExempt) {
        vat = 'ë©´ì„¸';
        supply = total;
      } else {
        if (isVatIncluded) {
          // ì´ì•¡ì´ ë¶€ê°€ì„¸ í¬í•¨ëœ ê¸ˆì•¡ì¼ ê²½ìš° â†’ ê³µê¸‰ê°€ ì—­ì‚°
          supply = Math.round(total / 1.1);
          vat = total - supply;
        } else {
          // ì´ì•¡ = ê³µê¸‰ê°€ + ë¶€ê°€ì„¸ (ë¶€ê°€ì„¸ ë³„ë„ì´ë¯€ë¡œ ì—­ì‚° í•„ìš”)
          supply = Math.round(total / 1.1);
          vat = total - supply;
        }
      }

      $('#BaljuPrice').val(supply.toLocaleString());
      $('#BaljuVat').val(
        isVatExempt ? 'ë©´ì„¸' : vat.toLocaleString()
      );

      // ì„ íƒì‚¬í•­: ì´ì•¡ í•„ë“œ ë³´ì •
      // $('#BaljuTotalPrice').val((supply + vat).toLocaleString());
    }

    // ê³µê¸‰ê°€ ì…ë ¥ ì‹œ â†’ ì´ì•¡ ë° ë¶€ê°€ì„¸ ê³„ì‚°
    function calculateFromSupplyPrice() {
      const supplyStr = $('#BaljuPrice').val().replace(/,/g, '');
      const isVatExempt = $('#VatExempt').val() === 'Y';
      const isVatIncluded = $('#VatIncluded').is(':checked');

      const supplyPrice = parseFloat(supplyStr || 0);

      let vat = 0;
      let totalPrice = supplyPrice;

      if (isVatExempt) {
        // ë©´ì„¸ì¼ ê²½ìš°
        $('#BaljuVat')
          .val('ë©´ì„¸')
          .prop('readonly', true)
          .css({'background-color': '', 'color': ''});

        totalPrice = supplyPrice; // ì´ì•¡ì€ ê³µê¸‰ê°€ ê·¸ëŒ€ë¡œ
      } else {
        if (isVatIncluded) {
          // ë¶€ê°€ì„¸ í¬í•¨ â†’ ê³µê¸‰ê°€ = ì´ì•¡, ë¶€ê°€ì„¸ë¥¼ ì—­ì‚°
          vat = Math.round(supplyPrice * 10 / 110); // ê³µê¸‰ê°€ì˜ 10/110 ê³„ì‚°
          totalPrice = supplyPrice; // ì´ì•¡ì€ ì…ë ¥í•œ ê³µê¸‰ê°€ ê·¸ëŒ€ë¡œ
        } else {
          // ë¶€ê°€ì„¸ ë³„ë„ â†’ ê³µê¸‰ê°€ì— ë¶€ê°€ì„¸ ì¶”ê°€
          vat = Math.round(supplyPrice * 0.1);
          totalPrice = supplyPrice + vat;
        }

        $('#BaljuVat')
          .val(vat.toLocaleString())
          .prop('readonly', true)
          .css({'background-color': '', 'color': '', 'text-align': ''});
      }
    }

    function calculateAmount({ row }) {
      const $row = $(row);
      const qty = parseFloat($row.find('input[name^="quantity_"]').val().replace(/,/g, '') || '0');
      const unitPrice = parseFloat($row.find('input[name^="BaljuUnitPrice_"]').val().replace(/,/g, '') || '0');
      const isVatIncluded = $row.find('input[name^="VatIncluded"]').prop('checked');

      const $unitPrice = $row.find('input[name^="BaljuUnitPrice_"]');
      const $supply = $row.find('input[name^="BaljuPrice_"]');
      const $vat = $row.find('input[name^="BaljuVat_"]');
      const $total = $row.find('input[name^="totalAmount_"]');

      let supplyPrice = 0, vat = 0, totalPrice = 0;

      if (isVatIncluded) {
        totalPrice = unitPrice * qty;
        supplyPrice = Math.round(totalPrice * 10 / 11);
        vat = totalPrice - supplyPrice;
      } else {
        supplyPrice = unitPrice * qty;
        vat = Math.round(supplyPrice * 0.1);
        totalPrice = supplyPrice + vat;
      }

      $unitPrice.val(unitPrice);
      formatNumberInput(unitPrice.toString(), $unitPrice);
      $supply.val(supplyPrice).trigger('keyup');
      $vat.val(vat).trigger('keyup');
      $total.val(totalPrice).trigger('keyup');
    }


    let page = null;
    var picker = new ax5.ui.picker();

    $(document).ready(function (e) {

      const spjangcd = sessionStorage.getItem('spjangcd');
      if (spjangcd) {
        $('#spjangcdHidden').val(spjangcd);  // hidden inputì´ ìˆì–´ì•¼ í•¨
      }

      page = new SujuUploadPage();

//        $('#divDate').ax5DatePicker({ direction: 'top' });
      $('#srchStartDt').val(CommonUtil.getYYYYMMDD(-7));
      $('#srchEndDt').val(CommonUtil.getYYYYMMDD());

      page.searchMainData();

      // ê²€ìƒ‰
      $('#btnSearch').click(function (e) {
        page.searchMainData();
      });

    });
  </script>

</th:block>
<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
</html>