<html layout:decorate="~{layout_page}">

<th:block layout:fragment="content">

  <div class="layout-contents">
    <div class="page-title-wrap">
      <div class="left">
        <h2>Î∞úÏ£º Îì±Î°ù(Í∞úÎ≥Ñ)</h2>
        <a title="Î∂ÅÎßàÌÅ¨" class="bookmark toggle">
          ÎÇ¥ Î©îÎâ¥
        </a>
      </div>
      <ul class="page-navi">
        <li><img src="/images/icon/ico-nav-home.svg" alt="ÌôàÏïÑÏù¥ÏΩò"></li>
        <li>Î∞úÏ£º/ÏàòÎ∂àÍ¥ÄÎ¶¨</li>
        <li>Î∞úÏ£º Îì±Î°ù</li>
      </ul>
    </div>

    <section class="section">
      <div class="section-top">
        <div class="search-wrap">
          <input type="hidden" id="spjangcdHidden" name="spjangcd"/>
          <dl>
            <dt>
              <label for="cboDateKind">
                Í≤ÄÏÉâ Íµ¨Î∂Ñ<span class="eq"></span>
              </label>
            </dt>
            <dd>
              <div class="srch-box">
                <select id="cboDateKind" name="cboDateKind">
                  <option value="sales">Î∞úÏ£ºÏùº</option>
                  <option value="delivery">ÎÇ©Í∏∞Ïùº</option>
                </select>
              </div>
            </dd>
          </dl>
          <dl>
            <dt>
              Ï°∞ÌöåÍ∏∞Í∞Ñ<span class="eq">*</span>
            </dt>
            <dd>
              <ul class="date-box">
                <li>
                  <input type="date" id="srchStartDt" name="srchStartDt">
                  <label for="srchStartDt" class="hide">ÏãúÏûëÏùº</label>
                </li>
                <li>
                  <input type="date" id="srchEndDt" name="srchEndDt">
                  <label for="srchEndDt" class="hide">Ï¢ÖÎ£åÏùº</label>
                </li>
              </ul>
            </dd>
          </dl>

          <dl>
            <dt>&nbsp;</dt>
            <dd>
              <li>
                <a class="btn btn-delete" title="Í≤ÄÏÉâ" id="btnSearch">
                  <!--                                        class Ïì∞Ïù¥Îäî Í≥≥ Ï∞æÍ≥† ÏóÜÏúºÎ©¥ ÌÅ¥ÎûòÏä§Î™Ö ÏàòÏ†ïÌïòÍ∏∞-->
                  <img src="/images/icon/btn-srch.svg" alt="Í≤ÄÏÉâ ÏïÑÏù¥ÏΩò">
                  Í≤ÄÏÉâ
                </a>
              </li>
            </dd>
          </dl>
        </div>
        <div class="button-wrap">
          <ul>
            <li>
              <a class="btn btn-excell" title="Îì±Î°ù" id="btnAddNew">
                <img src="/images/icon/ico-plus.svg" alt="Îì±Î°ù ÏïÑÏù¥ÏΩò">
                Îì±Î°ù
              </a>
            </li>
            <li>
              <a class="btn btn-delete" title="ÏÇ≠Ï†ú" id="btnDelete">
                <img src="/images/icon/ico-delete.svg" alt="ÏÇ≠Ï†ú ÏïÑÏù¥ÏΩò">
                ÏÇ≠Ï†ú
              </a>
            </li>
            <li>
              <a class="btn btn-edit" title="ÏàòÏ†ï" id="btnEdit">
                <img src="/images/icon/ico-edit.svg" alt="ÏàòÏ†ï ÏïÑÏù¥ÏΩò">
                ÏàòÏ†ï
              </a>
            </li>
          </ul>
        </div>
      </div>
      <div class="container-fluid">
        <div id="theGrid" style="height: 730px;"></div>
      </div>
      <!--        <div class="grid_box">-->

      <!--            <div class="h-640" data-ax5grid="sujuGrid" ></div>-->
      <!--        </div>-->
    </section>
  </div>
  <script type="text/x-tmpl" id="baljuTemplate">
    <div class="content_wrap popup" id="div_excel_upload">
        <div class="table-wrap">
        <form id="baljuForm">
            <table class="write-table">
                <caption>Ï£ºÎ¨∏Îì±Î°ù ÌÖåÏù¥Î∏î</caption>
                <input type="hidden" id="id" name="id">
                <input type="hidden" id="spjangcdHidden" name="spjangcd"/>
                <tbody>
                    <tr>
                        <th style="text-align: center">
                            <label for="JumunDate">Î∞úÏ£ºÏùº</label>
                        </th>
                        <td>
                            <input type="date" id="JumunDate" name="JumunDate">
                        </td>
                        <th style="text-align: center">
                            <label for="DueDate">ÎÇ©Í∏∞ÏòàÏ†ïÏùº</label>
                        </th>
                        <td>
                            <input type="date" id="DueDate" name="DueDate">
                        </td>
                    </tr>
                    <tr>
                        <th style="text-align: center">
                            <label for="cboCompany">Íµ¨Îß§Ï≤ò*</label>
                        </th>
                        <td colspan="3">
                            <input id="cboCompany" name="Company_id" type="hidden">
                            <input class="form-control2" type="text" id="CompanyName" name="CompanyName"
                             placeholder="Í≤ÄÏÉâÎ≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ Íµ¨Îß§Ï≤òÎ•º Í≤ÄÏÉâÌïòÏÑ∏Ïöî" readonly/>
                            &nbsp;
                            <a class="btn btn-delete" title="Í≤ÄÏÉâ" id="btnCompanySearch">
                                <img src="/images/icon/btn-srch.svg" alt="Í≤ÄÏÉâ ÏïÑÏù¥ÏΩò">
                                Íµ¨Îß§Ï≤ò Í≤ÄÏÉâ
                            </a>
                        </td>
                    </tr>
                    <tr>
                        <th style="text-align: center">
                            <label for="MaterialGroupName">Ï†úÌíàÍ∑∏Î£π</label>
                        </th>
                        <td>
                            <input type="text" id="MaterialGroupName" name="MaterialGroupName" readonly>
                        </td>
                        <th style="text-align: center">
                            <label for="product_code">ÌíàÎ™©ÏΩîÎìú</label>
                        </th>
                        <td>
                            <input type="text" id="product_code" name="product_code" readonly>
                        </td>
                    </tr>
                    <tr>
                        <th style="text-align: center">
                            <label for="txtProductName">ÌíàÎ™©Î™Ö</label>
                        </th>
                        <td colspan="3">
                            <input type="text" id="txtProductName" name="product_name"
                                   placeholder="Í≤ÄÏÉâÎ≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ Ï†úÌíàÏùÑ Í≤ÄÏÉâÌïòÏÑ∏Ïöî" readonly>
                            <input type="hidden" id="Material_id" name="Material_id">
                            &nbsp;
                            <a class="btn btn-delete" title="Í≤ÄÏÉâ" id="btnProductSearch">
                                <img src="/images/icon/btn-srch.svg" alt="Í≤ÄÏÉâ ÏïÑÏù¥ÏΩò">
                                Ï†úÌíà Í≤ÄÏÉâ
                            </a>
                        </td>
                    </tr>
                    <tr>
                        <th style="text-align: center">
                            <label for="SujuQty">Î∞úÏ£ºÎüâ*</label>
                        </th>
                        <td>
                            <input class="form-control2 tar" type="text" id="SujuQty" name="SujuQty" onkeyup="numberSujuQty(this.value)">
                        </td>
                        <th style="text-align: center">
                            <label for="cboBaljuType">Î∞úÏ£ºÍµ¨Î∂Ñ</label>
                        </th>
                        <td>
                            <select id="cboBaljuType" name="SujuType"></select>
                        </td>
                    </tr>
                    <tr>
                        <th style="text-align: center">
                            <label for="BaljuUnitPrice">Îã®Í∞Ä *</label>
                        </th>
                        <td style="display: flex; align-items: center; gap: 10px;">
                            <input class="form-control2 tar" type="text" id="BaljuUnitPrice" name="BaljuUnitPrice"
                                   onkeyup="numberUnitPrice(this.value)" style="width:50%;">
                            <label style="margin: 0; display: flex; align-items: center;">
                              <input type="checkbox" id="VatIncluded" name="VatIncluded" checked>
                              <span style="margin-left: 5px;">Î∂ÄÍ∞ÄÏÑ∏ Ìè¨Ìï®</span>
                            </label>
                          </td>
                        <th style="text-align: center">
                            <label for="BaljuPrice"> Í≥µÍ∏âÍ∞ÄÏï°</label>
                        </th>
                        <td>
                            <input class="form-control2 tar" type="text" id="BaljuPrice" name="BaljuPrice" onkeyup="numberBaljuQty(this.value)" >
                        </td>
                    </tr>
                    <tr>
                        <th style="text-align: center">
                            <label for="BaljuVat">Î∂ÄÍ∞ÄÏÑ∏Ïï°</label>
                        </th>
                        <td>
                            <input class="form-control2 tar" type="text" id="BaljuVat" name="BaljuVat" onkeyup="numberBaljuQty(this.value)" readonly>
                            <input type="hidden" id="VatExempt" name="VatExempt" value="false">
                       </td>
                        <th style="text-align: center">
                            <label for="BaljuTotalPrice">Ï¥ùÏï°(Î∞úÏ£ºÏï°)</label>
                        </th>
                        <td>
                            <input class="form-control2 tar" type="text" id="BaljuTotalPrice" name="BaljuTotalPrice" onkeyup="tTotalBaljuPrice(this.value)">
                        </td>
                    </tr>
                    <tr>
                        <th style="text-align: center">
                            <label for="description">ÎπÑÍ≥†</label>
                        </th>
                        <td colspan="3">
                            <textarea id="description" name="Description"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <th style="text-align: center">
                            <label for="unit">Îã®ÏúÑ</label>
                        </th>
                        <td>
                            <input type="text" id="unit" name="unit" readonly>
                        </td>
                        <th style="text-align: center">
                            <label for="StateName">ÏÉÅÌÉú</label>
                        </th>
                        <td>
                            <input type="text" id="StateName" name="StateName" readonly disabled>
                        </td>
                    </tr>
                </tbody>
            </table>
            </form>
        </div>

        <div class="popup-button">
                <button type="button" class="btn-popup y_write_auth" id="btnPopBaljuStop">Ï§ëÏßÄ</button>
                <button type="button" class="btn-popup y_write_auth" id="btnPopBaljuSave">Ï†ÄÏû•</button>
                <button type="button" class="btn-popup" id="modal-close-button">Îã´Í∏∞</button>
        </div>
    </div>
  </script>

</th:block>

<th:block layout:fragment="scripts">
  <!--<th:block th:replace="/common/columns_setting :: columns_setting"></th:block>-->
  <th:block th:replace="/common/multiform_material :: multiform_material"></th:block>
  <th:block th:replace="/common/popup_company :: popup_company"></th:block>

  <script type="text/javascript">
    function formatNumberInput(inputValue, targetSelector) {
      let cleaned = inputValue.replace(/[^0-9]/g, '').replace(/,/g, '');// Ïà´ÏûêÎßå ÎÇ®Í∏∞Í∏∞
      let formatted = cleaned.replace(/\B(?=(\d{3})+(?!\d))/g, ',');// ÏâºÌëú ÎÑ£Í∏∞
      $(targetSelector).val(formatted);// Í∞í ÎÑ£Í∏∞
    }

    // ÏàòÎüâ ÎòêÎäî Îã®Í∞ÄÍ∞Ä ÏûÖÎ†•ÎêòÏóàÏùÑ Îïå ‚Üí Í≥µÍ∏âÍ∞Ä/Î∂ÄÍ∞ÄÏÑ∏/Ï¥ùÏï° Í≥ÑÏÇ∞
    function updateBaljuPrice() {
      const qtyStr = $('#SujuQty').val().replace(/,/g, '');
      const unitStr = $('#BaljuUnitPrice').val().replace(/,/g, '');
      const isVatIncluded = $('#VatIncluded').is(':checked');
      const isVatExempt = $('#VatExempt').val() === 'Y';

      const qty = parseFloat(qtyStr || 0);
      const unitPrice = parseFloat(unitStr || 0);
      const supplyPrice = qty * unitPrice;

      let vat = 0;
      let totalPrice = supplyPrice;

      if (isVatExempt) {
        $('#BaljuVat')
          .val('Î©¥ÏÑ∏')
          .prop('readonly', true)
          .css({'background-color': '', 'color': ''});
        totalPrice = supplyPrice;
      } else {
        if (isVatIncluded) {
          vat = Math.round(supplyPrice * 10 / 110);
          totalPrice = supplyPrice;
        } else {
          vat = Math.round(supplyPrice * 0.1);
          totalPrice = supplyPrice + vat;
        }

        $('#BaljuVat')
          .val(vat.toLocaleString())
          .prop('readonly', true)
          .css({'background-color': '', 'color': '', 'text-align': ''});
      }

      $('#BaljuPrice').val(supplyPrice.toLocaleString());
      $('#BaljuTotalPrice').val(totalPrice.toLocaleString());
    }

    // Ï¥ùÏï°Ïù¥ ÏûÖÎ†•Îêú Í≤ΩÏö∞ ‚Üí Í≥µÍ∏âÍ∞Ä/Î∂ÄÍ∞ÄÏÑ∏Î•º Ïó≠ÏÇ∞
    function calculateFromTotalPrice() {
      const totalStr = $('#BaljuTotalPrice').val().replace(/,/g, '');
      const total = parseFloat(totalStr || 0);

      const isVatIncluded = $('#VatIncluded').is(':checked');
      const isVatExempt = $('#VatExempt').val() === 'Y';

      let supply = total;
      let vat = 0;

      if (isVatExempt) {
        vat = 'Î©¥ÏÑ∏';
        supply = total;
      } else {
        if (isVatIncluded) {
          // Ï¥ùÏï°Ïù¥ Î∂ÄÍ∞ÄÏÑ∏ Ìè¨Ìï®Îêú Í∏àÏï°Ïùº Í≤ΩÏö∞ ‚Üí Í≥µÍ∏âÍ∞Ä Ïó≠ÏÇ∞
          supply = Math.round(total / 1.1);
          vat = total - supply;
        } else {
          // Ï¥ùÏï° = Í≥µÍ∏âÍ∞Ä + Î∂ÄÍ∞ÄÏÑ∏ (Î∂ÄÍ∞ÄÏÑ∏ Î≥ÑÎèÑÏù¥ÎØÄÎ°ú Ïó≠ÏÇ∞ ÌïÑÏöî)
          supply = Math.round(total / 1.1);
          vat = total - supply;
        }
      }

      $('#BaljuPrice').val(supply.toLocaleString());
      $('#BaljuVat').val(
        isVatExempt ? 'Î©¥ÏÑ∏' : vat.toLocaleString()
      );

      // ÏÑ†ÌÉùÏÇ¨Ìï≠: Ï¥ùÏï° ÌïÑÎìú Î≥¥Ï†ï
      // $('#BaljuTotalPrice').val((supply + vat).toLocaleString());
    }

    // Í≥µÍ∏âÍ∞Ä ÏûÖÎ†• Ïãú ‚Üí Ï¥ùÏï° Î∞è Î∂ÄÍ∞ÄÏÑ∏ Í≥ÑÏÇ∞
    function calculateFromSupplyPrice() {
      const supplyStr = $('#BaljuPrice').val().replace(/,/g, '');
      const isVatExempt = $('#VatExempt').val() === 'Y';
      const isVatIncluded = $('#VatIncluded').is(':checked');

      const supplyPrice = parseFloat(supplyStr || 0);

      let vat = 0;
      let totalPrice = supplyPrice;

      if (isVatExempt) {
        // Î©¥ÏÑ∏Ïùº Í≤ΩÏö∞
        $('#BaljuVat')
          .val('Î©¥ÏÑ∏')
          .prop('readonly', true)
          .css({'background-color': '', 'color': ''});

        totalPrice = supplyPrice; // Ï¥ùÏï°ÏùÄ Í≥µÍ∏âÍ∞Ä Í∑∏ÎåÄÎ°ú
      } else {
        if (isVatIncluded) {
          // Î∂ÄÍ∞ÄÏÑ∏ Ìè¨Ìï® ‚Üí Í≥µÍ∏âÍ∞Ä = Ï¥ùÏï°, Î∂ÄÍ∞ÄÏÑ∏Î•º Ïó≠ÏÇ∞
          vat = Math.round(supplyPrice * 10 / 110); // Í≥µÍ∏âÍ∞ÄÏùò 10/110 Í≥ÑÏÇ∞
          totalPrice = supplyPrice; // Ï¥ùÏï°ÏùÄ ÏûÖÎ†•Ìïú Í≥µÍ∏âÍ∞Ä Í∑∏ÎåÄÎ°ú
        } else {
          // Î∂ÄÍ∞ÄÏÑ∏ Î≥ÑÎèÑ ‚Üí Í≥µÍ∏âÍ∞ÄÏóê Î∂ÄÍ∞ÄÏÑ∏ Ï∂îÍ∞Ä
          vat = Math.round(supplyPrice * 0.1);
          totalPrice = supplyPrice + vat;
        }

        $('#BaljuVat')
          .val(vat.toLocaleString())
          .prop('readonly', true)
          .css({'background-color': '', 'color': '', 'text-align': ''});
      }

      // $('#BaljuTotalPrice').val(totalPrice.toLocaleString());
    }

    // ÏàòÎüâ Î≥ÄÍ≤Ω Ïãú ‚Üí Îã®Í∞Ä √ó ÏàòÎüâ ‚Üí Í≥µÍ∏âÍ∞Ä Í≥ÑÏÇ∞
    function numberSujuQty(x) {
      formatNumberInput(x, "#SujuQty");
      updateBaljuPrice();
    }

    // Îã®Í∞Ä Î≥ÄÍ≤Ω Ïãú ‚Üí Îã®Í∞Ä √ó ÏàòÎüâ ‚Üí Í≥µÍ∏âÍ∞Ä Í≥ÑÏÇ∞
    function numberUnitPrice(x) {
      formatNumberInput(x, "#BaljuUnitPrice");
      updateBaljuPrice();
    }

    // Í≥µÍ∏âÍ∞Ä Î≥ÄÍ≤Ω Ïãú ‚Üí Î∂ÄÍ∞ÄÏÑ∏/Ï¥ùÏï° Í≥ÑÏÇ∞
    function numberBaljuQty(x) {
      formatNumberInput(x, "#BaljuPrice");
      calculateFromSupplyPrice();
    }

    // Ï¥ùÏï° Î≥ÄÍ≤Ω Ïãú ‚Üí Í≥µÍ∏âÍ∞Ä/Î∂ÄÍ∞ÄÏÑ∏ Ïó≠ÏÇ∞
    function tTotalBaljuPrice(x) {
      formatNumberInput(x, "#BaljuTotalPrice");
      calculateFromTotalPrice();
    }

    class SujuUploadPage {
      constructor() {
        this.url = '/api/balju/balju_order';
        this.grid = null;
        this.$btnEdit = $('#btnEdit');
        this.$btnAddNew = $('#btnAddNew');
        this.spjangcd = $('#spjangcdHidden');
        this.viewData = new wijmo.collections.CollectionView();
        this.init();
      }

      init() {
        let _this = this;
        this.grid = new wijmo.grid.FlexGrid('#theGrid', {
          selectionMode: wijmo.grid.SelectionMode.Row,
          headersVisibility: wijmo.grid.HeadersVisibility.Column,
          autoGenerateColumns: false,
          showMarquee: true,
          isReadOnly: true,
          formatItem: (sender, e) => {
            if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
              e.cell.style.textAlign = 'center';
            }
          },
          columns: [
            {binding: 'CompanyName', header: 'Íµ¨Îß§Ï≤ò', width: 120},
            {binding: 'BaljuTypeName', header: 'Íµ¨Î∂Ñ', width: 70, align: 'center'},
            {binding: 'JumunDate', header: 'Î∞úÏ£ºÏùº', width: 120, align: 'center'},
            {binding: 'MaterialGroupName', header: 'Ï†úÌíàÍ∑∏Î£π', width: 100},
            {binding: 'product_code', header: 'Ï†úÌíàÏΩîÎìú', width: 100},
            {binding: 'product_name', header: 'Ï†úÌíàÎ™Ö', width: 100},
            {binding: 'unit', header: 'Îã®ÏúÑ', width: 60, align: 'center'},
            {binding: 'SujuQty', header: 'ÏàòÎüâ', width: 60, align: 'right', format: 'n0'},
            {binding: 'BaljuUnitPrice', header: 'Îã®Í∞Ä', width: 100, align: 'right'},
            {binding: 'BaljuPrice', header: 'Í≥µÍ∏âÍ∞Ä', width: 100, align: 'right'},
            {binding: 'BaljuVat', header: 'Î∂ÄÍ≥ºÏÑ∏', width: 100, align: 'right'},
            {binding: 'BaljuTotalPrice', header: 'Î∞úÏ£ºÏï°', width: 100, align: 'right'},
            {binding: 'StateName', header: 'ÏÉÅÌÉú', width: 80, align: 'center'},
            {binding: 'SujuQty2', header: 'Í∏∞ÏûÖÍ≥†ÏàòÎüâ', width: 100, align: 'right'},
            {binding: 'SujuQty3', header: 'ÎØ∏ÏûÖÍ≥†ÏàòÎüâ', width: 100, align: 'right'},
            {binding: 'ShipmentStateName', header: 'ÎÇ©ÌíàÏû•ÏÜå', width: 100, align: 'center'},
            {binding: 'DueDate', header: 'ÎÇ©Í∏∞ÏòàÏ†ïÏùº', width: 120, align: 'center'},
            {binding: 'Description', header: 'ÎπÑÍ≥†', width: 200}
          ],
          itemsSource: this.viewData, // Îç∞Ïù¥ÌÑ∞Î•º ÏÑ§Ï†ïÌï† Î∞∞Ïó¥
        });

        new FlexGridContextMenu(this.grid);
        this.grid.downloadFileName = 'Î∞úÏ£º Îì±Î°ù';

        this.grid.hostElement.addEventListener('dblclick', function (e) {
          let items = _this.grid.selectedItems;
          if (items.length === 0) {
            return false;
          }
          _this.$btnEdit.trigger('click');
        });

        let nowDate = CommonUtil.getYYYYMMDD();
        let dueDate = CommonUtil.getYYYYMMDD(10);

        //Î∞úÏ£ºÎì±Î°ù ÌÅ¥Î¶≠
        this.$btnAddNew.click(function (e) {
          let defaultData = {
            id: '',
            mode: 'new',
            JumunDate: nowDate,
            DueDate: dueDate,
            State: 'draft',
            spjangcd: _this.spjangcd.val()
          };
          _this.showBaljuForm(defaultData);
        });

        // Î∞úÏ£º ÏàòÏ†ï ÌÅ¥Î¶≠
        this.$btnEdit.click(function (e) {
          let selectedItems = _this.grid.selectedItems;

          if (selectedItems.length === 1) {

            let selected = selectedItems[0];

            let data = {
              id: selected.id,
              SujuQty3: selected.SujuQty3,
              action: 'detail'
            };
            let fnsuccess = function (result) {
              result.data['mode'] = 'edit';
              result.data['SujuQty3'] = selected.SujuQty3;
              _this.showBaljuForm(result.data);
            };
            AjaxUtil.getAsyncData(_this.url + '/detail', data, fnsuccess);
          } else if (items.length > 1) {
            Alert.alert('', 'Îç∞Ïù¥ÌÑ∞Î•º ÌïòÎÇòÎßå ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
          } else {
            Alert.alert('', 'ÏÑ†ÌÉùÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
          }

        });

        // ÏÇ≠Ï†ú Î≤ÑÌäº
        $('#btnDelete').click(function (e) {
          let items = _this.grid.selectedItems;
          if (items.length > 0) {
            Alert.confirm('', 'ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?',
              function () {
                let id = items[0].id;
                let state = items[0].State;

                _this.deleteSujuData(id, state);
              },
              function () {
              }
            );
          } else {
            Alert.alert('', 'ÏÇ≠Ï†úÌï† Ìï≠Î™©ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.', function () {
              $(this).focus();
            });
          }
        });

        // ÏóîÌÑ∞ÌÇ§ Í≤ÄÏÉâ
        $('#keyword').on('keypress', function (e) {
          if (e.keyCode === 13) {
            _this.searchMainData();
          }
        });
      }

      showBaljuForm(data) {
        //baljuTemplate
        let _this = this;
        let content = tmpl('baljuTemplate', data);
        let $content = $(content);

        let modalContainer = null;
        if (data.mode === 'new') {
          modalContainer = new PopupDraggable('Î∞úÏ£º Îì±Î°ù');
        } else {
          modalContainer = new PopupDraggable('Î∞úÏ£º ÏàòÏ†ï');
        }

        modalContainer.open({width: 1050, height: 630, $content});
        $('#popSrchDt1').ax5DatePicker({direction: 'top'});
        $('#popSrchDt2').ax5DatePicker({direction: 'top'});

        // Ï†úÌíàÍ≤ÄÏÉâ
        let $btnProductSearch = $content.find('#btnProductSearch');
        let $btnCompanySearch = $content.find('#btnCompanySearch');
        let $MaterialGroupName = $content.find('#MaterialGroupName');
        let $product_code = $content.find('#product_code');
        let $txtProductName = $content.find('#txtProductName');
        let $Material_id = $content.find('#Material_id');

        let $baljuForm = $content.find('#baljuForm');

        let $cboBaljuType = $content.find('#cboBaljuType');
        let $cboMaterial = $content.find('#cboMaterial');
        let $JumunDate = $content.find('#JumunDate');
        let $DueDate = $content.find('#DueDate');

        let $AvailableStock = $('#AvailableStock');
        let $unit = $('#unit');
        let $cboCompany = $('#cboCompany');
        let $CompanyName = $('#CompanyName');
        let $quantity = $('#quantity');
        let $SujuQty = $('#SujuQty');
        let $BaljuUnitPrice = $content.find('#BaljuUnitPrice');
        let $BaljuPrice = $content.find('#BaljuPrice');
        let $BaljuVat = $content.find('#BaljuVat');
        let $isVatExempt = false;
        let $BaljuTotalPrice = $content.find('#BaljuTotalPri');
        let $vatCheck = $content.find('#VatIncluded');

        let $sujuQty3 = $content.find('#sujuQty3');

        $content.find('#spjangcdHidden').val(data.spjangcd || '');

        if (data.mode === 'new') {
          $btnProductSearch.removeAttr('disabled');

        }
        $vatCheck.change(function () {
          updateBaljuPrice();
          calculateFromTotalPrice();
          calculateFromSupplyPrice();
        });

        $btnProductSearch.click(function (e) {
          let pop = new PopMatComponent();
          pop.material_type = 'product,sangpum';
          pop.show(function (item) {
            console.log('$btnProductSearch', item);
            $txtProductName.val(item.Name);
            $Material_id.val(item.id);
            $product_code.val(item.Code);
            $MaterialGroupName.val(item.group_name);
            $isVatExempt = item.VatExemptionYN === 'Y';
            // Î∂ÄÍ∞ÄÏÑ∏ UI Ï≤òÎ¶¨
            if (item.VatExemptionYN === 'Y') {
              $BaljuVat.prop('readonly', true).val('Î©¥ÏÑ∏').css({'background-color': '', 'color': ''});
              $('#VatExempt').val('Y');
            } else {
              $BaljuVat.prop('readonly', true).val('')
                .css({'background-color': '', 'color': '', 'text-align': ''});
              $('#VatExempt').val('N');
            }

            if ($Material_id.val() && $cboCompany.val()) {
              tryShowBaljuPrice();
            }
          });
          pop.searchDataBind();
        });

        $content.find('#btnCompanySearch').click(function () {
          let poppage = new PopCompComponent();
          let $poppage = $(poppage);
          let searchcallback = function (items) {
            console.log('btnCompanySearch', items);
            $content.find('#cboCompany').val(items.id);
            $content.find('#CompanyName').val(items.compname);
            $isVatExempt = items.VatExemptionYN === 'Y';
            if (items.VatExemptionYN === 'Y') {
              $BaljuVat.prop('readonly', true).val('Î©¥ÏÑ∏').css({'background-color': '', 'color': ''});
              $('#VatExempt').val('Y');
            } else {
              $BaljuVat.prop('readonly', true).val('')
                .css({'background-color': '', 'color': '', 'text-align': ''});
              $('#VatExempt').val('N');
            }

            if ($Material_id.val() && $cboCompany.val()) {
              tryShowBaljuPrice();
            }
          };

          poppage.show(searchcallback);
        });

        let originalUnitPrice = null;

        //Îã®Í∞Ä Í≤ÄÏÉâ
        function tryShowBaljuPrice() {
          const mat_pk = $content.find('#Material_id').val();
          const company_id = $content.find('#cboCompany').val();
          const JumunDate = $content.find('#JumunDate').val();
          let url = _this.url + '/price';

          if (!mat_pk || !company_id || !JumunDate) return;

          let data = {
            'mat_pk': mat_pk,
            'company_id': company_id,
            'JumunDate': JumunDate
          };

          AjaxUtil.getAsyncData(url, data, function (result) {
            //console.log('[Ajax ÏùëÎãµ Îç∞Ïù¥ÌÑ∞]', result);
            if (result && result.data && result.data.length > 0) {
              const item = result.data[0];
              const unitPrice = item.UnitPrice || 0;
              const vat = item.vat || 0;
              const supplyPrice = unitPrice * 1;

              $content.find('#unitPrice').prop('readonly', true).val(unitPrice);
              originalUnitPrice = unitPrice;

              $BaljuUnitPrice.val(unitPrice);
              formatNumberInput(unitPrice.toString(), '#BaljuUnitPrice'); // ÏΩ§Îßà Ìè¨Îß∑ Ï†ÅÏö©

              $BaljuPrice.val(supplyPrice);
              formatNumberInput(supplyPrice.toString(), '#BaljuPrice');   // ÏΩ§Îßà Ìè¨Îß∑ Ï†ÅÏö©

            } else {
              $content.find('#unitPrice').val('0');
              originalUnitPrice = '0';

              $BaljuUnitPrice.val('');
              $BaljuPrice.val('');
              $BaljuVat.val('').prop('readonly', true);
            }
          });
        }

        // Ï†ÄÏû•Î≤ÑÌäº
        let $btnPopBaljuSave = $('#btnPopBaljuSave');
        // Ï§ëÏßÄ Î≤ÑÌäº
        let $btnPopBaljuStop = $content.find('#btnPopBaljuStop');
        // ÏÉÅÌÉú Í∞í Ï†ïÎ¶¨
        const isCanceled = (data.State || '').toLowerCase() === 'canceled';
        const isDraft = (data.State || '').toLowerCase() === 'draft';
        const isFullyReceived = Number(data.SujuQty3 || 0) === 0;
        // Îì±Î°ù Î™®ÎìúÏùº Í≤ΩÏö∞ ‚Üí Î≤ÑÌäº Ïà®ÍπÄ
        if (data.mode === 'new') {
          $btnProductSearch.removeAttr('disabled');
          $btnPopBaljuStop.hide();
        } else {
          // Î≤ÑÌäº ÌëúÏãú Ïó¨Î∂Ä
          if (isCanceled || !isFullyReceived || isDraft) {
            $btnPopBaljuStop.show();
            $btnPopBaljuStop.text(isCanceled ? 'Ï§ëÏßÄÏ∑®ÏÜå' : 'Ï§ëÏßÄ');
          } else {
            $btnPopBaljuStop.hide();
          }
          // ÏÉÅÌÉúÍ∞Ä draftÍ∞Ä ÏïÑÎãàÎ©¥ Ï†ÄÏû• Î≤ÑÌäº Ïà®Í∏∞Í≥† Îã®Í∞Ä ÏùΩÍ∏∞ Ï†ÑÏö©
          if (!isDraft) {
            $btnPopBaljuSave.hide();
            $BaljuUnitPrice.prop('readonly', true);
          }
        }

        //Î∞úÏ£ºÍµ¨Î∂Ñ
        AjaxUtil.fillSelectOptions($cboBaljuType, 'system_code', 'choose', null, 'Balju_type');

        //ÌåùÏóÖÌÉÄÏù¥ÌãÄ ÏÑ§Ï†ï
        let $popTitle = $content.find('#popTitle');
        if (data.mode === 'new') {
          $popTitle.text('Î∞úÏ£º Îì±Î°ù');
        } else {
          // Î∞úÏ£º ÏàòÏ†ïÏãú Ï†úÌíàÍ∑∏Î£πÍ≥º Ï†úÌíàÏùÑ ÏàòÏ†ïÌïòÍ≤å Ìï† Í≤É Ïù∏ÏßÄ?
          $popTitle.text('Î∞úÏ£º ÏàòÏ†ï');

          if (data.Company_id) {
            $CompanyName.attr('readonly', true);
          }
          originalUnitPrice = parseFloat(data.BaljuUnitPrice || '0');
        }
        FormUtil.BindDataForm(data, $baljuForm);


        if (data.SujuQty > 0) {
          $SujuQty.val(data.SujuQty.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
        }

        // ÌåùÏóÖ Ï§ëÏßÄÎ≤ÑÌäº ÌÅ¥Î¶≠
        $btnPopBaljuStop.click(function (e) {
          // ÌòÑÏû¨ Î≤ÑÌäº ÌÖçÏä§Ìä∏Î°ú ÏÉÅÌÉú ÌåêÎã® (Ï§ëÏßÄ / Ï§ëÏßÄÏ∑®ÏÜå)
          const isCanceled = $btnPopBaljuStop.text() === 'Ï§ëÏßÄÏ∑®ÏÜå';
          const confirmMsg = isCanceled ? 'Ï§ëÏßÄÏ∑®ÏÜå ÌïòÏãúÍ≤†ÏäµÎãàÍπå?' : 'Ï§ëÏßÄ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?';
          const notifyMsg = isCanceled ? 'Î∞úÏ£ºÍ∞Ä Ï§ëÏßÄÏ∑®ÏÜå ÎêòÏóàÏäµÎãàÎã§.' : 'Î∞úÏ£ºÍ∞Ä Ï§ëÏßÄ ÎêòÏóàÏäµÎãàÎã§.';

          Alert.confirm('', confirmMsg, function () {
            let url = _this.url + '/balju_stop';

            console.log("üì§ Ï†ÑÏÜ°Îê† Î∞úÏ£ºÏ†ïÏßÄ Îç∞Ïù¥ÌÑ∞:", data);

            let fnSaveSuccess = function (result) {
              Notify.success(notifyMsg);
              _this.searchMainData();
              modalContainer.close();
            };
            AjaxUtil.postAsyncData(url, data, fnSaveSuccess);
          });
        });

        // Î∞úÏ£ºÎì±Î°ù ÌåùÏóÖ Ï†ÄÏû•Î≤ÑÌäº ÌÅ¥Î¶≠
        $btnPopBaljuSave.click(function (e) {

          //Î∞úÏ£ºÏùº, ÎÇ©Í∏∞Ïùº Ï≤¥ÌÅ¨?
          let data = FormUtil.extractForm($baljuForm);
          const isVat = $('#VatIncluded').is(':checked');
          data.invatyn = isVat ? 'Y' : 'N';

          if ((data.Material_id == null) || (data.Material_id === '')) {
            Alert.alert('', 'Ï†úÌíàÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
            return;
          }

          if (($CompanyName.val() == null) || ($CompanyName.val() === '')) {
            Alert.alert('', 'Íµ¨Îß§Ï≤òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
            return;
          }

          if ($SujuQty.val() === '') {
            Alert.alert('', 'Î∞úÏ£ºÎüâÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
            return;
          }
          let currentUnitPrice = $content.find('#BaljuUnitPrice').val().replace(/,/g, '');  // Î∞úÏ£º Îã®Í∞Ä ÌïÑÎìú ID ÌôïÏù∏ ÌïÑÏàò
          let unitPriceChanged = originalUnitPrice != null &&
            parseFloat($content.find('#BaljuUnitPrice').val().replace(/,/g, '')) !== originalUnitPrice;
          console.log('Î∂ÄÍ∞ÄÏÑ∏ Ï†ÅÏö© Ïó¨Î∂Ä:', isVat);

          Alert.confirm('', 'Ï†ÄÏû•ÌïòÏãúÍ≤†ÏäµÎãàÍπå?', function () {

            // Î∞úÏ£º Ï†ÄÏû• Ìï®Ïàò Ï†ïÏùò
            let doSave = function () {
              let url = _this.url + '/manual_save';

              // Ïà´Ïûê Ìè¨Îß∑ Ï†úÍ±∞
              data.SujuQty = data.SujuQty.replace(/,/g, '');
              data.BaljuPrice = data.BaljuPrice.replace(/,/g, '');
              data.BaljuUnitPrice = data.BaljuUnitPrice.replace(/,/g, '');
              data.BaljuVat = (data.BaljuVat === 'Î©¥ÏÑ∏') ? '0' : data.BaljuVat.replace(/,/g, '');
              // data.BaljuVat = data.BaljuVat.replace(/,/g, '');
              data.BaljuTotalPrice = data.BaljuTotalPrice.replace(/,/g, '');
              data.spjangcd = $('#spjangcdHidden').val();

              console.log("üì§ Ï†ÑÏÜ°Îê† Î∞úÏ£º Îç∞Ïù¥ÌÑ∞:", data);

              AjaxUtil.postAsyncData(url, data, function (result) {
                Notify.success("Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.");
                _this.searchMainData();
                modalContainer.close();
              });
            };

            // Îã®Í∞Ä Î≥ÄÍ≤ΩÏù¥ ÏûàÎäî Í≤ΩÏö∞ ‚Üí Îã®Í∞Ä Î®ºÏ†Ä Ï†ÄÏû•
            if (unitPriceChanged) {
              let now = new Date();
              let hh = String(now.getHours()).padStart(2, '0');
              let mm = String(now.getMinutes()).padStart(2, '0');
              let ss = String(now.getSeconds()).padStart(2, '0');

              let applyStartDate = `${data.JumunDate}T${hh}:${mm}:${ss}`;

              let priceData = {
                Material_id: data.Material_id,
                Company_id: data.Company_id,
                UnitPrice: currentUnitPrice,
                ApplyStartDate: applyStartDate,  // ‚úÖ ÏàòÏ†ïÎêú Í∞í ÏÇ¨Ïö©!
                type: '01',
                ChangerName: userinfo.username,
                spjangcd: _this.spjangcd.val()
              };

              AjaxUtil.postAsyncData('/api/definition/material/savePrice', priceData, function (res) {
                if (res.success) {
                  console.log('‚úÖ Îã®Í∞Ä Ï†ÄÏû• ÏÑ±Í≥µ');
                  doSave();
                } else {
                  Alert.alert('Îã®Í∞Ä Ï†ÄÏû• Ïã§Ìå®', res.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò');
                }
              });
            } else {
              // Îã®Í∞Ä Î≥ÄÍ≤Ω ÏóÜÏúºÎ©¥ Î∞úÏ£º Ï†ÄÏû• Î∞îÎ°ú Ïã§Ìñâ
              doSave();
            }
          });
        });

        FormUtil.BindDataForm(data, $baljuForm);

        // Ïà´Ïûê ÏûÖÎ†• ÌïÑÎìú ÏûêÎèô Ìè¨Îß∑
        const numberFields = [
          '#BaljuPrice',
          '#BaljuUnitPrice',
          '#BaljuVat',
          '#BaljuTotalPrice',
          '#SujuQty'
        ];

        numberFields.forEach(selector => {
          $content.find(selector).off('keyup').on('keyup', function () {
            formatNumberInput($(this).val(), selector);
          });

          // Í∞íÏù¥ ÏûàÎã§Î©¥ ÏΩ§Îßà Ìè¨Îß∑ Î∞îÎ°ú Ï†ÅÏö©
          let value = $content.find(selector).val();
          if (value) {
            formatNumberInput(value, selector);
          }
        });

      }

      deleteSujuData(id, state) {
        let _this = this;
        let url = _this.url + '/delete';
        let data = {'id': id, 'State': state}
        let fnsuccess = function (res) {
          if (res.success) {
            Notify.success('ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
            _this.searchMainData();
          } else {
            Alert.alert('', res.message);
          }
        };

        AjaxUtil.postAsyncData(url, data, fnsuccess);
      }

      searchMainData() {
        let _this = this;
        let date_kind = $('#cboDateKind').val();  //Î∞úÏ£ºÍµ¨Î∂Ñ
        let start = $('#srchStartDt').val();  //ÏãúÏûëÏùº
        let end = $('#srchEndDt').val();      //Ï¢ÖÎ£åÏùº
        let url = this.url + '/read';

        let data = {
          'date_kind': date_kind,
          'start': start,
          'end': end,
          'action': 'read',
          spjangcd: this.spjangcd.val()
        };

        let fnsuccess = function (result) {
          if (result != null) {
            _this.viewData.sourceCollection = result.data;
          }
        };
        AjaxUtil.getAsyncData(url, data, fnsuccess);
      }
    }

    let page = null;
    var picker = new ax5.ui.picker();

    $(document).ready(function (e) {

      const spjangcd = sessionStorage.getItem('spjangcd');
      if (spjangcd) {
        $('#spjangcdHidden').val(spjangcd);  // hidden inputÏù¥ ÏûàÏñ¥Ïïº Ìï®
      }

      page = new SujuUploadPage();

//        $('#divDate').ax5DatePicker({ direction: 'top' });
      $('#srchStartDt').val(CommonUtil.getYYYYMMDD(-7));
      $('#srchEndDt').val(CommonUtil.getYYYYMMDD());

      page.searchMainData();

      // Í≤ÄÏÉâ
      $('#btnSearch').click(function (e) {
        page.searchMainData();
      });

    });
  </script>

</th:block>
<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
</html>