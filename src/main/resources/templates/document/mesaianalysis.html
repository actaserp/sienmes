<html layout:decorate="~{layout_page}">
<head>
    <style>
        .wj-header {
            text-align: center !important;
        }
        .analysis-result-box {
            border: 1px solid #ddd;
            padding: 12px;
            background-color: #f9f9f9;
            height: auto;                /* âœ… ê¸°ì¡´ì—ëŠ” ê³ ì • height: 400px */
            min-height: 350px;           /* âœ… ë‚´ìš© ì—†ì„ ë•Œë„ ê³µê°„ í™•ë³´ */
            overflow-y: auto;
            color: #333;
            white-space: normal;
            word-break: break-word;
            .table-scroll {
                max-height: 400px;
                overflow-y: auto;
            }

        }

    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<th:block layout:fragment="content">
    <div class="layout-contents">
        <div class="page-title-wrap">
            <div class="left">
                <h2>MES AI ë¶„ì„</h2>
                <a title="ë¶ë§ˆí¬" class="bookmark toggle">ë‚´ ë©”ë‰´</a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
                <li>AI ë¶„ì„</li>
                <li>GPT ë¶„ì„</li>
            </ul>
        </div>

        <section class="section">
            <div class="section-top" style="width: 100%;">
                <div class="search-wrap" style="width: 50%;">
                    <dl style="width: 100%; display: block;"> <!-- âœ… dlì´ blockìœ¼ë¡œ -->
                        <dt>
                            <label for="gpt_prompt">ì§ˆë¬¸ ì…ë ¥</label>
                        </dt>
                        <dd style="width: 100%; display: block;"> <!-- âœ… ddë„ blockìœ¼ë¡œ -->
                            <div class="srch-box" style="width: 100%;">
                                <!-- ê¸°ì¡´ (í•œ ì¤„ input) -->
                                <!-- <input type="text" id="queryInput" ... /> -->
                                <!-- ìˆ˜ì •ëœ (ë©€í‹°ë¼ì¸ ì…ë ¥ì°½) -->
                                <textarea id="queryInput"
                                          rows="10"
                                          style="width: 100%; max-width: 100%; min-height: 200px; resize: vertical;"
                                          placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”. Shift+Enterë¡œ ì¤„ë°”ê¿ˆ, Enterë¡œ ì‹¤í–‰"></textarea>
                            </div>
                        </dd>
                    </dl>

                    <dl>
                        <dt><span class="eq"></span></dt>
                        <dd>
                            <div class="button-wrap" style=" margin-left: 20px">
                                <ul>
                                    <li>
                                        <a class="btn btn-delete" title="GPT ë¶„ì„" id="btnAnalyzeGPT">
                                            <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                            ë¶„ì„
                                        </a>
                                    </li>
                                    <li>
                                        <a class="btn btn-edit" title="ìˆ˜ì •" id="btnResetGPT">
                                            ğŸ—‘ï¸ ì´ˆê¸°í™”
                                        </a>
                                    </li>
                                    <li>
                                        <a class="btn btn-copy" title="ë³µì‚¬" id="btnCopyResult">
                                            ğŸ“‹ ë³µì‚¬
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </dd>
                    </dl>
                </div>
            </div>

            <div class="container-fluid">
                <div class="result-layout" style="display: flex; gap: 16px; width: 100%;">
                    <!-- GPT ë‹µë³€ ì˜ì—­ -->
                    <div style="flex: 1;">
                        <div class="table-scroll" style="max-height: 400px; overflow-y: auto;">
                            <div id="gpt_result_box" class="analysis-result-box">
                                ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                            </div>
                        </div>
                        <!-- X/Yì¶• ì„ íƒ UI -->
                        <div style="margin-top: 10px;">
                            <label for="xAxisSelect">Xì¶•:</label>
                            <input type="text" id="xAxisSelect" placeholder="ì˜ˆ: ì¼ì" style="width: 150px; margin-right: 10px;">
                            <label for="yAxisSelect">Yì¶•:</label>
                            <input type="text" id="yAxisSelect" placeholder="ì˜ˆ: ê¸ˆì•¡" style="width: 150px; margin-right: 10px;">
                            <button id="btnShowChart" class="btn">ğŸ“Š ê·¸ë˜í”„ ë³´ê¸°</button>
                        </div>
                    </div>

                    <!-- ê·¸ë˜í”„ ì˜ì—­ -->
                    <div id="gpt_chart_box" style="flex: 1; display: none;">
                        <canvas id="gpt_result_chart"></canvas>
                    </div>
                </div>
            </div>

        </section>
    </div>
</th:block>

<th:block layout:fragment="scripts">
    <script type="text/javascript">
        $('#btnResetGPT').click(function () {
            $('#queryInput').val('');
            $('#gpt_result_box').html(''); // ë˜ëŠ” .text('')
            $('#queryInput').focus();
        });

        $('#btnCopyResult').click(function () {
            const text = $('#gpt_result_box').text().trim();
            if (!text) {
                Alert.alert('ì•Œë¦¼', 'ë³µì‚¬í•  ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            navigator.clipboard.writeText(text).then(function () {
                Alert.alert('ì•ˆë‚´', 'ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }).catch(function (err) {
                Alert.alert('ì˜¤ë¥˜', 'ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                console.error(err);
            });
        });
        document.getElementById("queryInput").addEventListener("keydown", function (e) {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault(); // ì¤„ë°”ê¿ˆ ë§‰ê³ 
                document.getElementById("queryButton").click(); // ë˜ëŠ” runQuery();
            }
        });

        $('#btnAnalyzeGPT').click(function () {
            const prompt = $('#queryInput').val();
            if (!prompt.trim()) {
                Alert.alert('ì•Œë¦¼', 'ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            $('#gpt_result_box').html('<span style="color:#888;">GPTê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</span>');
            $('#gpt_chart_box').hide(); // ì´ˆê¸° ìƒíƒœë¡œ ìˆ¨ê¹€
            const requestData = {
                prompt: prompt,
                data: []
            };
            const fncallback = function (result) {
                console.log("GPT ì‘ë‹µ:", result);
                let html = '';
                let data = [];
                let sql = result.sql || ''; // ì‹¤í–‰ëœ SQL ì¿¼ë¦¬ (ë°±ì—”ë“œì—ì„œ í¬í•¨ì‹œì¼œì•¼ í•¨)

                const messageObj = result.message || {};
                const tableData = messageObj.tableData || result.tableData || [];

                if (result.answer) {
                    // ğŸ¯ ìì—°ì–´ ì‘ë‹µ ì²˜ë¦¬
                    // html = `<p>${result.answer.replaceAll('\n', '<br/>')}</p>`;
                    html = `<p style="white-space: pre-wrap;">${result.answer}</p>`;
                    window.gptData = [];
                    $('#gpt_chart_box').hide();
                } else if (typeof messageObj.message === 'string' && tableData.length === 0) {
                    html = messageObj.message;
                } else {
                    // ğŸ¯ SQL ê²°ê³¼ ì²˜ë¦¬
                    html = result.message?.message || result.message || '';
                    data = result.message?.tableData || result.tableData || [];
                    if (data.length === 0) {
                        // âš  ê²°ê³¼ ë°ì´í„° ì—†ìŒ + ì¿¼ë¦¬ í‘œì‹œ
                        html = `
                                <div style="color: orange;">
                                    <b>âš  ê²°ê³¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</b><br>
                                    ${sql ? `
                                        <div style="margin-top: 8px;">
                                            <span style="font-size: 13px; color: #555;">ì‹¤í–‰ëœ ì¿¼ë¦¬:</span>
                                            <pre style="background:#f9f9f9; padding:8px; border:1px solid #ccc;">${sql}</pre>
                                        </div>` : ''
                        }
                                </div>
                            `;
                        window.gptData = [];
                        $('#gpt_chart_box').hide();
                    }
                }

                if (html  && html.trim()) {
                    $('#gpt_result_box').html(html);
                    window.gptData = data;
                    $('#gpt_chart_box').hide(); // ê·¸ë˜í”„ëŠ” í´ë¦­ ì „ê¹Œì§€ ìˆ¨ê¹€
                } else {
                    $('#gpt_result_box').html('<span style="color:red;">ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</span>');
                    window.gptData = [];
                    $('#gpt_chart_box').hide();
                }
            };


            AjaxUtil.postJsonData('/api/mes/gpt-analyze', requestData, fncallback);
        });


        $('#btnShowChart').click(function () {
            const xKey = $('#xAxisSelect').val().trim();
            const yKey = $('#yAxisSelect').val().trim();

            if (!xKey || !yKey) {
                Alert.alert('ì•Œë¦¼', 'Xì¶•ê³¼ Yì¶• í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const result = window.gptData || [];

            if (result.length === 0) {
                Alert.alert('ì•Œë¦¼', 'í‘œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                // âœ… ë‹µë³€ ì˜ì—­ì€ ë¹„ìš°ê³ 
                // $('#gpt_result_box').html('');

                // âœ… ê·¸ë˜í”„ ì˜ì—­ì€ ë³´ì—¬ì¤Œ
                $('#gpt_chart_box').show();

                // âœ… Xì¶•, Yì¶• ë°ì´í„° ì¶”ì¶œ
                const labels = [];
                const data = [];

                window.gptData.forEach(row => {
                    const x = row[xKey];
                    const y = parseFloat(row[yKey]);
                    if (!isNaN(y)) {
                        labels.push(x);
                        data.push(y);
                    }
                });

                if (labels.length === 0 || data.length === 0) {
                    alert("ê·¸ë˜í”„ë¡œ í‘œì‹œí•  ìˆ˜ ìˆëŠ” ìˆ«ì ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                const ctx = document.getElementById('gpt_result_chart').getContext('2d');

                // âœ… ê¸°ì¡´ ì°¨íŠ¸ ì‚­ì œ (ì¤‘ë³µ ë°©ì§€)
                if (window.gptChart) {
                    window.gptChart.destroy();
                }

                // âœ… ìƒˆë¡œ ì°¨íŠ¸ ìƒì„± ë° ì €ì¥
                window.gptChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: yKey,
                            data: data,
                            backgroundColor: '#4e79a7'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: true }
                        }
                    }
                });

            } catch (e) {
                console.error(e);
                Alert.alert('ì˜¤ë¥˜', 'ê·¸ë˜í”„ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });



    </script>
</th:block>

</html>
