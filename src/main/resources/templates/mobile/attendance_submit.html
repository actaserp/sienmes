<!DOCTYPE html>
<html lang="ko">
<style>
  .btn-clear {
    display: none !important; /* ê°•ì œë¡œ ìˆ¨ê¹€ */
  }
  .btn-close {
    display: none !important; /* ê°•ì œë¡œ ìˆ¨ê¹€ */
  }
  /* ê²€ìƒ‰ ì˜ì—­ ìŠ¤íƒ€ì¼ */
  #searcharea, #detailarea {
    position: relative;
    width: 100%;
    margin-top: 10px;
  }

  /* ê²€ìƒ‰ ì•„ì´ì½˜ (SVG) */
  .search-icon {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
  }

  /* ê²€ìƒ‰ ê°€ì´ë“œ ìŠ¤íƒ€ì¼ */
  .search-guide {
    padding: 10px;
    font-size: 14px;
    color: #666;
  }

  /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
  .btn-select, .btn-login {
    width: 100%;
    padding: 10px;
    margin-top: 10px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }

  /* ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ (ë°°ê²½ íë¦¬ê²Œ) */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5); /* ë°˜íˆ¬ëª…í•œ ê²€ì€ìƒ‰ ë°°ê²½ */
    z-index: 999; /* ëª¨ë‹¬ë³´ë‹¤ í•œ ë‹¨ê³„ ì•„ë˜ */
  }

  /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
  .modal {
    display: none;
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    width: 400px;
    height: 650px;
    max-width: 90%;
    background-color: white;
    border-radius: 10px;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    padding: 20px;
    border: none;
    z-index: 9999;
  }

  /* ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
  .modal-close {
    position: absolute;
    top: 10px;
    right: 5px;
    width: 30px; /* ë²„íŠ¼ í¬ê¸° */
    height: 25px;
    border: none;
    border-radius: 3px;
    background: none; !important; /* ë°°ê²½ ì œê±° */
    background-color: transparent; !important; /* ë°°ê²½ì„ íˆ¬ëª…í•˜ê²Œ */
    z-index: 1000;
    cursor: pointer; /* í´ë¦­ ê°€ëŠ¥í•œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
  }

  #loadingSpinner {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.8); /* ë°°ê²½ ì–´ë‘¡ê²Œ */
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }

  #loadingImage {
    width: 95%; /* ì „ì²´ í™”ë©´ì˜ 80% í¬ê¸° */
    max-width: 900px; /* ìµœëŒ€ í¬ê¸° ì œí•œ */
  }

  .contents-wrap dd{
    margin-bottom: 20px;
  }

  .contents-wrap dt{
    margin-left: 10px;
    margin-bottom: 5px;
  }

</style>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ACTAS MES</title>
  <link rel="icon" type="image/png" href="/images/logo/actas_log_a.png">
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/> <!-- Slide css -->
  <link rel="stylesheet" href="/resource/ax5ui/ax5ui.all.css">
  <link rel="stylesheet" type="text/css" href="/assets_mobile/css/import.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

  <script src="/assets_mobile/js/ui.js"></script> <!-- Common js -->
  <script th:inline="javascript">
    var sandanData = /*[[${session.sandanList}]]*/ [];
  </script>


  <script type="text/javascript" src="/resource/ax5ui/ax5ui.all.min.js?v=1000"></script>

  <script type="text/javascript" src="/js/ax5commUtil.js?v=1070"></script>

  <script src="/js/common.js?v=1060"></script>
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script> <!-- Slide js -->
  <script src="/js/Mobile.js"></script>
</head>

<body>
<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
<div class="mobile-wrapper page-ticket-list"><!-- â˜…í˜ì´ì§€ Classëª… -->
  <!-- [ëª¨ë°”ì¼] í—¤ë”  -->
  <div class="mobile-layout-header">
    <header>
      <div class="left">
        <a href="#" title="ì „ì²´ë©”ë‰´" class="logo">
        </a>
      </div>
      <div class="left" style="margin-left:35px; font-size: 25px;">
        <h2>íœ´ê°€ë“±ë¡</h2>
      </div>
      <div class="right">
        <a href="#" title="ì „ì²´ë©”ë‰´" class="btn-menu">
          <img src="/assets_mobile/images/icon/btn-menu.svg" alt="ì „ì²´ë©”ë‰´ ì•„ì´ì½˜">
        </a>
      </div>
    </header>
  </div> <!-- //mobile-layout-header end-->

  <!-- [ëª¨ë°”ì¼] ë©”ë‰´  -->
  <div th:insert="~{mobile/mobile_menu :: mobile_menu}"></div>
  <!-- [ëª¨ë°”ì¼] ì»¨ë´ì¸   -->
  <div class="mobile-layout-contents">
    <!--- (ë ˆì´ì•„ì›ƒ) Contents ì˜ì—­ -->
    <div class="layout-contents" >
      <!-- ê²€ìƒ‰ ì˜ì—­  -->
      <div class="search-wrap">

      </div>
      <!-- ì»¨í…ì¸  ì˜ì—­  -->
      <div class="contents-wrap">
          <dl>
            <dt>ì‚¬ìš©ìID</dt>
            <dd>
              <div style="display: flex; gap: 10px">
                <div style="width: 100%">
                  <input type="text" id="userId" readonly>
                </div>
              </div>
            </dd>
            <dt>ì‚¬ìš©ìëª…</dt>
            <dd>
              <div style="display: flex; gap: 10px">
                <div style="width: 100%">
                  <input type="text" id="userName2" readonly>
                </div>
              </div>
            </dd>
            <dt>íœ´ê°€í•­ëª©</dt>
            <dd>
              <div style="display: flex; gap: 10%">
                  <select style="width: 70%" id="attKind" onchange="bindPeriod();">
                    <option>íœ´ê°€</option>
                  </select>
                  <label style="display: flex; align-items: center">
                    <input type="checkbox" style="margin: 0" id="isAnnual" disabled>
                    &nbsp;&nbsp;ì—°ì°¨</label>
              </div>
            </dd>
            <dt>ê¸°ê°„</dt>
            <dd>
              <!-- ì‹œì‘ ë‚ ì§œ/ì‹œê°„ -->
              <div style="display: flex; flex-direction: column; gap: 5px;">
                <div style="display: flex; gap: 10px;">
                  <input type="date" id="startDate" style="width: 140px;">
                  <input type="time" id="startTime" style="width: 140px;">
                </div>
              </div>

              <span style="font-weight: bold;">~</span>

              <!-- ì¢…ë£Œ ë‚ ì§œ/ì‹œê°„ -->
              <div style="display: flex; flex-direction: column; gap: 5px;">
                <div style="display: flex; gap: 10px;">
                  <input type="date" id="endDate" style="width: 140px;">
                  <input type="time" id="endTime" style="width: 140px;">
                </div>
              </div>

            </dd>
            <div style="display: flex;">
              <dt>ì‚¬ìš©ì¼ìˆ˜</dt>
              <dt style="margin-left: auto">ì—°ì°¨ì”ì—¬ì¼ìˆ˜</dt>
            </div>
            <dd>
              <div style="display: flex; gap: 10px">
                <div style="width: 100%; display: flex;">
                  <input type="number" id="useDate" style="width: 45%;" readonly>
                  <input type="number" id="usedDate" style="width: 45%; margin-left: auto;" readonly>
                </div>
              </div>
            </dd>
            <dt>ì‚¬ìœ </dt>
            <dd>
              <div style="display: flex; gap: 10px">
                <div style="width: 100%">
                  <input type="text" id="remark" >
                </div>
              </div>
            </dd>
          </dl>
          <div class="srch-btn">
            <button class="btn-dark" onclick="saveAttendance()">ë“±ë¡</button>
          </div>
        </div>
      </div><!--// contents-wrap end-->
    </div> <!--//layout-contents end -->
  </div> <!-- //mobile-layout-contents end-->
</div> <!-- //page-wrapper end-->
<script th:inline="javascript">
  // // Thymeleafì—ì„œ ê°’ ì„¤ì •: Null ì²´í¬ì™€ ê¸°ë³¸ê°’ ì²˜ë¦¬
  // var groupid = [[${session.groupid != null ? session.groupid : 'null'}]];
  // var id = /*[[${id != null ? id : 'null'}]]*/;
  // var groupname = /*[[${groupname != null ? groupname : 'null'}]]*/;
  // var username = /*[[${username != null ? username : 'null'}]]*/;
  //
  // // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ê°’ ìœ ì§€ (null ë˜ëŠ” ë¹ˆ ë¬¸ìì—´ì€ ì €ì¥í•˜ì§€ ì•ŠìŒ)
  // if (groupid && groupid !== 'null') localStorage.setItem('groupid', groupid);
  // if (id && id !== 'null') localStorage.setItem('id', id);
  // if (username && username !== 'null') localStorage.setItem('username', username);
  // if (groupname && groupname !== 'null') localStorage.setItem('groupname', groupname);
</script>

<script type="text/javascript">

  $(document).ready(function (e) {
    searchMainData();
    AjaxUtil.fillSelectOptions($('#attKind'), 'workcd', 'choose', false, 'work_division', '');
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    document.getElementById('startDate').addEventListener('change', calculateUseDays);
    document.getElementById('endDate').addEventListener('change', calculateUseDays);
  })
  // íœ´ê°€ê¸°ê°„ ì´ˆê¸° 00ì‹œ00ë¶„ ë°”ì¸ë“œ
  function bindDate(userStartTime){
    const today = new Date();
    const formattedDate = today.toISOString().split('T')[0];

    // userStartTimeì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ "00:00" ì„¤ì •
    const startTime = userStartTime ?? "00:00";

    // ì‹œì‘ ì‹œê°„ê³¼ ì¢…ë£Œ ì‹œê°„ ì´ˆê¸°í™”
    document.getElementById('startDate').value = `${formattedDate}`;
    document.getElementById('endDate').value = `${formattedDate}`;
  }

  // ìœ ì €ì •ë³´ í™•ì¸ (ì‚¬ìš©ìì •ë³´/ ID, ì´ë¦„, ì—°ì°¨ì”ì—¬ì¼ìˆ˜ ë°”ì¸ë“œ)
  function searchMainData(){
    let _this = this;
    let url = '/api/attendance_submit/read_userInfo'
    let data = {
    }
    let fnsuccess = function (result) {
      if (result != null) {
        console.log("âœ… ì‘ë‹µ ë°ì´í„°: ", result.data);

        // ìš”ì†Œê°€ ì¡´ì¬í•  ë•Œë§Œ ë°”ì¸ë”©
        const userIdEl = document.getElementById('userId');
        const userNameEl = document.getElementById('userName2');
        const usedDateEl = document.getElementById('usedDate');

        if (userIdEl) userIdEl.value = result.data.username ?? '';
        if (userNameEl) userNameEl.value = result.data.first_name ?? '';
        if (usedDateEl) usedDateEl.value = result.data.restnum ?? '';

        bindDate(result.data.sttime);
      }
    };
    AjaxUtil.getAsyncData(url, data, fnsuccess);
  }
  // íœ´ê°€ ë“±ë¡
  function saveAttendance(office){
    let _this = this;
    let url = '/api/attendance_submit/submitAttendance'
    let data = {
      'userId': document.getElementById('userId').value,
      'userName': document.getElementById('userName2').value,
      'attKind': document.getElementById('attKind').value,
      // 'isAnnual': document.getElementById('isAnnual').value,
      'useDate': document.getElementById('useDate').value,
      'usedDate': document.getElementById('usedDate').value,
      'remark': document.getElementById('remark').value,
      'startDate': document.getElementById('startDate').value,
      'startTime': document.getElementById('startTime').value,
      'endDate': document.getElementById('endDate').value,
      'endTime': document.getElementById('endTime').value,
      'isAnnual': document.getElementById('isAnnual').checked ? "1" : "0"
    }
    let fnsuccess = function (result) {
      if (result != null) {
        if (result.success) {
          Alert.alert('', result.message, function() {
            window.location.href = '/mobile/attendance_current';
          });
        } else {
          Alert.alert('', "íœ´ê°€ ë“±ë¡ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.");
        }
      } else {
        Alert.alert('', "ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
      }
    };
    AjaxUtil.postAsyncData(url, data, fnsuccess);
  }

  // ë‚ ì§œì™€ ì‹œê°„ ì°¨ì´ ê³„ì‚° í•¨ìˆ˜
  function calculateUseDays() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const useDateInput = document.getElementById('useDate');

    console.log('ë‚ ìê³„ì‚° ë©”ì„œë“œ ë™ì‘')
    if (useDateInput.getAttribute('data-fixed') === 'true') {
      console.log('useDateëŠ” ê³ ì •ê°’ ìƒíƒœì…ë‹ˆë‹¤. ê³„ì‚°í•˜ì§€ ì•ŠìŒ.');
      return;
    }
    if (startDate && endDate) {
      const start = new Date(startDate);
      const end = new Date(endDate);
      // ê°™ì€ ë‚ ì§œë©´ ìµœì†Œ í•˜ë£¨
      // í•˜ë£¨ = 1000ms * 60s * 60m * 24h
      const dayDiff = (end - start) / (1000 * 60 * 60 * 24);

      if (dayDiff === 0) {
        useDateInput.value = "1.00"; // ê°™ì€ ë‚ ì´ë©´ 1ì¼
      } else {
        useDateInput.value = dayDiff > 0 ? (dayDiff + 1).toFixed(2) : '0.00'; // ì–‘ìˆ˜ë©´ +1ì¼
      }
    }
  }
  function bindPeriod() {
    let _this = this;
    let url = '/api/attendance_submit/bindPeriod'
    let data = {
      'attKind': document.getElementById('attKind').value,
    }
    let fnsuccess = function (result) {
      if (result != null) {
        console.log("result : ", result);
        let usenum = parseFloat(result.data.usenum);
        if (usenum > 0 && usenum < 1) {
          const useDateInput = document.getElementById('useDate');
          useDateInput.value = usenum.toFixed(2);
          useDateInput.setAttribute('data-fixed', 'true'); // ğŸ”’ ì ê¸ˆ í‘œì‹œ
        } else {
          document.getElementById('useDate').removeAttribute('data-fixed');
        }
        document.getElementById('isAnnual').checked = result.data.yearflag === '1';
      } else {
        Alert.alert('', "ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
      }
    };
    AjaxUtil.getAsyncData(url, data, fnsuccess);
  }
</script>
</body>
</html>
