<!DOCTYPE html>
<html lang="ko">
<style>
    .btn-clear {
        display: none !important; /* ê°•ì œë¡œ ìˆ¨ê¹€ */
    }
    .btn-close {
        display: none !important; /* ê°•ì œë¡œ ìˆ¨ê¹€ */
    }
    /* ê²€ìƒ‰ ì˜ì—­ ìŠ¤íƒ€ì¼ */
    #searcharea, #detailarea {
        position: relative;
        width: 100%;
        margin-top: 10px;
    }

    .search-container input {
        margin-top: 10px;
        margin-bottom: 10px;
        box-shadow: 0 4px 5px rgba(0, 0, 0, 0.2);
    }

    #searcharea input, #detailarea input {
        width: 100%;
        border: none;
        outline: none;
        font-size: 16px;
        padding: 10px;
    }

    #theGrid {
        overflow-x: auto; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ í™œì„±í™” */
        white-space: nowrap; /* í…Œì´ë¸”ì´ ìë™ìœ¼ë¡œ ì¤„ ë°”ê¿ˆë˜ì§€ ì•Šë„ë¡ ì„¤ì • */
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: none;
    }

    .modal {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        width: 95%;
        z-index: 1001;
    }

    .modal input, .modal select {
        width: 100%;
        margin-bottom: 10px;
        padding: 5px;
    }

</style>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACTAS MES</title>
    <link rel="icon" type="image/png" href="/images/logo/actas_log_a.png">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/> <!-- Slide css -->
    <link rel="stylesheet" href="/resource/ax5ui/ax5ui.all.css">
    <link rel="stylesheet" type="text/css" href="/assets_mobile/css/import.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

    <script src="/assets_mobile/js/ui.js"></script> <!-- Common js -->
    <script th:inline="javascript">
        var sandanData = /*[[${session.sandanList}]]*/ [];
    </script>


    <script type="text/javascript" src="/resource/ax5ui/ax5ui.all.min.js?v=1000"></script>

    <script type="text/javascript" src="/js/ax5commUtil.js?v=1070"></script>

    <script src="/js/common.js?v=1060"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script> <!-- Slide js -->
    <script src="/js/Mobile.js"></script>
</head>

<body>
<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
<div class="mobile-wrapper page-ticket-list"><!-- â˜…í˜ì´ì§€ Classëª… -->
    <!-- [ëª¨ë°”ì¼] í—¤ë”  -->
    <div class="mobile-layout-header">
        <header>
            <div class="left">
                <a href="#" title="ì „ì²´ë©”ë‰´" class="logo">
                </a>
            </div>
            <div class="left" style="margin-left:35px; font-size: 25px;">
                <h2>ê°œì¸ë³„íœ´ê°€í˜„í™©</h2>
            </div>
            <div class="right">
                <a href="#" title="ì „ì²´ë©”ë‰´" class="btn-menu">
                    <img src="/assets_mobile/images/icon/btn-menu.svg" alt="ì „ì²´ë©”ë‰´ ì•„ì´ì½˜">
                </a>
            </div>
        </header>
    </div> <!-- //mobile-layout-header end-->

    <!-- [ëª¨ë°”ì¼] ë©”ë‰´  -->
    <div th:insert="~{mobile/mobile_menu :: mobile_menu}"></div>
    <!-- [ëª¨ë°”ì¼] ì»¨ë´ì¸   -->
    <div class="mobile-layout-contents">
        <!--- (ë ˆì´ì•„ì›ƒ) Contents ì˜ì—­ -->
        <div class="layout-contents" >
            <!-- ê²€ìƒ‰ ì˜ì—­  -->
            <div class="search-wrap">
                <div class="srch-tit aco-hd">
                    <p>ê¸°ë³¸ê²€ìƒ‰</p>
                    <a href="#" title="ì—´ê¸°/ë‹«ê¸°" class="btn-aco">
                        <img src="/assets_mobile/images/icon/ico-down.svg" alt="ì—´ê¸°/ë‹«ê¸°">
                    </a>
                </div>
                <div class="srch-cont aco-cont">
                    <dl>
                        <dt>ì¡°íšŒë…„ë„</dt>
                        <dd>
                            <div style="display: flex; gap: 10px">
                                <div style="width: 100%">
                                    <select id="searchYear">
                                        <option>
                                            2025
                                        </option>
                                    </select>
                                </div>
                            </div>
                        </dd>
                    </dl>
                    <dl>
                        <dt>ê·¼íƒœí•­ëª©</dt>
                        <dd>
                            <div style="display: flex; gap: 10px">
                                <div style="width: 100%">
                                    <select id="selectWorkcd">
                                        <option>ì „ì²´</option>
                                    </select>
                                </div>
                            </div>
                        </dd>
                    </dl>
                    <div class="srch-btn">
                        <button class="btn-dark" onclick="handleSearch()">ì¡°íšŒ</button>
                    </div>
                </div>
            </div>
            <!-- ì»¨í…ì¸  ì˜ì—­  -->
            <div class="contents-wrap">
                <div id="theGrid">

                </div>
                <div class="srch-btn">
                </div>
            </div><!--// contents-wrap end-->
        </div> <!--//layout-contents end -->
        <!-- ìˆ˜ì • ëª¨ë‹¬ -->
        <!-- ìˆ˜ì • ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ ë° ì°½ -->
        <div id="vacationEditModal" class="modal-overlay">
            <div class="modal">
                <h3>íœ´ê°€ ì •ë³´ ìˆ˜ì •</h3>
                <input type="hidden" id="vacId">
                <br>
                <div class="form-group" >
                    <label for="editAttKind">ê·¼íƒœí•­ëª©:</label>
                    <div style="display: flex; gap: 10%">
                        <select id="editAttKind" style="width: 70%" onchange="bindPeriod();">
                            <option>íœ´ê°€</option>
                        </select>
                        <label style="display: flex; align-items: center">
                            <input type="checkbox" style="margin: 0" id="isAnnual" disabled>
                            &nbsp;&nbsp;ì—°ì°¨</label>
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <label for="editStartDate">ì‹œì‘ì¼:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="date" id="editStartDate" style="width: 140px;">
                        <input type="time" id="editStartTime" style="width: 140px;">
                    </div>
                </div>

                <div class="form-group">
                    <label for="editEndDate">ì¢…ë£Œì¼:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="date" id="editEndDate" style="width: 140px;">
                        <input type="time" id="editEndTime" style="width: 140px;">
                    </div>
                </div>

                <div class="form-group">
                    <label for="editUseDate">ì‚¬ìš©ì¼ìˆ˜:</label>
                    <input type="number" id="editUseDate" readonly>
                </div>

                <div class="form-group">
                    <label for="editRemark">ì‚¬ìœ :</label>
                    <input type="text" id="editRemark">
                </div>

                <div style="display: flex; gap: 10px;">
                    <button onclick="submitEditVacation()" style="background-color: #56a0fd; color: #FFFFFF">ìˆ˜ì •</button>
                    <button onclick="deleteVacation()">ì‚­ì œ</button>
                    <button onclick="closeEditModal()">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div> <!-- //mobile-layout-contents end-->
</div> <!-- //page-wrapper end-->
<script th:inline="javascript">
    // // Thymeleafì—ì„œ ê°’ ì„¤ì •: Null ì²´í¬ì™€ ê¸°ë³¸ê°’ ì²˜ë¦¬
    // var groupid = [[${session.groupid != null ? session.groupid : 'null'}]];
    // var id = /*[[${id != null ? id : 'null'}]]*/;
    // var groupname = /*[[${groupname != null ? groupname : 'null'}]]*/;
    // var username = /*[[${username != null ? username : 'null'}]]*/;
    //
    // // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ê°’ ìœ ì§€ (null ë˜ëŠ” ë¹ˆ ë¬¸ìì—´ì€ ì €ì¥í•˜ì§€ ì•ŠìŒ)
    // if (groupid && groupid !== 'null') localStorage.setItem('groupid', groupid);
    // if (id && id !== 'null') localStorage.setItem('id', id);
    // if (username && username !== 'null') localStorage.setItem('username', username);
    // if (groupname && groupname !== 'null') localStorage.setItem('groupname', groupname);
</script>
<script type="text/javascript">

    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const date = String(today.getDate()).padStart(2, '0');

    $(document).ready(function () {
        AjaxUtil.fillSelectOptions($('#selectWorkcd'), 'workcd', 'all', false, 'work_division', '');
        AjaxUtil.fillSelectOptions($('#editAttKind'), 'workcd', 'choose', false, 'work_division', '');
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        document.getElementById('editStartDate').addEventListener('change', calculateUseDays);
        document.getElementById('editEndDate').addEventListener('change', calculateUseDays);
        searchMainData();
    });
    // yy.mm.dd í˜•ì‹ í¬ë©§í•¨ìˆ˜
    function formatDateToYYMMDD(dateStr) {
        if (!dateStr || dateStr.length < 10) return '';
        return dateStr.slice(2, 10); // "2024.05.27" â†’ "24.05.27"
    }
    function searchMainData() {
        let url = '/api/attendance_current/read';
        let data = {
            'workcd': document.getElementById('selectWorkcd').value,
            'searchYear': document.getElementById('searchYear').value,
        };
        let fnsuccess = function (result) {
            if (result != null && result.data != null) {
                if(result.data.annInfo == null){
                    result.data.annInfo = {
                        rtdate: "",
                        ewolnum: "",
                        holinum: "",
                        daynum: "",
                        restnum: ""
                    };
                }
                // í˜„ì¬ íœ´ê°€ì •ë³´ ë°ì´í„° ê°œìˆ˜ í™•ì¸
                const currentLength = result.data.vacInfo.length;
                if (currentLength < 8) {
                    const itemsToAdd = 8 - currentLength;
                    for (let i = 0; i < itemsToAdd; i++) {
                        result.data.vacInfo.push({});
                    }
                }
                // ì¡°íšŒëœ ì—°ì°¨ì •ë³´
                const annInfo = result.data.annInfo;
                // ì¡°íšŒëœ ë°ì´í„°(íœ´ê°€ì •ë³´)
                const vacitems = result.data.vacInfo;

                // âœ… ë™ì  í…Œì´ë¸” ìƒì„±
                let tableHtml = `
          <table>
                        <tr>
                            <th>ì…ì‚¬ì¼</th>
                            <td colspan="7" style="text-align: left">
                                ${annInfo.rtdate || ''}
                            </td>
                            <td>

                            </td>
                        </tr>
                        <br>
                        <tr>
                            <th>ì´ì›”</th>
                            <td>
                                ${annInfo.ewolnum || ''}
                            </td>
                            <th>ìƒì„±</th>
                            <td>
                                ${annInfo.holinum || ''}
                            </td>
                            <th>ì‚¬ìš©</th>
                            <td>
                                ${annInfo.daynum || ''}
                            </td>
                            <th>ì”ì—¬</th>
                            <td>
                                ${annInfo.restnum || ''}
                            </td>
                            <td></td>
                        </tr>
                        <br>
                        <tr>
                            <th>ì‹ ì²­ì¼</th>
                            <th>êµ¬ë¶„</th>
                            <th>ì—°ì°¨</th>
                            <th>ì‹œì‘ì¼</th>
                            <th>ì¢…ë£Œì¼</th>
                            <th>ê¸°ê°„</th>
                            <th>ì‚¬ìœ </th>
                            <th>ì‹œì‘ì‹œê°</th>
                            <th>ì¢…ë£Œì‹œê°</th>
                        </tr>
                `;

                vacitems.forEach(vacInfo => {
                    tableHtml += `
                    <tr>
                        <td>${formatDateToYYMMDD(vacInfo.reqdate) || ''}</td>
                        <td>${vacInfo.worknm || ''}</td>
                        <td>${vacInfo.yearflag || ''}</td>
                        <td>${formatDateToYYMMDD(vacInfo.frdate) || ''}</td>
                        <td>${formatDateToYYMMDD(vacInfo.todate) || ''}</td>
                        <td>${vacInfo.daynum || ''}</td>
                        <td>${vacInfo.remark || ''}</td>
                        <td>${vacInfo.sttime || ''}</td>
                        <td>${vacInfo.edtime || ''}</td>
                        <td style="display: none;">${vacInfo.workcd || ''}</td>
                        <td style="display: none;">${vacInfo.id || ''}</td>
                        <td style="display: none;">${vacInfo.appgubun || ''}</td>
                        <td style="display: none;">${vacInfo.fixflag || ''}</td>
                    </tr>
                `;
                });

                tableHtml += `
                </table>
            `;

                // âœ… ê¸°ì¡´ ë‚´ìš© ì œê±°í•˜ê³  ìƒˆë¡­ê²Œ ë°”ì¸ë”©
                const tableBody = document.querySelector('#theGrid');
                tableBody.innerHTML = tableHtml;
            } else {
                const tableBody = document.querySelector('#theGrid');
                tableBody.innerHTML = `
          <tr>
              <td colspan="6" style="text-align: center; padding: 8px;">ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
          </tr>
      `;
            }
        };
        AjaxUtil.getAsyncData(url, data, fnsuccess);
    }
    // ê²€ìƒ‰ë²„íŠ¼ í´ë¦­
    function handleSearch() {
        searchMainData();
        const buttons = document.querySelectorAll('.btn-aco');
        buttons.forEach(button => {
            button.click();
        });
    }
    // yyyy.mm.dd í˜•ì‹ ë³µì›í•¨ìˆ˜
    function restoreFullYearDate(shortDateStr) {
        if (!shortDateStr || shortDateStr.length !== 8) return ''; // ex: "24.05.27"
        const parts = shortDateStr.split('.');
        const fullYear = '20' + parts[0]; // assumes 20xx
        return `${fullYear}.${parts[1]}.${parts[2]}`;
    }
    // íœ´ê°€ì •ë³´ í…Œì´ë¸” í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    document.querySelector('#theGrid').addEventListener('click', function (e) {
        const targetRow = e.target.closest('tr');
        if (!targetRow) return;
        const cells = targetRow.querySelectorAll('td');
        const gubunValue = cells[11].innerText;
        const fixflag = cells[12].innerText;
        const isEmptyRow = Array.from(cells).every(cell => cell.innerText.trim() === "");
        if (isEmptyRow) return;
        if (gubunValue !== '001'){
            Alert.alert('',  'í•´ë‹¹ í•­ëª©ì€ ê²°ì¬ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.')
            return
        }else if (fixflag !== '0' && fixflag !== ''){
            Alert.alert('',  'í•´ë‹¹ í•­ëª©ì€ í™•ì¸ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.')
            return
        }

        openEditModal(targetRow);
    });
    function openEditModal(targetRow) {
        const cells = targetRow.querySelectorAll('td');
        // ëª¨ë‹¬ì— ê°’ ì±„ìš°ê¸°
        const textValue = cells[9].innerText;

        // ëª¨ë“  option ìš”ì†Œë¥¼ ìˆœíšŒ
        const selectElement = document.getElementById('editAttKind');
        const options = selectElement.options;

        for (let i = 0; i < options.length; i++) {
            if (options[i].value === textValue) {
                selectElement.value = options[i].value;
                break;
            }
        }
        // âœ… ë‚ ì§œì™€ ì‹œê°„ ì¡°í•©í•´ì„œ datetime-local í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        const startDate = restoreFullYearDate(cells[3].innerText).split('.');
        const startTime = cells[7].innerText; // hh:mm

        const endDate = restoreFullYearDate(cells[4].innerText).split('.');
        const endTime = cells[8].innerText;

        // âœ… datetime-local í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        const formattedStartDateTime = `${startDate[0]}-${startDate[1]}-${startDate[2]}`;
        const formattedEndDateTime = `${endDate[0]}-${endDate[1]}-${endDate[2]}`;
        document.getElementById('editStartDate').value = formattedStartDateTime;
        document.getElementById('editStartTime').value = startTime;
        document.getElementById('editEndDate').value = formattedEndDateTime;
        document.getElementById('editEndTime').value = endTime;
        document.getElementById('editUseDate').value = cells[5].innerText;
        document.getElementById('editRemark').value = cells[6].innerText;
        document.getElementById('vacId').value = cells[10].innerText;
        document.getElementById('isAnnual').checked = cells[2].innerText !== '';

        // ëª¨ë‹¬ ì—´ê¸°
        document.getElementById('vacationEditModal').style.display = 'block';
    }

    // âœ… ëª¨ë‹¬ ë‹«ê¸°
    function closeEditModal() {
        document.getElementById('vacationEditModal').style.display = 'none';
    }

    // ëª¨ë‹¬ ë°ì´í„° ì €ì¥(íœ´ê°€ë°ì´í„° ìˆ˜ì •)
    function submitEditVacation() {
        let url = '/api/attendance_current/updateAttendance';
        let data = {
            'vacId': document.getElementById('vacId').value,
            'attKind': document.getElementById('editAttKind').value,
            'useDate': document.getElementById('editUseDate').value,
            'remark': document.getElementById('editRemark').value,
            'startDate': document.getElementById('editStartDate').value,
            'startTime': document.getElementById('editStartTime').value,
            'endDate': document.getElementById('editEndDate').value,
            'endTime': document.getElementById('editEndTime').value,
            'isAnnual': document.getElementById('isAnnual').checked ? "1" : "0"
        };

        let fnsuccess = function (result) {
            if (result != null) {
                if (result.success) {
                    Alert.alert('', result.message, reloadWindow);
                } else {
                    Alert.alert('',"íœ´ê°€ ìˆ˜ì •ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.");
                }
            } else {
                Alert.alert('',"ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
            }
        };

        AjaxUtil.postAsyncData(url, data, fnsuccess);
    }

    // íœ´ê°€ë°ì´í„° ì‚­ì œ
    function deleteVacation() {
        let url = '/api/attendance_current/deleteAttendance';
        let data = {
            'vacId': document.getElementById('vacId').value
        };

        let fnsuccess = function (result) {
            if (result != null) {
                if (result.success) {
                    Alert.alert('', result.message, reloadWindow);
                } else {
                    Alert.alert('',"íœ´ê°€ ì‚­ì œì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.");
                }
            } else {
                Alert.alert('',"ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
            }
        };

        AjaxUtil.postAsyncData(url, data, fnsuccess);
    }

    // ë‚ ì§œì™€ ì‹œê°„ ì°¨ì´ ê³„ì‚° í•¨ìˆ˜
    function calculateUseDays() {
        const startDate = document.getElementById('editStartDate').value;
        const endDate = document.getElementById('editEndDate').value;
        const useDateInput = document.getElementById('editUseDate');

        console.log('ë‚ ìê³„ì‚° ë©”ì„œë“œ ë™ì‘')
        if (useDateInput.getAttribute('data-fixed') === 'true') {
            console.log('useDateëŠ” ê³ ì •ê°’ ìƒíƒœì…ë‹ˆë‹¤. ê³„ì‚°í•˜ì§€ ì•ŠìŒ.');
            return;
        }
        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            // ê°™ì€ ë‚ ì§œë©´ ìµœì†Œ í•˜ë£¨
            // í•˜ë£¨ = 1000ms * 60s * 60m * 24h
            const dayDiff = (end - start) / (1000 * 60 * 60 * 24);

            if (dayDiff === 0) {
                useDateInput.value = "1.00"; // ê°™ì€ ë‚ ì´ë©´ 1ì¼
            } else {
                useDateInput.value = dayDiff > 0 ? (dayDiff + 1).toFixed(2) : '0.00'; // ì–‘ìˆ˜ë©´ +1ì¼
            }
        }
    }
    function reloadWindow(){
        console.log("í™•ì¸ ë²„íŠ¼ í´ë¦­ë¨");
        window.location.reload(); // âœ… í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
    }
    function bindPeriod() {
        let _this = this;
        let url = '/api/attendance_submit/bindPeriod'
        let data = {
            'attKind': document.getElementById('editAttKind').value,
        }
        let fnsuccess = function (result) {
            if (result != null) {
                console.log("result : ", result);
                let usenum = parseFloat(result.data.usenum);
                if (usenum > 0 && usenum < 1) {
                    const useDateInput = document.getElementById('editUseDate');
                    useDateInput.value = usenum.toFixed(2);
                    useDateInput.setAttribute('data-fixed', 'true'); // ğŸ”’ ì ê¸ˆ í‘œì‹œ
                } else {
                    document.getElementById('editUseDate').removeAttribute('data-fixed');
                }
                document.getElementById('isAnnual').checked = result.data.yearflag === '1';
            } else {
                Alert.alert('', "ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
            }
        };
        AjaxUtil.getAsyncData(url, data, fnsuccess);
    }
</script>
</body>
</html>
