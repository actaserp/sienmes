<!DOCTYPE html>
<html lang="ko">
<style>
  .contents-wrap{

  }
  .currentData{

  }

  .ip-card{
    width: 80%;
    aspect-ratio: 1 / 1;
    background: linear-gradient(135deg, #4dd0e1, #81c784);
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    margin-bottom: 10px;
    position: relative;
    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
    text-align: center;
    margin-left: 10%;
    font-size: large;
  }

  .office-card{
    text-align: center;
    padding: 10px;
    margin-bottom: 5px;
    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .btnArea{
    position: fixed;
    bottom: 0px;
    width: 93%;
    height: 120px;
  }

  .office_btn {
    background-color: #007aff;
    color: white;
    border: none;
    border-radius: 8px;
    width: 100px;
    height: 100px;
    font-size: 1.2em;
    cursor: pointer;
    transition: background-color 0.3s;
    display: block;
    margin-top: 10px;
    margin-bottom: 50px;
    border: none;
    box-shadow: 0 4px 5px rgba(0, 0, 0, 0.2);
  }

  #officeIcon {
    color: #ffffff;
    background-color: #9acaf4;
    border-radius: 10px;
    font-size: 2.5em;
    width: 15%;
    aspect-ratio: 1 / 1;
    padding-top: 2%;
    margin-right: 10%;
  }

  #selectWorkcd {
    max-height: 150px; /* ìµœëŒ€ 150pxê¹Œì§€ë§Œ ë³´ì—¬ì¤Œ */
    overflow-y: auto;  /* ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ ì„¤ì • */
  }
</style>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ACTAS ERP</title>
  <link rel="icon" type="image/png" href="/images/logo/actas_log_a.png">
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/> <!-- Slide css -->
  <link rel="stylesheet" href="/resource/ax5ui/ax5ui.all.css">
  <link rel="stylesheet" type="text/css" href="/assets_mobile/css/import.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

  <script src="/assets_mobile/js/ui.js"></script> <!-- Common js -->
  <script th:inline="javascript">
    var sandanData = /*[[${session.sandanList}]]*/ [];
  </script>


  <script type="text/javascript" src="/resource/ax5ui/ax5ui.all.min.js?v=1000"></script>

  <script type="text/javascript" src="/js/ax5commUtil.js?v=1070"></script>

  <script src="/js/common.js?v=1060"></script>
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script> <!-- Slide js -->
  <script src="/js/Mobile.js"></script>
  <script src="https://kit.fontawesome.com/84dc79ac13.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body>
<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
<div class="mobile-wrapper page-ticket-list"><!-- â˜…í˜ì´ì§€ Classëª… -->
  <!-- [ëª¨ë°”ì¼] í—¤ë”  -->
  <div class="mobile-layout-header">
    <header>
      <div class="left">
        <a href="#" title="ì „ì²´ë©”ë‰´" class="logo">
        </a>
      </div>
      <div class="left" style="margin-left:35px; font-size: 25px;">
        <h2>ì¶œí‡´ê·¼ë“±ë¡</h2>
      </div>
      <div class="right">
        <a href="#" title="ì „ì²´ë©”ë‰´" class="btn-menu">
          <img src="/assets_mobile/images/icon/btn-menu.svg" alt="ì „ì²´ë©”ë‰´ ì•„ì´ì½˜">
        </a>
      </div>
    </header>
  </div> <!-- //mobile-layout-header end-->

  <!-- [ëª¨ë°”ì¼] ë©”ë‰´  -->
  <div th:insert="~{mobile/mobile_menu :: mobile_menu}"></div>
  <!-- [ëª¨ë°”ì¼] ì»¨ë´ì¸   -->
  <div class="mobile-layout-contents">
    <!--- (ë ˆì´ì•„ì›ƒ) Contents ì˜ì—­ -->
    <div class="layout-contents" >
      <!-- ê²€ìƒ‰ ì˜ì—­  -->
      <div class="search-wrap" style="margin-bottom: 10px">

      </div>
      <!-- ì»¨í…ì¸  ì˜ì—­  -->
      <div class="contents-wrap">
        <dl style="margin-bottom: 10px">
<!--          <div style="width: 100%; display: flex; justify-content: center; margin: 30px 0 30px 0;">-->
<!--            <img src="/assets_mobile/images/logo/actas_log.png" alt="ë¡œê³  ì´ë¯¸ì§€" style="width: 70%">-->
<!--          </div>-->
          <div class="ip-card">
            <input type="hidden" id="postno">
            <!--í˜„ì¬ ì •ë³´ ì¹´ë“œ-->
            <!-- í˜„ì¬ ë‚ ì ì¶œë ¥ -->
            <div style="margin-bottom: 10px">
              <div id="searchDate" class="currentData" style="text-align: justify;"></div>
              <div id="userInfo" class="currentData" style="text-align: end">ìƒì‚°ë¶€ í™ê¸¸ë™ ì‚¬ì›</div>
            </div>
            <!-- ip ê²€ìƒ‰ ì‹œê°„(í˜„ì¬ì‹œê°„) -->
            <div>
              <span id="searchTime" class="currentData" style="height: 100px; font-size: 40px;"></span>
            </div>
            <!-- í˜„ì¬ip -->
            <div>
              <span id="ipAddress" class="currentData" style="border-radius: 0 0 10px 10px;"></span>
            </div>
          </div>

          <!-- ì¶œê·¼ì‹œê°„ ì¹´ë“œ -->
          <div class="office-card">
            <i class="fa-solid fa-stopwatch fa_xl" id="officeIcon"></i>
            <div>
              <div class="status">ì¶œê·¼</div>
              <div class="time" id="officeTime" style="font-weight: bold">ì˜¤ì „ 09:00</div>
            </div>
          </div>

          <!-- ê·¼íƒœêµ¬ë¶„ í™•ì¸ -->
          <div id="workcd" style="display: none">
            <label>ê·¼íƒœêµ¬ë¶„</label>
            <div>
              <select id="selectWorkcd">
                <option>íœ´ê°€</option>
              </select>
            </div>
            <div style="font-size: small; color: red;" id="gpsInfo">
            </div>
          </div>

          <!-- ë²„íŠ¼ -->
          <div class="btnArea">
            <div id="inside" style="display: none; gap: 13%; justify-content: center;">
              <button onclick="submitCommute('inOfficeIn')" class="office_btn" style=""><i class="fa-solid fa-briefcase fa_xl" style="color: #ffffff;"></i><br>ì‚¬ë‚´ì¶œê·¼</button>
              <button onclick="submitCommute('inOfficeOut')" class="office_btn" style="background-color: red;"><i class="fa-solid fa-person-walking fa-xl" style="color: #ffffff;"></i><br>ì‚¬ë‚´í‡´ê·¼</button>
            </div>
            <div id="outside" style="display: none; gap: 13%; justify-content: center;">
              <button onclick="submitCommute('outOfficeIn')" class="office_btn" style=""><i class="fa-solid fa-briefcase fa_xl" style="color: #ffffff;"></i><br>ì™¸ë¶€ì¶œê·¼</button>
              <button onclick="submitCommute('outOfficeOut')" class="office_btn" style="background-color: red;"><i class="fa-solid fa-person-walking fa_xl" style="color: #fafafa;"></i><br>ì™¸ë¶€í‡´ê·¼</button>
            </div>
          </div>
        </dl>
      </div><!--// contents-wrap end-->
    </div> <!--//layout-contents end -->
  </div> <!-- //mobile-layout-contents end-->
</div> <!-- //page-wrapper end-->
<script th:inline="javascript">
  // // Thymeleafì—ì„œ ê°’ ì„¤ì •: Null ì²´í¬ì™€ ê¸°ë³¸ê°’ ì²˜ë¦¬
  // var groupid = [[${session.groupid != null ? session.groupid : 'null'}]];
  // var id = /*[[${id != null ? id : 'null'}]]*/;
  // var groupname = /*[[${groupname != null ? groupname : 'null'}]]*/;
  // var username = /*[[${username != null ? username : 'null'}]]*/;
  //
  // // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ê°’ ìœ ì§€ (null ë˜ëŠ” ë¹ˆ ë¬¸ìì—´ì€ ì €ì¥í•˜ì§€ ì•ŠìŒ)
  // if (groupid && groupid !== 'null') localStorage.setItem('groupid', groupid);
  // if (id && id !== 'null') localStorage.setItem('id', id);
  // if (username && username !== 'null') localStorage.setItem('username', username);
  // if (groupname && groupname !== 'null') localStorage.setItem('groupname', groupname);
</script>
<script type="text/javascript">
  // í˜„ì¬ ë‚ ì§œ ì„¤ì • (í˜ì´ì§€ ë¡œë”© ì‹œ 1íšŒ ì„¤ì •)
  // ìš”ì¼ ì´ë¦„ ë°°ì—´
  const weekDays = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
  // GPS ë³€ìˆ˜
  let latitude = null;
  let longitude = null;

  const updateDate = () => {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const date = String(today.getDate()).padStart(2, '0');
    const weekDay = weekDays[today.getDay()];
    document.getElementById('searchDate').innerText = `${year}.${month}.${date}(${weekDay})`;
  };

  const updateIPAddress = () => {
    const cacheBuster = `?format=json&cb=${Date.now()}`;
    fetch(`https://api.ipify.org${cacheBuster}`)
            .then(response => response.text())
            .then(data => {
              console.log("ì‘ë‹µ ë°ì´í„° í™•ì¸:", data);
              if (data.includes('{')) {
                const jsonData = JSON.parse(data);
                document.getElementById('ipAddress').innerText = 'IP : ' + jsonData.ip;
                handleIPDisplay(jsonData.ip);
              } else {
                document.getElementById('ipAddress').innerText = 'IP : ' + data.trim();
                handleIPDisplay(data.trim());
              }
            })
            .catch(error => {
              console.error("IP ì¡°íšŒ ì¤‘ ì—ëŸ¬ ë°œìƒ: ", error.message);
            });
  };

  const handleIPDisplay = (ip) => {
    if (ip === '106.240.249.66') {
      console.log('ì‚¬ë‚´ IP í™•ì¸');
      document.getElementById('inside').style.display = 'flex';
      document.getElementById('outside').style.display = 'none';
      document.getElementById('workcd').style.display = 'none';
    } else {
      console.log('ì™¸ë¶€ IP í™•ì¸');
      document.getElementById('inside').style.display = 'none';
      document.getElementById('outside').style.display = 'flex';
      document.getElementById('workcd').style.display = 'block';

    }
  };

  // ë„¤íŠ¸ì›Œí¬ ì—°ê²° ìƒíƒœ ë³€ê²½ ê°ì§€
  window.addEventListener('online', () => {
    console.log("ğŸ“¡ ë„¤íŠ¸ì›Œí¬ê°€ ë‹¤ì‹œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤. IPë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.");
    updateIPAddress();
  });

  // ë„¤íŠ¸ì›Œí¬ íƒ€ì… ë³€ê²½ ê°ì§€ (LTE â†’ Wi-Fi ë“±)
  if (navigator.connection) {
    navigator.connection.addEventListener('change', () => {
      console.log('ğŸ“¶ ë„¤íŠ¸ì›Œí¬ íƒ€ì… ë³€ê²½ ê°ì§€ë¨:', navigator.connection.effectiveType);
      setTimeout(() => {
        updateIPAddress();
      }, 2000); // ë„¤íŠ¸ì›Œí¬ ì•ˆì •í™” ëŒ€ê¸°
    });
  }

  const updateTime = () => {
    const now = new Date();
    let hours = now.getHours();
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12 || 12;
    const formattedTime = `${hours}:${minutes}:${seconds} ${ampm}`;
    document.getElementById('searchTime').innerText = formattedTime;
  };

  (() => {
    updateIPAddress();
    updateTime();
  })();

  setInterval(updateIPAddress, 5000);
  setInterval(updateTime, 5000);

  updateDate();

  $(document).ready(function (e) {
    // ìœ ì €ì •ë³´ í™•ì¸
    function searchMainData(){
      let _this = this;
      let url = '/api/mobile_main/read_userInfo'
      let data = {
      }
      let fnsuccess = function (result) {
        console.log('result : ', result)
        if (result != null) {
          document.getElementById('userInfo').textContent = result.data.Name +" "+ result.data.first_name +" "+ result.data.jik_id;
          document.getElementById('officeTime').textContent = result.data.inOfficeTime ? result.data.inOfficeTime : "--:--";
          // ê·¼íƒœêµ¬ë¶„ê°’ ë°”ì¸ë“œ
          const selectElement = document.getElementById('selectWorkcd');
          const options = selectElement.options;
          for (let i = 0; i < options.length; i++) {
            if (options[i].value === result.data.workcd) {
              selectElement.value = options[i].value;
              break;
            }
          }
        }
      };
      AjaxUtil.getAsyncData(url, data, fnsuccess);
    }
    searchMainData();
    AjaxUtil.fillSelectOptions($('#selectWorkcd'), 'workcd', 'choose', false, 'work_division', '');
  })

  // ê³µíœ´ì¼ í™•ì¸ api
  // API ì •ë³´
  const API_KEY = 'bu6q9pRCluI8rJbEWr3Rzw5Dy6yiZC0XMpLyxho278jONlqE5NxPaaVyULwLr3WEYKyWfBOWnHyG2iOxdd4Uxg==';  // ğŸ”¥ ë°œê¸‰ë°›ì€ API í‚¤ë¥¼ ì—¬ê¸°ì— ë„£ìœ¼ì„¸ìš”
  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  let isHoly = 0;

  // API URL ì„¤ì •
  const url = `http://apis.data.go.kr/B090041/openapi/service/SpcdeInfoService/getHoliDeInfo?solYear=${year}&solMonth=${month}&ServiceKey=${API_KEY}`;
  async function checkHoliday() {
    try {
      const response = await axios.get(url, {
        params: {
          _type: 'json'
        }
      });

      const items = response.data.response.body.items.item;
      const todayString = `${year}${month}${day}`;
      const isWeekend = today.getDay() === 0 || today.getDay() === 6;
      const isHoliday = items && items.some(item => item.locdate === todayString);
      if (isWeekend) {
        console.log("ì˜¤ëŠ˜ì€ ì£¼ë§ì…ë‹ˆë‹¤.");
        isHoly = 1;
      } else if (isHoliday) {
        console.log("ì˜¤ëŠ˜ì€ ê³µíœ´ì¼ì…ë‹ˆë‹¤.");
        isHoly = 1;
      } else {
        console.log("ì˜¤ëŠ˜ì€ í‰ì¼ì…ë‹ˆë‹¤.");
      }

    } catch (error) {
      console.error("API í˜¸ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:", error.message);
    }
  }
  function reloadWindow(){
    console.log("í™•ì¸ ë²„íŠ¼ í´ë¦­ë¨");
    window.location.reload(); // âœ… í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
  }

  // ì¶œê·¼/í‡´ê·¼ ë“±ë¡(ìƒíƒœê°’ì— ë”°ë¼ ë¡œì§ ë³€ê²½)
  function submitCommute(office){
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const date = String(today.getDate()).padStart(2, '0');
    const weekDay = weekDays[today.getDay()];
    const weekNum = today.getDay();
    console.log('office tag : ', office)
      //ì¶œê·¼ ë²„íŠ¼í´ë¦­
    if(office.trim() === 'inOfficeIn' || office.trim() === 'outOfficeIn') {
      if(office.trim() === 'outOfficeIn'){
        if (document.getElementById('selectWorkcd').value === "") {
          Alert.alert('', 'ê·¼íƒœêµ¬ë¶„ì„ ì„ íƒí•˜ì—¬ì£¼ì‹­ì‹œì˜¤');
          return;
        }
      }
      if(document.getElementById('officeTime').textContent !== '--:--') {
        Alert.alert('', 'ì´ë¯¸ì¶œê·¼ í•˜ì…¨ìŠµë‹ˆë‹¤.');
      }else {
        checkHoliday();
        let _this = this;
        let url = '/api/mobile_main/submitCommute'
        let data = {
          'weekNum': weekNum,
          'office': office,
          'workym': year + month,
          'workday': date,
          'isHoly': isHoly,
          'workcd': document.getElementById('selectWorkcd').value,
          'latitude': latitude,
          'longitude': longitude,
          'gpsInfo' : document.getElementById('gpsInfo').innerText
        }
        let fnsuccess = function (result) {
          if (result != null) {
            if (result.success) {
              Alert.alert('', result.message, reloadWindow);
            } else {
              Alert.alert('', "ì¶œê·¼ ë“±ë¡ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.");
            }
          } else {
            Alert.alert('', "ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
          }
        };
        AjaxUtil.postAsyncData(url, data, fnsuccess);
      }
    }else{
      if(office.trim() === 'outOfficeOut'){
        if (document.getElementById('selectWorkcd').value === "") {
          Alert.alert('', 'ê·¼íƒœêµ¬ë¶„ì„ ì„ íƒí•˜ì—¬ì£¼ì‹­ì‹œì˜¤');
          return;
        }
      }
      // í‡´ê·¼ë²„íŠ¼ í´ë¦­
      if(document.getElementById('officeTime').textContent === '--:--') {
        Alert.alert('', 'ì¶œê·¼ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
      }else{
        console.log('office tag : ', office)
        let _this = this;
        let url = '/api/mobile_main/modifyCommute'
        let data = {
          'office': office,
          'workym': year + month,
          'workday': date,
          'workcd': document.getElementById('selectWorkcd').value,
          'gpsInfo' : document.getElementById('gpsInfo').innerText
        }
        let fnsuccess = function (result) {
          if (result.success) {
            Alert.alert('', result.message, function() {
              window.location.href = 'mobile/commute_current';
            });
          } else {
            Alert.alert('', "ì¶œê·¼ ë“±ë¡ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.");
          }
        };
        AjaxUtil.postAsyncData(url, data, fnsuccess);
      }
    }
  }

  // GPS ì¢Œí‘œë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
  const getGPSLocation = () => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          latitude = position.coords.latitude;
          longitude = position.coords.longitude;
          console.log(`GPS Coordinates: Lat ${latitude}, Lon ${longitude}`);
        },
        (error) => {
          console.warn("GPS ì ‘ê·¼ ì‹¤íŒ¨, IP ê¸°ë°˜ ìœ„ì¹˜ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.", error.message);
        }
      );
    } else {
      console.error("ì´ ë¸Œë¼ìš°ì €ëŠ” Geolocationì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }
  };

  function getAddressFromVWorld(lat, lon) {
    let _this = this;
    let url = '/api/mobile_main/switchAddress'
    let data = {
      'lat': lat,
      'lon': lon
    }
    let fnsuccess = function (result) {
      console.log("ì£¼ì†Œ : " , result.data)
      document.getElementById('gpsInfo').innerText = result.data
    };
    AjaxUtil.postAsyncData(url, data, fnsuccess);
  }

  function getLocationFromIP() {
    fetch('https://ipapi.co/json/')
      .then(res => res.json())
      .then(data => {
        console.log("IP ê¸°ë°˜ ìœ„ì¹˜:", data);
        getAddressFromVWorld(data.latitude, data.longitude);
      });
  }

</script>
</body>
</html>
