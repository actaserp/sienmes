<html layout:decorate="~{layout_page}">
<head>
    <style>
        #matListTb input, #matListTb textarea {
            width: 100px;
            height: 40px;
        }

        input[type="date"][readonly] {
            background-color: #EDEFF5;
        }
    </style>
</head>
<th:block layout:fragment="content">

    <div class="layout-contents">
        <div class="page-title-wrap">
            <div class="left">
                <h2>ìƒì‚° ê³„íš ë“±ë¡</h2>
                <a title="ë¶ë§ˆí¬" class="bookmark toggle">
                    ë‚´ ë©”ë‰´
                </a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
                <li>ìƒì‚° ê´€ë¦¬</li>
                <li>ìƒì‚° ê³„íš ë“±ë¡</li>
            </ul>
        </div>

        <section class="section">
            <div class="section-top">
                <div class="search-wrap">
                    <dl>
                        <dt>
                            <label for="cboDateKind">
                                ê³„íšì¼ì<span class="eq"></span>
                            </label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <select id="cboDateKind" name="cboDateKind">
                                    <option value="selectDate" selected>ê¸°ê°„</option>
                                    <option value="week">ì£¼ê°„</option>
                                    <option value="month">ì›”ê°„</option>
                                </select>
                                <div id="extraSelectBox" style="display:inline-block; margin-left: 10px;"></div>
                            </div>
                        </dd>
                    </dl>
                    <dl>
                        <dt>
                            ì¡°íšŒê¸°ê°„<span class="eq">*</span>
                        </dt>
                        <dd>
                            <ul class="date-box">
                                <li>
                                    <input type="date" id="srchStartDt" name="srchStartDt">
                                    <label for="srchStartDt" class="hide">ì‹œì‘ì¼</label>
                                </li>
                                <li>
                                    <input type="date" id="srchEndDt" name="srchEndDt">
                                    <label for="srchEndDt" class="hide">ì¢…ë£Œì¼</label>
                                </li>
                            </ul>
                        </dd>
                    </dl>

                    <dl>
                        <dt>&nbsp;</dt>
                        <dd>
                            <li>
                                <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnSearch">
                                    <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                                    <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                    ê²€ìƒ‰
                                </a>
                            </li>
                        </dd>
                    </dl>
                </div>
                <div class="button-wrap">
                    <ul>
                        <li>
                            <a class="btn btn-excell" title="ë“±ë¡" id="btnAddNew">
                                <img src="/images/icon/ico-plus.svg" alt="ë“±ë¡ ì•„ì´ì½˜">
                                ë“±ë¡
                            </a>
                        </li>
                        <!--                        <li>-->
                        <!--                            <a class="btn btn-delete" title="ì‚­ì œ" id="btnDelete">-->
                        <!--                                <img src="/images/icon/ico-delete.svg" alt="ì‚­ì œ ì•„ì´ì½˜">-->
                        <!--                                ì‚­ì œ-->
                        <!--                            </a>-->
                        <!--                        </li>-->
                        <li>
                            <a class="btn btn-edit" title="ìˆ˜ì •" id="btnEdit">
                                <img src="/images/icon/ico-edit.svg" alt="ìˆ˜ì • ì•„ì´ì½˜">
                                ìˆ˜ì •
                            </a>
                            <!--                        </li>-->
                            <!--                        <li>-->
                            <!--                            <a class="btn" title="ì—‘ì…€ ì—…ë¡œë“œ" id="btnShowUpload">-->
                            <!--                                ì—‘ì…€ ì—…ë¡œë“œ-->
                            <!--                            </a>-->
                            <!--                        </li>-->
                            <!--                        <li>-->
                            <!--                            <a class="btn" title="ì–‘ì‹ ë‹¤ìš´ë¡œë“œ" id="btnDownloadTemplate">-->
                            <!--                                ì–‘ì‹ ë‹¤ìš´ë¡œë“œ-->
                            <!--                            </a>-->
                            <!--                        </li>-->
                    </ul>
                </div>
            </div>
            <div class="container-fluid">
                <div id="theGrid" style="height: 730px;"></div>
            </div>
            <!--        <div class="grid_box">-->

            <!--            <div class="h-640" data-ax5grid="sujuGrid" ></div>-->
            <!--        </div>-->
        </section>
    </div>
    <script type="text/x-tmpl" id="planTemplate">
        <style>
            /* ì•„ì´í…œ í…Œì´ë¸” ì „ì²´ ì„¤ì • */
            .item-table {
                width: 100%;
                border-collapse: collapse;
                table-layout: fixed;
                margin-top: 10px;
            }

            /* í—¤ë” ì…€ ìŠ¤íƒ€ì¼ */
            .item-table th {
                background-color: #EDEFF5;
                text-align: center;
                font-weight: bold;
                padding: 8px;
                border: 1px solid #ccc;
            }

            /* ë°”ë”” ì…€ ìŠ¤íƒ€ì¼ */
            .item-table td {
                padding: 6px;
                text-align: center;
                border: 1px solid #ccc;
            }

            /* ì…ë ¥ í•„ë“œ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
            .item-table input {
                width: 100%;
                box-sizing: border-box;
                padding: 4px;
            }

            /* í’ˆëª© & ë¹„ê³  ì™¼ìª½ ì •ë ¬ */
            .item-table td:first-child,
            .item-table td:nth-child(6) {
                text-align: left;
            }

            /* ê³µí†µ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
            .item-table .btn.in_btn {
                display: inline-flex;
                justify-content: center;
                align-items: center;
                width: 32px;
                height: 32px;
                border-radius: 4px;
                padding: 0;
                border: 1px solid #B3B3B3;
                background-color: #fff;
                cursor: pointer;
                transition: background-color 0.2s;
                line-height: 0;
            }

            /* + ë²„íŠ¼ ì „ìš© ìŠ¤íƒ€ì¼ */
            .item-table .btn.in_btn.plus img {
                width: 10px;
                height: 10px;
                display: block;
            }

            /* ê³µí†µ ì•„ì´ì½˜ ë²„íŠ¼ ì´ë¯¸ì§€ (ì‚­ì œ, ê²€ìƒ‰ í¬í•¨) */
            .item-table .btn.in_btn img {
                width: 12px;
                height: 12px;
                display: block;
                margin-right: 5px;
            }

            .input-with-button {
                display: flex;
                gap: 4px; /* ë²„íŠ¼ê³¼ input ì‚¬ì´ ì—¬ë°± */
                align-items: center;
            }

            .input-with-button input {
                flex: 1; /* ë‚˜ë¨¸ì§€ ì˜ì—­ ì°¨ì§€ */
                min-width: 0;
                padding: 4px;
            }

            .input-with-button .btn.in_btn {
                flex-shrink: 0;
            }

            .content_wrap.popup {
                display: flex;
                flex-direction: column;
                height: 100%;
            }

            .table-wrap {
                flex: 1;
                overflow-y: auto;
                padding-right: 5px;
            }

            .popup-button {
                flex-shrink: 0;
                padding: 10px;
                background: #fff;
                border-top: 1px solid #ddd;
            }

            .input-with-checkbox {
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .input-with-checkbox input[type="number"] {
                flex: 1;
                min-width: 0;
                padding: 4px;
            }

            .input-with-checkbox input[type="checkbox"] {
                flex-shrink: 0;
                width: 18px;
                height: 18px;
            }
        </style>
        <div class="content_wrap popup">
            <div class="table-wrap">
            <form id="planForm">
                <table class="write-table">
                    <caption>ê³„íš ë“±ë¡ í…Œì´ë¸”</caption>
                    <input type="hidden" id="head_id" name="head_id">
                    <tbody>
                        <tr>
                            <th style="text-align: center">
                                <label for="datetype">ê³„íšì¼ì</label>
                            </th>
                            <td>
                                <div class="input-group" id="prod_datepicker">
                                    <select id="datetype" name="datetype">
                                        <option value="selectDate" selected>ê¸°ê°„</option>
                                        <option value="week">ì£¼ê°„</option>
                                        <option value="month">ì›”ê°„</option>
                                    </select>
                                </div>
                            </td>
                            <th style="text-align: center">
                                <label>ë‚©ê¸°ì¼*</label>
                            </th>
                            <td>
                                <div class="input-group" id="prod_datepicker">
                                    <input type="date" id="stdate" name="stdate" style="margin-right: 5px;" readOnly>
                                    ~
                                    <input type="date" id="eddate" name="eddate" style="margin-right: 5px;" readOnly>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th style="text-align: center">
                                <label for="actnm">í˜„ì¥ëª…</label>
                            </th>
                            <td>
                                <input class="form-control2" type="text" id="actnm" name="actnm">
                            </td>
                            <th style="text-align: center">
                                <label for="cmcode">í†µì‹ </label>
                            </th>
                            <td colspan="3">
                                <select id="cmcode" name="cmcode">
                                </select>
                            </td>
                        </tr>

                        <tr>
                            <th style="text-align: center">
                                <label for="description">ë¹„ê³ </label>
                            </th>
                            <td colspan="3">
                                <textarea id="description" name="description" style="height:40px;"></textarea>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <table class="item-table">

                    <table class="item-table">

                    <colgroup>
                        <col style="width: 10%">
                        <col style="width: 30%">
                        <col style="width: 10%">
                        <col style="width: 45%">
                        <col style="width: 5%">
                    </colgroup>
                    <thead>
                    <tr id="itemHeaderRow">
                        <th>ì½”ë“œ</th>
                        <th>í’ˆëª©</th>
                        <th>ìˆ˜ëŸ‰</th>
                        <th>ë©”ëª¨</th>
                        <th>
                            <a class="btn in_btn plus" id="addRemark" title="ì¶”ê°€">
                                <img src="/images/icon/ico-plus.svg" alt="ë“±ë¡ ì•„ì´ì½˜" />
                            </a>
                        </th>
                    </tr>
                    </thead>
                    <tr class="item-template-row" style="display: none;">
                        <td>
                            <input type="text" name="product_code" readOnly/>
                        </td>
                        <td>
                            <div class="input-with-button">
                                <input type="hidden" name="id" />
                                <input type="text" name="txtProductName" placeholder="ì½”ë“œ ë˜ëŠ” í’ˆëª… ì…ë ¥ í›„ ì—”í„°" autocomplete="off" />
                                <input type="hidden" name="material_id" />
                                <a class="btn in_btn" title="í’ˆëª© ê²€ìƒ‰" id="btnProductSearch" >
                                    <img src="/images/icon/btn-srch-black.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜" />
                                </a>
                            </div>
                        </td>
                        <td><input type="text" name="qty" placeholder="ìˆ˜ëŸ‰" /></td>

                        <td><input type="text" name="remark" /></td>

                        <td class="al_c item_border">
                            <a class="btn in_btn" title="ì‚­ì œ" onclick="removeItemRow(this)">
                                <img src="/images/icon/ico-delete.svg" alt="ì‚­ì œ ì•„ì´ì½˜" />
                            </a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </form>
            </div>
            <div class="popup-button">
                    <button type="button" class="btn-popup y_write_auth" id="btnPopSave">ì €ì¥</button>
                    <button type="button" class="btn-popup" id="modal-close-button">ë‹«ê¸°</button>
                    <button type="button" class="btn-popup y_write_auth" id="btnDelete" style="display:none;">ì „ì²´ ì‚­ì œ</button>
            </div>
        </div>
    </script>

</th:block>

<th:block layout:fragment="scripts">
    <!--<th:block th:replace="/common/columns_setting :: columns_setting"></th:block>-->
    <th:block th:replace="/common/multiform_material :: multiform_material"></th:block>

    <script type="text/javascript">

        let isInternalFormatting = false;

        class JobPlanPage {
            constructor() {
                this.url = '/api/production/job_plan';
                this.grid = null;
                this.$btnEdit = $('#btnEdit');
                this.$btnAddNew = $('#btnAddNew');
                this.viewData = new wijmo.collections.CollectionView();
                this.init();

            }

            resetPlanListIndex() {
                this.planListIndex = 0;
            }

            nextPlanListIndex() {
                return this.planListIndex++;
            }

            init() {
                let _this = this;
                this.grid = new wijmo.grid.FlexGrid('#theGrid', {
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.Column,
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    formatItem: (sender, e) => {
                        const col = e.getColumn();
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                        if (e.panel.cellType === wijmo.grid.CellType.Cell) {
                            // ë‚ ì§œ í¬ë§· ì²˜ë¦¬
                            if (col.binding === 'stdate' || col.binding === 'eddate') {
                                const raw = e.cell.textContent?.trim();
                                if (/^\d{8}$/.test(raw)) {
                                    e.cell.textContent = `${raw.slice(0, 4)}-${raw.slice(4, 6)}-${raw.slice(6, 8)}`;
                                }
                            }
                        }
                    },
                    columns: [
                        {binding: 'stdate', header: 'ê³„íš ì‹œì‘ì¼', width: 120, align: 'center'},
                        {binding: 'eddate', header: 'ê³„íš ì¢…ë£Œì¼', width: 120, align: 'center'},
                        {binding: 'actnm', header: 'í˜„ì¥ëª…', width: 200},
                        {binding: 'cmcode', header: 'í†µì‹ ', width: 100, align: 'center', format: 'n0'},
                        {binding: 'description', header: 'ë¹„ê³ ', width: 200},
                        {binding: 'mat_code', header: 'í’ˆëª© ì½”ë“œ', width: 150, align: 'center'},
                        {binding: 'mat_name', header: 'í’ˆëª©', width: 300},
                        {binding: 'qty', header: 'ìˆ˜ëŸ‰', width: 100},
                        {binding: 'remark', header: 'ë©”ëª¨', width: 200},
                    ],
                    itemsSource: this.viewData, // ë°ì´í„°ë¥¼ ì„¤ì •í•  ë°°ì—´
                });

                new FlexGridContextMenu(this.grid);
                this.grid.downloadFileName = 'ìƒì‚° ê³„íš ë‚´ì—­';

                this.grid.hostElement.addEventListener('dblclick', function (e) {
                    let items = _this.grid.selectedItems;
                    if (items.length === 0) {
                        return false;
                    }
                    _this.$btnEdit.trigger('click');
                });

                let nowDate = CommonUtil.getYYYYMMDD();
                let dueDate = CommonUtil.getYYYYMMDD(10);

                //ìˆ˜ì£¼ë“±ë¡ í´ë¦­
                this.$btnAddNew.click(function (e) {
                    let defaultData = {
                        id: '',
                        mode: 'new',
                        JumunDate: nowDate,
                        DueDate: dueDate,
                    };
                    _this.showPlanForm(defaultData);
                });

                // ìˆ˜ì£¼ ìˆ˜ì • í´ë¦­
                this.$btnEdit.click(function (e) {
                    let selectedItems = _this.grid.selectedItems;
                    const it = _this.grid.selectedItems && _this.grid.selectedItems[0];
                    console.log('it', it);
                    if (selectedItems.length === 1) {
                        window.selectedGridId = it.mat_code;
                        let data = {
                            head_id: selectedItems[0].head_id,
                            action: 'detail'
                        };
                        let fnsuccess = function (result) {
                            result.data['mode'] = 'edit';
                            _this.showPlanForm(result.data);
                        };
                        AjaxUtil.getAsyncData(_this.url + '/detail', data, fnsuccess);
                    } else {
                        Alert.alert('', 'ì„ íƒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    }

                });

                // ì—”í„°í‚¤ ê²€ìƒ‰
                $('#keyword').on('keypress', function (e) {
                    if (e.keyCode === 13) {
                        _this.searchMainData();
                    }
                });
            }

            showPlanForm(data) {

                let _this = this;
                let content = tmpl('planTemplate', data);
                let $content = $(content);
                let $btnDelete = $content.find('#btnDelete');
                let $planForm = $content.find('#planForm');
                let $cmcode = $content.find('#cmcode');

                let modalContainer = null;
                if (data.mode === 'new') {
                    modalContainer = new PopupDraggable('ë“±ë¡');
                } else {
                    modalContainer = new PopupDraggable('ìˆ˜ì •');
                    $btnDelete.show();
                }
                modalContainer.open({width: 1100, height: 550, $content});

                // ì €ì¥ë²„íŠ¼
                let $btnPopSave = $('#btnPopSave');

                //ìˆ˜ì£¼êµ¬ë¶„
                AjaxUtil.fillSelectOptions($cmcode, 'system_code', 'choose', '', 'comunication_type');
                initPopupDateKindHandler($content);

                setTimeout(() => {
                    FormUtil.BindDataPlanForm(data, $planForm);

                    const datetype = $content.find('#datetype').val();

                    if (datetype === 'week' || datetype === 'month') {
                        $content.find('#datetype').trigger('change');

                        // select boxê°€ ìƒì„±ë˜ê¸°ê¹Œì§€ ì ì‹œ ê¸°ë‹¤ë¦° ë’¤ ê°’ ì„¤ì •
                        setTimeout(() => {
                            if (datetype === 'week') {
                                $content.find('#popupWeekSelector').val(data.popupWeekSelector);
                                $content.find('#stdate').val(data.stdate);
                                $content.find('#eddate').val(data.eddate);
                            } else if (datetype === 'month') {
                                $content.find('#stdate').val(data.stdate);
                                $content.find('#eddate').val(data.eddate);
                            }
                        }, 10); // ë„ˆë¬´ ê¸¸ê²Œ ì¤„ í•„ìš” ì—†ì´ 10~50ms ì •ë„ë©´ ì¶©ë¶„
                    }
                }, 100);

                // ìˆ˜ì£¼ë“±ë¡ íŒì—… ì €ì¥ë²„íŠ¼ í´ë¦­
                $btnPopSave.click(function (e) {

                    let data = FormUtil.extractForm($planForm);

                    if (!data.material_id_0) {
                        Alert.alert('', 'í’ˆëª©ì„ ì„ íƒí•˜ì„¸ìš”.');
                        return;
                    }

                    // 2. ê° í–‰ì˜ ìœ íš¨ì„± ì²´í¬
                    let index = 0;
                    while (true) {
                        const materialId = data[`material_id_${index}`];

                        if (materialId === undefined) break; // ëê¹Œì§€ ì²´í¬

                        if (materialId !== null && materialId !== '') {
                            const qty = data[`qty_${index}`];

                            if (!qty) {
                                Alert.alert('', `(${index + 1}ë²ˆì§¸ í–‰) ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.`);
                                return;
                            }
                        }

                        index++;
                    }

                    Alert.confirm('', 'ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function () {
                        const items = [];
                        for (let i = 0; i < page.planListIndex; i++) {
                            const materialId = data[`material_id_${i}`];
                            if (!materialId) continue;

                            items.push({
                                id: data[`id_${i}`] || '',
                                material_id: materialId,
                                txtProductName: data[`txtProductName_${i}`] || '',
                                qty: (data[`qty_${i}`] || '0').replace(/,/g, ''),
                                remark: data[`remark_${i}`] || '',
                            });
                        }


                        // ê³µí†µ ì •ë³´ + ë¦¬ìŠ¤íŠ¸ ì „ì†¡
                        const payload = {
                            head_id: data.head_id,
                            actnm: data.actnm,
                            stdate: data.stdate,
                            eddate: data.eddate,
                            datetype: data.datetype,
                            cmcode: data.cmcode,
                            spjangcd: data.spjangcd,
                            description: data.description,
                            items: items
                        };

                        console.log('payload', payload);

                        AjaxUtil.postJsonData(_this.url + '/save', payload, function (res) {
                            if (res.success) {
                                Notify.success("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                                _this.searchMainData();
                                modalContainer.close();
                            } else {
                                Alert.alert('ì €ì¥ ì‹¤íŒ¨', res.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                            }
                        });

                    });

                });

                // ìˆ«ì í¬ë§· (input ì¤‘ formatting)
                $content.on('input', 'input[name^="qty_"]', function () {
                    if (isInternalFormatting) return;
                    isInternalFormatting = true;

                    const $this = $(this);
                    const input = this;
                    const raw = $this.val().replace(/[^0-9]/g, '');
                    const cursor = input.selectionStart;
                    const prevLength = input.value.length;

                    if (raw === '') {
                        $this.val('');
                    } else {
                        const formatted = Number(raw).toLocaleString();
                        $this.val(formatted);

                        const diff = formatted.length - prevLength;
                        input.setSelectionRange(cursor + diff, cursor + diff);
                    }

                    isInternalFormatting = false;
                });

                // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ íŒì—…
                $content.on('click', 'a[title="í’ˆëª© ê²€ìƒ‰"]', function () {
                    const $row = $(this).closest('tr');

                    const $productInput = $row.find('input[name^="txtProductName_"]');
                    const $productId = $row.find('input[name^="material_id_"]');
                    const $productCode = $row.find('input[name^="product_code_"]');

                    const pop = new PopMatComponent();
                    pop.material_type = 'product,sangpum';

                    pop.show(function (item) {
                        $productInput.val(item.Name);
                        $productId.val(item.id);
                        $productCode.val(item.Code);
                    });


                });

                $content.on('keydown', 'input[name^="txtProductName_"]', function (e) {
                    if (e.key !== 'Enter' && e.keyCode !== 13) return;

                    e.preventDefault();

                    const $field = $(this);
                    const $row = $field.closest('tr');

                    const $productInput = $row.find('input[name^="txtProductName_"]');
                    const $productId = $row.find('input[name^="material_id_"]');
                    const $productCode = $row.find('input[name^="product_code_"]');

                    const keyword = $field.val().trim();
                    const pop = new PopMatComponent();
                    pop.material_type = 'product,sangpum';

                    const callback = function (item) {
                        $productId.val(item.id || '');
                        $productInput.val(item.Name || '');
                        $productCode.val(item.Code || '');
                    };

                    if (!keyword) {
                        pop.focusAfterClose = $field[0];
                        pop.show(callback);
                        return;
                    }

                    const data = {
                        keyword: keyword,
                        spjangcd: sessionStorage.getItem('spjangcd')
                    };

                    const result = AjaxUtil.getSyncData('/api/popup/search_material', data);
                    const rows = result?.data || [];

                    if (rows.length === 1) {
                        callback(rows[0]);
                    } else {
                        pop.show(callback);
                        setTimeout(() => {
                            pop.$keyword.val(keyword);
                            pop.$btnMaterialSearch.trigger('click');
                        }, 50);
                    }
                });

                // í’ˆëª©ëª… ì§€ìš°ë©´ ì½”ë“œë“¤ë„ ê°™ì´ ì§€ì›Œì§€ê²Œ
                $content.on('input', 'input[name^="txtProductName_"]', function () {
                    const $field = $(this);
                    const $row = $field.closest('tr');

                    const $productId = $row.find('input[name^="material_id_"]');
                    const $productCode = $row.find('input[name^="product_code_"]');

                    if ($field.val().trim() === '') {
                        // ê°’ì´ ë¹„ì—ˆì„ ê²½ìš° ì—°ê´€ëœ í•„ë“œ ì´ˆê¸°í™”
                        $productId.val('');
                        $productCode.val('');
                    }
                });

                $content.find('#addRemark').click(function () {
                    const $tbody = $content.find('.item-table tbody');
                    const $template = $tbody.find('.item-template-row');

                    for (let i = 0; i < 3; i++) {
                        const $newRow = $template.clone().removeClass('item-template-row').show();
                        const index = page.nextPlanListIndex();
                        $newRow.find('input').each(function () {
                            const baseName = $(this).attr('name');
                            if (baseName) {
                                $(this).attr('name', `${baseName}_${index}`);
                            }
                        });

                        $newRow.find('a[title="ì‚­ì œ"]').attr('id', `btnDelItem_${index}`);
                        $tbody.append($newRow);
                    }
                });

                // í¬ì»¤ìŠ¤ ìë™ ì´ë™: Enter + ë°©í–¥í‚¤(â†â†’â†‘â†“)
                $content.on('keydown', 'input', function (e) {
                    const key = e.key;

                    if (!['Enter', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(key)) return;
                    e.preventDefault();

                    const $input = $(this);
                    const $row = $input.closest('tr');
                    const nameAttr = $input.attr('name') || '';

                    const focusOrder = [
                        'txtProductName_',
                        'qty_',
                        'remark_',
                    ];

                    const currentIndex = focusOrder.findIndex(prefix => nameAttr.startsWith(prefix));
                    if (currentIndex === -1) return;

                    let $nextInput = null;

                    // â†”ï¸ ì¢Œìš° ì´ë™
                    if (key === 'ArrowRight' && currentIndex < focusOrder.length - 1) {
                        const nextPrefix = focusOrder[currentIndex + 1];
                        $nextInput = $row.find(`input[name^="${nextPrefix}"]`);
                    } else if (key === 'ArrowLeft' && currentIndex > 0) {
                        const prevPrefix = focusOrder[currentIndex - 1];
                        $nextInput = $row.find(`input[name^="${prevPrefix}"]`);
                    }

                    // â†•ï¸ ìƒí•˜ ì´ë™
                    if (key === 'ArrowDown' || key === 'ArrowUp') {
                        const $targetRow = key === 'ArrowDown'
                            ? $row.nextAll('tr:visible').first()
                            : $row.prevAll('tr:visible').first();

                        const allowAutoAdd = ['txtProductName_', 'remark_'];
                        const isAllowedField = allowAutoAdd.some(prefix => nameAttr.startsWith(prefix));

                        // â¬‡ï¸ ë°©í–¥í‚¤ + í˜„ì¬ í–‰ì´ ë§ˆì§€ë§‰ + í—ˆìš©ëœ í•„ë“œì¼ ê²½ìš° â†’ í–‰ ìë™ ì¶”ê°€
                        if (key === 'ArrowDown' && !$targetRow.length && isAllowedField) {
                            $content.find('#addRemark').trigger('click');

                            setTimeout(() => {
                                const $rows = $content.find('.item-table tbody tr:visible').not('.item-template-row');
                                const $newRow = $rows.last();
                                const $newInput = $newRow.find('input[name^="txtProductName_"]');
                                if ($newInput.length) $newInput.focus().select();
                            }, 50);
                            return;
                        }
                        // ì¼ë°˜ ìƒí•˜ ì´ë™
                        $nextInput = $targetRow.find(`input[name^="${focusOrder[currentIndex]}"]`);
                    }

                    // â†µ Enter í‚¤: í˜„ì¬ í–‰ ë‚´ ë‹¤ìŒ í•„ë“œ
                    if (key === 'Enter' && currentIndex < focusOrder.length - 1) {
                        const nextPrefix = focusOrder[currentIndex + 1];
                        $nextInput = $row.find(`input[name^="${nextPrefix}"]`);
                    } else if (key === 'Enter' && nameAttr.startsWith('description_')) {
                        const $nextRow = $row.nextAll('tr:visible').first();
                        if (!$nextRow.length) {
                            //console.log('ë‹¤ìŒ í–‰ ì—†ìŒ. í–‰ ìë™ ì¶”ê°€ íŠ¸ë¦¬ê±°.');
                            $content.find('#addRemark').trigger('click');

                            setTimeout(() => {
                                const $rows = $content.find('.item-table tbody tr:visible').not('.item-template-row');
                                const $newRow = $rows.last();
                                const $newInput = $newRow.find('input[name^="txtProductName_"]');
                                if ($newInput.length) $newInput.focus().select();
                            }, 50);
                            return;
                        } else {
                            $nextInput = $nextRow.find('input[name^="txtProductName_"]');
                        }
                    }

                    if ($nextInput && $nextInput.length) {
                        $nextInput.focus().select();
                    }
                });

                // ì‚­ì œ ë²„íŠ¼
                $btnDelete.click(function (e) {
                    let data = FormUtil.extractForm($planForm);

                    Alert.confirm('', 'ì „ì²´ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                        function () {
                            let id = data.head_id;
                            _this.deletePlanData(id);
                        },
                        function () {
                        }
                    );
                    modalContainer.close();

                });

            }

            deletePlanData(id) {
                let _this = this;
                let url = _this.url + '/delete';
                let data = {'id': id}
                let fnsuccess = function (res) {
                    if (res.success) {
                        Notify.success('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        _this.searchMainData();
                    } else {
                        Alert.alert('', res.message);
                    }
                };

                AjaxUtil.postAsyncData(url, data, fnsuccess);
            }

            searchMainData() {
                let _this = this;
                let date_kind = $('#cboDateKind').val();
                let start = $('#srchStartDt').val();
                let end = $('#srchEndDt').val();
                let url = this.url + '/read';

                let data = {
                    'date_kind': date_kind,
                    'start': start,
                    'end': end,
                    'action': 'read'
                };

                let fnsuccess = function (result) {
                    if (result != null) {
                        console.log('result', result.data);
                        _this.viewData.sourceCollection = result.data;

                        if (window.selectedGridId) {
                            // GridUtil.selectRowById(_this.grid, window.selectedGridId);
                            GridUtil.selectRowById(_this.grid, window.selectedGridId, {idField: 'mat_code'});
                            window.selectedGridId = null;
                        }
                    }
                };
                AjaxUtil.getAsyncData(url, data, fnsuccess);

            }


        }

        //í–‰ ì‚­ì œ í•¨ìˆ˜
        function removeItemRow(el) {
            const $tbody = $(el).closest('tbody');
            const $rows = $tbody.find('tr:not(.item-template-row)');
            const $targetRow = $(el).closest('tr');

            if ($rows.length <= 3) {
                // ì…ë ¥ê°’ì´ ìˆìœ¼ë©´ ì´ˆê¸°í™”ë§Œ í•˜ê³  ë¦¬í„´
                const hasData = $targetRow.find('input[type="text"], input[type="number"]').filter(function () {
                    return $(this).val().trim() !== '';
                }).length > 0;

                if (hasData) {
                    $targetRow.find('input[type="text"], input[type="number"]').val('');
                    // hidden ê°’ë„ ì´ˆê¸°í™”í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì¶”ê°€
                    $targetRow.find('input[type="hidden"]').val('');
                }

                return;
            }

            // 4ê°œ ì´ìƒì´ë©´ ì •ìƒ ì‚­ì œ
            $targetRow.remove();
        }

        // íŒì—… ë‚ ì§œ ê³„ì‚° ë¡œì§
        function initPopupDateKindHandler($content) {
            const $datetype = $content.find('#datetype');
            const $extraSelectBox = $('<span style="margin-top:10px;" id="extraSelectBox"></span>');
            const $stdate = $content.find('#stdate');
            const $eddate = $content.find('#eddate');
            console.log('$stdate', $stdate.val());
            console.log('$eddate', $eddate.val());

            $datetype.after($extraSelectBox);

            $datetype.on('change', function () {
                const type = $(this).val();
                $extraSelectBox.empty();
                $stdate.val('').prop('readOnly', false);
                $eddate.val('').prop('readOnly', false);

                if (type === 'week') {
                    const $weekSelect = $('<select id="popupWeekSelector"></select>');
                    const now = new Date();
                    // ğŸ‘‰ stdateê°€ ìˆìœ¼ë©´ ê·¸ê²ƒ ê¸°ì¤€, ì—†ìœ¼ë©´ ì˜¤ëŠ˜ ê¸°ì¤€
                    const stdateStr = $stdate.val(); // ex: "2025-08-01" ë˜ëŠ” "20250801"
                    const targetDate = stdateStr
                        ? parseDate(stdateStr)
                        : now;

                    const year = targetDate.getFullYear();
                    const currentWeek = getISOWeekNumber(targetDate);

                    for (let i = 1; i <= 52; i++) {
                        const value = `${year}-W${String(i).padStart(2, "0")}`;
                        const text = `${year}ë…„ ${i}ì£¼ì°¨`;
                        const $option = $(`<option value="${value}">${text}</option>`);
                        if (i === currentWeek) {
                            $option.prop("selected", true); // âœ… selected ì„¤ì •
                        }
                        $weekSelect.append($option);
                    }

                    $weekSelect.on('change', function () {
                        const [y, w] = $(this).val().split('-W');
                        const weekNum = parseInt(w, 10);
                        const start = getDateOfISOWeek(weekNum, y);
                        const end = new Date(start);
                        end.setDate(start.getDate() + 6);
                        $stdate.val(formatDate(start)).prop('readOnly', true);
                        $eddate.val(formatDate(end)).prop('readOnly', true);
                    });

                    $extraSelectBox.append($weekSelect);
                    $weekSelect.trigger('change');
                } else if (type === 'month') {
                    const $monthSelect = $('<select id="popupMonthSelector"></select>');
                    const stdateStr = $stdate.val();
                    const targetDate = stdateStr ? parseDate(stdateStr) : new Date();

                    const year = targetDate.getFullYear();
                    const selectedMonth = targetDate.getMonth() + 1;

                    for (let i = 1; i <= 12; i++) {
                        const value = `${year}-${String(i).padStart(2, "0")}`;
                        const text = `${year}ë…„ ${i}ì›”`;
                        const $option = $(`<option value="${value}">${text}</option>`);
                        if (i === selectedMonth) {
                            $option.prop("selected", true);
                        }
                        $monthSelect.append($option);
                    }

                    $monthSelect.on('change', function () {
                        const [y, m] = $(this).val().split('-');
                        const start = new Date(parseInt(y), parseInt(m) - 1, 1);
                        const end = new Date(parseInt(y), parseInt(m), 0);
                        $stdate.val(formatDate(start)).prop('readOnly', true);
                        $eddate.val(formatDate(end)).prop('readOnly', true);
                    });

                    $extraSelectBox.append($monthSelect);
                    $monthSelect.trigger('change');
                } else {
                    const startVal = CommonUtil.getYYYYMMDD(-7);
                    const endVal = CommonUtil.getYYYYMMDD();

                    $stdate.val(startVal).prop('readOnly', false);
                    $eddate.val(endVal).prop('readOnly', false);
                }

            });

            // ìµœì´ˆ ì ìš©
            $datetype.trigger('change');
        }

        // ISO ì£¼ì°¨ ê³„ì‚°
        function getDateOfISOWeek(week, year) {
            const jan4 = new Date(year, 0, 4);
            const day = jan4.getDay() || 7;
            const start = new Date(jan4);
            start.setDate(jan4.getDate() - day + 1 + (week - 1) * 7);
            return start;
        }

        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, "0");
            const d = String(date.getDate()).padStart(2, "0");
            return `${y}-${m}-${d}`;
        }

        function getISOWeekNumber(date) {
            const target = new Date(date.valueOf());
            const dayNum = (date.getDay() + 6) % 7;
            target.setDate(target.getDate() - dayNum + 3);
            const firstThursday = new Date(target.getFullYear(), 0, 4);
            const diff = target - firstThursday;
            return 1 + Math.round(diff / (7 * 24 * 60 * 60 * 1000));
        }

        function parseDate(str) {
            if (!str) return new Date();
            if (/^\d{8}$/.test(str)) {
                return new Date(
                    parseInt(str.slice(0, 4)),
                    parseInt(str.slice(4, 6)) - 1,
                    parseInt(str.slice(6, 8))
                );
            } else if (/^\d{4}-\d{2}-\d{2}$/.test(str)) {
                return new Date(str);
            }
            return new Date();
        }

        let page = null;

        $(document).ready(function (e) {

            page = new JobPlanPage();

            $('#srchStartDt').val(CommonUtil.getYYYYMMDD(-7));
            $('#srchEndDt').val(CommonUtil.getYYYYMMDD());

            page.searchMainData();


            // ê²€ìƒ‰
            $('#btnSearch').click(function (e) {
                page.searchMainData();
            });


        })

        document.addEventListener("DOMContentLoaded", function () {
            const cboDateKind = document.getElementById("cboDateKind");
            const extraSelectBox = document.getElementById("extraSelectBox");
            const srchStartDt = document.getElementById("srchStartDt");
            const srchEndDt = document.getElementById("srchEndDt");

            cboDateKind.addEventListener("change", function () {
                const type = this.value;

                extraSelectBox.innerHTML = ""; // ì´ˆê¸°í™”
                srchStartDt.value = "";
                srchEndDt.value = "";
                srchStartDt.readOnly = false;
                srchEndDt.readOnly = false;

                if (type === "week") {
                    const select = document.createElement("select");
                    select.id = "weekSelector";

                    const now = new Date();
                    const currentYear = now.getFullYear();
                    const currentWeek = getISOWeekNumber(now);
                    for (let i = 1; i <= 52; i++) {
                        const option = document.createElement("option");
                        option.value = `${currentYear}-W${String(i).padStart(2, "0")}`;
                        option.textContent = `${currentYear}ë…„ ${i}ì£¼ì°¨`;
                        if (i === currentWeek) {
                            option.selected = true; // â† í˜„ì¬ ì£¼ì°¨ ìë™ ì„ íƒ
                        }
                        select.appendChild(option);
                    }

                    select.addEventListener("change", function () {
                        const week = this.value;
                        const [year, weekNumStr] = week.split("-W");
                        const weekNum = parseInt(weekNumStr, 10);

                        const start = getDateOfISOWeek(weekNum, year);
                        const end = new Date(start);
                        end.setDate(start.getDate() + 6);

                        srchStartDt.value = formatDate(start);
                        srchEndDt.value = formatDate(end);
                        srchStartDt.readOnly = true;
                        srchEndDt.readOnly = true;
                    });

                    extraSelectBox.appendChild(select);
                    select.dispatchEvent(new Event("change")); // ì´ˆê¸° ì„ íƒê°’ ë°˜ì˜
                } else if (type === "month") {
                    const select = document.createElement("select");
                    select.id = "monthSelector";

                    const now = new Date();
                    const currentYear = now.getFullYear();
                    const currentMonth = now.getMonth();

                    for (let i = 0; i < 12; i++) {
                        const month = new Date(currentYear, i, 1);
                        const option = document.createElement("option");
                        option.value = `${month.getFullYear()}-${String(month.getMonth() + 1).padStart(2, "0")}`;
                        option.textContent = `${month.getFullYear()}ë…„ ${month.getMonth() + 1}ì›”`;
                        if (i === currentMonth) {
                            option.selected = true; // â† í˜„ì¬ ë‹¬ ìë™ ì„ íƒ
                        }
                        select.appendChild(option);
                    }

                    select.selectedIndex = currentMonth;

                    select.addEventListener("change", function () {
                        const [year, month] = this.value.split("-");
                        const start = new Date(parseInt(year), parseInt(month) - 1, 1);
                        const end = new Date(parseInt(year), parseInt(month), 0); // ë§ì¼

                        srchStartDt.value = formatDate(start);
                        srchEndDt.value = formatDate(end);
                        srchStartDt.readOnly = true;
                        srchEndDt.readOnly = true;
                    });

                    extraSelectBox.appendChild(select);
                    select.dispatchEvent(new Event("change")); // ì´ˆê¸° ì„ íƒê°’ ë°˜ì˜
                } else {
                    const startVal = CommonUtil.getYYYYMMDD(-7);
                    const endVal = CommonUtil.getYYYYMMDD();

                    $('#srchStartDt').val(startVal).prop('readOnly', false);
                    $('#srchEndDt').val(endVal).prop('readOnly', false);
                }
            });

            function getDateOfISOWeek(week, year) {
                const jan4 = new Date(year, 0, 4); // í•­ìƒ 1ì›” 4ì¼ ê¸°ì¤€
                const day = jan4.getDay() || 7;
                const start = new Date(jan4);
                start.setDate(jan4.getDate() - day + 1 + (week - 1) * 7);
                return start;
            }

            function formatDate(date) {
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, "0");
                const d = String(date.getDate()).padStart(2, "0");
                return `${y}-${m}-${d}`;
            }

            function getISOWeekNumber(date) {
                const target = new Date(date.valueOf());
                const dayNum = (date.getDay() + 6) % 7;
                target.setDate(target.getDate() - dayNum + 3);
                const firstThursday = new Date(target.getFullYear(), 0, 4);
                const diff = target - firstThursday;
                return 1 + Math.round(diff / (7 * 24 * 60 * 60 * 1000));
            }
        });


    </script>

</th:block>
<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
</html>