<html layout:decorate="~{layout_page}">

<th:block layout:fragment="content">

  <div class="layout-contents">
    <div class="page-title-wrap">
      <div class="left">
        <h2>ë°œì£¼ ë“±ë¡(ê°œë³„)</h2>
        <a title="ë¶ë§ˆí¬" class="bookmark toggle">
          ë‚´ ë©”ë‰´
        </a>
      </div>
      <ul class="page-navi">
        <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
        <li>ë°œì£¼/ìˆ˜ë¶ˆê´€ë¦¬</li>
        <li>ë°œì£¼ ë“±ë¡</li>
      </ul>
    </div>

    <section class="section">
      <div class="section-top">
        <div class="search-wrap">
          <dl>
            <dt>
              <label for="cboDateKind">
                ê²€ìƒ‰ êµ¬ë¶„<span class="eq"></span>
              </label>
            </dt>
            <dd>
              <div class="srch-box">
                <select id="cboDateKind" name="cboDateKind">
                  <option value="sales">ë°œì£¼ì¼</option>
                  <option value="delivery">ë‚©ê¸°ì¼</option>
                </select>
              </div>
            </dd>
          </dl>
          <dl>
            <dt>
              ì¡°íšŒê¸°ê°„<span class="eq">*</span>
            </dt>
            <dd>
              <ul class="date-box">
                <li>
                  <input type="date" id="srchStartDt" name="srchStartDt">
                  <label for="srchStartDt" class="hide">ì‹œì‘ì¼</label>
                </li>
                <li>
                  <input type="date" id="srchEndDt" name="srchEndDt">
                  <label for="srchEndDt" class="hide">ì¢…ë£Œì¼</label>
                </li>
              </ul>
            </dd>
          </dl>

          <dl>
            <dt>&nbsp;</dt>
            <dd>
              <li>
                <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnSearch">
                  <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                  <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                  ê²€ìƒ‰
                </a>
              </li>
            </dd>
          </dl>
        </div>
        <div class="button-wrap">
          <ul>
            <li>
              <a class="btn btn-excell" title="ë“±ë¡" id="btnAddNew">
                <img src="/images/icon/ico-plus.svg" alt="ë“±ë¡ ì•„ì´ì½˜">
                ë“±ë¡
              </a>
            </li>
            <li>
              <a class="btn btn-delete" title="ì‚­ì œ" id="btnDelete">
                <img src="/images/icon/ico-delete.svg" alt="ì‚­ì œ ì•„ì´ì½˜">
                ì‚­ì œ
              </a>
            </li>
            <li>
              <a class="btn btn-edit" title="ìˆ˜ì •" id="btnEdit">
                <img src="/images/icon/ico-edit.svg" alt="ìˆ˜ì • ì•„ì´ì½˜">
                ìˆ˜ì •
              </a>
            </li>
          </ul>
        </div>
      </div>
      <div class="container-fluid">
        <div id="theGrid" style="height: 730px;"></div>
      </div>
      <!--        <div class="grid_box">-->

      <!--            <div class="h-640" data-ax5grid="sujuGrid" ></div>-->
      <!--        </div>-->
    </section>
  </div>
  <script type="text/x-tmpl" id="baljuTemplate">
    <div class="content_wrap popup" id="div_excel_upload">
        <div class="table-wrap">
        <form id="baljuForm">
            <table class="write-table">
                <caption>ì£¼ë¬¸ë“±ë¡ í…Œì´ë¸”</caption>
                <input type="hidden" id="id" name="id">
                <tbody>
                    <tr>
                        <th style="text-align: center">
                            <label for="MaterialGroupName">ì œí’ˆê·¸ë£¹</label>
                        </th>
                        <td>
                            <input type="text" id="MaterialGroupName" name="MaterialGroupName" readonly>
                        </td>
                        <th style="text-align: center">
                            <label for="product_code">í’ˆëª©ì½”ë“œ</label>
                        </th>
                        <td>
                            <input type="text" id="product_code" name="product_code" readonly>
                        </td>
                    </tr>
                    <tr>
                        <th style="text-align: center">
                            <label for="txtProductName">í’ˆëª©ëª…</label>
                        </th>
                        <td colspan="3">
                            <input type="text" id="txtProductName" name="product_name"
                                   placeholder="ê²€ìƒ‰ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì œí’ˆì„ ê²€ìƒ‰í•˜ì„¸ìš”" readonly>
                            <input type="hidden" id="Material_id" name="Material_id">
                            &nbsp;
                            <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnProductSearch">
                                <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                ì œí’ˆ ê²€ìƒ‰
                            </a>
                        </td>
                    </tr>
                    <tr>
                        <th style="text-align: center">
                            <label for="SujuQty">ë°œì£¼ëŸ‰*</label>
                        </th>
                        <td>
                            <input class="form-control2 tar" type="text" id="SujuQty" name="SujuQty" onkeyup="numberSujuQty(this.value)">
                        </td>
                        <th style="text-align: center">
                            <label for="AvailableStock">ë‹¹ì‹œ ê°€ìš©ì¬ê³ </label>
                        </th>
                        <td>
                            <input class="form-control2 tar" type="text" id="AvailableStock" name="AvailableStock" readonly>
                        </td>
                    </tr>
                    <tr>
                        <th style="text-align: center">
                            <label for="cboCompany">êµ¬ë§¤ì²˜*</label>
                        </th>
                        <td colspan="3">
                            <input id="cboCompany" name="Company_id" type="hidden">
                            <input class="form-control2" type="text" id="CompanyName" name="CompanyName" readonly/>
                            &nbsp;
                            <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnCompanySearch">
                                <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                êµ¬ë§¤ì²˜ ê²€ìƒ‰
                            </a>
                        </td>
                    </tr>
                    <tr>
                        <th style="text-align: center">
                            <label for="cboBaljuType">ë°œì£¼êµ¬ë¶„</label>
                        </th>
                        <td colspan="3">
                            <select id="cboBaljuType" name="SujuType"></select>
                        </td>
                    </tr>
                    <tr>
                        <th style="text-align: center">
                            <label for="JumunDate">ë°œì£¼ì¼</label>
                        </th>
                        <td>
                            <input type="date" id="JumunDate" name="JumunDate">
                        </td>
                        <th style="text-align: center">
                            <label for="DueDate">ë‚©ê¸°ì˜ˆì •ì¼</label>
                        </th>
                        <td>
                            <input type="date" id="DueDate" name="DueDate">
                        </td>
                    </tr>
                    <tr>
                        <th style="text-align: center">
                            <label for="description">ë¹„ê³ </label>
                        </th>
                        <td colspan="3">
                            <textarea id="description" name="Description"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <th style="text-align: center">
                            <label for="unit">ë‹¨ìœ„</label>
                        </th>
                        <td>
                            <input type="text" id="unit" name="unit" readonly>
                        </td>
                        <th style="text-align: center">
                            <label for="StateName">ìƒíƒœ</label>
                        </th>
                        <td>
                            <input type="text" id="StateName" name="StateName" readonly disabled>
                        </td>
                    </tr>
                </tbody>
            </table>
            </form>
        </div>

        <div class="popup-button">

                <button type="button" class="btn-popup y_write_auth" id="btnPopBaljuSave">ì €ì¥</button>
                <button type="button" class="btn-popup" id="modal-close-button">ë‹«ê¸°</button>

        </div>
    </div>
  </script>

</th:block>

<th:block layout:fragment="scripts">
  <!--<th:block th:replace="/common/columns_setting :: columns_setting"></th:block>-->
  <th:block th:replace="/common/multiform_material :: multiform_material"></th:block>
  <th:block th:replace="/common/popup_company :: popup_company"></th:block>

  <script type="text/javascript">

    function numberSujuQty(x) {
      x = x.replace(/[^0-9]/g, '');   // ì…ë ¥ê°’ì´ ìˆ«ìê°€ ì•„ë‹ˆë©´ ê³µë°±
      x = x.replace(/,/g, '');          // ,ê°’ ê³µë°±ì²˜ë¦¬
      $("#SujuQty").val(x.replace(/\B(?=(\d{3})+(?!\d))/g, ",")); // ì •ê·œì‹ì„ ì´ìš©í•´ì„œ 3ìë¦¬ ë§ˆë‹¤ , ì¶”ê°€
    }

    class SujuUploadPage {
      constructor() {
        this.url = '/api/balju/balju_order';
        this.grid = null;
        this.$btnEdit = $('#btnEdit');
        this.$btnAddNew = $('#btnAddNew');
        this.viewData = new wijmo.collections.CollectionView();
        this.init();
      }

      init() {
        let _this = this;
        this.grid = new wijmo.grid.FlexGrid('#theGrid', {
          selectionMode: wijmo.grid.SelectionMode.Row,
          headersVisibility: wijmo.grid.HeadersVisibility.Column,
          autoGenerateColumns: false,
          showMarquee: true,
          isReadOnly: true,
          formatItem: (sender, e) => {
            if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
              e.cell.style.textAlign = 'center';
            }
          },
          columns: [
            {binding: 'CompanyName', header: 'êµ¬ë§¤ì²˜', width: 120},
            {binding: 'BaljuTypeName', header: 'ë°œì£¼êµ¬ë¶„', width: 100, align: 'center'},
            {binding: 'JumunDate', header: 'ë°œì£¼ì¼', width: 120, align: 'center'},
            {binding: 'MaterialGroupName', header: 'ì œí’ˆê·¸ë£¹', width: 100},
            {binding: 'product_code', header: 'ì œí’ˆì½”ë“œ', width: 100},
            {binding: 'product_name', header: 'ì œí’ˆëª…', width: 200},
            {binding: 'unit', header: 'ë‹¨ìœ„', width: 80, align: 'center'},
            {binding: 'SujuQty', header: 'ìˆ˜ëŸ‰', width: 80, align: 'right', format: 'n0'},
            {binding: 'DueDate', header: 'ë‚©ê¸°ì˜ˆì •ì¼', width: 120, align: 'center'},
            {binding: 'StateName', header: 'ìƒíƒœ', width: 100, align: 'center'},
            {binding: 'ShipmentStateName', header: 'ë‚©í’ˆì¥ì†Œ', width: 100, align: 'center'},
            {binding: 'plan_state', header: 'ì…ê³ ìˆ˜ëŸ‰', width: 100, align: 'center'},
            {binding: 'Description', header: 'ë¹„ê³ ', width: 200}
          ],
          itemsSource: this.viewData, // ë°ì´í„°ë¥¼ ì„¤ì •í•  ë°°ì—´
        });

        new FlexGridContextMenu(this.grid);
        this.grid.downloadFileName = 'ë°œì£¼ ë“±ë¡';

        this.grid.hostElement.addEventListener('dblclick', function (e) {
          let items = _this.grid.selectedItems;
          if (items.length === 0) {
            return false;
          }
          _this.$btnEdit.trigger('click');
        });

        let nowDate = CommonUtil.getYYYYMMDD();
        let dueDate = CommonUtil.getYYYYMMDD(10);

        //ë°œì£¼ë“±ë¡ í´ë¦­
        this.$btnAddNew.click(function (e) {
          let defaultData = {
            id: '',
            mode: 'new',
            JumunDate: nowDate,
            DueDate: dueDate,
            State: 'draft'
          };
          _this.showBaljuForm(defaultData);
        });

        // ë°œì£¼ ìˆ˜ì • í´ë¦­
        this.$btnEdit.click(function (e) {
          let selectedItems = _this.grid.selectedItems;

          if (selectedItems.length === 1) {

            let data = {
              id: selectedItems[0].id,
              action: 'detail'
            };
            let fnsuccess = function (result) {
              result.data['mode'] = 'edit';
              _this.showBaljuForm(result.data);
            };
            AjaxUtil.getAsyncData(_this.url + '/detail', data, fnsuccess);
          } else if (items.length > 1) {
            Alert.alert('', 'ë°ì´í„°ë¥¼ í•˜ë‚˜ë§Œ ì„ íƒí•˜ì„¸ìš”.');
          } else {
            Alert.alert('', 'ì„ íƒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          }

        });

        // ì‚­ì œ ë²„íŠ¼
        $('#btnDelete').click(function (e) {
          let items = _this.grid.selectedItems;
          if (items.length > 0) {
            Alert.confirm('', 'ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
              function () {
                let id = items[0].id;
                let state = items[0].State;

                _this.deleteSujuData(id, state);
              },
              function () {
              }
            );
          } else {
            Alert.alert('', 'ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', function () {
              $(this).focus();
            });
          }
        });

        // ì—”í„°í‚¤ ê²€ìƒ‰
        $('#keyword').on('keypress', function (e) {
          if (e.keyCode === 13) {
            _this.searchMainData();
          }
        });
      }

      showBaljuForm(data) {
        //baljuTemplate
        let _this = this;
        let content = tmpl('baljuTemplate', data);
        let $content = $(content);

        let modalContainer = null;
        if (data.mode === 'new') {
          modalContainer = new PopupDraggable('ë“±ë¡');
        } else {
          modalContainer = new PopupDraggable('ìˆ˜ì •');
        }
        modalContainer.open({width: 1050, height: 580, $content});
        $('#popSrchDt1').ax5DatePicker({direction: 'top'});
        $('#popSrchDt2').ax5DatePicker({direction: 'top'});

        // ì œí’ˆê²€ìƒ‰
        let $btnProductSearch = $content.find('#btnProductSearch');
        let $btnCompanySearch = $content.find('#btnCompanySearch');
        let $MaterialGroupName = $content.find('#MaterialGroupName');
        let $product_code = $content.find('#product_code');
        let $txtProductName = $content.find('#txtProductName');
        let $Material_id = $content.find('#Material_id');

        let $baljuForm = $content.find('#baljuForm');

        let $cboBaljuType = $content.find('#cboBaljuType');
        let $cboMaterial = $content.find('#cboMaterial');
        let $JumunDate = $content.find('#JumunDate');
        let $DueDate = $content.find('#DueDate');

        let $AvailableStock = $('#AvailableStock');
        let $unit = $('#unit');
        let $cboCompany = $('#cboCompany');
        let $CompanyName = $('#CompanyName');
        let $quantity = $('#quantity');
        let $SujuQty = $('#SujuQty');

        if (data.mode === 'new') {
          $btnProductSearch.removeAttr('disabled');

        }

        $btnProductSearch.click(function (e) {
          let pop = new PopMatComponent();
          pop.material_type = 'product,sangpum';
          pop.show(function (item) {
            $txtProductName.val(item.Name);
            $Material_id.val(item.id);
            $product_code.val(item.Code);
            $MaterialGroupName.val(item.group_name);
          });
          pop.searchDataBind();
        });

        $content.find('#btnCompanySearch').click(function () {
          let poppage = new PopCompComponent();
          let $poppage = $(poppage);
          let searchcallback = function (items) {
            $content.find('#cboCompany').val(items.id);
            $content.find('#CompanyName').val(items.compname);
          };

          poppage.show(searchcallback);
        });

        // ì €ì¥ë²„íŠ¼
        let $btnPopBaljuSave = $('#btnPopBaljuSave');


        //ë°œì£¼êµ¬ë¶„
        AjaxUtil.fillSelectOptions($cboBaljuType, 'system_code', 'choose', null, 'Balju_type');


        //íŒì—…íƒ€ì´í‹€ ì„¤ì •
        let $popTitle = $content.find('#popTitle');
        if (data.mode === 'new') {
          $popTitle.text('ë°œì£¼ ë“±ë¡');
        } else {
          // ë°œì£¼ ìˆ˜ì •ì‹œ ì œí’ˆê·¸ë£¹ê³¼ ì œí’ˆì„ ìˆ˜ì •í•˜ê²Œ í•  ê²ƒ ì¸ì§€?
          $popTitle.text('ë°œì£¼ ìˆ˜ì •');

          if (data.Company_id) {
            $CompanyName.attr('readonly', true);
          }
        }
        FormUtil.BindDataForm(data, $baljuForm);


        if (data.SujuQty > 0) {
          $SujuQty.val(data.SujuQty.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
        }


        // ë°œì£¼ë“±ë¡ íŒì—… ì €ì¥ë²„íŠ¼ í´ë¦­
        $btnPopBaljuSave.click(function (e) {

          //ë°œì£¼ì¼, ë‚©ê¸°ì¼ ì²´í¬?
          let data = FormUtil.extractForm($baljuForm);

          if ((data.Material_id == null) || (data.Material_id === '')) {
            Alert.alert('', 'ì œí’ˆì„ ì„ íƒí•˜ì„¸ìš”.');
            return;
          }

          if (($CompanyName.val() == null) || ($CompanyName.val() === '')) {
            Alert.alert('', 'êµ¬ë§¤ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
            return;
          }

          if ($SujuQty.val() === '') {
            Alert.alert('', 'ë°œì£¼ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.');
            return;
          }

          Alert.confirm('', 'ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function () {
            let url = _this.url + '/manual_save';


            data.SujuQty = data.SujuQty.replace(/,/g, '');
            console.log("ğŸ“¤ ì „ì†¡ë  ë°œì£¼ ë°ì´í„°:", data);
            let fnSaveSuccess = function (result) {
              Notify.success("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
              _this.searchMainData();
              modalContainer.close();
            };
            AjaxUtil.postAsyncData(url, data, fnSaveSuccess);
          });
        });
      }

      deleteSujuData(id, state) {
        let _this = this;
        let url = _this.url + '/delete';
        let data = {'id':id, 'State': state}
        let fnsuccess = function (res) {
          if (res.success) {
            Notify.success('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            _this.searchMainData();
          } else {
            Alert.alert('', res.message);
          }
        };

        AjaxUtil.postAsyncData(url, data, fnsuccess);
      }

      // exportExcel() {
      //     var targetview = this.grid;
      //     targetview.exportExcel('ë°œì£¼ë‚´ì—­.xls');
      // }

      searchMainData() {
        let _this = this;
        let date_kind = $('#cboDateKind').val();  //ë°œì£¼êµ¬ë¶„
        let start = $('#srchStartDt').val();  //ì‹œì‘ì¼
        let end = $('#srchEndDt').val();      //ì¢…ë£Œì¼
        let url = this.url + '/read';

        let data = {
          'date_kind': date_kind,
          'start': start,
          'end': end,
          'action': 'read'
        };

        let fnsuccess = function (result) {
          if (result != null) {
            _this.viewData.sourceCollection = result.data;
          }
        };
        AjaxUtil.getAsyncData(url, data, fnsuccess);
      }
    }

    let page = null;
    var picker = new ax5.ui.picker();

    $(document).ready(function (e) {

      page = new SujuUploadPage();

      picker.bind({
        target: $('[data-ax5picker="multi"]'),
        direction: "top",
        content: {
          width: 214,  //130 270
          margin: 10,
          type: 'date',
          config: {
            control: {
              left: '<i class="fa fa-chevron-left"></i>',
              yearTmpl: '%s',
              monthTmpl: '%s',
              right: '<i class="fa fa-chevron-right"></i>'
            },
            lang: {
              yearTmpl: "%së…„",
              months: ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'],
              dayTmpl: "%s"
            }
          }
        },
        btns: {
          /*ok: {
              label: "ë‹«ê¸°", theme: "default", onClick: function () {
                  this.self.close();
              }
          }*/
        }
      });

//        $('#divDate').ax5DatePicker({ direction: 'top' });
      $('#srchStartDt').val(CommonUtil.getYYYYMMDD(-7));
      $('#srchEndDt').val(CommonUtil.getYYYYMMDD());

      page.searchMainData();

      // page.popColSetting = new popColSetting();
      // let columns = page.popColSetting.loadColumnData(gui.gui_code, gui.template_key, 'grid',  page.grid);

      // if (userinfo.group_code == 'admin') {
      //     $('#btnGridSetting').css('visibility', 'visible');
      // }

      // ê²€ìƒ‰
      $('#btnSearch').click(function (e) {
        page.searchMainData();
      });

      // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
      // $('#btnExc/el').on('click', function () {
      //     page.exportExcel();
      // });

      //ê·¸ë¦¬ë“œ ì»¬ëŸ¼ ì„¤ì • ë²„íŠ¼
      // $('#btnGridSetting').click(function (e) {
      //     let _this = this;
      //
      //     let fix_cols = page.grid_config.frozenColumnIndex;
      //     page.popColSetting.show(gui.gui_code, gui.template_key, 'grid', page.grid_config.columns, page.grid, { 'order_fix':false,  'fix_cols' : fix_cols });
      // });

    })
  </script>

</th:block>
<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
</html>